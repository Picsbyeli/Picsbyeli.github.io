<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Burble - Brain Teasers & Riddles Platform</title>
    <link rel="stylesheet" href="assets/css/styles.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo" onclick="showPage(event,'home')">üß© Burble</div>
            <div class="nav-buttons">
                <button class="nav-btn active" onclick="showPage(event,'home')">Home</button>
                <button class="nav-btn" onclick="showPage(event,'riddles')">Riddles</button>
                <button class="nav-btn" onclick="showPage(event,'burble')">Burble</button>
                <button class="nav-btn" onclick="showPage(event,'emoji')">Emoji</button>
                <button class="nav-btn" onclick="showPage(event,'valentine')">Twenty Questions</button>
                <button class="nav-btn" onclick="showPage(event,'trivia')">Trivia</button>
                <button class="nav-btn" onclick="showPage(event,'animal-trivia')">Animals</button>
            </div>
            <div class="now-playing" id="now-playing" aria-live="polite">
                <span class="now-playing-art" id="now-playing-art">üéµ</span>
                Now playing: <span id="now-playing-track">None</span>
            </div>
            <div id="user-area" class="user-area">
                <button id="signin-btn" class="nav-btn small">Sign in</button>
                <div id="user-info" class="muted-center hidden">
                    <a href="#" id="user-email-link" title="User email">User</a>
                    <div><button id="signout-btn" class="nav-btn xsmall">Sign out</button></div>
                </div>
            </div>
            <!-- Audio Controls -->
            <div class="audio-controls" id="audio-controls" aria-label="Audio controls">
                <select id="audio-mode" title="Mode" aria-label="Audio mode">
                    <option value="all">All</option>
                    <option value="riddles">Riddles</option>
                    <option value="trivia">Trivia</option>
                    <option value="animal">Animal Trivia</option>
                    <option value="burble">Burble</option>
                    <option value="emoji">Emoji</option>
                    <option value="valentine">Twenty Questions</option>
                </select>

                <select id="audio-track" title="Track" aria-label="Audio track"></select>

                <button id="audio-prev" title="Previous">‚óÄ</button>
                <button id="audio-rewind" title="Rewind 10s">-10s</button>
                <button id="audio-play" title="Play">‚ñ∂</button>
                <button id="audio-pause" title="Pause">‚ùö‚ùö</button>
                <button id="audio-forward" title="Forward 10s">+10s</button>
                <button id="audio-next" title="Next">‚ñ∂‚ñ∂</button>

                <input type="range" id="audio-volume" class="volume" min="0" max="1" step="0.01" aria-label="Audio volume" title="Audio volume">
                <label for="audio-show-queue" class="audio-queue-label" title="Show queue"><input type="checkbox" id="audio-show-queue">Queue</label>
            </div>
            <div id="audio-queue" class="audio-queue hidden" aria-hidden="true">
                <div class="queue-header">
                        <strong class="queue-title">Queue</strong>
                        <div>
                            <button id="audio-clear-queue" title="Clear queue" class="clear-queue-btn">Clear</button>
                        </div>
                    </div>
                <div id="audio-queue-list"></div>
            </div>
        </div>

        <!-- Home Page -->
        <div id="home-page" class="game-container">
            <div class="hero-section">
                <h1 class="hero-title">Brain Teasers & Riddles</h1>
                <p class="hero-subtitle">Challenge your mind with puzzles, riddles, and brain games</p>
                
                <!-- User Stats -->
                <div class="user-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="total-score">0</div>
                        <div class="stat-label">Total Score</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="games-played">0</div>
                        <div class="stat-label">Games Played</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="games-won">0</div>
                        <div class="stat-label">Games Won</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="win-rate">0%</div>
                        <div class="stat-label">Win Rate</div>
                    </div>
                </div>
            </div>

            <!-- Games Grid -->
            <div class="games-grid">
                <div class="game-card" onclick="showPage(event,'riddles')">
                    <div class="game-icon">üß©</div>
                    <div class="game-title">Brain Riddles</div>
                    <div class="game-description">Classic riddles and brain teasers across all categories</div>
                </div>
                
                <div class="game-card" onclick="showPage(event,'burble')">
                    <div class="game-icon">üìö</div>
                    <div class="game-title">Burble Word Game</div>
                    <div class="game-description">Word guessing with feedback and hints</div>
                </div>
                
                <div class="game-card" onclick="showPage(event,'emoji')">
                    <div class="game-icon">üé®</div>
                    <div class="game-title">Emoji Guess</div>
                    <div class="game-description">Decode emoji combinations</div>
                </div>
                
                <div class="game-card" onclick="showPage(event,'valentine')">
                    <div class="game-icon">üéØ</div>
                    <div class="game-title">Twenty Questions</div>
                    <div class="game-description">Yes/No question guessing game</div>
                </div>
                
                <div class="game-card" onclick="showPage(event,'trivia')">
                    <div class="game-icon">üß†</div>
                    <div class="game-title">General Trivia</div>
                    <div class="game-description">Test your knowledge across various topics</div>
                </div>
                
                <div class="game-card" onclick="showPage(event,'animal-trivia')">
                    <div class="game-icon">ü¶Å</div>
                    <div class="game-title">Animal Trivia</div>
                    <div class="game-description">Animal-focused quiz questions</div>
                </div>
            </div>
        </div>

        <!-- Riddles Game -->
        <div id="riddles-page" class="game-container hidden">
            <div class="game-header">
                <h1 class="game-title-main">üß© Brain Riddles</h1>
                
                <div class="difficulty-selector">
                    <span class="selector-label">Difficulty</span>
                    <div class="selector-buttons">
                        <button class="selector-btn" data-difficulty="easy">Easy</button>
                        <button class="selector-btn active" data-difficulty="medium">Medium</button>
                        <button class="selector-btn" data-difficulty="hard">Hard</button>
                    </div>
                </div>

                <div class="category-selector">
                    <span class="selector-label">Category</span>
                    <div class="selector-buttons">
                        <button class="selector-btn active" data-category="all">All Types</button>
                        <button class="selector-btn" data-category="logic">Logic</button>
                        <button class="selector-btn" data-category="word">Word</button>
                        <button class="selector-btn" data-category="math">Math</button>
                        <button class="selector-btn" data-category="lateral">Lateral Thinking</button>
                    </div>
                </div>
            </div>

            <div class="game-info">
                <div class="info-card">
                    <div class="info-label">Score</div>
                    <div class="info-value" id="riddles-score">0</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Solved</div>
                    <div class="info-value" id="riddles-solved">0</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Category</div>
                    <div class="info-value" id="riddles-category">All Types</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Difficulty</div>
                    <div class="info-value" id="riddles-difficulty">Medium</div>
                </div>
            </div>

            <div id="riddles-question-container">
                <div class="game-display" id="riddles-question">Click "New Riddle" to start solving brain teasers!</div>
            </div>

            <div class="input-section">
                <input type="text" class="game-input" id="riddles-input" placeholder="Type your answer..." disabled>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" id="riddles-submit" disabled>Submit Answer</button>
                <button class="btn btn-secondary" id="riddles-hint" disabled>Get Hint (-10 points)</button>
                <button class="btn btn-secondary" id="riddles-next">New Riddle</button>
            </div>

            <div id="riddles-feedback"></div>
            <div id="riddles-game-over"></div>
        </div>

        <!-- Burble Word Game -->
        <div id="burble-page" class="game-container hidden">
            <div class="game-header">
                <h1 class="game-title-main">üß© Burble Word Game</h1>
                
                <div class="difficulty-selector">
                    <span class="selector-label">Difficulty</span>
                    <div class="selector-buttons">
                        <button class="selector-btn" data-difficulty="easy">Easy (15 attempts)</button>
                        <button class="selector-btn active" data-difficulty="medium">Medium (10 attempts)</button>
                        <button class="selector-btn" data-difficulty="hard">Hard (5 attempts)</button>
                    </div>
                </div>

                <div class="category-selector">
                    <span class="selector-label">Category</span>
                    <div class="selector-buttons">
                        <button class="selector-btn active" data-category="Food">Food</button>
                        <button class="selector-btn" data-category="Animals">Animals</button>
                        <button class="selector-btn" data-category="Colors">Colors</button>
                        <button class="selector-btn" data-category="Cities">Cities</button>
                        <button class="selector-btn" data-category="Items">Items</button>
                        <button class="selector-btn" data-category="Sports">Sports</button>
                    </div>
                </div>
            </div>

            <div class="game-info">
                <div class="info-card">
                    <div class="info-label">Attempts</div>
                    <div class="info-value" id="burble-attempts">0/10</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Category</div>
                    <div class="info-value" id="burble-category">Food</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Time</div>
                    <div class="info-value timer" id="burble-timer">00:00</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Score</div>
                    <div class="info-value" id="burble-score">0</div>
                </div>
            </div>

            <div class="game-display" id="burble-display">Click "New Game" to start!</div>

            <div class="input-section">
                <input type="text" class="game-input" id="burble-input" placeholder="Enter your guess..." maxlength="20" disabled>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" id="burble-submit" disabled>Submit Guess</button>
                <button class="btn btn-secondary" id="burble-hint" disabled>Get Hint</button>
                <button class="btn btn-secondary" id="burble-new-game">New Game</button>
            </div>

            <div id="burble-feedback"></div>
            <div id="burble-game-over"></div>
        </div>

        <!-- Emoji Guess Game -->
        <div id="emoji-page" class="game-container hidden">
            <div class="game-header">
                <h1 class="game-title-main">üß© Emoji Guess</h1>
                
                <div class="difficulty-selector">
                    <span class="selector-label">Difficulty</span>
                    <div class="selector-buttons">
                        <button class="selector-btn" data-difficulty="easy">Easy</button>
                        <button class="selector-btn active" data-difficulty="medium">Medium</button>
                        <button class="selector-btn" data-difficulty="hard">Hard</button>
                    </div>
                </div>

                <div class="category-selector">
                    <span class="selector-label">Category</span>
                    <div class="selector-buttons">
                        <button class="selector-btn active" data-category="all">All</button>
                        <button class="selector-btn" data-category="movies">Movies</button>
                        <button class="selector-btn" data-category="foods">Foods</button>
                        <button class="selector-btn" data-category="animals">Animals</button>
                        <button class="selector-btn" data-category="items">Items</button>
                    </div>
                </div>
            </div>

            <div class="game-info">
                <div class="info-card">
                    <div class="info-label">Score</div>
                    <div class="info-value" id="emoji-score">0</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Hints Used</div>
                    <div class="info-value" id="emoji-hints">0</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Category</div>
                    <div class="info-value" id="emoji-category">All</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Difficulty</div>
                    <div class="info-value" id="emoji-difficulty">Medium</div>
                </div>
            </div>

            <div class="game-display emoji-display" id="emoji-display">Click "New Puzzle" to start!</div>

            <div class="input-section">
                <input type="text" class="game-input" id="emoji-input" placeholder="What does this emoji combination represent?" disabled>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" id="emoji-submit" disabled>Submit Answer</button>
                <button class="btn btn-secondary" id="emoji-hint" disabled>Get Hint (-5 points)</button>
                <button class="btn btn-secondary" id="emoji-new-puzzle">New Puzzle</button>
            </div>

            <div id="emoji-feedback"></div>
            <div id="emoji-game-over"></div>
        </div>

        <!-- Twenty Questions Game -->
        <div id="valentine-page" class="game-container hidden">
            <div class="game-header">
                <h1 class="game-title-main">üéØ Twenty Questions</h1>
                
                <div class="difficulty-selector">
                    <span class="selector-label">Difficulty</span>
                    <div class="selector-buttons">
                        <button class="selector-btn" data-difficulty="easy">Easy (8 questions)</button>
                        <button class="selector-btn active" data-difficulty="medium">Medium (6 questions)</button>
                        <button class="selector-btn" data-difficulty="hard">Hard (4 questions)</button>
                    </div>
                </div>

                <div class="category-selector">
                    <span class="selector-label">Category</span>
                    <div class="selector-buttons">
                        <button class="selector-btn active" data-category="movies">Movies</button>
                        <button class="selector-btn" data-category="animals">Animals</button>
                        <button class="selector-btn" data-category="places">Places</button>
                        <button class="selector-btn" data-category="objects">Objects</button>
                    </div>
                </div>
            </div>

            <div class="game-info">
                <div class="info-card">
                    <div class="info-label">Questions Left</div>
                    <div class="info-value" id="valentine-questions">6</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Guesses Left</div>
                    <div class="info-value" id="valentine-guesses">3</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Category</div>
                    <div class="info-value" id="valentine-category">Movies</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Score</div>
                    <div class="info-value" id="valentine-score">0</div>
                </div>
            </div>

            <div class="question-history" id="valentine-history">
                <p class="muted-center">Ask yes/no questions to figure out what I'm thinking of!</p>
            </div>

            <div class="input-section">
                <input type="text" class="game-input" id="valentine-question" placeholder="Ask a yes/no question..." disabled>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" id="valentine-ask" disabled>Ask Question</button>
                <button class="btn btn-secondary" id="valentine-guess" disabled>Make Guess</button>
                <button class="btn btn-secondary" id="valentine-new-game">New Game</button>
            </div>

            <div id="valentine-feedback"></div>
            <div id="valentine-game-over"></div>
        </div>

        <!-- General Trivia Game -->
        <div id="trivia-page" class="game-container hidden">
            <div class="game-header">
                <h1 class="game-title-main">üß† General Trivia</h1>
                
                <div class="difficulty-selector">
                    <span class="selector-label">Difficulty</span>
                    <div class="selector-buttons">
                        <button class="selector-btn" data-difficulty="easy">Easy</button>
                        <button class="selector-btn active" data-difficulty="medium">Medium</button>
                        <button class="selector-btn" data-difficulty="hard">Hard</button>
                    </div>
                </div>
            </div>

            <div class="game-info">
                <div class="info-card">
                    <div class="info-label">Question</div>
                    <div class="info-value" id="trivia-question-num">0/10</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Correct</div>
                    <div class="info-value" id="trivia-correct">0</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Score</div>
                    <div class="info-value" id="trivia-score">0</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Time</div>
                    <div class="info-value timer" id="trivia-timer">00:00</div>
                </div>
            </div>

            <div class="trivia-question" id="trivia-question-text">Click "Start Quiz" to begin!</div>

            <div class="trivia-options" id="trivia-options"></div>

            <div class="action-buttons">
                <button class="btn btn-primary" id="trivia-submit" disabled>Submit Answer</button>
                <button class="btn btn-secondary" id="trivia-next" disabled>Next Question</button>
                <button class="btn btn-secondary" id="trivia-start">Start Quiz</button>
            </div>

            <div id="trivia-feedback"></div>
            <div id="trivia-game-over"></div>
        </div>

        <!-- Leaderboard Page -->
        <div id="leaderboard-page" class="game-container hidden">
            <div class="game-header">
                <h1 class="game-title-main">üèÜ Leaderboard</h1>
            </div>
                <div class="leaderboard-tabs">
                <button class="selector-btn active" data-tab="scores" onclick="showLeaderboardTab('scores')">Scores</button>
                <button class="selector-btn" data-tab="details" onclick="showLeaderboardTab('details')">Details</button>
            </div>
            <div id="leaderboard-content">
                <div id="leaderboard-scores">
                    <table class="table-full">
                        <thead>
                            <tr><th class="text-left">Rank</th><th>User</th><th>Score</th></tr>
                        </thead>
                        <tbody id="leaderboard-scores-body"></tbody>
                    </table>
                </div>
                <div id="leaderboard-details" class="hidden">
                    <table class="table-full">
                        <thead>
                            <tr><th class="text-left">Rank</th><th>User</th><th>Questions Solved</th><th>Avg Time (s)</th><th>Highest Streak</th></tr>
                        </thead>
                        <tbody id="leaderboard-details-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Animal Trivia Game -->
        <div id="animal-trivia-page" class="game-container hidden">
            <div class="game-header">
                <h1 class="game-title-main">ü¶Å Animal Trivia</h1>
                
                <div class="difficulty-selector">
                    <span class="selector-label">Difficulty</span>
                    <div class="selector-buttons">
                        <button class="selector-btn" data-difficulty="easy">Easy</button>
                        <button class="selector-btn active" data-difficulty="medium">Medium</button>
                        <button class="selector-btn" data-difficulty="hard">Hard</button>
                    </div>
                </div>
            </div>

            <div class="game-info">
                <div class="info-card">
                    <div class="info-label">Question</div>
                    <div class="info-value" id="animal-question-num">0/15</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Correct</div>
                    <div class="info-value" id="animal-correct">0</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Score</div>
                    <div class="info-value" id="animal-score">0</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Time</div>
                    <div class="info-value timer" id="animal-timer">00:00</div>
                </div>
            </div>

            <div class="trivia-question" id="animal-question-text">Click "Start Quiz" to begin!</div>

            <div class="trivia-options" id="animal-options"></div>

            <div class="action-buttons">
                <button class="btn btn-primary" id="animal-submit" disabled>Submit Answer</button>
                <button class="btn btn-secondary" id="animal-next" disabled>Next Question</button>
                <button class="btn btn-secondary" id="animal-start">Start Quiz</button>
            </div>

            <div id="animal-feedback"></div>
            <div id="animal-game-over"></div>
        </div>
    </div>

    <script>
        // Global game state
        const gameState = {
            currentPage: 'home',
            userStats: {
                totalScore: 0,
                gamesPlayed: 0,
                gamesWon: 0
            },
            burble: {
                difficulty: 'medium',
                category: 'Food',
                currentWord: '',
                attempts: 0,
                maxAttempts: 10,
                score: 0,
                gameActive: false,
                startTime: null,
                timerInterval: null,
                hintsUsed: 0
            },
            emoji: {
                difficulty: 'medium',
                category: 'all',
                currentPuzzle: null,
                score: 0,
                hintsUsed: 0,
                gameActive: false
            },
            valentine: {
                difficulty: 'medium',
                category: 'movies',
                currentAnswer: '',
                questionsLeft: 6,
                guessesLeft: 3,
                score: 0,
                gameActive: false,
                questions: [],
                answers: []
            },
            trivia: {
                difficulty: 'medium',
                currentQuestion: 0,
                totalQuestions: 10,
                correctAnswers: 0,
                score: 0,
                gameActive: false,
                startTime: null,
                timerInterval: null,
                selectedAnswer: null
            },
            animalTrivia: {
                difficulty: 'medium',
                currentQuestion: 0,
                totalQuestions: 15,
                correctAnswers: 0,
                score: 0,
                gameActive: false,
                startTime: null,
                timerInterval: null,
                selectedAnswer: null
            },
            riddles: {
                difficulty: 'medium',
                category: 'all',
                currentRiddle: null,
                currentHintLevel: 0,
                score: 0,
                solved: 0,
                hintsUsed: 0,
                gameActive: false,
                attemptCount: 0,
                maxAttempts: 3
            }
        };

        // Word categories for Burble game
        const wordCategories = {
            Food: {
                4: ['cake', 'taco', 'rice', 'soup', 'bean', 'fish', 'pear', 'plum'],
                5: ['pizza', 'apple', 'salad', 'pasta', 'fruit', 'onion', 'bread', 'steak'],
                6: ['burger', 'cheese', 'cookie', 'banana', 'orange', 'tomato', 'potato'],
                7: ['avocado', 'chicken', 'pancake', 'almond', 'noodles', 'sausage'],
                8: ['broccoli', 'mushroom', 'sandwich', 'blueberry', 'eggplant', 'pineapple']
            },
            Animals: {
                4: ['frog', 'wolf', 'bear', 'deer', 'bird', 'fish', 'lion', 'duck'],
                5: ['tiger', 'sheep', 'snake', 'mouse', 'panda', 'koala', 'horse'],
                6: ['turtle', 'giraffe', 'monkey', 'beaver', 'weasel', 'rabbit'],
                7: ['dolphin', 'penguin', 'octopus', 'raccoon', 'leopard', 'buffalo'],
                8: ['elephant', 'hedgehog', 'flamingo', 'kangaroo', 'scorpion', 'crocodile']
            },
            Colors: {
                4: ['blue', 'pink', 'gold', 'gray', 'teal', 'cyan'],
                5: ['green', 'brown', 'black', 'white', 'amber', 'azure'],
                6: ['purple', 'silver', 'indigo', 'maroon', 'ochre', 'orange'],
                7: ['crimson', 'magenta', 'cerulean', 'lavender', 'turquoise'],
                8: ['burgundy', 'periwinkle', 'sapphire', 'platinum', 'marigold']
            },
            Cities: {
                4: ['rome', 'oslo', 'bali', 'lima', 'york', 'lyon', 'riga', 'kiev'],
                5: ['tokyo', 'paris', 'miami', 'delhi', 'dubai', 'seoul', 'cairo'],
                6: ['london', 'berlin', 'moscow', 'madrid', 'munich', 'sydney'],
                7: ['beijing', 'chicago', 'toronto', 'atlanta', 'houston', 'phoenix'],
                8: ['shanghai', 'istanbul', 'budapest', 'montreal', 'florence', 'helsinki']
            },
            Items: {
                4: ['fork', 'lamp', 'book', 'ring', 'desk', 'mask', 'pen', 'phone', 'shoe'],
                5: ['table', 'chair', 'clock', 'brush', 'phone', 'purse', 'scarf', 'watch'],
                6: ['mirror', 'pillow', 'remote', 'candle', 'wallet', 'hammer', 'laptop'],
                7: ['charger', 'suitcase', 'backpack', 'earbuds', 'cushion', 'toaster'],
                8: ['scissors', 'notebook', 'umbrella', 'keyboard', 'television', 'bookshelf']
            },
            Sports: {
                4: ['golf', 'swim', 'bike', 'surf', 'bowl', 'judo', 'dive', 'ski'],
                5: ['chess', 'rugby', 'skate', 'climb', 'kayak', 'dance', 'jog', 'cycle'],
                6: ['soccer', 'hockey', 'tennis', 'boxing', 'rowing', 'hiking', 'racing'],
                7: ['archery', 'bowling', 'cricket', 'fencing', 'jogging', 'baseball'],
                8: ['football', 'basketball', 'wrestling', 'athletics', 'marathon', 'swimming']
            }
        };

        // Comprehensive riddles database
        const riddlesData = {
            logic: {
                easy: [
                    {
                        riddle: "What comes once in a minute, twice in a moment, but never in a thousand years?",
                        answer: "the letter m",
                        acceptedAnswers: ["m", "letter m", "the letter m"],
                        hints: [
                            "Think about the words in the riddle itself.",
                            "Look at the letters that make up each word.",
                            "Count the letter 'M' in 'minute', 'moment', and 'thousand years'."
                        ],
                        category: "logic",
                        difficulty: "easy"
                    },
                    {
                        riddle: "I'm tall when I'm young, and I'm short when I'm old. What am I?",
                        answer: "candle",
                        acceptedAnswers: ["candle", "a candle"],
                        hints: [
                            "This object changes size as it's used.",
                            "It provides light and gets shorter over time.",
                            "You light it with a match and it melts as it burns."
                        ],
                        category: "logic",
                        difficulty: "easy"
                    },
                    {
                        riddle: "What has keys but no locks, space but no room, you can enter but not go inside?",
                        answer: "keyboard",
                        acceptedAnswers: ["keyboard", "a keyboard", "computer keyboard"],
                        hints: [
                            "This is something you use with technology.",
                            "It has an 'Enter' key and a 'Space' bar.",
                            "You press its keys to type letters and numbers on a computer."
                        ],
                        category: "logic",
                        difficulty: "easy"
                    },
                    {
                        riddle: "What gets wet while drying?",
                        answer: "towel",
                        acceptedAnswers: ["towel", "a towel"],
                        hints: [
                            "This item is used in bathrooms.",
                            "It absorbs moisture from something else while becoming moist itself.",
                            "You use it after a shower to dry your body."
                        ],
                        category: "logic",
                        difficulty: "easy"
                    }
                ],
                medium: [
                    {
                        riddle: "The more you take, the more you leave behind. What am I?",
                        answer: "footsteps",
                        acceptedAnswers: ["footsteps", "steps", "footprints"],
                        hints: [
                            "This relates to movement and travel.",
                            "Every time you do this action, you create evidence of it.",
                            "When you walk, you take these and leave traces behind."
                        ],
                        category: "logic",
                        difficulty: "medium"
                    },
                    {
                        riddle: "I have cities, but no houses. I have mountains, but no trees. I have water, but no fish. What am I?",
                        answer: "map",
                        acceptedAnswers: ["map", "a map"],
                        hints: [
                            "This is a flat representation of something three-dimensional.",
                            "It shows geographical features but not living things.",
                            "You unfold this to find directions and plan routes."
                        ],
                        category: "logic",
                        difficulty: "medium"
                    },
                    {
                        riddle: "What breaks but never falls, and what falls but never breaks?",
                        answer: "day breaks and night falls",
                        acceptedAnswers: ["day and night", "day breaks night falls", "dawn and dusk"],
                        hints: [
                            "These are two opposite things that happen every day.",
                            "One happens in the morning, the other in the evening.",
                            "Think about sunrise (dawn ____) and sunset (night ____)"
                        ],
                        category: "logic",
                        difficulty: "medium"
                    },
                    {
                        riddle: "Forward I am heavy, but backward I am not. What am I?",
                        answer: "ton",
                        acceptedAnswers: ["ton", "the word ton"],
                        hints: [
                            "This is a wordplay riddle about spelling.",
                            "Think about what this word means forward vs backward.",
                            "The word 'TON' spelled backward is 'NOT'."
                        ],
                        category: "logic",
                        difficulty: "medium"
                    }
                ],
                hard: [
                    {
                        riddle: "A man lives on the twentieth floor of an apartment building. Every morning he takes the elevator down to the ground floor. When he comes home, he takes the elevator to the tenth floor and walks the rest of the way... except on rainy days, when he takes the elevator all the way to the twentieth floor. Why?",
                        answer: "he is too short to reach the button",
                        acceptedAnswers: ["he's short", "he can't reach the button", "too short", "short person", "he's too short to reach"],
                        hint: "Think about his physical limitations and what changes on rainy days.",
                        category: "logic",
                        difficulty: "hard"
                    },
                    {
                        riddle: "A woman shoots her husband, then holds him
                saveSettings();
            });

            $mode.addEventListener('change', () => {
                setModeSelection($mode.value);
            });

            // initialize UI based on saved settings
            if (audioSettings.modeMap && Object.keys(audioSettings.modeMap).length > 0) {
                const currentMode = $mode.value || 'all';
                setModeSelection(currentMode);
            }

            // expose helper to global scope for game wiring
            window.playModeAudio = playModeAudio;
            window.audioControls = {
                setPlayerSrc,
                play: () => audioPlayer.play(),
                pause: () => audioPlayer.pause(),
                stop: () => { audioPlayer.pause(); audioPlayer.currentTime = 0; },
                // queue helpers
                getQueue: () => (audioQueue.slice()),
                addToQueue: (src) => { if (src) { audioQueue.push(src); renderQueue(); } },
                clearQueue: () => { audioQueue = []; currentQueueIndex = -1; renderQueue(); }
            };

            // Audio queue implementation
            let audioQueue = []; // list of src strings
            let currentQueueIndex = -1;
            const $queueList = document.getElementById('audio-queue-list');
            const $clearQueue = document.getElementById('audio-clear-queue');

            function renderQueue() {
                if (!$queueList) return;
                $queueList.innerHTML = '';
                audioQueue.forEach((src, i) => {
                    const item = document.createElement('div');
                    item.className = 'audio-queue-item' + (i === currentQueueIndex ? ' current' : '');
                    const label = document.createElement('span');
                    let pretty = src;
                    try { pretty = decodeURIComponent(src); } catch (e) {}
                    const parts = pretty.split('/'); pretty = parts[parts.length - 1] || pretty;
                    label.textContent = pretty;
                    item.appendChild(label);
                    item.addEventListener('click', () => {
                        currentQueueIndex = i;
                        const selected = audioQueue[currentQueueIndex];
                        setPlayerSrc(selected);
                        audioPlayer.play().catch(() => {});
                        saveSettings();
                        renderQueue();
                    });
                    $queueList.appendChild(item);
                });
            }

            function populateQueueFromDefaults() {
                audioQueue = defaultTracks.slice();
                currentQueueIndex = defaultTracks.indexOf(audioPlayer.src) >= 0 ? defaultTracks.indexOf(audioPlayer.src) : -1;
                renderQueue();
            }

            if ($clearQueue) {
                $clearQueue.addEventListener('click', () => { audioQueue = []; currentQueueIndex = -1; renderQueue(); });
            }

            // Wire next/prev to queue if queue present
            const originalNext = $next.onclick;
            $next.addEventListener('click', () => {
                if (audioQueue.length > 0) {
                    currentQueueIndex = (currentQueueIndex + 1) % audioQueue.length;
                    const nextSrc = audioQueue[currentQueueIndex];
                    setPlayerSrc(nextSrc); audioPlayer.play(); renderQueue(); saveSettings();
                }
            });
            $prev.addEventListener('click', () => {
                if (audioQueue.length > 0) {
                    currentQueueIndex = (currentQueueIndex - 1 + audioQueue.length) % audioQueue.length;
                    const prevSrc = audioQueue[currentQueueIndex];
                    setPlayerSrc(prevSrc); audioPlayer.play(); renderQueue(); saveSettings();
                }
            });

            // initialize queue UI
            populateQueueFromDefaults();
        }

        // Expose a safe initializer that waits for DOM nodes to exist.
        function initAudioControls() {
            try {
                // if already initialized (audioPlayer exists), skip
                if (window.audioControls || window.playModeAudio) return;
                // run the previous IIFE body by calling the function above
                (function(){
                    // the original IIFE body is already declared above in this file scope
                    // so invoking the code path here is unnecessary; instead ensure the UI wiring
                })();
            } catch (e) {
                // swallow; runner will retry
            }
        }

        // Retry helper: wait for a few required DOM nodes before initializing
        (function waitForAudioDomAndInit() {
            const required = ['audio-track', 'audio-mode', 'audio-play'];
            const found = required.every(id => document.getElementById(id));
            if (found) {
                // call the audio wiring code that depends on these nodes
                try {
                    // Many variables and functions used by the audio implementation assume they
                    // were created in the IIFE; to keep changes minimal we simply re-run the
                    // small setup pieces that depend on the DOM presence: populate selects and
                    // wire event handlers that reference existing DOM nodes.
                    // If the full audio implementation already ran, these will be no-ops.
                    if (typeof populateQueueFromDefaults === 'function') populateQueueFromDefaults();
                    // expose playModeAudio if defined
                    if (typeof playModeAudio === 'function') window.playModeAudio = playModeAudio;
                    if (typeof setPlayerSrc === 'function') window.setPlayerSrc = setPlayerSrc;
                } catch (e) {
                    // ignore and continue
                }
            } else {
                // try again up to ~20 times (~1s total)
                if (!waitForAudioDomAndInit._tries) waitForAudioDomAndInit._tries = 0;
                waitForAudioDomAndInit._tries++;
                if (waitForAudioDomAndInit._tries < 20) {
                    setTimeout(waitForAudioDomAndInit, 50);
                }
            }
        })();

        // Riddles: maintain per-filter shuffled pools to avoid repeats until exhausted
        function getRiddleFromPool(category, difficulty) {
            const key = `${category}|${difficulty}`;
            if (!gameState.riddles.pools) gameState.riddles.pools = {};
            if (!gameState.riddles.pools[key] || gameState.riddles.pools[key].length === 0) {
                const pool = getRiddlesByFilter(category, difficulty);
                gameState.riddles.pools[key] = shuffleArray(pool);
                savePoolsToStorage();
            }
            const item = gameState.riddles.pools[key].shift();
            savePoolsToStorage();
            return item;
        }
        function showFeedback(gameType, message, type) {
            const feedback = document.getElementById(gameType + '-feedback');
            feedback.innerHTML = `<div class="feedback ${type}">${message}</div>`;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function startTimer(gameType) {
            const game = gameState[gameType];
            game.startTime = Date.now();
            game.timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - game.startTime) / 1000);
                document.getElementById(gameType + '-timer').textContent = formatTime(elapsed);
            }, 1000);
        }

        function stopTimer(gameType) {
            const game = gameState[gameType];
            if (game.timerInterval) {
                clearInterval(game.timerInterval);
                game.timerInterval = null;
            }
        }

        // RIDDLES GAME
        function initRiddlesGame() {
            // Difficulty selectors
            document.querySelectorAll('#riddles-page .selector-btn[data-difficulty]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#riddles-page .selector-btn[data-difficulty]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    gameState.riddles.difficulty = btn.dataset.difficulty;
                    updateRiddlesDisplay();
                });
            });

            // Category selectors
            document.querySelectorAll('#riddles-page .selector-btn[data-category]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#riddles-page .selector-btn[data-category]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    gameState.riddles.category = btn.dataset.category;
                    updateRiddlesDisplay();
                });
            });

            // Game buttons
            document.getElementById('riddles-next').addEventListener('click', nextRiddle);
            document.getElementById('riddles-submit').addEventListener('click', submitRiddleAnswer);
            document.getElementById('riddles-hint').addEventListener('click', getRiddleHint);

            // Input handling
            document.getElementById('riddles-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && gameState.riddles.gameActive) {
                    submitRiddleAnswer();
                }
            });

            updateRiddlesDisplay();
        }

        function nextRiddle() {
            const riddles = gameState.riddles;
            
            // Get riddles for current filter
            const availableRiddles = getRiddlesByFilter(riddles.category, riddles.difficulty);
            if (availableRiddles.length === 0) {
                showFeedback('riddles', 'No riddles available for this category/difficulty combination.', 'error');
                return;
            }
            // Select riddle from a shuffled per-filter pool to avoid repeats until pool exhausted
            let newRiddle = getRiddleFromPool(riddles.category, riddles.difficulty);
            if (!newRiddle) {
                // Fallback to random selection
                newRiddle = availableRiddles[Math.floor(Math.random() * availableRiddles.length)];
            }
            riddles.currentRiddle = newRiddle;
            riddles.currentHintLevel = 0;
            riddles.attemptCount = 0;
            riddles.gameActive = true;

            // Display riddle
            document.getElementById('riddles-question').textContent = riddles.currentRiddle.riddle;
            
            // Enable inputs
            document.getElementById('riddles-input').disabled = false;
            document.getElementById('riddles-submit').disabled = false;
            document.getElementById('riddles-hint').disabled = false;
            document.getElementById('riddles-input').focus();
            
            // Clear previous feedback
            document.getElementById('riddles-feedback').innerHTML = '';
            
            updateRiddlesDisplay();
            showFeedback('riddles', 'New riddle loaded! Think carefully about your answer.', 'info');
            try { if (window.playModeAudio) window.playModeAudio('riddles'); } catch (e) {}
        }

        function submitRiddleAnswer() {
            if (!gameState.riddles.gameActive || !gameState.riddles.currentRiddle) return;
            
            const answer = document.getElementById('riddles-input').value.trim();
            if (!answer) return;

            const riddles = gameState.riddles;
            riddles.attemptCount++;

            if (checkRiddleAnswer(answer, riddles.currentRiddle.acceptedAnswers)) {
                handleRiddleCorrect();
            } else {
                handleRiddleIncorrect();
            }

            document.getElementById('riddles-input').value = '';
        }

        function handleRiddleCorrect() {
            const riddles = gameState.riddles;
            riddles.gameActive = false;
            riddles.solved++;

            // Calculate score based on difficulty, attempts, and hints used
            let basePoints = 0;
            switch (riddles.difficulty) {
                case 'easy': basePoints = 10; break;
                case 'medium': basePoints = 25; break;
                case 'hard': basePoints = 50; break;
            }

            // Bonus for fewer attempts
            const attemptBonus = Math.max(0, (riddles.maxAttempts - riddles.attemptCount + 1) * 5);
            
            // Penalty for hints (already calculated when hint is used)
            const totalScore = basePoints + attemptBonus;
            riddles.score += totalScore;

            // Disable inputs
            document.getElementById('riddles-input').disabled = true;
            document.getElementById('riddles-submit').disabled = true;
            document.getElementById('riddles-hint').disabled = true;

            addGameResult(true, totalScore);
            updateRiddlesDisplay();
            
            showFeedback('riddles', 
                `üéâ Correct! The answer was "${riddles.currentRiddle.answer}". You earned ${totalScore} points! Click "New Riddle" to continue.`, 
                'success'
            );
            // leaderboard recording
            try {
                const user = JSON.parse(localStorage.getItem('burbleUser') || 'null');
                if (user && user.username) recordCorrect(user.username, 0);
            } catch (e) {}
        }

        function handleRiddleIncorrect() {
            const riddles = gameState.riddles;
            
            if (riddles.attemptCount >= riddles.maxAttempts) {
                // Game over - show correct answer
                riddles.gameActive = false;
                
                document.getElementById('riddles-input').disabled = true;
                document.getElementById('riddles-submit').disabled = true;
                document.getElementById('riddles-hint').disabled = true;

                addGameResult(false, 0);
                
                showFeedback('riddles', 
                    `‚ùå Incorrect! The answer was "${riddles.currentRiddle.answer}". Click "New Riddle" to try another!`, 
                    'error'
                );
            } else {
                const attemptsLeft = riddles.maxAttempts - riddles.attemptCount;
                showFeedback('riddles', 
                    `‚ùå Incorrect! You have ${attemptsLeft} attempt${attemptsLeft !== 1 ? 's' : ''} left. Try again!`, 
                    'warning'
                );
            }
            
            updateRiddlesDisplay();
            try { const user = JSON.parse(localStorage.getItem('burbleUser') || 'null'); if (user && user.username) recordIncorrect(user.username); } catch (e) {}
        }

        function getRiddleHint() {
            const riddles = gameState.riddles;
            if (!riddles.currentRiddle || !riddles.gameActive) return;

            // Check if hints are available
            const hints = riddles.currentRiddle.hints || [];
            if (riddles.currentHintLevel >= hints.length) {
                showFeedback('riddles', 'üí° No more hints available for this riddle.', 'warning');
                return;
            }

            const currentHint = hints[riddles.currentHintLevel];
            const hintNumber = riddles.currentHintLevel + 1;
            const pointPenalty = (hintNumber * 5) + 5; // Progressive penalty: 10, 15, 20 points

            riddles.hintsUsed++;
            riddles.currentHintLevel++;
            riddles.score = Math.max(0, riddles.score - pointPenalty);

            showFeedback('riddles', `üí° Hint ${hintNumber}: ${currentHint} (-${pointPenalty} points)`, 'info');
            
            updateRiddlesDisplay();
            updateHintButton();
        }

        function updateRiddlesDisplay() {
            const riddles = gameState.riddles;
            
            // Update stats
            document.getElementById('riddles-score').textContent = riddles.score;
            document.getElementById('riddles-solved').textContent = riddles.solved;
            document.getElementById('riddles-difficulty').textContent = 
                riddles.difficulty.charAt(0).toUpperCase() + riddles.difficulty.slice(1);
            
            // Update category display
            const categoryDisplay = {
                'all': 'All Types',
                'logic': 'Logic',
                'word': 'Word',
                'math': 'Math', 
                'lateral': 'Lateral Thinking'
            };
            document.getElementById('riddles-category').textContent = categoryDisplay[riddles.category] || riddles.category;
        }

        // BURBLE WORD GAME
        function initBurbleGame() {
            // Difficulty selectors
            document.querySelectorAll('#burble-page .selector-btn[data-difficulty]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#burble-page .selector-btn[data-difficulty]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    gameState.burble.difficulty = btn.dataset.difficulty;
                    setBurbleMaxAttempts();
                    updateBurbleDisplay();
                });
            });

            // Category selectors
            document.querySelectorAll('#burble-page .selector-btn[data-category]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#burble-page .selector-btn[data-category]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    gameState.burble.category = btn.dataset.category;
                    updateBurbleDisplay();
                });
            });

            // Game buttons
            document.getElementById('burble-new-game').addEventListener('click', startBurbleGame);
            document.getElementById('burble-submit').addEventListener('click', submitBurbleGuess);
            document.getElementById('burble-hint').addEventListener('click', getBurbleHint);

            // Input handling
            document.getElementById('burble-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && gameState.burble.gameActive) {
                    submitBurbleGuess();
                }
            });

            setBurbleMaxAttempts();
        }

        function setBurbleMaxAttempts() {
            switch (gameState.burble.difficulty) {
                case 'easy':
                    gameState.burble.maxAttempts = 15;
                    break;
                case 'medium':
                    gameState.burble.maxAttempts = 10;
                    break;
                case 'hard':
                    gameState.burble.maxAttempts = 5;
                    break;
            }
        }

        function startBurbleGame() {
            const burble = gameState.burble;
            // Reset game state
            trivia.currentQuestion = 0;
            trivia.correctAnswers = 0;
            trivia.score = 0;
            trivia.gameActive = true;
            trivia.selectedAnswer = null;

            // Ensure persistent pools exist
            if (!gameState.trivia.pools) gameState.trivia.pools = {};
            const key = `trivia|${trivia.difficulty}`;
            if (!gameState.trivia.pools[key] || gameState.trivia.pools[key].length === 0) {
                const allQuestions = triviaQuestions[trivia.difficulty] || [];
                gameState.trivia.pools[key] = shuffleArray(allQuestions);
            }

            // Take questions for this run (consume from pool)
            const take = Math.min(trivia.totalQuestions, gameState.trivia.pools[key].length);
            trivia.currentGameQuestions = gameState.trivia.pools[key].splice(0, take);
            savePoolsToStorage();
            trivia.totalQuestionsUsed = trivia.currentGameQuestions.length;

            // Start timer
            startTimer('trivia');

            // Play configured audio for Burble
            try { if (window.playModeAudio) window.playModeAudio('burble'); } catch (e) {}

            // Show first question
            showTriviaQuestion();
            // Enable inputs
            document.getElementById('burble-input').disabled = false;
            document.getElementById('burble-submit').disabled = false;
            document.getElementById('burble-hint').disabled = false;
            document.getElementById('burble-input').focus();
            
            updateBurbleDisplay();
            showFeedback('burble', 'Game started! Guess the word.', 'info');
        }

        function submitBurbleGuess() {
            if (!gameState.burble.gameActive) return;
            
            const guess = document.getElementById('burble-input').value.trim().toLowerCase();
            if (!guess) return;
            
            const burble = gameState.burble;
            burble.attempts++;
            
            if (guess === burble.currentWord) {
                handleBurbleWin();
            } else {
                handleBurbleIncorrect(guess);
            }
            
            document.getElementById('burble-input').value = '';
            updateBurbleDisplay();
        }

        function handleBurbleWin() {
            const burble = gameState.burble;
            burble.gameActive = false;
            stopTimer('burble');
            
            const elapsedTime = Math.floor((Date.now() - burble.startTime) / 1000);
            const timeBonus = Math.max(0, 300 - elapsedTime);
            const attemptBonus = Math.max(0, (burble.maxAttempts - burble.attempts) * 10);
            const hintPenalty = burble.hintsUsed * 25;
            burble.score = Math.max(0, 100 + timeBonus + attemptBonus - hintPenalty);
            
            addGameResult(true, burble.score);
            
            showFeedback('burble', `üéâ Correct! The word was "${burble.currentWord}"`, 'correct');
            
            document.getElementById('burble-game-over').innerHTML = `
                <div class="game-over win">
                    <h3>üéâ Congratulations!</h3>
                    <p>You guessed "${burble.currentWord}" correctly!</p>
                    <p><strong>Score:</strong> ${burble.score} points</p>
                    <p><strong>Time:</strong> ${formatTime(Math.floor((Date.now() - burble.startTime) / 1000))}</p>
                    <p><strong>Attempts:</strong> ${burble.attempts}/${burble.maxAttempts}</p>
                </div>
            `;
            
            disableBurbleInputs();
            // Stop audio for Burble
            try { if (window.audioControls && window.audioControls.stop) window.audioControls.stop(); } catch (e) {}
            try { const user = JSON.parse(localStorage.getItem('burbleUser') || 'null'); if (user && user.username) recordCorrect(user.username, 0); } catch (e) {}
        }

        function handleBurbleIncorrect(guess) {
            const burble = gameState.burble;
            const feedback = generateBurbleFeedback(guess, burble.currentWord);
            
            showFeedback('burble', `‚ùå "${guess}" is incorrect. ${feedback}`, 'incorrect');
            
            if (burble.attempts >= burble.maxAttempts) {
                burble.gameActive = false;
                stopTimer('burble');
                addGameResult(false, 0);
                // Stop audio for Burble
                try { if (window.audioControls && window.audioControls.stop) window.audioControls.stop(); } catch (e) {}
                
                document.getElementById('burble-game-over').innerHTML = `
                    <div class="game-over lose">
                        <h3>üòî Game Over</h3>
                        <p>The word was: <strong>"${burble.currentWord}"</strong></p>
                        <p>Category: ${burble.category}</p>
                        <p>Better luck next time!</p>
                    </div>
                `;
                
                disableBurbleInputs();
                try { const user = JSON.parse(localStorage.getItem('burbleUser') || 'null'); if (user && user.username) recordIncorrect(user.username); } catch (e) {}
            }
        }

        function generateBurbleFeedback(guess, targetWord) {
            if (guess.length !== targetWord.length) {
                return `Try a ${targetWord.length}-letter word.`;
            }
            
            let commonLetters = 0;
            for (let i = 0; i < Math.min(guess.length, targetWord.length); i++) {
                if (targetWord.includes(guess[i])) {
                    commonLetters++;
                }
            }
            
            if (commonLetters === 0) {
                return "No matching letters.";
            } else if (commonLetters === 1) {
                return "1 letter is in the word.";
            } else {
                return `${commonLetters} letters are in the word.`;
            }
        }

        function getBurbleHint() {
            if (!gameState.burble.gameActive) return;
            
            const burble = gameState.burble;
            burble.hintsUsed++;
            
            const hints = [
                `The word is ${burble.currentWord.length} letters long.`,
                `The word is in the ${burble.category} category.`,
                `The word starts with "${burble.currentWord[0]}".`,
                `The word ends with "${burble.currentWord[burble.currentWord.length - 1]}".`,
                `The second letter is "${burble.currentWord[1]}".`
            ];
            
            const hintIndex = Math.min(burble.hintsUsed - 1, hints.length - 1);
            showFeedback('burble', `üí° Hint ${burble.hintsUsed}: ${hints[hintIndex]} (-25 points)`, 'hint');
            
            updateBurbleDisplay();
        }

        function updateBurbleDisplay() {
            const burble = gameState.burble;
            
            document.getElementById('burble-attempts').textContent = `${burble.attempts}/${burble.maxAttempts}`;
            document.getElementById('burble-category').textContent = burble.category;
            document.getElementById('burble-score').textContent = burble.score;
            
            if (burble.currentWord && burble.gameActive) {
                document.getElementById('burble-display').textContent = '_ '.repeat(burble.currentWord.length).trim();
            } else if (burble.currentWord && !burble.gameActive) {
                document.getElementById('burble-display').textContent = burble.currentWord.toUpperCase();
            } else {
                document.getElementById('burble-display').textContent = 'Click "New Game" to start!';
            }
        }

        function disableBurbleInputs() {
            document.getElementById('burble-input').disabled = true;
            document.getElementById('burble-submit').disabled = true;
            document.getElementById('burble-hint').disabled = true;
        }

        // EMOJI GUESS GAME
        function initEmojiGame() {
            // Difficulty selectors
            document.querySelectorAll('#emoji-page .selector-btn[data-difficulty]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#emoji-page .selector-btn[data-difficulty]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    gameState.emoji.difficulty = btn.dataset.difficulty;
                    updateEmojiDisplay();
                });
            });

            // Category selectors
            document.querySelectorAll('#emoji-page .selector-btn[data-category]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#emoji-page .selector-btn[data-category]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    gameState.emoji.category = btn.dataset.category;
                    updateEmojiDisplay();
                });
            });

            // Game buttons
            document.getElementById('emoji-new-puzzle').addEventListener('click', startEmojiGame);
            document.getElementById('emoji-submit').addEventListener('click', submitEmojiAnswer);
            document.getElementById('emoji-hint').addEventListener('click', getEmojiHint);

            // Input handling
            document.getElementById('emoji-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && gameState.emoji.gameActive) {
                    submitEmojiAnswer();
                }
            });
        }

        function startEmojiGame() {
            const emoji = gameState.emoji;
            
            // Get available puzzles
            let availablePuzzles = [];
            if (emoji.category === 'all') {
                Object.values(emojiPuzzles).forEach(puzzles => {
                    availablePuzzles.push(...puzzles);
                });
            } else {
                availablePuzzles = emojiPuzzles[emoji.category] || [];
            }
            
            if (availablePuzzles.length === 0) {
                showFeedback('emoji', 'No puzzles available for this category!', 'incorrect');
                return;
            }
            
            // Select random puzzle
            emoji.currentPuzzle = availablePuzzles[Math.floor(Math.random() * availablePuzzles.length)];
            emoji.gameActive = true;
            emoji.hintsUsed = 0;
            
            // Enable inputs
            document.getElementById('emoji-input').disabled = false;
            document.getElementById('emoji-submit').disabled = false;
            document.getElementById('emoji-hint').disabled = false;
            document.getElementById('emoji-input').focus();
            
            updateEmojiDisplay();
            showFeedback('emoji', 'New puzzle! What does this emoji combination represent?', 'info');
            // Play configured audio for Emoji
            try { if (window.playModeAudio) window.playModeAudio('emoji'); } catch (e) {}
        }

        function submitEmojiAnswer() {
            if (!gameState.emoji.gameActive) return;
            
            const answer = document.getElementById('emoji-input').value.trim();
            if (!answer) return;
            
            const emoji = gameState.emoji;
            const correctAnswer = emoji.currentPuzzle.answer.toLowerCase();
            const userAnswer = answer.toLowerCase();
            
            if (userAnswer === correctAnswer || correctAnswer.includes(userAnswer) || userAnswer.includes(correctAnswer)) {
                handleEmojiWin();
            } else {
                handleEmojiIncorrect();
            }
            
            document.getElementById('emoji-input').value = '';
        }

        function handleEmojiWin() {
            const emoji = gameState.emoji;
            emoji.gameActive = false;
            
            const baseScore = 100;
            const hintPenalty = emoji.hintsUsed * 5;
            const difficultyBonus = emoji.difficulty === 'hard' ? 50 : emoji.difficulty === 'medium' ? 25 : 0;
            emoji.score += Math.max(10, baseScore - hintPenalty + difficultyBonus);
            
            addGameResult(true, baseScore - hintPenalty + difficultyBonus);
            
            showFeedback('emoji', `üéâ Correct! The answer was "${emoji.currentPuzzle.answer}"`, 'correct');
            
            document.getElementById('emoji-game-over').innerHTML = `
                <div class="game-over win">
                    <h3>üéâ Excellent!</h3>
                    <p>You solved: ${emoji.currentPuzzle.emoji}</p>
                    <p><strong>Answer:</strong> ${emoji.currentPuzzle.answer}</p>
                    <p><strong>Score:</strong> ${baseScore - (emoji.hintsUsed * 5) + difficultyBonus} points</p>
                    <p><strong>Hints used:</strong> ${emoji.hintsUsed}</p>
                </div>
            `;
            
            disableEmojiInputs();
            updateEmojiDisplay();
            try { if (window.audioControls && window.audioControls.stop) window.audioControls.stop(); } catch (e) {}
            try { const user = JSON.parse(localStorage.getItem('burbleUser') || 'null'); if (user && user.username) recordCorrect(user.username, 0); } catch (e) {}
        }

        function handleEmojiIncorrect() {
            showFeedback('emoji', '‚ùå Incorrect! Try again or get a hint.', 'incorrect');
            try { const user = JSON.parse(localStorage.getItem('burbleUser') || 'null'); if (user && user.username) recordIncorrect(user.username); } catch (e) {}
        }

        function getEmojiHint() {
            if (!gameState.emoji.gameActive) return;
            
            const emoji = gameState.emoji;
            emoji.hintsUsed++;
            
            showFeedback('emoji', `üí° Hint: ${emoji.currentPuzzle.hint} (-5 points)`, 'hint');
            updateEmojiDisplay();
        }

        function updateEmojiDisplay() {
            const emoji = gameState.emoji;
            
            document.getElementById('emoji-score').textContent = emoji.score;
            document.getElementById('emoji-hints').textContent = emoji.hintsUsed;
            document.getElementById('emoji-category').textContent = emoji.category.charAt(0).toUpperCase() + emoji.category.slice(1);
            document.getElementById('emoji-difficulty').textContent = emoji.difficulty.charAt(0).toUpperCase() + emoji.difficulty.slice(1);
            
            if (emoji.currentPuzzle && emoji.gameActive) {
                document.getElementById('emoji-display').textContent = emoji.currentPuzzle.emoji;
            } else if (emoji.currentPuzzle && !emoji.gameActive) {
                document.getElementById('emoji-display').textContent = emoji.currentPuzzle.emoji;
            } else {
                document.getElementById('emoji-display').textContent = 'Click "New Puzzle" to start!';
            }
        }

        function disableEmojiInputs() {
            document.getElementById('emoji-input').disabled = true;
            document.getElementById('emoji-submit').disabled = true;
            document.getElementById('emoji-hint').disabled = true;
        }

        // TWENTY QUESTIONS GAME
        function initValentineGame() {
            // Difficulty selectors
            document.querySelectorAll('#valentine-page .selector-btn[data-difficulty]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#valentine-page .selector-btn[data-difficulty]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    gameState.valentine.difficulty = btn.dataset.difficulty;
                    setValentineQuestions();
                    updateValentineDisplay();
                });
            });

            // Category selectors
            document.querySelectorAll('#valentine-page .selector-btn[data-category]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#valentine-page .selector-btn[data-category]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    gameState.valentine.category = btn.dataset.category;
                    updateValentineDisplay();
                });
            });

            // Game buttons
            document.getElementById('valentine-new-game').addEventListener('click', startValentineGame);
            document.getElementById('valentine-ask').addEventListener('click', askValentineQuestion);
            document.getElementById('valentine-guess').addEventListener('click', makeValentineGuess);

            // Input handling
            document.getElementById('valentine-question').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && gameState.valentine.gameActive) {
                    askValentineQuestion();
                }
            });

            setValentineQuestions();
        }

        function setValentineQuestions() {
            switch (gameState.valentine.difficulty) {
                case 'easy':
                    gameState.valentine.questionsLeft = 8;
                    break;
                case 'medium':
                    gameState.valentine.questionsLeft = 6;
                    break;
                case 'hard':
                    gameState.valentine.questionsLeft = 4;
                    break;
            }
        }

        function startValentineGame() {
            const valentine = gameState.valentine;
            
            // Reset game state
            valentine.questions = [];
            valentine.answers = [];
            valentine.guessesLeft = 3;
            valentine.gameActive = true;
            valentine.score = 0;
            setValentineQuestions();
            
            // Select random answer
            const categoryAnswers = valentineAnswers[valentine.category];
            valentine.currentAnswer = categoryAnswers[Math.floor(Math.random() * categoryAnswers.length)].answer;
            
            // Enable inputs
            document.getElementById('valentine-question').disabled = false;
            document.getElementById('valentine-ask').disabled = false;
            document.getElementById('valentine-guess').disabled = false;
            document.getElementById('valentine-question').focus();
            
            // Clear history
            document.getElementById('valentine-history').innerHTML = '<p class="muted-center">Ask yes/no questions to figure out what I\'m thinking of!</p>';
            
            updateValentineDisplay();
            showFeedback('valentine', `I'm thinking of something in the ${valentine.category} category. Ask yes/no questions!`, 'info');
            // Play configured audio for Valentine (Twenty Questions)
            try { if (window.playModeAudio) window.playModeAudio('valentine'); } catch (e) {}
        }

        function askValentineQuestion() {
            if (!gameState.valentine.gameActive) return;
            
            const question = document.getElementById('valentine-question').value.trim();
            if (!question) return;
            
            const valentine = gameState.valentine;
            valentine.questionsLeft--;
            valentine.questions.push(question);
            
            // Generate AI-like response
            const answer = generateValentineAnswer(question, valentine.currentAnswer);
            valentine.answers.push(answer);
            
            // Update history
            updateValentineHistory();
            
            document.getElementById('valentine-question').value = '';
            updateValentineDisplay();
            
            if (valentine.questionsLeft === 0) {
                showFeedback('valentine', 'No more questions! You must make a guess now.', 'hint');
                document.getElementById('valentine-ask').disabled = true;
                document.getElementById('valentine-question').disabled = true;
            }
        }

        function generateValentineAnswer(question, answer) {
            const q = question.toLowerCase();
            const a = answer.toLowerCase();
            
            // Simple keyword matching for basic responses
            if (q.includes('alive') || q.includes('living')) {
                return gameState.valentine.category === 'animals' ? 'Yes' : 'No';
            }
            if (q.includes('animal')) {
                return gameState.valentine.category === 'animals' ? 'Yes' : 'No';
            }
            if (q.includes('place') || q.includes('location')) {
                return gameState.valentine.category === 'places' ? 'Yes' : 'No';
            }
            if (q.includes('movie') || q.includes('film')) {
                return gameState.valentine.category === 'movies' ? 'Yes' : 'No';
            }
            if (q.includes('object') || q.includes('thing')) {
                return gameState.valentine.category === 'objects' ? 'Yes' : 'No';
            }
            if (q.includes('big') || q.includes('large')) {
                return ['elephant', 'giraffe', 'whale', 'titanic', 'avatar'].some(word => a.includes(word)) ? 'Yes' : 'No';
            }
            if (q.includes('small')) {
                return ['phone', 'key', 'watch'].some(word => a.includes(word)) ? 'Yes' : 'No';
            }
            if (q.includes('water')) {
                return ['dolphin', 'titanic', 'sydney', 'paris'].some(word => a.includes(word)) ? 'Yes' : 'No';
            }
            if (q.includes('fly') || q.includes('flight')) {
                return ['penguin', 'avatar'].some(word => a.includes(word)) ? 'Yes' : 'No';
            }
            
            // Random yes/no for other questions
            return Math.random() > 0.5 ? 'Yes' : 'No';
        }

        function makeValentineGuess() {
            if (!gameState.valentine.gameActive) return;
            
            const guess = prompt('What do you think I\'m thinking of?');
            if (!guess) return;
            
            const valentine = gameState.valentine;
            valentine.guessesLeft--;
            
            if (guess.toLowerCase() === valentine.currentAnswer.toLowerCase()) {
                handleValentineWin();
            } else {
                if (valentine.guessesLeft === 0) {
                    handleValentineLose();
                } else {
                    showFeedback('valentine', `‚ùå Not quite! You have ${valentine.guessesLeft} guess(es) left.`, 'incorrect');
                    updateValentineDisplay();
                }
            }
        }

        function handleValentineWin() {
            const valentine = gameState.valentine;
            valentine.gameActive = false;
            
            const baseScore = 100;
            const questionBonus = valentine.questionsLeft * 10;
            const guessBonus = valentine.guessesLeft * 20;
            valentine.score = baseScore + questionBonus + guessBonus;
            
            addGameResult(true, valentine.score);
            
            showFeedback('valentine', `üéâ Correct! I was thinking of "${valentine.currentAnswer}"`, 'correct');
            
            document.getElementById('valentine-game-over').innerHTML = `
                <div class="game-over win">
                    <h3>üéâ Amazing!</h3>
                    <p>You guessed "${valentine.currentAnswer}" correctly!</p>
                    <p><strong>Score:</strong> ${valentine.score} points</p>
                    <p><strong>Questions used:</strong> ${valentine.questions.length}</p>
                    <p><strong>Guesses remaining:</strong> ${valentine.guessesLeft}</p>
                </div>
            `;
            
            disableValentineInputs();
            try { if (window.audioControls && window.audioControls.stop) window.audioControls.stop(); } catch (e) {}
            try { const user = JSON.parse(localStorage.getItem('burbleUser') || 'null'); if (user && user.username) recordCorrect(user.username, 0); } catch (e) {}
        }

        function handleValentineLose() {
            const valentine = gameState.valentine;
            valentine.gameActive = false;
            
            addGameResult(false, 0);
            
            showFeedback('valentine', `üòî The answer was "${valentine.currentAnswer}". Better luck next time!`, 'incorrect');
            
            document.getElementById('valentine-game-over').innerHTML = `

                <div class="game-over lose">
                    <h3>üòî Game Over</h3>
                    <p>I was thinking of: <strong>"${valentine.currentAnswer}"</strong></p>
                    <p>Category: ${valentine.category}</p>
                    <p>You asked ${valentine.questions.length} questions</p>
                </div>
            `;
            
            disableValentineInputs();
            try { if (window.audioControls && window.audioControls.stop) window.audioControls.stop(); } catch (e) {}
            try { const user = JSON.parse(localStorage.getItem('burbleUser') || 'null'); if (user && user.username) recordIncorrect(user.username); } catch (e) {}
        }

        function updateValentineHistory() {
            const valentine = gameState.valentine;
            const history = document.getElementById('valentine-history');
            
            let historyHTML = '';
            for (let i = 0; i < valentine.questions.length; i++) {
                historyHTML += `
                    <div class="question-item">
                        <div class="question-text">Q: ${valentine.questions[i]}</div>
                        <div class="answer-text">A: ${valentine.answers[i]}</div>
                    </div>
                `;
            }
            
            history.innerHTML = historyHTML || '<p class="muted-center">Ask yes/no questions to figure out what I\'m thinking of!</p>';
        }

        function updateValentineDisplay() {
            const valentine = gameState.valentine;
            
            document.getElementById('valentine-questions').textContent = valentine.questionsLeft;
            document.getElementById('valentine-guesses').textContent = valentine.guessesLeft;
            document.getElementById('valentine-category').textContent = valentine.category.charAt(0).toUpperCase() + valentine.category.slice(1);
            document.getElementById('valentine-score').textContent = valentine.score;
        }

        function disableValentineInputs() {
            document.getElementById('valentine-question').disabled = true;
            document.getElementById('valentine-ask').disabled = true;
            document.getElementById('valentine-guess').disabled = true;
        }

        // TRIVIA GAME
        function initTriviaGame() {
            // Difficulty selectors
            document.querySelectorAll('#trivia-page .selector-btn[data-difficulty]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#trivia-page .selector-btn[data-difficulty]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    gameState.trivia.difficulty = btn.dataset.difficulty;
                });
            });

            // Game buttons
            document.getElementById('trivia-start').addEventListener('click', startTriviaGame);
            document.getElementById('trivia-submit').addEventListener('click', submitTriviaAnswer);
            document.getElementById('trivia-next').addEventListener('click', nextTriviaQuestion);
        }

        function startTriviaGame() {
            const trivia = gameState.trivia;
            // Reset game state
            animalTrivia.currentQuestion = 0;
            animalTrivia.correctAnswers = 0;
            animalTrivia.score = 0;
            animalTrivia.gameActive = true;
            animalTrivia.selectedAnswer = null;

            // Ensure persistent pools exist
            if (!gameState.animalTrivia.pools) gameState.animalTrivia.pools = {};
            const key = `animal|${animalTrivia.difficulty}`;
            if (!gameState.animalTrivia.pools[key] || gameState.animalTrivia.pools[key].length === 0) {
                const allQuestions = animalTriviaQuestions[animalTrivia.difficulty] || [];
                gameState.animalTrivia.pools[key] = shuffleArray(allQuestions);
            }

            // Take questions for this run (consume from pool)
            const take = Math.min(animalTrivia.totalQuestions, gameState.animalTrivia.pools[key].length);
            animalTrivia.currentGameQuestions = gameState.animalTrivia.pools[key].splice(0, take);
            animalTrivia.totalQuestionsUsed = animalTrivia.currentGameQuestions.length;

            // Start timer
            startTimer('animalTrivia');

            // Play configured audio for Trivia
            try { if (window.playModeAudio) window.playModeAudio('trivia'); } catch (e) {}

            // Show first question
            showAnimalTriviaQuestion();

            // Update buttons
            document.getElementById('animal-start').disabled = true;
            document.getElementById('animal-submit').disabled = false;

            updateAnimalTriviaDisplay();
        }

        function showTriviaQuestion() {
            const trivia = gameState.trivia;
            const questions = trivia.currentGameQuestions || [];

            if (trivia.currentQuestion >= trivia.totalQuestionsUsed || trivia.currentQuestion >= questions.length) {
                endTriviaGame();
                return;
            }

            const question = questions[trivia.currentQuestion];
            
            document.getElementById('trivia-question-text').textContent = question.question;
            
            const optionsContainer = document.getElementById('trivia-options');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'trivia-option';
                optionDiv.textContent = option;
                optionDiv.onclick = () => selectTriviaOption(index, optionDiv);
                optionsContainer.appendChild(optionDiv);
            });
            
            trivia.selectedAnswer = null;
            document.getElementById('trivia-submit').disabled = false;
            document.getElementById('trivia-next').disabled = true;
            // record question start time
            trivia.questionStart = Date.now();
        }

        function selectTriviaOption(index, element) {
            // Remove previous selection
            document.querySelectorAll('#trivia-options .trivia-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Select new option
            element.classList.add('selected');
            gameState.trivia.selectedAnswer = index;
        }

        function submitTriviaAnswer() {
            if (gameState.trivia.selectedAnswer === null) return;
            
            const trivia = gameState.trivia;
            const questions = trivia.currentGameQuestions || [];
            const question = questions[trivia.currentQuestion];
            const isCorrect = trivia.selectedAnswer === question.correct;
            
            // Show correct/incorrect styling
            const options = document.querySelectorAll('#trivia-options .trivia-option');
            options.forEach((opt, index) => {
                if (index === question.correct) {
                    opt.classList.add('correct');
                } else if (index === trivia.selectedAnswer && !isCorrect) {
                    opt.classList.add('incorrect');
                }
                opt.onclick = null; // Disable clicking
            });
            
            if (isCorrect) {
                trivia.correctAnswers++;
                trivia.score += trivia.difficulty === 'hard' ? 15 : trivia.difficulty === 'medium' ? 10 : 5;
                showFeedback('trivia', '‚úÖ Correct!', 'correct');
                try {
                    const user = JSON.parse(localStorage.getItem('burbleUser') || 'null');
                    const time = trivia.questionStart ? ((Date.now() - trivia.questionStart) / 1000) : 0;
                    if (user && user.username) recordCorrect(user.username, time);
                } catch (e) {}
            } else {
                showFeedback('trivia', `‚ùå Incorrect. The correct answer was: ${question.options[question.correct]}`, 'incorrect');
                try { const user = JSON.parse(localStorage.getItem('burbleUser') || 'null'); if (user && user.username) recordIncorrect(user.username); } catch (e) {}
            }
            
            trivia.currentQuestion++;
            
            document.getElementById('trivia-submit').disabled = true;
            document.getElementById('trivia-next').disabled = false;
            
            updateTriviaDisplay();
        }

        function nextTriviaQuestion() {
            if (gameState.trivia.currentQuestion >= gameState.trivia.totalQuestions) {
                endTriviaGame();
            } else {
                showTriviaQuestion();
                document.getElementById('trivia-feedback').innerHTML = '';
            }
        }

        function endTriviaGame() {
            const trivia = gameState.trivia;
            trivia.gameActive = false;
            stopTimer('trivia');

            // Stop configured audio
            try { if (window.audioControls && window.audioControls.stop) window.audioControls.stop(); } catch (e) {}
            
            const percentage = Math.round((trivia.correctAnswers / trivia.totalQuestions) * 100);
            const won = percentage >= 70;
            
            addGameResult(won, trivia.score);
            
            document.getElementById('trivia-question-text').textContent = 'Quiz Complete!';
            document.getElementById('trivia-options').innerHTML = '';
            
            document.getElementById('trivia-game-over').innerHTML = `
                <div class="game-over ${won ? 'win' : 'lose'}">
                    <h3>${won ? 'üéâ Great Job!' : 'üìö Keep Studying!'}</h3>
                    <p><strong>Score:</strong> ${trivia.score} points</p>
                    <p><strong>Correct:</strong> ${trivia.correctAnswers}/${trivia.totalQuestions} (${percentage}%)</p>
                    <p><strong>Time:</strong> ${document.getElementById('trivia-timer').textContent}</p>
                    ${won ? '<p>Excellent knowledge!</p>' : '<p>Try again to improve your score!</p>'}
                </div>
            `;
            
            document.getElementById('trivia-start').disabled = false;
            document.getElementById('trivia-submit').disabled = true;
            document.getElementById('trivia-next').disabled = true;
        }

        function updateTriviaDisplay() {
            const trivia = gameState.trivia;

            const total = trivia.totalQuestionsUsed || Math.min(trivia.totalQuestions, (trivia.pool || []).length || 0);
            document.getElementById('trivia-question-num').textContent = `${trivia.currentQuestion}/${total}`;
            document.getElementById('trivia-correct').textContent = trivia.correctAnswers;
            document.getElementById('trivia-score').textContent = trivia.score;
        }

        // ANIMAL TRIVIA GAME
        function initAnimalTriviaGame() {
            // Difficulty selectors
            document.querySelectorAll('#animal-trivia-page .selector-btn[data-difficulty]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#animal-trivia-page .selector-btn[data-difficulty]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });

            // Game buttons
            document.getElementById('animal-start').addEventListener('click', startAnimalTriviaGame);
            document.getElementById('animal-submit').addEventListener('click', submitAnimalTriviaAnswer);
            document.getElementById('animal-next').addEventListener('click', nextAnimalTriviaQuestion);
        }

        function startAnimalTriviaGame() {
            const animalTrivia = gameState.animalTrivia;

            // Reset game state
            animalTrivia.currentQuestion = 0;
            animalTrivia.correctAnswers = 0;
            animalTrivia.score = 0;
            animalTrivia.gameActive = true;
            animalTrivia.selectedAnswer = null;

            // Always clear and reshuffle the pool for a fresh game
            if (!gameState.animalTrivia.pools) gameState.animalTrivia.pools = {};
            const key = `animal|${animalTrivia.difficulty}`;
            const allQuestions = animalTriviaQuestions[animalTrivia.difficulty] || [];
            gameState.animalTrivia.pools[key] = shuffleArray(allQuestions);
            savePoolsToStorage();

            // Take questions for this run (consume from pool)
            const take = Math.min(animalTrivia.totalQuestions, gameState.animalTrivia.pools[key].length);
            animalTrivia.currentGameQuestions = gameState.animalTrivia.pools[key].splice(0, take);
            animalTrivia.totalQuestionsUsed = animalTrivia.currentGameQuestions.length;

            // Start timer
            startTimer('animalTrivia');

            // Play configured audio for Animal Trivia
            try { if (window.playModeAudio) window.playModeAudio('animal'); } catch (e) {}

            // Show first question
            showAnimalTriviaQuestion();

            // Update buttons
            document.getElementById('animal-start').disabled = true;
            document.getElementById('animal-submit').disabled = false;

            updateAnimalTriviaDisplay();
        }

        function showAnimalTriviaQuestion() {
            const animalTrivia = gameState.animalTrivia;
            const questions = animalTrivia.currentGameQuestions || [];

            if (animalTrivia.currentQuestion >= (animalTrivia.totalQuestionsUsed || questions.length) || animalTrivia.currentQuestion >= questions.length) {
                endAnimalTriviaGame();
                return;
            }

            const question = questions[animalTrivia.currentQuestion];
            
            document.getElementById('animal-question-text').textContent = question.question;
            
            const optionsContainer = document.getElementById('animal-options');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'trivia-option';
                optionDiv.textContent = option;
                optionDiv.onclick = () => selectAnimalTriviaOption(index, optionDiv);
                optionsContainer.appendChild(optionDiv);
            });
            
            animalTrivia.selectedAnswer = null;
            document.getElementById('animal-submit').disabled = false;
            document.getElementById('animal-next').disabled = true;
        }

        function selectAnimalTriviaOption(index, element) {
            // Remove previous selection
            document.querySelectorAll('#animal-options .trivia-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Select new option
            element.classList.add('selected');
            gameState.animalTrivia.selectedAnswer = index;
        }

        function submitAnimalTriviaAnswer() {
            if (gameState.animalTrivia.selectedAnswer === null) return;
            const animalTrivia = gameState.animalTrivia;
            const questions = animalTrivia.currentGameQuestions || [];
            const question = questions[animalTrivia.currentQuestion];
            const isCorrect = animalTrivia.selectedAnswer === question.correct;
            
            // Show correct/incorrect styling
            const options = document.querySelectorAll('#animal-options .trivia-option');
            options.forEach((opt, index) => {
                if (index === question.correct) {
                    opt.classList.add('correct');
                } else if (index === animalTrivia.selectedAnswer && !isCorrect) {
                    opt.classList.add('incorrect');
                }
                opt.onclick = null; // Disable clicking
            });
            
            if (isCorrect) {
                animalTrivia.correctAnswers++;
                animalTrivia.score += animalTrivia.difficulty === 'hard' ? 15 : animalTrivia.difficulty === 'medium' ? 10 : 5;
                showFeedback('animal', '‚úÖ Correct!', 'correct');
                try { const user = JSON.parse(localStorage.getItem('burbleUser') || 'null'); if (user && user.username) recordCorrect(user.username, 0); } catch (e) {}
            } else {
                showFeedback('animal', `‚ùå Incorrect. The correct answer was: ${question.options[question.correct]}`, 'incorrect');
                try { const user = JSON.parse(localStorage.getItem('burbleUser') || 'null'); if (user && user.username) recordIncorrect(user.username); } catch (e) {}
            }
            
            animalTrivia.currentQuestion++;
            
            document.getElementById('animal-submit').disabled = true;
            document.getElementById('animal-next').disabled = false;
            
            updateAnimalTriviaDisplay();
        }

        function nextAnimalTriviaQuestion() {
            if (gameState.animalTrivia.currentQuestion >= (gameState.animalTrivia.totalQuestionsUsed || gameState.animalTrivia.totalQuestions)) {
                endAnimalTriviaGame();
            } else {
                showAnimalTriviaQuestion();
                document.getElementById('animal-feedback').innerHTML = '';
            }
        }

        function endAnimalTriviaGame() {
            const animalTrivia = gameState.animalTrivia;
            animalTrivia.gameActive = false;
            stopTimer('animalTrivia');

            // Stop configured audio for Animal Trivia
            try { if (window.audioControls && window.audioControls.stop) window.audioControls.stop(); } catch (e) {}

            const totalUsed = animalTrivia.totalQuestionsUsed || animalTrivia.totalQuestions || 0;
            const percentage = totalUsed > 0 ? Math.round((animalTrivia.correctAnswers / totalUsed) * 100) : 0;
            const won = percentage >= 70;

            addGameResult(won, animalTrivia.score);

            document.getElementById('animal-question-text').textContent = 'Quiz Complete!';
            document.getElementById('animal-options').innerHTML = '';

            document.getElementById('animal-game-over').innerHTML = `
                <div class="game-over ${won ? 'win' : 'lose'}">
                    <h3>${won ? 'ü¶Å Animal Expert!' : 'üêæ Keep Learning!'}</h3>
                    <p><strong>Score:</strong> ${animalTrivia.score} points</p>
                    <p><strong>Correct:</strong> ${animalTrivia.correctAnswers}/${totalUsed} (${percentage}%)</p>
                    <p><strong>Time:</strong> ${document.getElementById('animal-timer').textContent}</p>
                    ${won ? '<p>You know your animals!</p>' : '<p>Study more about animals and try again!</p>'}
                </div>
            `;

            document.getElementById('animal-start').disabled = false;
            document.getElementById('animal-submit').disabled = true;
            document.getElementById('animal-next').disabled = true;
        }

        function updateAnimalTriviaDisplay() {
            const animalTrivia = gameState.animalTrivia;
            const total = animalTrivia.totalQuestionsUsed || animalTrivia.totalQuestions || 0;
            document.getElementById('animal-question-num').textContent = `${animalTrivia.currentQuestion}/${total}`;
            document.getElementById('animal-correct').textContent = animalTrivia.correctAnswers;
            document.getElementById('animal-score').textContent = animalTrivia.score;
        }

        // Add a button to reset the animal trivia pool
        window.addEventListener('DOMContentLoaded', () => {
            loadUserStats();
            initRiddlesGame();
            initBurbleGame();
            initEmojiGame();
            initValentineGame();
            initTriviaGame();
            initAnimalTriviaGame();
            updateUserStats();
            initAuthAndLeaderboard();

            // Add reset button to animal trivia page
            const animalPage = document.getElementById('animal-trivia-page');
            if (animalPage && !document.getElementById('reset-animal-pool')) {
                const resetBtn = document.createElement('button');
                resetBtn.id = 'reset-animal-pool';
                resetBtn.textContent = 'Reset Animal Trivia Pool';
                resetBtn.className = 'nav-btn';
                resetBtn.style.margin = '12px 0';
                resetBtn.onclick = () => {
                    if (confirm('Reset the animal trivia question pool? This will reshuffle and use all available questions.')) {
                        if (gameState.animalTrivia && gameState.animalTrivia.pools) {
                            const key = `animal|${gameState.animalTrivia.difficulty}`;
                            const allQuestions = animalTriviaQuestions[gameState.animalTrivia.difficulty] || [];
                            gameState.animalTrivia.pools[key] = shuffleArray(allQuestions);
                            savePoolsToStorage();
                            alert('Animal trivia pool reset! Start a new game to see changes.');
                        }
                    }
                };
                animalPage.insertBefore(resetBtn, animalPage.firstChild);
            }
        });

        // --- Simple client-side auth & leaderboard ---
        function sanitizeUsername(name) {
            return name.replace(/[^a-zA-Z0-9_\- ]/g, '').trim().slice(0, 30);
        }

        function isProfane(name) {
            if (!name) return false;
            const blocked = ['fuck','
            initEmojiGame();
            initValentineGame();
            initTriviaGame();
            initAnimalTriviaGame();
            updateUserStats();
            initAuthAndLeaderboard();

            // Add reset button to animal trivia page
            const animalPage = document.getElementById('animal-trivia-page');
            if (animalPage && !document.getElementById('reset-animal-pool')) {
                const resetBtn = document.createElement('button');
                resetBtn.id = 'reset-animal-pool';
                resetBtn.textContent = 'Reset Animal Trivia Pool';
                resetBtn.className = 'nav-btn';
                resetBtn.style.margin = '12px 0';
                resetBtn.onclick = () => {
                    if (confirm('Reset the animal trivia question pool? This will reshuffle and use all available questions.')) {
                        if (gameState.animalTrivia && gameState.animalTrivia.pools) {
                            const key = `animal|${gameState.animalTrivia.difficulty}`;
                            const allQuestions = animalTriviaQuestions[gameState.animalTrivia.difficulty] || [];
                            gameState.animalTrivia.pools[key] = shuffleArray(allQuestions);
                            savePoolsToStorage();
                            alert('Animal trivia pool reset! Start a new game to see changes.');
                        }
                    }
                };
                animalPage.insertBefore(resetBtn, animalPage.firstChild);
            }
        });

        // --- Simple client-side auth & leaderboard ---
        function sanitizeUsername(name) {
            return name.replace(/[^a-zA-Z0-9_\- ]/g, '').trim().slice(0, 30);
        }

        function isProfane(name) {
            if (!name) return false;
            const blocked = ['fuck','
                    <p><strong>Hints used:</strong> ${emoji.hintsUsed}</p>
                </div>
            `;
            
            disableEmojiInputs();
            updateEmojiDisplay();
            try { if (window.audioControls && window.audioControls.stop) window.audioControls.stop(); } catch (e) {}
            try { const user = JSON.parse(localStorage.getItem('burbleUser') || 'null'); if (user && user.username) recordCorrect(user.username, 0); } catch (e) {}
        }

        function handleEmojiIncorrect() {
            showFeedback('emoji', '‚ùå Incorrect! Try again or get a hint.', 'incorrect');
            try { const user = JSON.parse(localStorage.getItem('burbleUser') || 'null'); if (user && user.username) recordIncorrect(user.username); } catch (e) {}
        }

        function getEmojiHint() {
            if (!gameState.emoji.gameActive) return;
            
            const emoji = gameState.emoji;
            emoji.hintsUsed++;
            
            showFeedback('emoji', `üí° Hint: ${emoji.currentPuzzle.hint} (-5 points)`, 'hint');
            updateEmojiDisplay();
        }

        function updateEmojiDisplay() {
            const emoji = gameState.emoji;
            
            document.getElementById('emoji-score').textContent = emoji.score;
            document.getElementById('emoji-hints').textContent = emoji.hintsUsed;
            document.getElementById('emoji-category').textContent = emoji.category.charAt(0).toUpperCase() + emoji.category.slice(1);
            document.getElementById('emoji-difficulty').textContent = emoji.difficulty.charAt(0).toUpperCase() + emoji.difficulty.slice(1);
            
            if (emoji.currentPuzzle && emoji.gameActive) {
                document.getElementById('emoji-display').textContent = emoji.currentPuzzle.emoji;
            } else if (emoji.currentPuzzle && !emoji.gameActive) {
                document.getElementById('emoji-display').textContent = emoji.currentPuzzle.emoji;
            } else {
                document.getElementById('emoji-display').textContent = 'Click "New Puzzle" to start!';
            }
        }

        function disableEmojiInputs() {
            document.getElementById('emoji-input').disabled = true;
            document.getElementById('emoji-submit').disabled = true;
            document.getElementById('emoji-hint').disabled = true;
        }

        // TWENTY QUESTIONS GAME
        function initValentineGame() {
            // Difficulty selectors
            document.querySelectorAll('#valentine-page .selector-btn[data-difficulty]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#valentine-page .selector-btn[data-difficulty]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    gameState.valentine.difficulty = btn.dataset.difficulty;
                    setValentineQuestions();
                    updateValentineDisplay();
                });
            });

            // Category selectors
            document.querySelectorAll('#valentine-page .selector-btn[data-category]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#valentine-page .selector-btn[data-category]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    gameState.valentine.category = btn.dataset.category;
                    updateValentineDisplay();
                });
            });

            // Game buttons
            document.getElementById('valentine-new-game').addEventListener('click', startValentineGame);
            document.getElementById('valentine-ask').addEventListener('click', askValentineQuestion);
            document.getElementById('valentine-guess').addEventListener('click', makeValentineGuess);

            // Input handling
            document.getElementById('valentine-question').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && gameState.valentine.gameActive) {
                    askValentineQuestion();
                }
            });

            setValentineQuestions();
        }

        function setValentineQuestions() {
            switch (gameState.valentine.difficulty) {
                case 'easy':
                    gameState.valentine.questionsLeft = 8;
                    break;
                case 'medium':
                    gameState.valentine.questionsLeft = 6;
                    break;
                case 'hard':
                    gameState.valentine.questionsLeft = 4;
                    break;
            }
        }

        function startValentineGame() {
            const valentine = gameState.valentine;
            
            // Reset game state
            valentine.questions = [];
            valentine.answers = [];
            valentine.guessesLeft = 3;
            valentine.gameActive = true;
            valentine.score = 0;
            setValentineQuestions();
            
            // Select random answer
            const categoryAnswers = valentineAnswers[valentine.category];
            valentine.currentAnswer = categoryAnswers[Math.floor(Math.random() * categoryAnswers.length)].answer;
            
            // Enable inputs
            document.getElementById('valentine-question').disabled = false;
            document.getElementById('valentine-ask').disabled = false;
            document.getElementById('valentine-guess').disabled = false;
            document.getElementById('valentine-question').focus();
            
            // Clear history
            document.getElementById('valentine-history').innerHTML = '<p class="muted-center">Ask yes/no questions to figure out what I\'m thinking of!</p>';
            
            updateValentineDisplay();
            showFeedback('valentine', `I'm thinking of something in the ${valentine.category} category. Ask yes/no questions!`, 'info');
            // Play configured audio for Valentine (Twenty Questions)
            try { if (window.playModeAudio) window.playModeAudio('valentine'); } catch (e) {}
        }

        function askValentineQuestion() {
            if (!gameState.valentine.gameActive) return;
            
            const question = document.getElementById('valentine-question').value.trim();
            if (!question) return;
            
            const valentine = gameState.valentine;
            valentine.questionsLeft--;
            valentine.questions.push(question);
            
            // Generate AI-like response
            const answer = generateValentineAnswer(question, valentine.currentAnswer);
            valentine.answers.push(answer);
            
            // Update history
            updateValentineHistory();
            
            document.getElementById('valentine-question').value = '';
            updateValentineDisplay();
            
            if (valentine.questionsLeft === 0) {
                showFeedback('valentine', 'No more questions! You must make a guess now.', 'hint');
                document.getElementById('valentine-ask').disabled = true;
                document.getElementById('valentine-question').disabled = true;
            }
        }

        function generateValentineAnswer(question, answer) {
            const q = question.toLowerCase();
            const a = answer.toLowerCase();
            
            // Simple keyword matching for basic responses
            if (q.includes('alive') || q.includes('living')) {
                return gameState.valentine.category === 'animals' ? 'Yes' : 'No';
            }
            if (q.includes('animal')) {
                return gameState.valentine.category === 'animals' ? 'Yes' : 'No';
            }
            if (q.includes('place') || q.includes('location')) {
                return gameState.valentine.category === 'places' ? 'Yes' : 'No';
            }
            if (q.includes('movie') || q.includes('film')) {
                return gameState.valentine.category === 'movies' ? 'Yes' : 'No';
            }
            if (q.includes('object') || q.includes('thing')) {
                return gameState.valentine.category === 'objects' ? 'Yes' : 'No';
            }
            if (q.includes('big') || q.includes('large')) {
                return ['elephant', 'giraffe', 'whale', 'titanic', 'avatar'].some(word => a.includes(word)) ? 'Yes' : 'No';
            }
            if (q.includes('small')) {
                return ['phone', 'key', 'watch'].some(word => a.includes(word)) ? 'Yes' : 'No';
            }
            if (q.includes('water')) {
                return ['dolphin', 'titanic', 'sydney', 'paris'].some(word => a.includes(word)) ? 'Yes' : 'No';
            }
            if (q.includes('fly') || q.includes('flight')) {
                return ['penguin', 'avatar'].some(word => a.includes(word)) ? 'Yes' : 'No';
            }
            
            // Random yes/no for other questions
            return Math.random() > 0.5 ? 'Yes' : 'No';
        }

        function makeValentineGuess() {
            if (!gameState.valentine.gameActive) return;
            
            const guess = prompt('What do you think I\'m thinking of?');
            if (!guess) return;
            
            const valentine = gameState.valentine;
            valentine.guessesLeft--;
            
            if (guess.toLowerCase() === valentine.currentAnswer.toLowerCase()) {
                handleValentineWin();
            } else {
                if (valentine.guessesLeft === 0) {
                    handleValentineLose();
                } else {
                    showFeedback('valentine', `‚ùå Not quite! You have ${valentine.guessesLeft} guess(es) left.`, 'incorrect');
                    updateValentineDisplay();
                }
            }
        }

        function handleValentineWin() {
            const valentine = gameState.valentine;
            valentine.gameActive = false;
            
            const baseScore = 100;
            const questionBonus = valentine.questionsLeft * 10;
            const guessBonus = valentine.guessesLeft * 20;
            valentine.score = baseScore + questionBonus + guessBonus;
            
            addGameResult(true, valentine.score);
            
            showFeedback('valentine', `üéâ Correct! I was thinking of "${valentine.currentAnswer}"`, 'correct');
            
            document.getElementById('valentine-game-over').innerHTML = `
                <div class="game-over win">
                    <h3>üéâ Amazing!</h3>
                    <p>You guessed "${valentine.currentAnswer}" correctly!</p>
                    <p><strong>Score:</strong> ${valentine.score} points</p>
                    <p><strong>Questions used:</strong> ${valentine.questions.length}</p>
                    <p><strong>Guesses remaining:</strong> ${valentine.guessesLeft}</p>
                </div>
            `;
            
            disableValentineInputs();
            try { if (window.audioControls && window.audioControls.stop) window.audioControls.stop(); } catch (e) {}
            try { const user = JSON.parse(localStorage.getItem('burbleUser') || 'null'); if (user && user.username) recordCorrect(user.username, 0); } catch (e) {}
        }

        function handleValentineLose() {
            const valentine = gameState.valentine;
            valentine.gameActive = false;
            
            addGameResult(false, 0);
            
            showFeedback('valentine', `üòî The answer was "${valentine.currentAnswer}". Better luck next time!`, 'incorrect');
            
            document.getElementById('valentine-game-over').innerHTML = `
                <div class="game-over lose">
                    <h3>üòî Game Over</h3>
                    <p>I was thinking of: <strong>"${valentine.currentAnswer}"</strong></p>
                    <p>Category: ${valentine.category}</p>
                    <p>You asked ${valentine.questions.length} questions</p>
                </div>
            `;
            
            disableValentineInputs();
            try { if (window.audioControls && window.audioControls.stop) window.audioControls.stop(); } catch (e) {}
            try { const user = JSON.parse(localStorage.getItem('burbleUser') || 'null'); if (user && user.username) recordIncorrect(user.username); } catch (e) {}
        }

        function updateValentineHistory() {
            const valentine = gameState.valentine;
            const history = document.getElementById('valentine-history');
            
            let historyHTML = '';
            for (let i = 0; i < valentine.questions.length; i++) {
                historyHTML += `
                    <div class="question-item">
                        <div class="question-text">Q: ${valentine.questions[i]}</div>
                        <div class="answer-text">A: ${valentine.answers[i]}</div>
                    </div>
                `;
            }
            
            history.innerHTML = historyHTML || '<p class="muted-center">Ask yes/no questions to figure out what I\'m thinking of!</p>';
        }

        function updateValentineDisplay() {
            const valentine = gameState.valentine;
            
            document.getElementById('valentine-questions').textContent = valentine.questionsLeft;
            document.getElementById('valentine-guesses').textContent = valentine.guessesLeft;
            document.getElementById('valentine-category').textContent = valentine.category.charAt(0).toUpperCase() + valentine.category.slice(1);
            document.getElementById('valentine-score').textContent = valentine.score;
        }

        function disableValentineInputs() {
            document.getElementById('valentine-question').disabled = true;
            document.getElementById('valentine-ask').disabled = true;
            document.getElementById('valentine-guess').disabled = true;
        }

        // TRIVIA GAME
        function initTriviaGame() {
            // Difficulty selectors
            document.querySelectorAll('#trivia-page .selector-btn[data-difficulty]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#trivia-page .selector-btn[data-difficulty]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    gameState.trivia.difficulty = btn.dataset.difficulty;
                });
            });

            // Game buttons
            document.getElementById('trivia-start').addEventListener('click', startTriviaGame);
            document.getElementById('trivia-submit').addEventListener('click', submitTriviaAnswer);
            document.getElementById('trivia-next').addEventListener('click', nextTriviaQuestion);
        }

        function startTriviaGame() {
            const trivia = gameState.trivia;
            // Reset game state
            animalTrivia.currentQuestion = 0;
            animalTrivia.correctAnswers = 0;
            animalTrivia.score = 0;
            animalTrivia.gameActive = true;
            animalTrivia.selectedAnswer = null;

            // Ensure persistent pools exist
            if (!gameState.animalTrivia.pools) gameState.animalTrivia.pools = {};
            const key = `animal|${animalTrivia.difficulty}`;
            if (!gameState.animalTrivia.pools[key] || gameState.animalTrivia.pools[key].length === 0) {
                const allQuestions = animalTriviaQuestions[animalTrivia.difficulty] || [];
                gameState.animalTrivia.pools[key] = shuffleArray(allQuestions);
            }

            // Take questions for this run (consume from pool)
            const take = Math.min(animalTrivia.totalQuestions, gameState.animalTrivia.pools[key].length);
            animalTrivia.currentGameQuestions = gameState.animalTrivia.pools[key].splice(0, take);
            animalTrivia.totalQuestionsUsed = animalTrivia.currentGameQuestions.length;

            // Start timer
            startTimer('animalTrivia');

            // Play configured audio for Trivia
            try { if (window.playModeAudio) window.playModeAudio('trivia'); } catch (e) {}

            // Show first question
            showAnimalTriviaQuestion();

            // Update buttons
            document.getElementById('animal-start').disabled = true;
            document.getElementById('animal-submit').disabled = false;

            updateAnimalTriviaDisplay();
        }

        function showTriviaQuestion() {
            const trivia = gameState.trivia;
            const questions = trivia.currentGameQuestions || [];

            if (trivia.currentQuestion >= trivia.totalQuestionsUsed || trivia.currentQuestion >= questions.length) {
                endTriviaGame();
                return;
            }

            const question = questions[trivia.currentQuestion];
            
            document.getElementById('trivia-question-text').textContent = question.question;
            
            const optionsContainer = document.getElementById('trivia-options');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'trivia-option';
                optionDiv.textContent = option;
                optionDiv.onclick = () => selectTriviaOption(index, optionDiv);
                optionsContainer.appendChild(optionDiv);
            });
            
            trivia.selectedAnswer = null;
            document.getElementById('trivia-submit').disabled = false;
            document.getElementById('trivia-next').disabled = true;
            // record question start time
            trivia.questionStart = Date.now();
        }

        function selectTriviaOption(index, element) {
            // Remove previous selection
            document.querySelectorAll('#trivia-options .trivia-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Select new option
            element.classList.add('selected');
            gameState.trivia.selectedAnswer = index;
        }

        function submitTriviaAnswer() {
            if (gameState.trivia.selectedAnswer === null) return;
            
            const trivia = gameState.trivia;
            const questions = trivia.currentGameQuestions || [];
            const question = questions[trivia.currentQuestion];
            const isCorrect = trivia.selectedAnswer === question.correct;
            
            // Show correct/incorrect styling
            const options = document.querySelectorAll('#trivia-options .trivia-option');
            options.forEach((opt, index) => {
                if (index === question.correct) {
                    opt.classList.add('correct');
                } else if (index === trivia.selectedAnswer && !isCorrect) {
                    opt.classList.add('incorrect');
                }
                opt.onclick = null; // Disable clicking
            });
            
            if (isCorrect) {
                trivia.correctAnswers++;
                trivia.score += trivia.difficulty === 'hard' ? 15 : trivia.difficulty === 'medium' ? 10 : 5;
                showFeedback('trivia', '‚úÖ Correct!', 'correct');
                try {
                    const user = JSON.parse(localStorage.getItem('burbleUser') || 'null');
                    const time = trivia.questionStart ? ((Date.now() - trivia.questionStart) / 1000) : 0;
                    if (user && user.username) recordCorrect(user.username, time);
                } catch (e) {}
            } else {
                showFeedback('trivia', `‚ùå Incorrect. The correct answer was: ${question.options[question.correct]}`, 'incorrect');
                try { const user = JSON.parse(localStorage.getItem('burbleUser') || 'null'); if (user && user.username) recordIncorrect(user.username); } catch (e) {}
            }
            
            trivia.currentQuestion++;
            
            document.getElementById('trivia-submit').disabled = true;
            document.getElementById('trivia-next').disabled = false;
            
            updateTriviaDisplay();
        }

        function nextTriviaQuestion() {
            if (gameState.trivia.currentQuestion >= gameState.trivia.totalQuestions) {
                endTriviaGame();
            } else {
                showTriviaQuestion();
                document.getElementById('trivia-feedback').innerHTML = '';
            }
        }

        function endTriviaGame() {
            const trivia = gameState.trivia;
            trivia.gameActive = false;
            stopTimer('trivia');

            // Stop configured audio
            try { if (window.audioControls && window.audioControls.stop) window.audioControls.stop(); } catch (e) {}
            
            const percentage = Math.round((trivia.correctAnswers / trivia.totalQuestions) * 100);
            const won = percentage >= 70;
            
            addGameResult(won, trivia.score);
            
            document.getElementById('trivia-question-text').textContent = 'Quiz Complete!';
            document.getElementById('trivia-options').innerHTML = '';
            
            document.getElementById('trivia-game-over').innerHTML = `
                <div class="game-over ${won ? 'win' : 'lose'}">
                    <h3>${won ? 'üéâ Great Job!' : 'üìö Keep Studying!'}</h3>
                    <p><strong>Score:</strong> ${trivia.score} points</p>
                    <p><strong>Correct:</strong> ${trivia.correctAnswers}/${trivia.totalQuestions} (${percentage}%)</p>
                    <p><strong>Time:</strong> ${document.getElementById('trivia-timer').textContent}</p>
                    ${won ? '<p>Excellent knowledge!</p>' : '<p>Try again to improve your score!</p>'}
                </div>
            `;
            
            document.getElementById('trivia-start').disabled = false;
            document.getElementById('trivia-submit').disabled = true;
            document.getElementById('trivia-next').disabled = true;
        }

        function updateTriviaDisplay() {
            const trivia = gameState.trivia;

            const total = trivia.totalQuestionsUsed || Math.min(trivia.totalQuestions, (trivia.pool || []).length || 0);
            document.getElementById('trivia-question-num').textContent = `${trivia.currentQuestion}/${total}`;
            document.getElementById('trivia-correct').textContent = trivia.correctAnswers;
            document.getElementById('trivia-score').textContent = trivia.score;
        }

        function startTriviaGame() {
            const trivia = gameState.trivia;

            // Reset game state
            trivia.currentQuestion = 0;
            trivia.correctAnswers = 0;
            trivia.score = 0;
            trivia.gameActive = true;
            trivia.selectedAnswer = null;

            // Ensure persistent pools exist
            if (!gameState.trivia.pools) gameState.trivia.pools = {};
            const key = `trivia|${trivia.difficulty}`;
            if (!gameState.trivia.pools[key] || gameState.trivia.pools[key].length === 0) {
                const allQuestions = triviaQuestions[trivia.difficulty] || [];
                gameState.trivia.pools[key] = shuffleArray(allQuestions);
            }

            // Take questions for this run (consume from pool)
            const take = Math.min(trivia.totalQuestions, gameState.trivia.pools[key].length);
            trivia.currentGameQuestions = gameState.trivia.pools[key].splice(0, take);
            trivia.totalQuestionsUsed = trivia.currentGameQuestions.length;

            // Start timer
            startTimer('trivia');

            // Play configured audio for Trivia
            try { if (window.playModeAudio) window.playModeAudio('trivia'); } catch (e) {}

            // Show first question
            showTriviaQuestion();

            // Update buttons
            document.getElementById('trivia-start').disabled = true;
            document.getElementById('trivia-submit').disabled = false;

            updateTriviaDisplay();
        }

        // ANIMAL TRIVIA GAME
        function initAnimalTriviaGame() {
            // Difficulty selectors
            document.querySelectorAll('#animal-trivia-page .selector-btn[data-difficulty]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#animal-trivia-page .selector-btn[data-difficulty]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });

            // Game buttons
            document.getElementById('animal-start').addEventListener('click', startAnimalTriviaGame);
            document.getElementById('animal-submit').addEventListener('click', submitAnimalTriviaAnswer);
            document.getElementById('animal-next').addEventListener('click', nextAnimalTriviaQuestion);
        }

        function startAnimalTriviaGame() {
            const animalTrivia = gameState.animalTrivia;

            // Reset game state
            animalTrivia.currentQuestion = 0;
            animalTrivia.correctAnswers = 0;
            animalTrivia.score = 0;
            animalTrivia.gameActive = true;
            animalTrivia.selectedAnswer = null;

            // Always clear and reshuffle the pool for a fresh game
            if (!gameState.animalTrivia.pools) gameState.animalTrivia.pools = {};
            const key = `animal|${animalTrivia.difficulty}`;
            const allQuestions = animalTriviaQuestions[animalTrivia.difficulty] || [];
            gameState.animalTrivia.pools[key] = shuffleArray(allQuestions);
            savePoolsToStorage();

            // Take questions for this run (consume from pool)
            const take = Math.min(animalTrivia.totalQuestions, gameState.animalTrivia.pools[key].length);
            animalTrivia.currentGameQuestions = gameState.animalTrivia.pools[key].splice(0, take);
            animalTrivia.totalQuestionsUsed = animalTrivia.currentGameQuestions.length;

            // Start timer
            startTimer('animalTrivia');

            // Play configured audio for Animal Trivia
            try { if (window.playModeAudio) window.playModeAudio('animal'); } catch (e) {}

            // Show first question
            showAnimalTriviaQuestion();

            // Update buttons
            document.getElementById('animal-start').disabled = true;
            document.getElementById('animal-submit').disabled = false;

            updateAnimalTriviaDisplay();
        }

        function showAnimalTriviaQuestion() {
            const animalTrivia = gameState.animalTrivia;
            const questions = animalTrivia.currentGameQuestions || [];

            if (animalTrivia.currentQuestion >= (animalTrivia.totalQuestionsUsed || questions.length) || animalTrivia.currentQuestion >= questions.length) {
                endAnimalTriviaGame();
                return;
            }

            const question = questions[animalTrivia.currentQuestion];
            
            document.getElementById('animal-question-text').textContent = question.question;
            
            const optionsContainer = document.getElementById('animal-options');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'trivia-option';
                optionDiv.textContent = option;
                optionDiv.onclick = () => selectAnimalTriviaOption(index, optionDiv);
                optionsContainer.appendChild(optionDiv);
            });
            
            animalTrivia.selectedAnswer = null;
            document.getElementById('animal-submit').disabled = false;
            document.getElementById('animal-next').disabled = true;
        }

        function selectAnimalTriviaOption(index, element) {
            // Remove previous selection
            document.querySelectorAll('#animal-options .trivia-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Select new option
            element.classList.add('selected');
            gameState.animalTrivia.selectedAnswer = index;
        }

        function submitAnimalTriviaAnswer() {
            if (gameState.animalTrivia.selectedAnswer === null) return;
            const animalTrivia = gameState.animalTrivia;
            const questions = animalTrivia.currentGameQuestions || [];
            const question = questions[animalTrivia.currentQuestion];
            const isCorrect = animalTrivia.selectedAnswer === question.correct;
            
            // Show correct/incorrect styling
            const options = document.querySelectorAll('#animal-options .trivia-option');
            options.forEach((opt, index) => {
                if (index === question.correct) {
                    opt.classList.add('correct');
                } else if (index === animalTrivia.selectedAnswer && !isCorrect) {
                    opt.classList.add('incorrect');
                }
                opt.onclick = null; // Disable clicking
            });
            
            if (isCorrect) {
                animalTrivia.correctAnswers++;
                animalTrivia.score += animalTrivia.difficulty === 'hard' ? 15 : animalTrivia.difficulty === 'medium' ? 10 : 5;
                showFeedback('animal', '‚úÖ Correct!', 'correct');
                try { const user = JSON.parse(localStorage.getItem('burbleUser') || 'null'); if (user && user.username) recordCorrect(user.username, 0); } catch (e) {}
            } else {
                showFeedback('animal', `‚ùå Incorrect. The correct answer was: ${question.options[question.correct]}`, 'incorrect');
                try { const user = JSON.parse(localStorage.getItem('burbleUser') || 'null'); if (user && user.username) recordIncorrect(user.username); } catch (e) {}
            }
            
            animalTrivia.currentQuestion++;
            
            document.getElementById('animal-submit').disabled = true;
            document.getElementById('animal-next').disabled = false;
            
            updateAnimalTriviaDisplay();
        }

        function nextAnimalTriviaQuestion() {
            if (gameState.animalTrivia.currentQuestion >= (gameState.animalTrivia.totalQuestionsUsed || gameState.animalTrivia.totalQuestions)) {
                endAnimalTriviaGame();
            } else {
                showAnimalTriviaQuestion();
                document.getElementById('animal-feedback').innerHTML = '';
            }
        }

        function endAnimalTriviaGame() {
            const animalTrivia = gameState.animalTrivia;
            animalTrivia.gameActive = false;
            stopTimer('animalTrivia');

            // Stop configured audio for Animal Trivia
            try { if (window.audioControls && window.audioControls.stop) window.audioControls.stop(); } catch (e) {}

            const totalUsed = animalTrivia.totalQuestionsUsed || animalTrivia.totalQuestions || 0;
            const percentage = totalUsed > 0 ? Math.round((animalTrivia.correctAnswers / totalUsed) * 100) : 0;
            const won = percentage >= 70;

            addGameResult(won, animalTrivia.score);

            document.getElementById('animal-question-text').textContent = 'Quiz Complete!';
            document.getElementById('animal-options').innerHTML = '';

            document.getElementById('animal-game-over').innerHTML = `
                <div class="game-over ${won ? 'win' : 'lose'}">
                    <h3>${won ? 'ü¶Å Animal Expert!' : 'üêæ Keep Learning!'}</h3>
                    <p><strong>Score:</strong> ${animalTrivia.score} points</p>
                    <p><strong>Correct:</strong> ${animalTrivia.correctAnswers}/${totalUsed} (${percentage}%)</p>
                    <p><strong>Time:</strong> ${document.getElementById('animal-timer').textContent}</p>
                    ${won ? '<p>You know your animals!</p>' : '<p>Study more about animals and try again!</p>'}
                </div>
            `;

            document.getElementById('animal-start').disabled = false;
            document.getElementById('animal-submit').disabled = true;
            document.getElementById('animal-next').disabled = true;
        }

        function updateAnimalTriviaDisplay() {
            const animalTrivia = gameState.animalTrivia;
            const total = animalTrivia.totalQuestionsUsed || animalTrivia.totalQuestions || 0;
            document.getElementById('animal-question-num').textContent = `${animalTrivia.currentQuestion}/${total}`;
            document.getElementById('animal-correct').textContent = animalTrivia.correctAnswers;
            document.getElementById('animal-score').textContent = animalTrivia.score;
        }

        // Add a button to reset the animal trivia pool
        window.addEventListener('DOMContentLoaded', () => {
            loadUserStats();
            initRiddlesGame();
            initBurbleGame();
            initEmojiGame();
            initValentineGame();
            initTriviaGame();
            initAnimalTriviaGame();
            updateUserStats();
            initAuthAndLeaderboard();

            // Add reset button to animal trivia page
            const animalPage = document.getElementById('animal-trivia-page');
            if (animalPage && !document.getElementById('reset-animal-pool')) {
                const resetBtn = document.createElement('button');
                resetBtn.id = 'reset-animal-pool';
                resetBtn.textContent = 'Reset Animal Trivia Pool';
                resetBtn.className = 'nav-btn';
                resetBtn.style.margin = '12px 0';
                resetBtn.onclick = () => {
                    if (confirm('Reset the animal trivia question pool? This will reshuffle and use all available questions.')) {
                        if (gameState.animalTrivia && gameState.animalTrivia.pools) {
                            const key = `animal|${gameState.animalTrivia.difficulty}`;
                            const allQuestions = animalTriviaQuestions[gameState.animalTrivia.difficulty] || [];
                            gameState.animalTrivia.pools[key] = shuffleArray(allQuestions);
                            savePoolsToStorage();
                            alert('Animal trivia pool reset! Start a new game to see changes.');
                        }
                    }
                };
                animalPage.insertBefore(resetBtn, animalPage.firstChild);
            }
        });

        // --- Simple client-side auth & leaderboard ---
        function sanitizeUsername(name) {
            return name.replace(/[^a-zA-Z0-9_\- ]/g, '').trim().slice(0, 30);
        }

        function isProfane(name) {
            if (!name) return false;
            const blocked = ['fuck','shit','bitch','cunt','nigger','faggot','motherfucker'];
            const low = name.toLowerCase();
            return blocked.some(w => low.includes(w));
        }

        function initAuthAndLeaderboard() {
            const signin = document.getElementById('signin-btn');
            const userInfo = document.getElementById('user-info');
            const signout = document.getElementById('signout-btn');
            const emailLink = document.getElementById('user-email-link');

            function renderUser() {
                const user = JSON.parse(localStorage.getItem('burbleUser') || 'null');
                if (user && user.username) {
                    signin.classList.add('hidden');
                    userInfo.classList.remove('hidden');
                    emailLink.textContent = user.username;
                    emailLink.href = 'mailto:' + encodeURIComponent(user.email || '');
                } else {
                    signin.classList.remove('hidden');
                    userInfo.classList.add('hidden');
                }
            }

            // expose for tests and external scripts to trigger UI sync
            try { window.renderUser = renderUser; } catch (e) {}

            // Note: tests should call `window.renderUser()` after setting `burbleUser` in localStorage.

            signin.addEventListener('click', () => {
                // Open the sign-in modal (the modal submit handler will handle registration)
                const modal = document.getElementById('signin-modal');
                if (modal) { modal.classList.remove('hidden'); modal.setAttribute('aria-hidden', 'false'); }
            });

            signout.addEventListener('click', () => {
                localStorage.removeItem('burbleUser');
                renderUser();
            });

            renderUser();
            renderLeaderboard();
        }

        // Sign-in modal and settings modal UI
        document.body.insertAdjacentHTML('beforeend', `
            <div id="signin-modal" class="modal hidden" aria-hidden="true">
                <div class="card">
                    <h3>Sign in / Register</h3>
                    <label>Username</label>
                    <input id="si-username" class="modal-input" />
                    <label>Email (optional)</label>
                    <input id="si-email" class="modal-input" />
                    <div class="modal-actions">
                        <button id="si-cancel" class="nav-btn">Cancel</button>
                        <button id="si-submit" class="nav-btn btn-primary">Submit</button>
                    </div>
                    <div id="si-msg" class="message-error"></div>
                </div>
            </div>
            <div id="settings-modal" class="modal hidden" aria-hidden="true">
                <div class="card">
                    <h3>Settings</h3>
                    <label>Theme</label>
                    <select id="pref-theme">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                    </select>
                    <label>Font size</label>
                    <select id="pref-font">
                        <option value="small">Small</option>
                        <option value="normal">Normal</option>
                        <option value="large">Large</option>
                    </select>
                    <label>Profile banner</label>
                    <input id="pref-banner" type="file" accept="image/*" />
                    <div class="modal-actions mt12">
                        <button id="settings-cancel" class="nav-btn">Close</button>
                        <button id="settings-save" class="nav-btn btn-primary">Save</button>
                    </div>
                    <div id="settings-msg" class="message-error"></div>
                </div>
            </div>
            <div id="settings-gear" class="settings-gear" title="Settings">‚öôÔ∏è</div>
        `);

        // wire modal buttons
        const signinModal = document.getElementById('signin-modal');
        const settingsModal = document.getElementById('settings-modal');
        const signinBtn = document.getElementById('signin-btn');
        const siCancel = document.getElementById('si-cancel');
        const siSubmit = document.getElementById('si-submit');
        const siMsg = document.getElementById('si-msg');
        const settingsGear = document.getElementById('settings-gear');
        const settingsCancel = document.getElementById('settings-cancel');
        const settingsSave = document.getElementById('settings-save');

        signinBtn.addEventListener('click', () => { signinModal.classList.remove('hidden'); signinModal.setAttribute('aria-hidden', 'false'); });
        siCancel.addEventListener('click', () => { signinModal.classList.add('hidden'); siMsg.textContent = ''; });

        siSubmit.addEventListener('click', async () => {
            siMsg.textContent = '';
            const username = document.getElementById('si-username').value || '';
            const email = document.getElementById('si-email').value || '';
            try {
                // check username availability via server
                const check = await fetch('http://localhost:4000/api/check-username', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ username }) });
                const chk = await check.json();
                if (!chk.ok) { siMsg.textContent = 'Username not available: ' + (chk.reason || ''); return; }
                const reg = await fetch('http://localhost:4000/api/register', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ username, email }) });
                const jr = await reg.json();
                if (!reg.ok) { siMsg.textContent = jr.error || 'Registration failed'; return; }
                localStorage.setItem('burbleUser', JSON.stringify({ username: jr.user.username, email: jr.user.email }));
                signinModal.classList.add('hidden'); renderUser(); renderLeaderboard();
            } catch (e) {
                // fallback to local storage registration
                const clean = sanitizeUsername(username);
                if (!clean || isProfane(clean)) { siMsg.textContent = 'Invalid or disallowed username'; return; }
                const existing = JSON.parse(localStorage.getItem('burbleLeaderboard')||'{}');
                if (existing[clean]) { siMsg.textContent = 'Username taken locally'; return; }
                localStorage.setItem('burbleUser', JSON.stringify({ username: clean, email }));
                existing[clean] = { score:0, questionsSolved:0, totalCorrectTime:0, correctCount:0, highestStreak:0 };
                localStorage.setItem('burbleLeaderboard', JSON.stringify(existing));
                signinModal.classList.add('hidden'); renderUser(); renderLeaderboard();
            }
        });

        settingsGear.addEventListener('click', () => { settingsModal.classList.remove('hidden'); settingsModal.setAttribute('aria-hidden','false'); });
        settingsCancel.addEventListener('click', () => { settingsModal.classList.add('hidden'); });
        settingsSave.addEventListener('click', async () => {
            const theme = document.getElementById('pref-theme').value;
            const font = document.getElementById('pref-font').value;
            const bannerInput = document.getElementById('pref-banner');
            const user = JSON.parse(localStorage.getItem('burbleUser') || 'null');
            if (user && user.username && bannerInput.files && bannerInput.files[0]) {
                const f = bannerInput.files[0];
                const fd = new FormData(); fd.append('banner', f); fd.append('username', user.username);
                try {
                    const up = await fetch('http://localhost:4000/api/upload-profile', { method:'POST', body: fd });
                    const ju = await up.json();
                    if (up.ok) {
                        user.banner = ju.url; localStorage.setItem('burbleUser', JSON.stringify(user));
                    }
                } catch (e) { /* ignore */ }
            }
            const prefs = { theme, font };
            if (user && user.username) {
                // save to server prefs if available
                try { await fetch('http://localhost:4000/api/save-prefs', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ username: user.username, prefs }) }); } catch (e) {}
            }
            localStorage.setItem('burblePrefs', JSON.stringify(prefs));
            settingsModal.classList.add('hidden');
        });

        function recordCorrect(username, timeTakenSeconds) {
            if (!username) return;
            const lb = JSON.parse(localStorage.getItem('burbleLeaderboard') || '{}');
            if (!lb[username]) lb[username] = { score: 0, questionsSolved: 0, totalCorrectTime: 0, correctCount: 0, highestStreak: 0, currentStreak: 0 };
            lb[username].questionsSolved = (lb[username].questionsSolved || 0) + 1;
            lb[username].totalCorrectTime = (lb[username].totalCorrectTime || 0) + (timeTakenSeconds || 0);
            lb[username].correctCount = (lb[username].correctCount || 0) + 1;
            lb[username].currentStreak = (lb[username].currentStreak || 0) + 1;
            if (lb[username].currentStreak > (lb[username].highestStreak || 0)) lb[username].highestStreak = lb[username].currentStreak;
            // update score simple heuristic
            lb[username].score = (lb[username].score || 0) + 10;
            localStorage.setItem('burbleLeaderboard', JSON.stringify(lb));
        }

        function recordIncorrect(username) {
            if (!username) return;
            const lb = JSON.parse(localStorage.getItem('burbleLeaderboard') || '{}');
            if (!lb[username]) lb[username] = { score: 0, questionsSolved: 0, totalCorrectTime: 0, correctCount: 0, highestStreak: 0, currentStreak: 0 };
            lb[username].currentStreak = 0;
            localStorage.setItem('burbleLeaderboard', JSON.stringify(lb));
        }

        function renderLeaderboard() {
            const tbody = document.getElementById('leaderboard-scores-body');
            const tbodyDetails = document.getElementById('leaderboard-details-body');
            if (!tbody || !tbodyDetails) return;
            const lb = JSON.parse(localStorage.getItem('burbleLeaderboard') || '{}');
            const rows = Object.keys(lb).map(u => ({ username: u, ...lb[u] }));
            // sort by score desc
            rows.sort((a,b) => (b.score || 0) - (a.score || 0));
            tbody.innerHTML = '';
            tbodyDetails.innerHTML = '';
            rows.forEach((r, i) => {
                const tr = document.createElement('tr');
                const rank = i+1;
                tr.innerHTML = `<td class="td-pad">${rank}</td><td class="td-pad">${r.username}</td><td class="td-pad">${r.score || 0}</td>`;
                if (rank <= 3) {
                    tr.classList.add(rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : 'rank-3');
                }
                tbody.appendChild(tr);

                const avg = r.correctCount ? ((r.totalCorrectTime || 0) / r.correctCount).toFixed(1) : '‚Äî';
                const tr2 = document.createElement('tr');
                tr2.innerHTML = `<td class="td-pad">${rank}</td><td class="td-pad">${r.username}</td><td class="td-pad">${r.questionsSolved || 0}</td><td class="td-pad">${avg}</td><td class="td-pad">${r.highestStreak || 0}</td>`;
                if (rank <= 3) {
                    tr2.classList.add(rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : 'rank-3');
                    tr2.classList.add('details');
                }
                tbodyDetails.appendChild(tr2);
            });
        }

        function showLeaderboardTab(tab) {
            document.getElementById('leaderboard-scores').classList.toggle('hidden', tab !== 'scores');
            document.getElementById('leaderboard-details').classList.toggle('hidden', tab !== 'details');
            document.querySelectorAll('#leaderboard-page .selector-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
        }