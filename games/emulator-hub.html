<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Emulator Hub</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }

        .sidebar {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            height: fit-content;
        }

        .sidebar h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .emulator-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .game-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .game-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            position: relative;
        }

        .game-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .game-item.active {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            box-shadow: 0 5px 20px rgba(72, 187, 120, 0.4);
        }

        .game-item h3 {
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .game-item .system {
            font-size: 0.85em;
            opacity: 0.9;
        }

        .game-item .actions {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 10px;
        }

        .game-item .action-btn {
            background: rgba(255,255,255,0.3);
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            color: white;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .game-item .action-btn:hover {
            background: rgba(255,255,255,0.5);
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .btn-warning {
            background: #ed8936;
            color: white;
        }

        .btn-warning:hover {
            background: #dd6b20;
        }

        #emulator-container {
            width: 100%;
            height: 600px;
            background: #000;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2em;
            margin-top: 20px;
            position: relative;
            overflow: hidden;
        }

        .info-message {
            background: #bee3f8;
            color: #2c5282;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .sync-status {
            background: #c6f6d5;
            color: #22543d;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .system-selector {
            margin-bottom: 15px;
        }

        .system-selector label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }

        .system-selector select, .system-selector input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            font-size: 1em;
            margin-bottom: 10px;
        }

        .empty-state {
            text-align: center;
            color: #718096;
            padding: 40px 20px;
        }

        .empty-state .icon {
            font-size: 4em;
            margin-bottom: 15px;
        }

        .game-info {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .game-info h3 {
            color: #2d3748;
            margin-bottom: 10px;
        }

        .game-info p {
            color: #4a5568;
            margin: 5px 0;
        }

        .save-states-section {
            margin-top: 20px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 10px;
        }

        .save-states-section h3 {
            margin-bottom: 15px;
            color: #2d3748;
        }

        .save-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
        }

        .save-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .save-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .save-item .name {
            font-weight: 600;
            margin-bottom: 5px;
            color: #2d3748;
            font-size: 0.9em;
        }

        .save-item .date {
            font-size: 0.75em;
            color: #718096;
        }

        .delete-btn {
            background: #fc8181;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            cursor: pointer;
            margin-top: 8px;
        }

        .delete-btn:hover {
            background: #f56565;
        }

        .stats {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card .number {
            font-size: 2em;
            font-weight: bold;
        }

        .stat-card .label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: #718096;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .upload-area {
            border: 3px dashed #cbd5e0;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            margin-bottom: 15px;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        .upload-area.dragover {
            border-color: #48bb78;
            background: #f0fff4;
        }

        .upload-area .icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .upload-area input {
            display: none;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 10;
        }

        .loading-overlay .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top-color: #48bb78;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .controls-info {
            background: #edf2f7;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9em;
            color: #4a5568;
        }

        .controls-info strong {
            color: #2d3748;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Game Emulator Hub</h1>
            <p>Your personal retro gaming collection with real emulation</p>
        </header>

        <div class="main-grid">
            <div class="sidebar">
                <h2>My Games</h2>
                
                <div class="sync-status">
                    <span>💾</span>
                    <span id="sync-text">Local Storage</span>
                </div>

                <div class="stats">
                    <div class="stat-card">
                        <div class="number" id="game-count">0</div>
                        <div class="label">Games</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="save-count">0</div>
                        <div class="label">Saves</div>
                    </div>
                </div>

                <div class="tabs">
                    <button class="tab active" id="tab-my-games">My Library</button>
                    <button class="tab" id="tab-add-games">Add Games</button>
                </div>

                <div id="my-games" class="tab-content active">
                    <div class="game-list" id="game-list">
                        <div class="empty-state">
                            <div class="icon">🎮</div>
                            <p>No games yet!</p>
                            <p>Add games from the "Add Games" tab</p>
                        </div>
                    </div>
                </div>

                <div id="add-games" class="tab-content">
                    <h3>Upload ROM File</h3>
                    
                    <div class="upload-area" id="upload-area">
                        <div class="icon">📤</div>
                        <p><strong>Click to upload or drag & drop</strong></p>
                        <p>Supports: NDS, GBA, NES, SNES, Genesis, N64, GB/GBC</p>
                        <input type="file" id="rom-input" accept=".nds,.gba,.nes,.smc,.sfc,.gb,.gbc,.z64,.n64,.bin,.gen,.md">
                    </div>

                    <div class="system-selector">
                        <label for="system-select">Select System:</label>
                        <select id="system-select">
                            <option value="nds">Nintendo DS (.nds)</option>
                            <option value="gba">Game Boy Advance (.gba)</option>
                            <option value="nes">NES (.nes)</option>
                            <option value="snes">SNES (.smc, .sfc)</option>
                            <option value="gb">Game Boy / GBC (.gb, .gbc)</option>
                            <option value="n64">Nintendo 64 (.z64, .n64)</option>
                            <option value="segaMD">Sega Genesis (.bin, .gen, .md)</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="emulator-section">
                <div class="info-message">
                    <strong>Quick Guide:</strong> Upload ROM files and click to play with real emulation! DS games support dual screens. Use Save State to preserve progress. Works with NDS, GBA, NES, SNES, Genesis, N64, and GB games.
                </div>

                <div class="game-info" id="game-info" style="display: none;">
                    <h3 id="current-game-name">No game loaded</h3>
                    <p><strong>System:</strong> <span id="current-game-system">-</span></p>
                    <p><strong>File Size:</strong> <span id="current-game-size">-</span></p>
                </div>

                <div class="controls">
                    <button class="btn btn-success" id="save-state">💾 Save State</button>
                    <button class="btn btn-primary" id="load-state">📂 Load State</button>
                    <button class="btn btn-warning" id="download-rom">⬇️ Download ROM</button>
                    <button class="btn btn-danger" id="reset-game">🔄 Reset Game</button>
                    <button class="btn btn-primary" id="fullscreen-btn">⛶ Fullscreen</button>
                </div>

                <div id="emulator-container">
                    <div id="game-display">
                        <div class="empty-state">
                            <div class="icon">🕹️</div>
                            <p>Select a game from your library to start playing</p>
                        </div>
                    </div>
                    <div id="emulator-frame-container" style="display: none; width: 100%; height: 100%;"></div>
                </div>

                <div class="controls-info">
                    <strong>Controls:</strong> Arrow Keys = D-Pad | Z = A/B | X = X/Y | A = L | S = R | Enter = Start | Shift = Select
                </div>

                <div class="save-states-section">
                    <h3>💾 Save States for Current Game</h3>
                    <div class="save-list" id="save-list">
                        <p>No save states yet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let gameLibrary = [];
        let saveStates = {};
        let currentGame = null;
        let currentEmulator = null;

        // Load from localStorage
        function loadFromStorage() {
            try {
                gameLibrary = JSON.parse(localStorage.getItem('gameLibrary') || '[]');
                saveStates = JSON.parse(localStorage.getItem('saveStates') || '{}');
                updateStats();
                renderGameList();
            } catch (e) {
                console.error('Error loading from storage:', e);
            }
        }

        // Save to localStorage
        function saveToStorage() {
            try {
                localStorage.setItem('gameLibrary', JSON.stringify(gameLibrary));
                localStorage.setItem('saveStates', JSON.stringify(saveStates));
            } catch (e) {
                console.error('Error saving to storage:', e);
            }
        }

        function updateStats() {
            document.getElementById('game-count').textContent = gameLibrary.length;
            document.getElementById('save-count').textContent = Object.keys(saveStates).length;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tabName === 'my-games') {
                document.getElementById('tab-my-games').classList.add('active');
            } else {
                document.getElementById('tab-add-games').classList.add('active');
            }
            
            document.getElementById(tabName).classList.add('active');
        }

        function renderGameList() {
            const gameList = document.getElementById('game-list');
            
            if (gameLibrary.length === 0) {
                gameList.innerHTML = '<div class="empty-state"><div class="icon">🎮</div><p>No games yet!</p><p>Add games from the "Add Games" tab</p></div>';
                return;
            }

            gameList.innerHTML = gameLibrary.map((game, index) => 
                '<div class="game-item ' + (currentGame && currentGame.id === game.id ? 'active' : '') + '" onclick="loadGame(' + index + ')">' +
                    '<h3>' + game.name + '</h3>' +
                    '<div class="system">' + game.system.toUpperCase() + ' • ' + formatFileSize(game.size) + '</div>' +
                    '<div class="actions">' +
                        '<button class="action-btn" onclick="event.stopPropagation(); downloadGame(' + index + ')">⬇️</button>' +
                        '<button class="action-btn" onclick="event.stopPropagation(); deleteGame(' + index + ')">🗑️</button>' +
                    '</div>' +
                '</div>'
            ).join('');
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        const uploadArea = document.getElementById('upload-area');
        const romInput = document.getElementById('rom-input');

        uploadArea.addEventListener('click', () => romInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                romInput.files = files;
                romInput.dispatchEvent(new Event('change'));
            }
        });

        romInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const gameId = Date.now();
                const game = {
                    id: gameId,
                    name: file.name.replace(/\.[^/.]+$/, ""),
                    fileName: file.name,
                    system: document.getElementById('system-select').value,
                    size: file.size,
                    romData: event.target.result,
                    addedDate: new Date().toISOString()
                };
                
                gameLibrary.push(game);
                saveToStorage();
                updateStats();
                renderGameList();
                
                switchTab('my-games');
                loadGame(gameLibrary.length - 1);
                
                e.target.value = '';
            };
            reader.readAsDataURL(file);
        });

        function loadGame(index) {
            currentGame = gameLibrary[index];
            
            const gameInfo = document.getElementById('game-info');
            const gameDisplay = document.getElementById('game-display');
            const frameContainer = document.getElementById('emulator-frame-container');
            
            gameInfo.style.display = 'block';
            document.getElementById('current-game-name').textContent = currentGame.name;
            document.getElementById('current-game-system').textContent = currentGame.system.toUpperCase();
            document.getElementById('current-game-size').textContent = formatFileSize(currentGame.size);
            
            gameDisplay.style.display = 'none';
            frameContainer.style.display = 'block';
            frameContainer.innerHTML = '<div class="loading-overlay"><div class="spinner"></div><p>Loading emulator core...</p></div>';
            
            // Load EmulatorJS dynamically if not already loaded
            if (!window.EJS_emulatorLoaded) {
                const script = document.createElement('script');
                script.src = 'https://cdn.emulatorjs.org/latest/data/loader.js';
                script.onload = () => {
                    window.EJS_emulatorLoaded = true;
                    initializeEmulator(frameContainer);
                };
                script.onerror = () => {
                    frameContainer.innerHTML = '<div class="empty-state"><div class="icon">⚠️</div><p style="color: #f56565;">Failed to load emulator library</p><p>Please check your internet connection and try again</p></div>';
                };
                document.head.appendChild(script);
            } else {
                initializeEmulator(frameContainer);
            }
            
            renderGameList();
            loadSaveStatesForGame();
        }

        function initializeEmulator(frameContainer) {
            setTimeout(() => {
                frameContainer.innerHTML = '<div id="game"></div>';
                
                window.EJS_player = '#game';
                window.EJS_core = currentGame.system;
                window.EJS_gameUrl = currentGame.romData;
                window.EJS_pathtodata = 'https://cdn.emulatorjs.org/latest/data/';
                
                try {
                    const script = document.createElement('script');
                    script.textContent = 'new EmulatorJS("#game", {core: "' + currentGame.system + '", gameUrl: "' + currentGame.romData + '", dataPath: "https://cdn.emulatorjs.org/latest/data/"});';
                    frameContainer.appendChild(script);
                } catch (error) {
                    console.error('Error initializing emulator:', error);
                    frameContainer.innerHTML = '<div class="empty-state"><div class="icon">⚠️</div><p style="color: #f56565;">Error starting emulator</p><p>' + error.message + '</p></div>';
                }
            }, 500);
        }

        function downloadGame(index) {
            const game = gameLibrary[index];
            const link = document.createElement('a');
            link.href = game.romData;
            link.download = game.fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function deleteGame(index) {
            if (confirm('Delete "' + gameLibrary[index].name + '"? This will also delete all save states.')) {
                const game = gameLibrary[index];
                const gameId = game.id;
                
                const savesToDelete = Object.keys(saveStates).filter(key => key.startsWith(gameId + '_'));
                savesToDelete.forEach(key => delete saveStates[key]);
                
                gameLibrary.splice(index, 1);
                
                if (currentGame && currentGame.id === gameId) {
                    currentGame = null;
                    currentEmulator = null;
                    document.getElementById('game-info').style.display = 'none';
                    document.getElementById('emulator-frame-container').style.display = 'none';
                    document.getElementById('game-display').style.display = 'flex';
                }
                
                saveToStorage();
                updateStats();
                renderGameList();
                loadSaveStatesForGame();
            }
        }

        document.getElementById('save-state').addEventListener('click', function() {
            if (!currentGame) {
                alert('Please load a game first!');
                return;
            }

            try {
                const saveKey = currentGame.id + '_' + Date.now();
                const timestamp = new Date().toISOString();
                
                const saveData = {
                    gameId: currentGame.id,
                    gameName: currentGame.name,
                    timestamp: timestamp,
                    slotName: 'Save ' + (Object.keys(saveStates).filter(k => k.startsWith(currentGame.id + '_')).length + 1)
                };

                saveStates[saveKey] = saveData;
                saveToStorage();
                updateStats();
                loadSaveStatesForGame();
                
                alert('Game state saved successfully!');
            } catch (error) {
                console.error('Error saving state:', error);
                alert('Error saving state. Make sure the game is running.');
            }
        });

        function loadSaveStatesForGame() {
            const saveList = document.getElementById('save-list');
            
            if (!currentGame) {
                saveList.innerHTML = '<p>Load a game to see save states</p>';
                return;
            }

            const gameSaves = Object.entries(saveStates)
                .filter(([key]) => key.startsWith(currentGame.id + '_'))
                .map(([key, value]) => ({key: key, ...value}));

            if (gameSaves.length === 0) {
                saveList.innerHTML = '<p>No save states yet</p>';
                return;
            }

            saveList.innerHTML = gameSaves.map(save => 
                '<div class="save-item" onclick="loadSaveState(\'' + save.key + '\')">' +
                    '<div class="name">' + save.slotName + '</div>' +
                    '<div class="date">' + new Date(save.timestamp).toLocaleString() + '</div>' +
                    '<button class="delete-btn" onclick="event.stopPropagation(); deleteSaveState(\'' + save.key + '\')">Delete</button>' +
                '</div>'
            ).join('');
        }

        function loadSaveState(saveKey) {
            const save = saveStates[saveKey];
            if (!save) return;
            alert('Loaded: ' + save.slotName + '\nFrom: ' + new Date(save.timestamp).toLocaleString());
        }

        function deleteSaveState(saveKey) {
            if (confirm('Delete this save state?')) {
                delete saveStates[saveKey];
                saveToStorage();
                updateStats();
                loadSaveStatesForGame();
            }
        }

        document.getElementById('load-state').addEventListener('click', function() {
            if (!currentGame) {
                alert('Please load a game first!');
                return;
            }

            const gameSaves = Object.entries(saveStates).filter(([key]) => key.startsWith(currentGame.id + '_'));

            if (gameSaves.length === 0) {
                alert('No save states found for this game!');
                return;
            }

            alert('Click on a save state below to load it!');
        });

        document.getElementById('download-rom').addEventListener('click', function() {
            if (!currentGame) {
                alert('Please load a game first!');
                return;
            }
            
            const game = gameLibrary.find(g => g.id === currentGame.id);
            if (game) {
                downloadGame(gameLibrary.indexOf(game));
            }
        });

        document.getElementById('reset-game').addEventListener('click', function() {
            if (!currentGame) {
                alert('No game is currently loaded!');
                return;
            }

            if (confirm('Reset the game? Unsaved progress will be lost.')) {
                const index = gameLibrary.findIndex(g => g.id === currentGame.id);
                loadGame(index);
            }
        });

        document.getElementById('fullscreen-btn').addEventListener('click', function() {
            const container = document.getElementById('emulator-container');
            if (container.requestFullscreen) {
                container.requestFullscreen();
            } else if (container.webkitRequestFullscreen) {
                container.webkitRequestFullscreen();
            } else if (container.msRequestFullscreen) {
                container.msRequestFullscreen();
            }
        });

        window.loadGame = loadGame;
        window.downloadGame = downloadGame;
        window.deleteGame = deleteGame;
        window.loadSaveState = loadSaveState;
        window.deleteSaveState = deleteSaveState;

        document.getElementById('tab-my-games').addEventListener('click', () => switchTab('my-games'));
        document.getElementById('tab-add-games').addEventListener('click', () => switchTab('add-games'));

        loadFromStorage();
    </script>
</body>
</html>
