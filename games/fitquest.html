<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <title>FitQuest - Level Up Your Fitness</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-dark: #1f2937;
            --bg-light: #f3f4f6;
            --text-dark: #111827;
            --text-light: #6b7280;
            --border: #e5e7eb;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-dark);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header with User Stats */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            position: relative;
        }

        .avatar-upload {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 28px;
            height: 28px;
            background: var(--secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 3px solid white;
        }

        .user-info h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .level-badge {
            display: inline-block;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        /* XP Progress Bar */
        .xp-container {
            margin-top: 15px;
        }

        .xp-bar {
            height: 30px;
            background: #e5e7eb;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .xp-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            z-index: 1;
            color: var(--text-dark);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary);
            display: block;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-light);
            margin-top: 5px;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 10px;
            background: white;
            padding: 10px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .nav-tab {
            padding: 12px 25px;
            border: none;
            background: transparent;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-light);
            transition: all 0.3s;
            white-space: nowrap;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        /* Content Sections */
        .content-section {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            animation: fadeIn 0.3s;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Today's Workout Section */
        .workout-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .workout-card h2 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .workout-meta {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn {
            background: white;
            color: var(--primary);
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-success {
            background: var(--secondary);
            color: white;
        }

        /* Exercise List */
        .exercise-list {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .exercise-item {
            background: #f9fafb;
            padding: 20px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--primary);
        }

        .exercise-info h3 {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .exercise-details {
            color: var(--text-light);
            font-size: 14px;
        }

        .exercise-checkbox {
            width: 30px;
            height: 30px;
            cursor: pointer;
        }

        /* AI Chat Interface */
        .chat-container {
            border: 2px solid var(--border);
            border-radius: 15px;
            height: 500px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f9fafb;
        }

        .message {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 12px;
            max-width: 80%;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .message.user {
            background: var(--primary);
            color: white;
            margin-left: auto;
        }

        .message.ai {
            background: white;
            border: 2px solid var(--border);
        }

        .chat-input-container {
            display: flex;
            padding: 20px;
            gap: 10px;
            border-top: 2px solid var(--border);
            background: white;
        }

        .chat-input {
            flex: 1;
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
        }

        /* Body Scan Section */
        .camera-container {
            background: #1f2937;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .camera-preview {
            width: 100%;
            max-width: 400px;
            height: 400px;
            background: #374151;
            border-radius: 12px;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .camera-preview video,
        .camera-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-upload-zone {
            border: 3px dashed var(--border);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .photo-upload-zone:hover {
            border-color: var(--primary);
            background: #f9fafb;
        }

        /* Progress Photos Gallery */
        .photo-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .photo-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 1;
            cursor: pointer;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-date {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px;
            font-size: 12px;
            text-align: center;
        }

        /* Achievement Cards */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .achievement-card {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            transition: transform 0.3s;
        }

        .achievement-card:hover {
            transform: translateY(-5px);
        }

        .achievement-card.unlocked {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
        }

        .achievement-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        /* Progress Timeline */
        .timeline-container {
            position: relative;
            padding-left: 40px;
        }

        .timeline-line {
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(to bottom, var(--primary), var(--secondary));
        }

        .timeline-item {
            position: relative;
            margin-bottom: 30px;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .timeline-dot {
            position: absolute;
            left: -29px;
            top: 20px;
            width: 20px;
            height: 20px;
            background: var(--primary);
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .timeline-photo {
            width: 100%;
            max-width: 300px;
            height: 300px;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .timeline-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
            font-size: 14px;
            color: var(--text-light);
        }

        .timeline-analysis {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        /* Notification System */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 2000;
            min-width: 300px;
            animation: slideInRight 0.3s;
        }

        @keyframes slideInRight {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification-success {
            border-left: 4px solid var(--secondary);
        }

        .notification-info {
            border-left: 4px solid var(--primary);
        }

        .notification-warning {
            border-left: 4px solid var(--warning);
        }

        /* iOS-specific styles */
        @supports (-webkit-touch-callout: none) {
            body {
                -webkit-user-select: none;
                -webkit-tap-highlight-color: transparent;
            }
            
            .btn {
                -webkit-appearance: none;
                cursor: pointer;
            }
            
            input, select, textarea {
                font-size: 16px; /* Prevents zoom on iOS */
                -webkit-appearance: none;
            }
        }

        /* Pull to refresh indicator (mobile) */
        .refresh-indicator {
            position: absolute;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: top 0.3s;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                padding: 20px 15px;
            }

            .user-profile {
                flex-direction: column;
                text-align: center;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .stat-card {
                padding: 12px;
            }

            .stat-value {
                font-size: 24px;
            }

            .message {
                max-width: 90%;
            }

            .nav-tabs {
                padding: 8px;
                gap: 5px;
            }

            .nav-tab {
                padding: 10px 15px;
                font-size: 14px;
            }

            .content-section {
                padding: 20px 15px;
            }

            .workout-card {
                padding: 20px;
            }

            .workout-card h2 {
                font-size: 22px;
            }

            .btn {
                padding: 12px 20px;
                font-size: 14px;
            }

            .modal-content {
                width: 95%;
                padding: 25px 20px;
                max-height: 90vh;
            }

            .timeline-container {
                padding-left: 25px;
            }

            .timeline-photo {
                max-width: 100%;
                height: auto;
            }

            .notification {
                right: 10px;
                left: 10px;
                min-width: auto;
            }

            .chat-container {
                height: 400px;
            }

            .camera-preview {
                height: 300px;
            }
        }

        /* Extra small devices */
        @media (max-width: 380px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .workout-meta {
                flex-direction: column;
                gap: 10px;
            }

            .nav-tab {
                padding: 8px 12px;
                font-size: 13px;
            }
        }

        /* Landscape mobile */
        @media (max-height: 500px) and (orientation: landscape) {
            .modal-content {
                max-height: 95vh;
                overflow-y: auto;
            }
        }

        /* Touch-friendly spacing */
        @media (hover: none) and (pointer: coarse) {
            .btn {
                min-height: 44px; /* iOS recommended touch target */
            }

            .exercise-checkbox {
                width: 40px;
                height: 40px;
            }

            .nav-tab {
                min-height: 44px;
            }
        }

        /* Leaderboard Styles */
        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            margin-bottom: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid var(--border);
        }

        .leaderboard-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }

        .leaderboard-item.rank-1 {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            border: none;
        }

        .leaderboard-item.rank-2 {
            background: linear-gradient(135deg, #e5e7eb, #d1d5db);
            border: none;
        }

        .leaderboard-item.rank-3 {
            background: linear-gradient(135deg, #fed7aa, #fb923c);
            border: none;
        }

        .rank-badge {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            background: var(--bg-light);
            flex-shrink: 0;
        }

        .leaderboard-item.rank-1 .rank-badge,
        .leaderboard-item.rank-2 .rank-badge,
        .leaderboard-item.rank-3 .rank-badge {
            background: rgba(255,255,255,0.3);
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-stats {
            display: flex;
            gap: 15px;
            font-size: 14px;
            opacity: 0.9;
            flex-wrap: wrap;
        }

        .score-badge {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            flex-shrink: 0;
        }

        .leaderboard-item.rank-1 .score-badge,
        .leaderboard-item.rank-2 .score-badge,
        .leaderboard-item.rank-3 .score-badge {
            color: white;
        }

        /* Friend Cards */
        .friend-card {
            background: #f9fafb;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .friend-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .friend-progress {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .progress-stat {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }

        .progress-stat-value {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary);
        }

        .progress-stat-label {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 3px;
        }

        /* Challenge Cards */
        .challenge-card {
            background: rgba(255,255,255,0.2);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .challenge-progress-bar {
            height: 10px;
            background: rgba(255,255,255,0.3);
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }

        .challenge-progress-fill {
            height: 100%;
            background: white;
            transition: width 0.3s;
        }

        /* Share Modal */
        .share-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .share-option {
            padding: 20px;
            border: 2px solid var(--border);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .share-option:hover {
            border-color: var(--primary);
            background: #f9fafb;
        }

        .share-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        /* Progress Card for Sharing */
        .progress-share-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            margin: 20px 0;
        }

        .progress-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .progress-item {
            text-align: center;
        }

        .progress-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .progress-label {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* Settings Styles */
        .setting-item {
            padding: 20px;
            background: #f9fafb;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .setting-item h4 {
            margin-bottom: 5px;
            font-size: 18px;
        }

        .setting-info {
            margin-bottom: 10px;
        }

        .connected-badge {
            display: inline-block;
            background: var(--secondary);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-top: 10px;
        }

        .disconnected-badge {
            display: inline-block;
            background: var(--text-light);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-top: 10px;
        }

        /* Background Theme Styles */
        .theme-option {
            cursor: pointer;
            padding: 10px;
            border: 3px solid transparent;
            border-radius: 12px;
            transition: all 0.3s;
        }

        .theme-option:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .theme-option.active {
            border-color: var(--primary);
            background: #f9fafb;
        }

        /* Background overlay for opacity control */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0);
            pointer-events: none;
            z-index: 0;
            transition: background 0.3s;
        }

        body.has-overlay::before {
            background: rgba(0, 0, 0, var(--overlay-opacity, 0));
        }

        .container {
            position: relative;
            z-index: 1;
        }

        .workout-mode-overlay {
            z-index: 3000;
        }

        /* Workout Mode Styles */
        .workout-mode-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 3000;
            display: none;
            flex-direction: column;
        }

        .workout-mode-overlay.active {
            display: flex;
        }

        .workout-header {
            padding: 20px;
            background: rgba(0,0,0,0.3);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .workout-progress {
            font-size: 18px;
            font-weight: bold;
        }

        .workout-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            overflow-y: auto;
        }

        .exercise-card-large {
            background: white;
            border-radius: 25px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.4s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .exercise-name-large {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--primary);
        }

        .exercise-details-large {
            font-size: 24px;
            color: var(--text-light);
            margin-bottom: 30px;
        }

        .set-tracker {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .set-indicator {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .set-indicator.completed {
            background: var(--secondary);
            color: white;
            transform: scale(1.1);
        }

        .set-indicator.active {
            background: var(--primary);
            color: white;
            transform: scale(1.2);
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
        }

        .timer-display {
            font-size: 72px;
            font-weight: bold;
            color: var(--primary);
            margin: 30px 0;
            font-variant-numeric: tabular-nums;
        }

        .timer-label {
            font-size: 18px;
            color: var(--text-light);
            margin-bottom: 10px;
        }

        .rest-timer {
            background: var(--warning);
            color: white;
            padding: 40px;
            border-radius: 25px;
            text-align: center;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .rest-timer .timer-display {
            color: white;
            font-size: 96px;
        }

        .workout-button {
            padding: 20px 50px;
            font-size: 24px;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            margin-top: 30px;
            transition: transform 0.2s;
        }

        .workout-button:active {
            transform: scale(0.95);
        }

        .btn-set-done {
            background: var(--secondary);
            color: white;
        }

        .btn-skip-rest {
            background: white;
            color: var(--warning);
        }

        .btn-exit-workout {
            background: var(--danger);
            color: white;
            padding: 10px 20px;
            font-size: 16px;
        }

        .workout-instructions {
            background: #f9fafb;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            text-align: left;
        }

        .workout-instructions h4 {
            margin-bottom: 10px;
            color: var(--primary);
        }

        .workout-instructions ul {
            padding-left: 25px;
            color: var(--text-light);
        }

        .workout-instructions li {
            margin: 8px 0;
        }

        /* Progress Ring */
        .progress-ring {
            width: 200px;
            height: 200px;
            margin: 30px auto;
        }

        .progress-ring-circle {
            transition: stroke-dashoffset 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        /* Celebration Animation */
        @keyframes celebrate {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .celebration {
            animation: celebrate 0.6s ease-in-out;
        }

        /* Hidden file input */
        input[type="file"] {
            display: none;
        }

        .streak-flame {
            font-size: 24px;
            animation: flicker 1.5s infinite;
        }

        @keyframes flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; transform: scale(1.1); }
        }
    </style>
    
    <!-- Easy-Peasy AI Bot Widget -->
    <script 
        src="https://bots.easy-peasy.ai/chat.min.js" 
        data-chat-url="https://bots.easy-peasy.ai/bot/b0a8df9c-9a01-4d51-a052-81d6f0ddac59" 
        data-btn-position="bottom-right"
        data-widget-btn-color="#6366f1"
        defer>
    </script>
</head>
<body>
    <div class="container">
        <!-- Header with User Stats -->
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div class="user-profile">
                    <div class="avatar" onclick="document.getElementById('avatarUpload').click()">
                        <span id="avatarInitial">U</span>
                        <div class="avatar-upload">üì∑</div>
                    </div>
                    <input type="file" id="avatarUpload" accept="image/*">
                    <div class="user-info">
                        <h1 id="userName">Warrior</h1>
                        <span class="level-badge">Level <span id="userLevel">1</span></span>
                        <div style="margin-top: 10px; color: var(--text-light);">
                            <span class="streak-flame">üî•</span>
                            <strong id="streakDays">0</strong> day streak
                        </div>
                    </div>
                </div>
                <button onclick="showSection('settings')" style="background: white; border: 2px solid var(--border); border-radius: 12px; padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 16px; font-weight: 600; transition: all 0.3s;">
                    ‚öôÔ∏è Settings
                </button>
            </div>

            <!-- XP Progress -->
            <div class="xp-container">
                <div class="xp-bar">
                    <div class="xp-fill" id="xpFill" style="width: 0%">
                        <span class="xp-text"><span id="currentXP">0</span> / <span id="maxXP">100</span> XP</span>
                    </div>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-value" id="totalWorkouts">0</span>
                    <span class="stat-label">Total Workouts</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="currentWeight">---</span>
                    <span class="stat-label">Current Weight</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="goalWeight">---</span>
                    <span class="stat-label">Goal Weight</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="achievements">0</span>
                    <span class="stat-label">Achievements</span>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('workout')">Today's Workout</button>
            <button class="nav-tab" onclick="showSection('ai-coach')">AI Coach</button>
            <button class="nav-tab" onclick="showSection('body-scan')">Body Analysis</button>
            <button class="nav-tab" onclick="showSection('progress')">Progress Photos</button>
            <button class="nav-tab" onclick="showSection('social')">üèÜ Leaderboard</button>
            <button class="nav-tab" onclick="showSection('achievements')">Achievements</button>
            <button class="nav-tab" onclick="showSection('plan')">My Plan</button>
            <button class="nav-tab" onclick="showSection('settings')">‚öôÔ∏è Settings</button>
        </div>

        <!-- Today's Workout Section -->
        <div id="workout" class="content-section active">
            <div class="workout-card">
                <h2>üí™ Today's Challenge</h2>
                <p>Complete today's workout to maintain your streak!</p>
                <div class="workout-meta">
                    <div class="meta-item">‚è±Ô∏è 45 minutes</div>
                    <div class="meta-item">üî• 250 calories</div>
                    <div class="meta-item">üíé +50 XP</div>
                </div>
                <button class="btn" onclick="startWorkout()">Start Workout</button>
            </div>

            <h3 style="margin-bottom: 15px;">Today's Exercises</h3>
            <div class="exercise-list" id="exerciseList">
                <!-- Exercises will be populated here -->
            </div>

            <button class="btn btn-success" onclick="completeWorkout()" style="width: 100%; margin-top: 20px;">
                ‚úÖ Complete Workout & Earn XP
            </button>
        </div>

        <!-- AI Coach Section -->
        <div id="ai-coach" class="content-section">
            <h2 style="margin-bottom: 20px;">ü§ñ Your AI Fitness Coach</h2>
            
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px; border-radius: 20px; color: white; text-align: center; margin-bottom: 30px;">
                <div style="font-size: 64px; margin-bottom: 20px;">üí¨</div>
                <h3 style="color: white; margin-bottom: 15px; font-size: 24px;">Easy-Peasy AI Coach Active!</h3>
                <p style="font-size: 16px; margin-bottom: 20px; opacity: 0.95;">
                    Your AI-powered fitness coach is ready to help you succeed. Look for the chat widget in the <strong>bottom-right corner</strong> of your screen.
                </p>
                <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 12px; margin-top: 25px;">
                    <p style="font-size: 14px; margin-bottom: 15px;"><strong>Click the chat button to:</strong></p>
                    <div style="text-align: left; max-width: 400px; margin: 0 auto;">
                        <p style="margin: 8px 0;">‚úì Get personalized workout advice</p>
                        <p style="margin: 8px 0;">‚úì Ask about nutrition and meal plans</p>
                        <p style="margin: 8px 0;">‚úì Upload photos for body analysis</p>
                        <p style="margin: 8px 0;">‚úì Track your progress with AI insights</p>
                        <p style="margin: 8px 0;">‚úì Set and achieve your fitness goals</p>
                    </div>
                </div>
            </div>

            <div style="background: white; padding: 30px; border-radius: 15px; border: 2px solid var(--border);">
                <h3 style="margin-bottom: 15px;">üéØ How to Use Your AI Coach</h3>
                <div style="display: grid; gap: 20px; margin-top: 20px;">
                    <div style="display: flex; gap: 15px; align-items: start;">
                        <div style="background: var(--primary); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">1</div>
                        <div>
                            <h4 style="margin-bottom: 5px;">Find the Chat Widget</h4>
                            <p style="color: var(--text-light); font-size: 14px;">Look for the purple chat button in the bottom-right corner of your screen.</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: start;">
                        <div style="background: var(--primary); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">2</div>
                        <div>
                            <h4 style="margin-bottom: 5px;">Start a Conversation</h4>
                            <p style="color: var(--text-light); font-size: 14px;">Click the widget to open the chat and ask any fitness-related question or upload progress photos.</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: start;">
                        <div style="background: var(--primary); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">3</div>
                        <div>
                            <h4 style="margin-bottom: 5px;">Upload Images for Analysis</h4>
                            <p style="color: var(--text-light); font-size: 14px;">Use the image upload feature in the chat to share progress photos, form checks, or meal plans for AI analysis.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div style="background: #f0f9ff; padding: 20px; border-radius: 12px; margin-top: 20px;">
                <h4 style="color: var(--primary); margin-bottom: 10px;">üí° Pro Tips</h4>
                <ul style="color: var(--text-dark); font-size: 14px; padding-left: 20px; line-height: 1.8;">
                    <li>Upload progress photos directly in the chat for instant AI body analysis</li>
                    <li>Share your current fitness level and the AI will tailor advice to you</li>
                    <li>Ask specific questions for more detailed responses</li>
                    <li>Upload meal photos for nutrition feedback and calorie estimates</li>
                    <li>Use the chat for motivation when you need an extra push</li>
                    <li>The AI is available 24/7 - chat anytime you need support</li>
                </ul>
            </div>
        </div>

        <!-- Body Scan Section -->
        <div id="body-scan" class="content-section">
            <h2 style="margin-bottom: 20px;">üì∏ Body Type Analysis</h2>
            <p style="color: var(--text-light); margin-bottom: 20px;">
                Upload photos for professional body type analysis and personalized recommendations.
            </p>

            <div class="photo-upload-zone" onclick="document.getElementById('bodyScanUpload').click()">
                <div style="font-size: 48px; margin-bottom: 15px;">üì∑</div>
                <h3>Upload Body Photos</h3>
                <p style="color: var(--text-light); margin-top: 10px;">
                    Upload front, side, and back photos for accurate analysis
                </p>
            </div>
            <input type="file" id="bodyScanUpload" accept="image/*" multiple onchange="analyzebodyPhotos(event)">

            <div class="camera-container" style="display: none;" id="cameraSection">
                <h3 style="color: white; margin-bottom: 20px;">Or Take Photos Now</h3>
                <div class="camera-preview" id="cameraPreview">
                    <p>Click "Enable Camera" to start</p>
                </div>
                <button class="btn" onclick="enableCamera()">üì∑ Enable Camera</button>
                <button class="btn btn-success" onclick="capturePhoto()" style="display: none;" id="captureBtn">
                    üì∏ Capture Photo
                </button>
            </div>

            <div id="analysisResults" style="margin-top: 30px; display: none;">
                <h3>Analysis Results</h3>
                <div style="background: #f9fafb; padding: 25px; border-radius: 15px; margin-top: 15px;">
                    <div id="analysisContent"></div>
                </div>
            </div>
        </div>

        <!-- Progress Photos Section -->
        <div id="progress" class="content-section">
            <h2 style="margin-bottom: 20px;">üìä Progress Tracker</h2>
            <p style="color: var(--text-light); margin-bottom: 20px;">
                Track your transformation with detailed progress photos and AI analysis over time.
            </p>

            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="openProgressUpload()">
                    ‚ûï Add Progress Photo
                </button>
                <button class="btn btn-success" onclick="viewSlideshow()" id="slideshowBtn" style="display: none;">
                    üé¨ View Transformation Slideshow
                </button>
                <button class="btn" onclick="comparePhotos()" id="compareBtn" style="display: none;">
                    üîÑ Compare Photos
                </button>
            </div>

            <!-- Progress upload modal -->
            <div class="modal" id="progressUploadModal">
                <div class="modal-content">
                    <h2 style="margin-bottom: 20px;">Add Progress Photo</h2>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">Select Body Part to Track</label>
                        <select id="bodyPartSelect" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 16px;">
                            <option value="full-body-front">Full Body - Front</option>
                            <option value="full-body-side">Full Body - Side</option>
                            <option value="full-body-back">Full Body - Back</option>
                            <option value="face">Face/Neck</option>
                            <option value="chest">Chest</option>
                            <option value="arms">Arms</option>
                            <option value="abs">Abs/Core</option>
                            <option value="legs">Legs</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">üìÖ Photo Date</label>
                        <input 
                            type="date" 
                            id="photoDatePicker" 
                            style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 16px;"
                        >
                        <p style="font-size: 13px; color: var(--text-light); margin-top: 5px;">
                            Select when this photo was taken (defaults to today)
                        </p>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">Current Weight (optional)</label>
                        <input type="number" id="photoWeight" placeholder="e.g., 245" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 16px;">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 12px; font-weight: bold;">Choose Photo Source</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <button class="btn btn-primary" onclick="document.getElementById('cameraInput').click()" style="padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                <span style="font-size: 32px;">üì∑</span>
                                <span>Take Photo</span>
                            </button>
                            <button class="btn btn-primary" onclick="document.getElementById('galleryInput').click()" style="padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                <span style="font-size: 32px;">üñºÔ∏è</span>
                                <span>From Gallery</span>
                            </button>
                        </div>
                        <input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="processProgressPhoto(event)" style="display: none;">
                        <input type="file" id="galleryInput" accept="image/*" onchange="processProgressPhoto(event)" style="display: none;">
                    </div>

                    <div id="photoPreviewContainer" style="display: none; margin-bottom: 20px;">
                        <img id="photoPreviewImage" style="width: 100%; border-radius: 12px; max-height: 300px; object-fit: cover;">
                        <p style="text-align: center; margin-top: 10px; color: var(--secondary); font-weight: bold;">
                            ‚úì Photo selected
                        </p>
                    </div>

                    <button class="btn" onclick="closeProgressUpload()" style="width: 100%;">
                        Cancel
                    </button>
                </div>
            </div>

            <!-- Photo timeline -->
            <div id="progressTimeline" style="margin-top: 30px;">
                <!-- Timeline will be populated here -->
            </div>

            <!-- Slideshow modal -->
            <div class="modal" id="slideshowModal">
                <div class="modal-content" style="max-width: 900px; padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>üé¨ Your Transformation Journey</h2>
                        <button onclick="closeSlideshow()" style="background: none; border: none; font-size: 28px; cursor: pointer;">‚úï</button>
                    </div>
                    
                    <div id="slideshowContainer" style="position: relative; background: #000; border-radius: 15px; overflow: hidden; min-height: 500px;">
                        <img id="slideshowImage" style="width: 100%; height: auto; display: block;">
                        <div id="slideshowInfo" style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.8); color: white; padding: 20px;">
                            <!-- Slideshow info -->
                        </div>
                    </div>

                    <div style="display: flex; justify-content: center; gap: 15px; margin-top: 20px;">
                        <button class="btn" onclick="previousSlide()">‚¨ÖÔ∏è Previous</button>
                        <button class="btn btn-primary" onclick="toggleAutoplay()" id="autoplayBtn">‚ñ∂Ô∏è Autoplay</button>
                        <button class="btn" onclick="nextSlide()">Next ‚û°Ô∏è</button>
                    </div>

                    <div id="slideshowAnalysis" style="margin-top: 30px; background: #f9fafb; padding: 25px; border-radius: 15px;">
                        <!-- AI analysis will appear here -->
                    </div>
                </div>
            </div>

            <!-- Comparison modal -->
            <div class="modal" id="compareModal">
                <div class="modal-content" style="max-width: 1000px;">
                    <h2 style="margin-bottom: 20px;">üìä Photo Comparison</h2>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">Before</label>
                            <select id="beforeSelect" onchange="updateComparison()" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 16px; margin-bottom: 15px;">
                                <!-- Options populated by JS -->
                            </select>
                            <div id="beforeImage" style="background: #f3f4f6; border-radius: 12px; min-height: 400px; display: flex; align-items: center; justify-content: center;">
                                <p style="color: var(--text-light);">Select a photo</p>
                            </div>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">After</label>
                            <select id="afterSelect" onchange="updateComparison()" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 16px; margin-bottom: 15px;">
                                <!-- Options populated by JS -->
                            </select>
                            <div id="afterImage" style="background: #f3f4f6; border-radius: 12px; min-height: 400px; display: flex; align-items: center; justify-content: center;">
                                <p style="color: var(--text-light);">Select a photo</p>
                            </div>
                        </div>
                    </div>

                    <div id="comparisonAnalysis" style="background: #f9fafb; padding: 25px; border-radius: 15px; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 15px;">AI Analysis</h3>
                        <p style="color: var(--text-light);">Select two photos to compare</p>
                    </div>

                    <button class="btn btn-primary" onclick="closeComparison()" style="width: 100%;">
                        Close
                    </button>
                </div>
            </div>
        </div>

        <!-- Achievements Section -->
        <div id="achievements" class="content-section">
            <h2 style="margin-bottom: 20px;">üèÜ Achievements</h2>
            <p style="color: var(--text-light); margin-bottom: 20px;">
                Unlock achievements as you progress on your fitness journey!
            </p>

            <div class="achievements-grid" id="achievementsGrid">
                <!-- Achievements will be populated here -->
            </div>
        </div>

        <!-- Social/Leaderboard Section -->
        <div id="social" class="content-section">
            <h2 style="margin-bottom: 20px;">üèÜ Leaderboard & Friends</h2>
            
            <!-- Friend Code Section -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 25px;">
                <h3 style="margin-bottom: 15px;">üë• Your Friend Code</h3>
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <div>
                        <div style="font-size: 24px; font-weight: bold; letter-spacing: 2px;" id="friendCode">LOADING...</div>
                        <p style="margin-top: 5px; font-size: 14px; opacity: 0.9;">Share this code with friends to connect</p>
                    </div>
                    <button class="btn" onclick="copyFriendCode()" style="background: white; color: var(--primary);">
                        üìã Copy Code
                    </button>
                </div>
            </div>

            <!-- Add Friend Section -->
            <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; border: 2px solid var(--border);">
                <h3 style="margin-bottom: 15px;">‚ûï Add a Friend</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <input 
                        type="text" 
                        id="addFriendInput" 
                        placeholder="Enter friend code (e.g., FIT-ABC123)"
                        style="flex: 1; min-width: 200px; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 16px;"
                    >
                    <button class="btn btn-primary" onclick="addFriend()">
                        Add Friend
                    </button>
                </div>
            </div>

            <!-- Tabs for different leaderboards -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <button class="btn" onclick="showLeaderboard('friends')" id="friendsLeaderboardBtn" style="background: var(--primary); color: white;">
                    üë• Friends
                </button>
                <button class="btn" onclick="showLeaderboard('global')" id="globalLeaderboardBtn">
                    üåç Global
                </button>
                <button class="btn" onclick="showLeaderboard('streaks')" id="streaksLeaderboardBtn">
                    üî• Streaks
                </button>
            </div>

            <!-- Leaderboard Display -->
            <div id="leaderboardContainer">
                <!-- Leaderboard will be populated here -->
            </div>

            <!-- My Progress Summary (Shareable) -->
            <div style="background: white; padding: 25px; border-radius: 15px; margin-top: 25px; border: 2px solid var(--border);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <h3>üìä My Progress Summary</h3>
                    <button class="btn btn-success" onclick="shareProgress()">
                        üì§ Share Progress
                    </button>
                </div>
                
                <div id="progressSummary" style="display: grid; gap: 15px;">
                    <!-- Progress summary cards -->
                </div>
            </div>

            <!-- Friends List -->
            <div style="background: white; padding: 25px; border-radius: 15px; margin-top: 25px; border: 2px solid var(--border);">
                <h3 style="margin-bottom: 20px;">üë• My Friends</h3>
                <div id="friendsList">
                    <!-- Friends will be displayed here -->
                </div>
            </div>

            <!-- Challenge Section -->
            <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 25px; border-radius: 15px; margin-top: 25px;">
                <h3 style="margin-bottom: 15px;">‚öîÔ∏è Weekly Challenges</h3>
                <p style="margin-bottom: 20px; opacity: 0.9;">Compete with friends in weekly fitness challenges!</p>
                <div id="challengesList">
                    <!-- Active challenges -->
                </div>
                <button class="btn" onclick="createChallenge()" style="background: white; color: var(--secondary); margin-top: 15px;">
                    ‚ûï Create Challenge
                </button>
            </div>
        </div>

        <!-- Achievements Section -->
        <div id="achievements" class="content-section">
            <h2 style="margin-bottom: 20px;">üèÜ Achievements</h2>
            <p style="color: var(--text-light); margin-bottom: 20px;">
                Unlock achievements as you progress on your fitness journey!
            </p>

            <div class="achievements-grid" id="achievementsGrid">
                <!-- Achievements will be populated here -->
            </div>
        </div>

        <!-- My Plan Section -->
        <div id="plan" class="content-section">
            <h2 style="margin-bottom: 20px;">üìã Your Personalized Plan</h2>
            
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 25px;">
                <h3>Goal: Mesomorph Transformation</h3>
                <p style="margin-top: 10px;">Target: 210-230 lbs by Summer</p>
            </div>

            <div style="display: grid; gap: 20px;">
                <div style="background: #f9fafb; padding: 25px; border-radius: 15px;">
                    <h3 style="margin-bottom: 15px;">üìÖ Weekly Schedule</h3>
                    <div id="weeklySchedule"></div>
                </div>

                <div style="background: #f9fafb; padding: 25px; border-radius: 15px;">
                    <h3 style="margin-bottom: 15px;">üçΩÔ∏è Nutrition Guidelines</h3>
                    <div id="nutritionPlan"></div>
                </div>

                <div style="background: #f9fafb; padding: 25px; border-radius: 15px;">
                    <h3 style="margin-bottom: 15px;">üéØ Current Focus</h3>
                    <p style="color: var(--text-light);">Based on your body type (Endomorph-Mesomorph), we're focusing on:</p>
                    <ul style="margin-top: 15px; padding-left: 25px; color: var(--text-light);">
                        <li>Strength training 4x per week</li>
                        <li>Cardio 3-4x per week</li>
                        <li>High protein intake (170-210g/day)</li>
                        <li>Progressive overload for muscle building</li>
                    </ul>
                </div>
            </div>

            <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="customizePlan()">
                ‚öôÔ∏è Customize My Plan
            </button>
        </div>

        <!-- Settings Section -->
        <div id="settings" class="content-section">
            <h2 style="margin-bottom: 20px;">‚öôÔ∏è Settings & Integrations</h2>

            <!-- Device Connections -->
            <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; border: 2px solid var(--border);">
                <h3 style="margin-bottom: 20px;">üì± Device Integrations</h3>
                
                <!-- Apple Watch -->
                <div class="setting-item">
                    <div class="setting-info">
                        <div style="font-size: 32px; margin-bottom: 10px;">‚åö</div>
                        <h4>Apple Watch (Bluetooth)</h4>
                        <p style="color: var(--text-light); margin-top: 5px;">
                            Connect your Apple Watch via Bluetooth for heart rate tracking
                        </p>
                        <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-top: 10px; font-size: 13px;">
                            <strong>‚ö†Ô∏è Browser Limitation:</strong> Web apps cannot directly access Apple Watch data. This requires:
                            <ul style="margin-top: 5px; padding-left: 20px;">
                                <li>Bluetooth Web API support (Chrome/Edge only)</li>
                                <li>Manual pairing with watch as Bluetooth device</li>
                                <li>Limited to heart rate data only</li>
                            </ul>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="connectAppleWatchBluetooth()" id="appleWatchBtn">
                            üîó Connect via Bluetooth
                        </button>
                        <div id="appleWatchStatus" style="margin-top: 10px; display: none;"></div>
                    </div>
                </div>

                <div style="height: 1px; background: var(--border); margin: 25px 0;"></div>

                <!-- Fitness Trackers -->
                <div class="setting-item">
                    <div class="setting-info">
                        <div style="font-size: 32px; margin-bottom: 10px;">üìä</div>
                        <h4>Fitness Trackers</h4>
                        <p style="color: var(--text-light); margin-top: 5px;">
                            Connect Fitbit, Garmin, Polar, or other heart rate monitors via Bluetooth
                        </p>
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn" onclick="connectBluetoothDevice()" id="bluetoothBtn">
                            üîµ Connect via Bluetooth
                        </button>
                        <div id="bluetoothStatus" style="margin-top: 10px; display: none;"></div>
                    </div>
                </div>
            </div>

            <!-- Music Integration -->
            <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; border: 2px solid var(--border);">
                <h3 style="margin-bottom: 20px;">üéµ Workout Music</h3>
                
                <!-- Spotify -->
                <div class="setting-item">
                    <div class="setting-info">
                        <div style="font-size: 32px; margin-bottom: 10px;">üéµ</div>
                        <h4>Spotify Playlist</h4>
                        <p style="color: var(--text-light); margin-top: 5px;">
                            Link a Spotify playlist to play during workouts
                        </p>
                        <div style="background: #e8f5e9; padding: 12px; border-radius: 8px; margin-top: 10px; font-size: 13px;">
                            <strong>‚úì How it works:</strong> Enter a Spotify playlist URL. During workouts, you'll get a button to open it in Spotify app/web player.
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <input 
                            type="text" 
                            id="spotifyPlaylistInput" 
                            placeholder="Paste Spotify playlist URL"
                            style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 14px; margin-bottom: 10px;"
                        >
                        <button class="btn btn-success" onclick="saveSpotifyPlaylist()">
                            ‚úì Save Playlist
                        </button>
                        <div id="spotifyStatus" style="margin-top: 10px; display: none;"></div>
                    </div>
                </div>

                <div style="height: 1px; background: var(--border); margin: 25px 0;"></div>

                <!-- Apple Music -->
                <div class="setting-item">
                    <div class="setting-info">
                        <div style="font-size: 32px; margin-bottom: 10px;">üéµ</div>
                        <h4>Apple Music Playlist</h4>
                        <p style="color: var(--text-light); margin-top: 5px;">
                            Link an Apple Music playlist for your workouts
                        </p>
                        <div style="background: #e8f5e9; padding: 12px; border-radius: 8px; margin-top: 10px; font-size: 13px;">
                            <strong>‚úì How it works:</strong> Enter an Apple Music playlist URL. Opens in Apple Music app when you start a workout.
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <input 
                            type="text" 
                            id="appleMusicPlaylistInput" 
                            placeholder="Paste Apple Music playlist URL"
                            style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 14px; margin-bottom: 10px;"
                        >
                        <button class="btn btn-success" onclick="saveAppleMusicPlaylist()">
                            ‚úì Save Playlist
                        </button>
                        <div id="appleMusicStatus" style="margin-top: 10px; display: none;"></div>
                    </div>
                </div>

                <div style="height: 1px; background: var(--border); margin: 25px 0;"></div>

                <!-- YouTube Music -->
                <div class="setting-item">
                    <div class="setting-info">
                        <div style="font-size: 32px; margin-bottom: 10px;">üì∫</div>
                        <h4>YouTube Playlist</h4>
                        <p style="color: var(--text-light); margin-top: 5px;">
                            Link a YouTube or YouTube Music playlist
                        </p>
                        <div style="background: #e8f5e9; padding: 12px; border-radius: 8px; margin-top: 10px; font-size: 13px;">
                            <strong>‚úì How it works:</strong> Enter a YouTube playlist URL. Opens in YouTube app/site during workouts.
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <input 
                            type="text" 
                            id="youtubePlaylistInput" 
                            placeholder="Paste YouTube playlist URL"
                            style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 14px; margin-bottom: 10px;"
                        >
                        <button class="btn btn-success" onclick="saveYoutubePlaylist()">
                            ‚úì Save Playlist
                        </button>
                        <div id="youtubeStatus" style="margin-top: 10px; display: none;"></div>
                    </div>
                </div>

                <!-- Music Integration Info -->
                <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-top: 20px; font-size: 13px;">
                    <strong>‚ÑπÔ∏è Important Notes:</strong>
                    <ul style="margin-top: 8px; padding-left: 20px; line-height: 1.6;">
                        <li>Music plays in separate app/browser tab (not embedded)</li>
                        <li>You'll need active subscription for Spotify/Apple Music</li>
                        <li>YouTube playlists work for free users</li>
                        <li>Music controls happen in your music app, not here</li>
                        <li>We provide quick-launch buttons during workouts</li>
                    </ul>
                </div>
            </div>

            <!-- Data Sync Options -->
            <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; border: 2px solid var(--border);">
                <h3 style="margin-bottom: 20px;">‚òÅÔ∏è Data Backup Options</h3>
                
                <!-- Google Account -->
                <div class="setting-item">
                    <div class="setting-info">
                        <div style="font-size: 32px; margin-bottom: 10px;">üîµ</div>
                        <h4>Google Drive Backup</h4>
                        <p style="color: var(--text-light); margin-top: 5px;">
                            Automatic cloud backup to Google Drive
                        </p>
                        <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-top: 10px; font-size: 13px;">
                            <strong>‚ö†Ô∏è Not Currently Available:</strong> Google Drive integration requires OAuth 2.0 authentication with backend server. Use manual export instead.
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn" onclick="connectGoogle()" id="googleBtn" style="background: #e5e7eb; color: var(--text-dark);">
                            ‚ÑπÔ∏è Learn More
                        </button>
                        <div id="googleStatus" style="margin-top: 10px; display: none;"></div>
                    </div>
                </div>

                <div style="height: 1px; background: var(--border); margin: 25px 0;"></div>

                <!-- Email Backup -->
                <div class="setting-item">
                    <div class="setting-info">
                        <div style="font-size: 32px; margin-bottom: 10px;">üìß</div>
                        <h4>Email Progress Reports</h4>
                        <p style="color: var(--text-light); margin-top: 5px;">
                            Save your email to receive weekly progress summaries
                        </p>
                        <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-top: 10px; font-size: 13px;">
                            <strong>‚ö†Ô∏è Email Storage Only:</strong> Your email is saved locally for future email report features. No emails are sent currently without backend server.
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <input 
                            type="email" 
                            id="emailInput" 
                            placeholder="your.email@example.com"
                            style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 16px; margin-bottom: 10px;"
                        >
                        <button class="btn btn-success" onclick="setupEmailBackup()">
                            üíæ Save Email for Future Reports
                        </button>
                        <div id="emailStatus" style="margin-top: 10px; display: none;"></div>
                    </div>
                </div>

                <div style="height: 1px; background: var(--border); margin: 25px 0;"></div>

                <!-- Manual Backup Recommendation -->
                <div style="background: #e8f5e9; padding: 20px; border-radius: 12px;">
                    <h4 style="color: var(--secondary); margin-bottom: 10px;">‚úÖ Recommended: Manual Backup</h4>
                    <p style="font-size: 14px; margin-bottom: 15px;">
                        The most reliable way to backup your data is to export it manually as a JSON file.
                    </p>
                    <button class="btn btn-success" onclick="exportData()" style="width: 100%;">
                        üì• Export All Data Now
                    </button>
                    <p style="font-size: 12px; color: var(--text-light); margin-top: 10px; text-align: center;">
                        Save the file somewhere safe. You can import it anytime to restore your progress.
                    </p>
                </div>
            </div>

            <!-- Appearance Settings -->
            <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; border: 2px solid var(--border);">
                <h3 style="margin-bottom: 20px;">üé® Appearance & Background</h3>
                
                <!-- Font Size Control -->
                <div style="margin-bottom: 25px;">
                    <h4 style="margin-bottom: 15px;">Text Size</h4>
                    <p style="color: var(--text-light); font-size: 14px; margin-bottom: 15px;">
                        Adjust text size for better readability
                    </p>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span style="font-size: 12px;">A</span>
                        <input 
                            type="range" 
                            id="fontSizeSlider" 
                            min="80" 
                            max="130" 
                            value="100" 
                            style="flex: 1;"
                            oninput="adjustFontSize(this.value)"
                        >
                        <span style="font-size: 20px;">A</span>
                    </div>
                    <div style="text-align: center; margin-top: 10px; font-weight: bold; color: var(--primary);" id="fontSizeValue">
                        100% (Normal)
                    </div>
                </div>

                <div style="height: 1px; background: var(--border); margin: 25px 0;"></div>

                <!-- Button Size Control -->
                <div style="margin-bottom: 25px;">
                    <h4 style="margin-bottom: 15px;">Button Size</h4>
                    <p style="color: var(--text-light); font-size: 14px; margin-bottom: 15px;">
                        Make buttons larger for easier tapping
                    </p>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span style="font-size: 12px;">üîò</span>
                        <input 
                            type="range" 
                            id="buttonSizeSlider" 
                            min="80" 
                            max="130" 
                            value="100" 
                            style="flex: 1;"
                            oninput="adjustButtonSize(this.value)"
                        >
                        <span style="font-size: 20px;">üîò</span>
                    </div>
                    <div style="text-align: center; margin-top: 10px; font-weight: bold; color: var(--primary);" id="buttonSizeValue">
                        100% (Normal)
                    </div>
                </div>

                <div style="height: 1px; background: var(--border); margin: 25px 0;"></div>

                <!-- Background Themes -->
                <div style="margin-bottom: 25px;">
                    <h4 style="margin-bottom: 15px;">Choose Background Theme</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div class="theme-option" onclick="setBackgroundTheme('default')" data-theme="default">
                            <div style="height: 80px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; margin-bottom: 8px;"></div>
                            <p style="text-align: center; font-weight: bold; font-size: 14px;">Purple Gradient</p>
                        </div>
                        <div class="theme-option" onclick="setBackgroundTheme('ocean')" data-theme="ocean">
                            <div style="height: 80px; background: linear-gradient(135deg, #2196F3 0%, #00BCD4 100%); border-radius: 8px; margin-bottom: 8px;"></div>
                            <p style="text-align: center; font-weight: bold; font-size: 14px;">Ocean Blue</p>
                        </div>
                        <div class="theme-option" onclick="setBackgroundTheme('sunset')" data-theme="sunset">
                            <div style="height: 80px; background: linear-gradient(135deg, #FF6B6B 0%, #FFE66D 100%); border-radius: 8px; margin-bottom: 8px;"></div>
                            <p style="text-align: center; font-weight: bold; font-size: 14px;">Sunset</p>
                        </div>
                        <div class="theme-option" onclick="setBackgroundTheme('forest')" data-theme="forest">
                            <div style="height: 80px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); border-radius: 8px; margin-bottom: 8px;"></div>
                            <p style="text-align: center; font-weight: bold; font-size: 14px;">Forest Green</p>
                        </div>
                        <div class="theme-option" onclick="setBackgroundTheme('dark')" data-theme="dark">
                            <div style="height: 80px; background: linear-gradient(135deg, #232526 0%, #414345 100%); border-radius: 8px; margin-bottom: 8px;"></div>
                            <p style="text-align: center; font-weight: bold; font-size: 14px;">Dark Mode</p>
                        </div>
                        <div class="theme-option" onclick="setBackgroundTheme('fire')" data-theme="fire">
                            <div style="height: 80px; background: linear-gradient(135deg, #f12711 0%, #f5af19 100%); border-radius: 8px; margin-bottom: 8px;"></div>
                            <p style="text-align: center; font-weight: bold; font-size: 14px;">Fire</p>
                        </div>
                    </div>
                </div>

                <div style="height: 1px; background: var(--border); margin: 25px 0;"></div>

                <!-- Custom Background Upload -->
                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px;">Upload Custom Background</h4>
                    <p style="color: var(--text-light); font-size: 14px; margin-bottom: 15px;">
                        Use your own image as the app background. Best with landscape photos.
                    </p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="document.getElementById('backgroundUpload').click()">
                            üì∑ Choose Image
                        </button>
                        <button class="btn" onclick="removeCustomBackground()" id="removeBackgroundBtn" style="display: none;">
                            üóëÔ∏è Remove Custom Background
                        </button>
                    </div>
                    <input type="file" id="backgroundUpload" accept="image/*" style="display: none;" onchange="uploadCustomBackground(event)">
                    <div id="backgroundPreview" style="margin-top: 15px; display: none;">
                        <p style="font-size: 14px; color: var(--text-light); margin-bottom: 10px;">Preview:</p>
                        <img id="backgroundPreviewImage" style="width: 100%; max-height: 200px; object-fit: cover; border-radius: 12px;">
                    </div>
                </div>

                <div style="height: 1px; background: var(--border); margin: 25px 0;"></div>

                <!-- Background Opacity -->
                <div>
                    <h4 style="margin-bottom: 15px;">Background Opacity</h4>
                    <p style="color: var(--text-light); font-size: 14px; margin-bottom: 15px;">
                        Adjust background darkness for better text readability
                    </p>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span style="font-size: 14px;">Light</span>
                        <input 
                            type="range" 
                            id="opacitySlider" 
                            min="0" 
                            max="100" 
                            value="0" 
                            style="flex: 1;"
                            oninput="adjustBackgroundOpacity(this.value)"
                        >
                        <span style="font-size: 14px;">Dark</span>
                    </div>
                    <div style="text-align: center; margin-top: 10px; font-weight: bold; color: var(--primary);" id="opacityValue">
                        0% overlay
                    </div>
                </div>
            </div>

            <!-- AI Configuration -->
            <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; border: 2px solid var(--border);">
                <h3 style="margin-bottom: 20px;">ü§ñ AI Coach Configuration</h3>
                
                <!-- Easy-Peasy AI Widget -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 12px; margin-bottom: 25px; color: white;">
                    <h4 style="margin-bottom: 10px; color: white;">‚ö° Easy-Peasy AI Chat Widget (Active)</h4>
                    <p style="font-size: 14px; margin-bottom: 15px; opacity: 0.95;">
                        Your AI fitness coach is embedded as a chat widget in the bottom-right corner of your screen. Click the purple button to start chatting!
                    </p>
                    <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <p style="font-size: 13px; margin-bottom: 10px;"><strong>‚ú® Features:</strong></p>
                        <ul style="font-size: 13px; padding-left: 20px; line-height: 1.8;">
                            <li>24/7 AI-powered fitness guidance</li>
                            <li>Personalized workout and nutrition advice</li>
                            <li>üì∏ Image upload for body and meal analysis</li>
                            <li>Context-aware responses based on your progress</li>
                            <li>Always accessible from any page</li>
                        </ul>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 6px; font-size: 13px; text-align: center;">
                        <strong>üí¨ Look for the chat button ‚Üí Bottom-right corner</strong>
                    </div>
                </div>

                <!-- Gemini AI (Optional Alternative) -->
                <div style="background: #f0f9ff; padding: 20px; border-radius: 12px; margin-bottom: 20px; opacity: 0.7;">
                    <h4 style="color: var(--primary); margin-bottom: 10px;">Google Gemini AI (Legacy Option)</h4>
                    <p style="font-size: 14px; margin-bottom: 15px; color: var(--text-light);">
                        <em>Note: With Easy-Peasy AI widget active, Gemini integration is no longer needed. The settings below are kept for advanced users only.</em>
                    </p>
                    <p style="font-size: 14px; margin-bottom: 10px;">
                        <strong>How to get FREE Gemini API key:</strong>
                    </p>
                    <ol style="font-size: 14px; padding-left: 20px; margin-bottom: 15px;">
                        <li>Visit <a href="https://makersuite.google.com/app/apikey" target="_blank" style="color: var(--primary);">Google AI Studio</a></li>
                        <li>Sign in with your Google account</li>
                        <li>Click "Create API Key"</li>
                        <li>Copy the key and paste below</li>
                    </ol>
                    <p style="font-size: 13px; color: var(--text-light);">
                        <strong>Note:</strong> Your API key is stored locally on your device only. It's free with generous limits (60 requests/minute).
                    </p>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">Gemini API Key</label>
                    <input 
                        type="password" 
                        id="geminiApiKeyInput" 
                        placeholder="Paste your Gemini API key here"
                        style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 14px; margin-bottom: 10px; font-family: monospace;"
                    >
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="saveGeminiApiKey()">
                            ‚úì Connect Gemini AI
                        </button>
                        <button class="btn" onclick="toggleApiKeyVisibility()">
                            üëÅÔ∏è Show/Hide
                        </button>
                    </div>
                    <div id="geminiStatus" style="margin-top: 10px; display: none;"></div>
                </div>

                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; font-size: 13px;">
                    <strong>‚ö†Ô∏è Without API Key:</strong> The chatbot uses smart rule-based responses with your actual fitness data. Still helpful, just not as conversational as real AI!
                </div>
            </div>

            <!-- Notification Settings -->
            <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; border: 2px solid var(--border);">
                <h3 style="margin-bottom: 20px;">üîî Notifications & Preferences</h3>
                
                <div class="setting-item">
                    <label style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                        <div>
                            <h4>Daily Workout Reminders</h4>
                            <p style="color: var(--text-light); margin-top: 5px; font-size: 14px;">Get reminded at 9 AM daily</p>
                        </div>
                        <input type="checkbox" id="notificationToggle" onchange="toggleNotifications()" style="width: 24px; height: 24px; cursor: pointer;">
                    </label>
                </div>

                <div style="height: 1px; background: var(--border); margin: 20px 0;"></div>

                <div class="setting-item">
                    <label style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                        <div>
                            <h4>Weekly Progress Reports</h4>
                            <p style="color: var(--text-light); margin-top: 5px; font-size: 14px;">Receive summary every Sunday</p>
                        </div>
                        <input type="checkbox" id="weeklyReportToggle" onchange="toggleWeeklyReports()" style="width: 24px; height: 24px; cursor: pointer;" checked>
                    </label>
                </div>

                <div style="height: 1px; background: var(--border); margin: 20px 0;"></div>

                <div class="setting-item">
                    <label style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                        <div>
                            <h4>Friend Activity Notifications</h4>
                            <p style="color: var(--text-light); margin-top: 5px; font-size: 14px;">Get notified when friends complete workouts</p>
                        </div>
                        <input type="checkbox" id="friendActivityToggle" onchange="toggleFriendActivity()" style="width: 24px; height: 24px; cursor: pointer;">
                    </label>
                </div>
            </div>

            <!-- Data Management -->
            <div style="background: white; padding: 25px; border-radius: 15px; border: 2px solid var(--border);">
                <h3 style="margin-bottom: 20px;">üíæ Data Management</h3>
                
                <!-- Storage Space Indicator -->
                <div style="background: #f9fafb; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px;">üìä Storage Space Used</h4>
                    <div style="background: #e5e7eb; height: 30px; border-radius: 15px; overflow: hidden; margin-bottom: 10px;">
                        <div id="storageBar" style="height: 100%; background: linear-gradient(90deg, var(--secondary), var(--warning)); width: 0%; transition: all 0.3s;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 14px;">
                        <span id="storageUsed">0 MB</span>
                        <span id="storagePercent">0%</span>
                        <span id="storageTotal">~10 MB</span>
                    </div>
                    <div id="storageWarning" style="display: none; margin-top: 15px; padding: 12px; background: #fff3cd; border-radius: 8px; font-size: 14px;">
                        <strong>‚ö†Ô∏è Storage Warning:</strong> <span id="storageWarningText"></span>
                    </div>
                </div>
                
                <div style="display: grid; gap: 15px;">
                    <button class="btn" onclick="exportData()">
                        üì• Export All Data
                    </button>
                    <button class="btn" onclick="importData()">
                        üì§ Import Data
                    </button>
                    <button class="btn" onclick="clearCache()" style="background: var(--warning); color: white;">
                        üóëÔ∏è Clear Cache
                    </button>
                    <button class="btn" onclick="resetApp()" style="background: var(--danger); color: white;">
                        ‚ö†Ô∏è Reset All Data
                    </button>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; font-size: 14px;">
                    <strong>‚ö†Ô∏è Note:</strong> Resetting will delete all your progress, photos, and achievements. This cannot be undone unless you've backed up your data.
                </div>
            </div>
        </div>
    </div>

    <!-- Workout Mode Overlay -->
    <div class="workout-mode-overlay" id="workoutModeOverlay">
        <div class="workout-header">
            <div class="workout-progress" id="workoutProgress">
                Exercise 1 of 5
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn" onclick="openWorkoutMusic()" style="background: var(--secondary); color: white; padding: 10px 20px; font-size: 16px;">
                    üéµ Music
                </button>
                <button class="btn-exit-workout" onclick="exitWorkoutMode()">
                    ‚úï Exit
                </button>
            </div>
        </div>
        
        <div class="workout-main" id="workoutMain">
            <!-- Content will be dynamically inserted here -->
        </div>
    </div>

    <!-- Modal for customization -->
    <div class="modal" id="customModal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">Customize Your Plan</h2>
            <div id="modalContent"></div>
            <button class="btn btn-primary" onclick="closeModal()" style="width: 100%; margin-top: 20px;">
                Save Changes
            </button>
        </div>
    </div>

    <script>
        // ==========================================
        // INDEXEDDB SETUP - 50MB Storage (5x more than localStorage)
        // ==========================================
        let db;
        const DB_NAME = 'FitQuestDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'appData';

        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => {
                    console.log('IndexedDB not available, falling back to localStorage');
                    resolve(null);
                };
                
                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('IndexedDB initialized - 50MB storage available');
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME);
                    }
                };
            });
        }

        // ==========================================
        // SMART AI CHATBOT - Contextual & Personalized
        // ==========================================
        const smartChatbot = {
            conversationHistory: [],
            lastTopic: null,
            
            // Analyze user's current state
            analyzeUserState() {
                const user = appState.user;
                const today = new Date();
                const startDate = user.startDate ? new Date(user.startDate) : today;
                const daysSinceStart = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
                const weeksSinceStart = Math.floor(daysSinceStart / 7);
                
                return {
                    level: user.level,
                    xp: user.xp,
                    maxXP: user.maxXP,
                    streak: user.streak,
                    totalWorkouts: user.totalWorkouts,
                    currentWeight: user.currentWeight,
                    startWeight: user.startWeight,
                    goalWeight: user.goalWeight,
                    weightLost: user.startWeight - user.currentWeight,
                    weightToGo: user.currentWeight - user.goalWeight,
                    achievements: user.achievements.length,
                    photos: appState.progressPhotos.length,
                    daysSinceStart: daysSinceStart,
                    weeksSinceStart: weeksSinceStart,
                    hasPhotos: appState.progressPhotos.length > 0,
                    recentWorkout: appState.user.lastWorkoutDate
                };
            },
            
            // Generate smart, contextual response
            generateResponse(userMessage) {
                const state = this.analyzeUserState();
                const msg = userMessage.toLowerCase();
                
                // Store conversation
                this.conversationHistory.push({ user: userMessage, time: Date.now() });
                
                // Weight progress questions
                if (msg.includes('weight') || msg.includes('lost') || msg.includes('progress')) {
                    if (state.weightLost > 0) {
                        return `Amazing work! üí™ You've lost ${state.weightLost.toFixed(1)} lbs since you started ${state.weeksSinceStart} weeks ago. That's an average of ${(state.weightLost / state.weeksSinceStart).toFixed(1)} lbs per week! You're ${state.weightToGo.toFixed(1)} lbs away from your goal of ${state.goalWeight} lbs. Keep crushing it! üéØ`;
                    } else if (state.currentWeight && state.goalWeight) {
                        return `You're at ${state.currentWeight} lbs with a goal of ${state.goalWeight} lbs. You have ${state.weightToGo.toFixed(1)} lbs to go! Let's make it happen together! üí™`;
                    } else {
                        return `I don't see your weight data yet. Go to Profile and add your current and goal weight so I can track your progress! üìä`;
                    }
                }
                
                // Streak questions
                if (msg.includes('streak') || msg.includes('consistent')) {
                    if (state.streak >= 30) {
                        return `INCREDIBLE! üî• You have a ${state.streak} day streak! You're in the top 1% of users. Your consistency is legendary! Keep this momentum going! üí™`;
                    } else if (state.streak >= 7) {
                        return `Awesome ${state.streak} day streak! üî• You're building serious habits. Just ${30 - state.streak} more days to hit the legendary 30-day mark! You got this! üí™`;
                    } else if (state.streak > 0) {
                        return `You're on a ${state.streak} day streak! üî• Every day counts. Keep showing up and watch your streak grow! Tomorrow makes ${state.streak + 1}! üéØ`;
                    } else {
                        return `Your streak is at 0 right now, but that's okay! Today is the perfect day to start a new streak. One workout at a time! Let's do this! üí™`;
                    }
                }
                
                // Workout questions
                if (msg.includes('workout') || msg.includes('exercise') || msg.includes('train')) {
                    if (state.totalWorkouts > 50) {
                        return `Wow! You've completed ${state.totalWorkouts} workouts! üí™ You're Level ${state.level} now! That's some serious dedication. Your body is transforming! Keep going! üöÄ`;
                    } else if (state.totalWorkouts > 10) {
                        return `You've done ${state.totalWorkouts} workouts and reached Level ${state.level}! üéØ You're building momentum. Every workout makes you stronger! Let's keep this going! üí™`;
                    } else if (state.totalWorkouts > 0) {
                        return `You've completed ${state.totalWorkouts} workouts! üí™ Great start! Consistency is key. Try to hit at least 3 workouts per week for best results! You're on the right track! üéØ`;
                    } else {
                        return `I see you haven't started working out yet! No problem - today is perfect to begin! Check out the Exercises tab and pick a routine. Start with Day 1 and let's build this habit together! üí™`;
                    }
                }
                
                // Photo/transformation questions
                if (msg.includes('photo') || msg.includes('picture') || msg.includes('transformation') || msg.includes('look')) {
                    if (state.photos >= 5) {
                        return `You have ${state.photos} progress photos! üì∏ That's amazing! Have you checked out your slideshow in Progress Photos? You can see your transformation journey! Your hard work is visible! üí™`;
                    } else if (state.photos > 0) {
                        return `You have ${state.photos} progress photos so far! üì∏ Keep taking photos weekly. After 5 photos, you'll unlock an automatic transformation slideshow! ${5 - state.photos} more to go! üéØ`;
                    } else {
                        return `You haven't added any progress photos yet! üì∏ Photos are THE best way to track your transformation. Go to Progress Photos and take your first "before" pic. You'll thank yourself later! Trust me! üí™`;
                    }
                }
                
                // Achievement questions
                if (msg.includes('achievement') || msg.includes('badge') || msg.includes('unlock')) {
                    return `You've unlocked ${state.achievements} out of 8 achievements! üèÜ Your current level is ${state.level}. Keep working out, taking photos, and maintaining your streak to unlock more! Every achievement is a milestone! üéØ`;
                }
                
                // Motivation/encouragement
                if (msg.includes('motivate') || msg.includes('encourage') || msg.includes('tired') || msg.includes('hard')) {
                    const responses = [
                        `You've already done ${state.totalWorkouts} workouts and built a ${state.streak} day streak! You're capable of amazing things! Don't stop now! üí™`,
                        `Look at you - Level ${state.level}! You didn't get here by accident. You earned it! Keep pushing! The best version of you is coming! üî•`,
                        `Progress isn't always visible day-to-day, but look at your ${state.weeksSinceStart} weeks of commitment! You're building something incredible! üí™`,
                        `Every champion was once a beginner who refused to give up. You're ${state.daysSinceStart} days in - that's ${state.daysSinceStart} days of choosing yourself! Keep going! üöÄ`
                    ];
                    return responses[Math.floor(Math.random() * responses.length)];
                }
                
                // Level/XP questions
                if (msg.includes('level') || msg.includes('xp') || msg.includes('experience')) {
                    const xpToNext = state.maxXP - state.xp;
                    return `You're Level ${state.level} with ${state.xp}/${state.maxXP} XP! üéØ Just ${xpToNext} XP until Level ${state.level + 1}! Complete workouts to gain XP. Each workout gives you 50 XP! Let's level up! üí™`;
                }
                
                // Greeting
                if (msg.includes('hello') || msg.includes('hi ') || msg.includes('hey')) {
                    if (state.streak > 0) {
                        return `Hey there, warrior! üî• ${state.streak} day streak looking strong! What can I help you with today? Let's keep this momentum going! üí™`;
                    } else {
                        return `Hey! Welcome back! üí™ What brings you here today? Need workout tips? Want to check your progress? I'm here to help! üéØ`;
                    }
                }
                
                // Help/general
                if (msg.includes('help') || msg.includes('what can') || msg.includes('how do')) {
                    return `I can help you with: üìä Progress tracking (weight, streak, workouts), üí™ Workout advice, üì∏ Progress photos, üèÜ Achievements, üéØ Goal setting. I also know YOUR specific stats! Ask me about your weight loss, streak, or transformation! What would you like to know?`;
                }
                
                // Default contextual response
                const defaults = [
                    `You're doing great! ${state.weeksSinceStart} weeks in, Level ${state.level}, ${state.totalWorkouts} workouts completed! What else would you like to know? üí™`,
                    `I'm here to support your journey! You've already made ${state.weeksSinceStart} weeks of progress. Ask me about your weight, streak, workouts, or photos! üéØ`,
                    `Your stats: Level ${state.level}, ${state.streak} day streak, ${state.totalWorkouts} workouts! What can I help you with today? üí™`
                ];
                
                return defaults[Math.floor(Math.random() * defaults.length)];
            }
        };

        // ==========================================
        // EASY-PEASY AI INTEGRATION
        // ==========================================
        const easyPeasyAI = {
            botId: 'b0a8df9c-9a01-4d51-a052-81d6f0ddac59',
            apiEndpoint: 'https://api.easy-peasy.ai/v1/chat',
            enabled: true,
            
            isEnabled() {
                return this.enabled;
            },
            
            setEnabled(value) {
                this.enabled = value;
                appState.user.easyPeasyEnabled = value;
                saveData();
                showNotification(value ? 'Easy-Peasy AI enabled! ü§ñ' : 'Easy-Peasy AI disabled', 'success');
            },
            
            async sendToEasyPeasy(userMessage) {
                if (!this.isEnabled()) {
                    return null; // Fall through to next AI
                }
                
                try {
                    const state = smartChatbot.analyzeUserState();
                    const context = `User's fitness stats: Level ${state.level}, ${state.streak} day streak, ${state.totalWorkouts} workouts completed, current weight ${state.currentWeight}lbs, goal ${state.goalWeight}lbs, lost ${state.weightLost}lbs, ${state.photos} progress photos, ${state.weeksSinceStart} weeks of training.`;
                    
                    // Attempt to communicate with Easy-Peasy AI bot
                    // Using their iframe/widget approach
                    const fullMessage = `${context}\n\nUser question: ${userMessage}`;
                    
                    // Since Easy-Peasy typically uses iframe embedding, we'll try their API
                    // If this doesn't work, the fallback will catch it
                    const response = await fetch(`https://bots.easy-peasy.ai/api/chat/${this.botId}`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: fullMessage,
                            context: context
                        })
                    });
                    
                    if (!response.ok) {
                        console.log('Easy-Peasy API not accessible, falling back...');
                        return null; // Fall through to Gemini or smart chatbot
                    }
                    
                    const data = await response.json();
                    if (data.response || data.message || data.text) {
                        return data.response || data.message || data.text;
                    }
                    
                    return null; // Fall through if no valid response
                } catch (error) {
                    console.log('Easy-Peasy AI unavailable, using fallback:', error.message);
                    return null; // Fall through to next AI option
                }
            }
        };

        // GOOGLE GEMINI FREE AI - User Provides Their Own Free API Key
        // ==========================================
        const geminiAI = {
            apiKey: null,
            conversationHistory: [],
            
            hasApiKey() {
                return this.apiKey && this.apiKey.length > 20;
            },
            
            setApiKey(key) {
                this.apiKey = key;
                appState.user.geminiApiKey = key;
                saveData();
                showNotification('Gemini AI connected! üéâ', 'success');
            },
            
            async sendToGemini(userMessage) {
                if (!this.hasApiKey()) {
                    return this.getApiKeyPrompt();
                }
                
                try {
                    const state = smartChatbot.analyzeUserState();
                    const context = `You are a fitness coach. User's stats: Level ${state.level}, ${state.streak} day streak, ${state.totalWorkouts} workouts, ${state.currentWeight}lbs current, ${state.goalWeight}lbs goal, ${state.weightLost}lbs lost, ${state.photos} photos, ${state.weeksSinceStart} weeks training. Be encouraging and reference their data.`;
                    
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${this.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: `${context}\n\nUser: ${userMessage}` }]
                            }]
                        })
                    });
                    
                    if (!response.ok) {
                        if (response.status === 400) {
                            return 'Invalid API key. Please check your Gemini API key in Settings ‚Üí AI Settings.';
                        }
                        throw new Error('API error');
                    }
                    
                    const data = await response.json();
                    if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
                        return data.candidates[0].content.parts[0].text;
                    }
                    
                    return smartChatbot.generateResponse(userMessage);
                } catch (error) {
                    console.error('Gemini error:', error);
                    return smartChatbot.generateResponse(userMessage);
                }
            },
            
            getApiKeyPrompt() {
                return `ü§ñ <strong>Real AI Available!</strong><br><br>
                Connect to Google's Gemini AI for natural conversations!<br><br>
                <strong>FREE but needs your API key:</strong><br>
                1. Visit <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a><br>
                2. Click "Create API Key"<br>
                3. Copy your key<br>
                4. Add it in Settings ‚Üí AI Configuration<br><br>
                Using smart rule-based responses until then! üí™`;
            }
        };

        // App State
        let appState = {
            user: {
                name: 'Warrior',
                level: 1,
                xp: 0,
                maxXP: 100,
                streak: 0,
                totalWorkouts: 0,
                currentWeight: null,
                goalWeight: null,
                bodyType: 'Endomorph-Mesomorph',
                achievements: [],
                notificationsEnabled: false,
                lastWorkoutDate: null,
                friendCode: null,
                startWeight: null,
                startDate: null
            },
            friends: [],
            workouts: [],
            progressPhotos: [],
            todayExercises: [
                { name: 'Push-ups', sets: '4 sets', reps: '10-20 reps', xp: 10, completed: false, category: 'Push' },
                { name: 'Pike Push-ups', sets: '3 sets', reps: '8-12 reps', xp: 10, completed: false, category: 'Push' },
                { name: 'Chair Dips', sets: '3 sets', reps: '10-15 reps', xp: 10, completed: false, category: 'Push' },
                { name: 'Backpack Floor Press', sets: '3 sets', reps: '12 reps', xp: 10, completed: false, category: 'Push' },
                { name: 'Lateral Raises', sets: '3 sets', reps: '15 reps', xp: 10, completed: false, category: 'Push' }
            ],
            achievements: [
                { id: 1, name: 'First Workout', icon: 'üéØ', unlocked: false, description: 'Complete your first workout' },
                { id: 2, name: '7 Day Streak', icon: 'üî•', unlocked: false, description: 'Maintain a 7-day workout streak' },
                { id: 3, name: 'Level 5', icon: '‚≠ê', unlocked: false, description: 'Reach level 5' },
                { id: 4, name: 'Body Scan', icon: 'üì∏', unlocked: false, description: 'Complete your first body scan' },
                { id: 5, name: '25 Workouts', icon: 'üí™', unlocked: false, description: 'Complete 25 total workouts' },
                { id: 6, name: 'Goal Weight', icon: 'üéâ', unlocked: false, description: 'Reach your goal weight' }
            ],
            challenges: [],
            slideshowIndex: 0,
            autoplayInterval: null,
            currentLeaderboard: 'friends'
        };

        // Simulated global leaderboard data (in production, this would come from a backend)
        const globalLeaderboard = [
            { name: 'FitGod_Mike', level: 15, xp: 3450, streak: 45, totalWorkouts: 156, friendCode: 'FIT-MIKE99' },
            { name: 'IronSarah', level: 12, xp: 2890, streak: 32, totalWorkouts: 134, friendCode: 'FIT-SARAH7' },
            { name: 'BeastMode_Jay', level: 11, xp: 2670, streak: 28, totalWorkouts: 98, friendCode: 'FIT-JAY456' },
            { name: 'HealthyHabits', level: 10, xp: 2340, streak: 40, totalWorkouts: 112, friendCode: 'FIT-HABIT8' },
            { name: 'FlexAppeal', level: 9, xp: 2100, streak: 21, totalWorkouts: 87, friendCode: 'FIT-FLEX22' }
        ];

        // Load saved data
        function loadData() {
            if (db) {
                // Use IndexedDB (50MB)
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get('appState');
                
                request.onsuccess = () => {
                    if (request.result) {
                        Object.assign(appState, request.result);
                    }
                    updateUI();
                };
                
                request.onerror = () => {
                    console.log('IndexedDB load failed, using localStorage');
                    loadFromLocalStorage();
                };
            } else {
                // Fallback to localStorage (10MB)
                loadFromLocalStorage();
            }
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('fitQuestData');
            if (saved) {
                appState = JSON.parse(saved);
            }
            updateUI();
        }

        // Save data
        function saveData() {
            if (db) {
                // Use IndexedDB (50MB storage)
                try {
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    store.put(appState, 'appState');
                    
                    transaction.oncomplete = () => {
                        updateStorageIndicator();
                    };
                } catch (error) {
                    console.error('IndexedDB save failed:', error);
                    saveToLocalStorage();
                }
            } else {
                // Fallback to localStorage (10MB)
                saveToLocalStorage();
            }
        }

        function saveToLocalStorage() {
            try {
                localStorage.setItem('fitQuestData', JSON.stringify(appState));
            } catch (e) {
                showNotification('Storage full! Export your data.', 'warning');
            }
        }

        // Update UI
        function updateUI() {
            document.getElementById('userName').textContent = appState.user.name;
            document.getElementById('userLevel').textContent = appState.user.level;
            document.getElementById('currentXP').textContent = appState.user.xp;
            document.getElementById('maxXP').textContent = appState.user.maxXP;
            document.getElementById('streakDays').textContent = appState.user.streak;
            document.getElementById('totalWorkouts').textContent = appState.user.totalWorkouts;
            document.getElementById('currentWeight').textContent = appState.user.currentWeight || '---';
            document.getElementById('goalWeight').textContent = appState.user.goalWeight || '---';
            document.getElementById('achievements').textContent = appState.user.achievements.length;

            const xpPercent = (appState.user.xp / appState.user.maxXP) * 100;
            document.getElementById('xpFill').style.width = xpPercent + '%';

            renderExercises();
            renderAchievements();
            renderWeeklySchedule();
            renderNutritionPlan();
            renderProgressTimeline();
            renderProgressSummary();
            renderFriendsList();
            renderLeaderboard();
            renderChallenges();
        }

        // Render exercises
        function renderExercises() {
            const list = document.getElementById('exerciseList');
            if (!list) return; // Safety check
            
            list.innerHTML = '';
            
            appState.todayExercises.forEach((exercise, index) => {
                const item = document.createElement('div');
                item.className = 'exercise-item';
                
                const exerciseInfo = document.createElement('div');
                exerciseInfo.className = 'exercise-info';
                exerciseInfo.innerHTML = `
                    <h3>${exercise.name}</h3>
                    <div class="exercise-details">
                        ${exercise.sets} √ó ${exercise.reps} ‚Ä¢ +${exercise.xp} XP
                    </div>
                `;
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'exercise-checkbox';
                checkbox.checked = exercise.completed;
                checkbox.addEventListener('change', function() {
                    toggleExercise(index);
                });
                
                item.appendChild(exerciseInfo);
                item.appendChild(checkbox);
                list.appendChild(item);
            });
        }

        // Toggle exercise completion
        function toggleExercise(index) {
            appState.todayExercises[index].completed = !appState.todayExercises[index].completed;
            saveData();
            renderExercises();
        }

        // Complete workout
        function completeWorkout() {
            const completed = appState.todayExercises.filter(e => e.completed).length;
            const total = appState.todayExercises.length;

            if (completed === 0) {
                showNotification('Complete at least one exercise before finishing your workout!', 'warning');
                return;
            }

            const xpEarned = appState.todayExercises
                .filter(e => e.completed)
                .reduce((sum, e) => sum + e.xp, 0);

            // Set start date if first workout
            if (appState.user.totalWorkouts === 0) {
                appState.user.startDate = new Date().toISOString();
                if (appState.user.currentWeight) {
                    appState.user.startWeight = appState.user.currentWeight;
                }
            }

            // Add XP
            appState.user.xp += xpEarned;
            appState.user.totalWorkouts++;
            appState.user.streak++;
            appState.user.lastWorkoutDate = new Date().toISOString();

            // Level up check
            while (appState.user.xp >= appState.user.maxXP) {
                appState.user.xp -= appState.user.maxXP;
                appState.user.level++;
                appState.user.maxXP = Math.floor(appState.user.maxXP * 1.5);
                showNotification(`üéâ LEVEL UP! You're now Level ${appState.user.level}!`, 'success');
                
                if (appState.user.level === 5) {
                    unlockAchievement(3);
                }
            }

            // Check achievements
            if (appState.user.totalWorkouts === 1) {
                unlockAchievement(1);
            }
            if (appState.user.streak === 7) {
                unlockAchievement(2);
            }
            if (appState.user.totalWorkouts === 25) {
                unlockAchievement(5);
            }

            // Reset exercises
            appState.todayExercises.forEach(e => e.completed = false);

            showNotification(`üéâ Workout Complete! +${xpEarned} XP earned! Streak: ${appState.user.streak} days üî•`, 'success');
            
            saveData();
            updateUI();
        }

        // Unlock achievement
        function unlockAchievement(id) {
            const achievement = appState.achievements.find(a => a.id === id);
            if (achievement && !achievement.unlocked) {
                achievement.unlocked = true;
                appState.user.achievements.push(id);
                alert(`üèÜ Achievement Unlocked!\n${achievement.name}\n${achievement.description}`);
            }
        }

        // Render achievements
        function renderAchievements() {
            const grid = document.getElementById('achievementsGrid');
            grid.innerHTML = '';

            appState.achievements.forEach(achievement => {
                const card = document.createElement('div');
                card.className = `achievement-card ${achievement.unlocked ? 'unlocked' : ''}`;
                card.innerHTML = `
                    <div class="achievement-icon">${achievement.icon}</div>
                    <h3>${achievement.name}</h3>
                    <p style="font-size: 14px; margin-top: 8px; opacity: 0.8;">
                        ${achievement.description}
                    </p>
                    ${achievement.unlocked ? '<p style="margin-top: 10px; font-weight: bold;">‚úÖ Unlocked</p>' : '<p style="margin-top: 10px; opacity: 0.6;">üîí Locked</p>'}
                `;
                grid.appendChild(card);
            });
        }

        // Show section
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
        }

        // Start workout (placeholder)
        function startWorkout() {
            alert('üèãÔ∏è Starting workout mode! Complete each exercise and check them off as you go.');
        }

        // AI Chat functionality
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            // Add user message
            const messagesDiv = document.getElementById('chatMessages');
            const userMsg = document.createElement('div');
            userMsg.className = 'message user';
            userMsg.innerHTML = `<strong>You</strong><p>${message}</p>`;
            messagesDiv.appendChild(userMsg);

            input.value = '';
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            // Show typing indicator
            const typingMsg = document.createElement('div');
            typingMsg.className = 'message ai';
            typingMsg.id = 'typingIndicator';
            typingMsg.innerHTML = `<strong>AI Coach</strong><p>Thinking...</p>`;
            messagesDiv.appendChild(typingMsg);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            // Get AI response (async for Gemini)
            generateAIResponse(message).then(response => {
                // Remove typing indicator
                const typing = document.getElementById('typingIndicator');
                if (typing) typing.remove();
                
                // Add AI response
                const aiMsg = document.createElement('div');
                aiMsg.className = 'message ai';
                aiMsg.innerHTML = `<strong>AI Coach</strong><p>${response}</p>`;
                messagesDiv.appendChild(aiMsg);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            });
        }

        // Generate AI response - tries Easy-Peasy first, then Gemini if available, then smart chatbot
        async function generateAIResponse(message) {
            // Try Easy-Peasy AI first
            if (easyPeasyAI.isEnabled()) {
                const easyPeasyResponse = await easyPeasyAI.sendToEasyPeasy(message);
                if (easyPeasyResponse) {
                    return easyPeasyResponse;
                }
                // If Easy-Peasy fails or returns null, fall through to Gemini
            }
            
            // Try Gemini if API key is set
            if (geminiAI.hasApiKey()) {
                return await geminiAI.sendToGemini(message);
            }
            
            // Fallback to smart contextual chatbot
            return smartChatbot.generateResponse(message);
        }

        // Body scan analysis
        function analyzebodyPhotos(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            const resultsDiv = document.getElementById('analysisResults');
            const contentDiv = document.getElementById('analysisContent');
            
            resultsDiv.style.display = 'block';
            contentDiv.innerHTML = '<div class="loading"></div> Analyzing your photos...';

            // Simulate analysis
            setTimeout(() => {
                contentDiv.innerHTML = `
                    <h3 style="color: var(--primary); margin-bottom: 15px;">Body Type Assessment</h3>
                    <p><strong>Current Classification:</strong> Endomorph-Mesomorph Mix</p>
                    <p style="margin-top: 10px; color: var(--text-light);">
                        You have a naturally strong build with good muscle potential. Your body stores fat easily but responds well to training.
                    </p>
                    
                    <h4 style="margin-top: 20px; margin-bottom: 10px;">Key Observations:</h4>
                    <ul style="color: var(--text-light); padding-left: 25px;">
                        <li>Broader torso with natural strength base</li>
                        <li>Higher fat storage around midsection</li>
                        <li>Solid muscle foundation in arms and legs</li>
                        <li>High muscle-building potential</li>
                    </ul>

                    <h4 style="margin-top: 20px; margin-bottom: 10px;">Transformation Potential:</h4>
                    <p style="color: var(--text-light);">
                        With fat loss and consistent training, you'll shift toward a Mesomorph-dominant physique. At 210-230 lbs, you'll have:
                    </p>
                    <ul style="color: var(--text-light); padding-left: 25px; margin-top: 10px;">
                        <li>Tighter waist and defined core</li>
                        <li>Broad shoulders and V-taper</li>
                        <li>Dense, powerful muscle structure</li>
                        <li>Athletic, strong appearance</li>
                    </ul>

                    <h4 style="margin-top: 20px; margin-bottom: 10px;">Recommendations:</h4>
                    <ul style="color: var(--text-light); padding-left: 25px;">
                        <li>Focus on 500-700 calorie deficit</li>
                        <li>Strength training 4x per week</li>
                        <li>High protein intake (170-210g/day)</li>
                        <li>Progressive overload for muscle retention</li>
                    </ul>
                `;

                unlockAchievement(4);
            }, 2000);
        }

        // Camera functionality
        let stream = null;
        function enableCamera() {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(s => {
                    stream = s;
                    const preview = document.getElementById('cameraPreview');
                    const video = document.createElement('video');
                    video.srcObject = stream;
                    video.autoplay = true;
                    preview.innerHTML = '';
                    preview.appendChild(video);
                    document.getElementById('captureBtn').style.display = 'inline-block';
                })
                .catch(err => {
                    alert('Camera access denied. Please enable camera permissions.');
                });
        }

        function capturePhoto() {
            const video = document.querySelector('#cameraPreview video');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            const photoData = canvas.toDataURL('image/png');
            
            // Add to progress photos
            appState.progressPhotos.push({
                data: photoData,
                date: new Date().toISOString()
            });
            
            saveData();
            alert('üì∏ Photo captured and added to your progress gallery!');
            renderProgressPhotos();
        }

        // Progress photos
        function openProgressUpload() {
            document.getElementById('progressUploadModal').classList.add('active');
        }

        function closeProgressUpload() {
            document.getElementById('progressUploadModal').classList.remove('active');
            document.getElementById('progressPhotoUpload').value = '';
            document.getElementById('photoWeight').value = '';
        }

        function processProgressPhoto(event) {
            const file = event.target.files[0];
            if (!file) return;

            const bodyPart = document.getElementById('bodyPartSelect').value;
            const weight = document.getElementById('photoWeight').value;

            const reader = new FileReader();
            reader.onload = function(e) {
                const photoData = {
                    data: e.target.result,
                    date: new Date().toISOString(),
                    bodyPart: bodyPart,
                    weight: weight || null,
                    analysis: null
                };

                // Simulate AI analysis
                showNotification('Analyzing your photo...', 'info');
                
                setTimeout(() => {
                    photoData.analysis = generatePhotoAnalysis(photoData, appState.progressPhotos);
                    appState.progressPhotos.push(photoData);
                    saveData();
                    closeProgressUpload();
                    renderProgressTimeline();
                    showNotification('Progress photo added successfully! üì∏', 'success');
                    
                    // Show slideshow button if we have 2+ photos
                    if (appState.progressPhotos.length >= 2) {
                        document.getElementById('slideshowBtn').style.display = 'inline-block';
                        document.getElementById('compareBtn').style.display = 'inline-block';
                    }
                }, 2000);
            };
            reader.readAsDataURL(file);
        }

        // AI Photo Analysis (Honest assessment with detailed body type analysis)
        function generatePhotoAnalysis(currentPhoto, previousPhotos) {
            const bodyPart = currentPhoto.bodyPart;
            const previousSame = previousPhotos.filter(p => p.bodyPart === bodyPart);
            
            if (previousSame.length === 0) {
                // First photo - provide detailed body type analysis
                return generateInitialBodyTypeAnalysis(bodyPart);
            }

            const mostRecent = previousSame[previousSame.length - 1];
            const daysSince = Math.floor((new Date(currentPhoto.date) - new Date(mostRecent.date)) / (1000 * 60 * 60 * 24));
            
            // Realistic progress analysis based on timeframe
            return generateProgressAnalysis(daysSince, bodyPart, currentPhoto.weight, mostRecent.weight);
        }

        // Generate detailed body type analysis from photo
        function generateInitialBodyTypeAnalysis(bodyPart) {
            // Simulate detailed body scanning (in production, this would use image recognition AI)
            const analyses = {
                'full-body-front': {
                    summary: 'Full body baseline established',
                    details: `Initial full body assessment captured. This photo will serve as your primary reference point for tracking overall transformation. For best accuracy, take this photo weekly in consistent lighting (preferably morning, natural light) and same clothing.`,
                    observations: [
                        'Front view baseline captured',
                        'Full body proportions recorded',
                        'Starting point for transformation tracking',
                        'Take weekly photos at same time/lighting for accurate comparison'
                    ],
                    bodyTypeAssessment: 'Based on this baseline photo, a detailed body composition analysis will be available after your next photo for comparison. Keep consistent with your nutrition and training plan.'
                },
                'full-body-side': {
                    summary: 'Side profile baseline established',
                    details: `Side profile captured showing posture and body composition. This angle is crucial for tracking abdominal changes and overall posture improvements. The side view often shows progress that front photos miss.`,
                    observations: [
                        'Side profile baseline recorded',
                        'Posture assessment captured',
                        'Torso depth and core positioning documented',
                        'Compare this angle weekly for best results'
                    ],
                    bodyTypeAssessment: 'Side view provides insights into core development and fat distribution patterns. Continue regular photos to track midsection changes over time.'
                },
                'full-body-back': {
                    summary: 'Back view baseline established',
                    details: `Back profile captured. This view is essential for tracking shoulder width, back development, and posterior chain progress. Many people neglect back photos but they reveal significant changes.`,
                    observations: [
                        'Back view baseline documented',
                        'Shoulder width and lat development recorded',
                        'Lower back and glute positioning captured',
                        'Weekly back photos show muscle definition progress'
                    ],
                    bodyTypeAssessment: 'Back development is key for achieving a V-taper physique. Track this view to monitor lat spread and shoulder development.'
                },
                'chest': {
                    summary: 'Chest area baseline captured',
                    details: `Chest and upper body baseline established. This region responds well to upper body training and shows definition changes within 4-6 weeks of consistent training.`,
                    observations: [
                        'Chest baseline recorded',
                        'Pec development starting point captured',
                        'Upper body fat distribution documented',
                        'Focus on progressive overload in chest exercises'
                    ],
                    bodyTypeAssessment: 'Chest development varies by body type - consistent pressing movements and adequate protein intake drive visible changes here.'
                },
                'arms': {
                    summary: 'Arm development baseline',
                    details: `Arm size and definition baseline captured. Arms typically show visible changes within 3-4 weeks of consistent training, making them great for tracking progress.`,
                    observations: [
                        'Arm circumference baseline documented',
                        'Bicep and tricep development starting point',
                        'Forearm size recorded',
                        'Track weekly - arms show fast visual changes'
                    ],
                    bodyTypeAssessment: 'Arm development responds quickly to training. Focus on both bicep and tricep work for balanced growth.'
                },
                'abs': {
                    summary: 'Core/abdominal baseline established',
                    details: `Midsection baseline captured. This area typically takes the longest to show definition as it requires lower overall body fat percentage (12-15% for visible abs). Core photos are most telling of overall progress.`,
                    observations: [
                        'Abdominal baseline documented',
                        'Core fat distribution recorded',
                        'Starting point for definition tracking',
                        'Visible abs require 12-15% body fat - be patient and consistent'
                    ],
                    bodyTypeAssessment: 'Abs are revealed through fat loss, not just built through training. Nutrition consistency is critical for this area.'
                },
                'legs': {
                    summary: 'Lower body baseline captured',
                    details: `Leg development and lower body composition baseline established. Legs often hold the most muscle potential and respond well to compound movements like squats and lunges.`,
                    observations: [
                        'Leg development baseline recorded',
                        'Quadriceps and hamstring size documented',
                        'Calf development captured',
                        'Lower body holds largest muscle groups - train consistently'
                    ],
                    bodyTypeAssessment: 'Lower body development is crucial for overall physique balance. Strong legs support metabolic rate and overall strength.'
                },
                'face': {
                    summary: 'Facial baseline established',
                    details: `Face and neck baseline captured. Facial definition is one of the first areas people notice when you lose fat. Jawline definition typically appears at 15-18% body fat for men, 20-24% for women.`,
                    observations: [
                        'Facial structure baseline documented',
                        'Neck and jawline starting point captured',
                        'Face often shows changes before other areas',
                        'Jawline definition appears with consistent fat loss'
                    ],
                    bodyTypeAssessment: 'Facial definition is directly tied to overall body fat percentage. As you lean down, this area will show dramatic improvements.'
                }
            };

            return analyses[bodyPart] || analyses['full-body-front'];
        }

        // Generate progress analysis between photos
        function generateProgressAnalysis(daysSince, bodyPart, currentWeight, previousWeight) {
            let summary, details, observations;

            if (daysSince < 7) {
                summary = 'Too early for visible changes';
                details = `Only ${daysSince} days since your last ${formatBodyPart(bodyPart)} photo. Physical changes in this area typically require 2-4 weeks minimum to become photographically noticeable. Continue your current routine - consistency is key.`;
                observations = [
                    `Less than 1 week of progress in ${formatBodyPart(bodyPart)}`,
                    'No significant visual changes expected yet',
                    'Body is adapting at cellular level even if not visible',
                    'Stay consistent - take next photo in 1-2 weeks',
                    'Water retention and lighting can mask early changes'
                ];
            } else if (daysSince < 14) {
                summary = 'Early adaptation phase';
                details = `${daysSince} days of training progress in your ${formatBodyPart(bodyPart)}. At this stage, internal adaptations are occurring (increased glycogen storage, improved muscle recruitment) but external changes are subtle. Continue pushing - week 3-4 is when visible changes typically emerge.`;
                observations = [
                    '1-2 weeks of consistent training',
                    'Neurological adaptations occurring',
                    'Muscle glycogen increasing (better pump)',
                    'Possible reduction in bloating/water retention',
                    'Continue current program for 2-3 more weeks for visible results'
                ];
            } else if (daysSince < 30) {
                summary = `Early visible changes in ${formatBodyPart(bodyPart)}`;
                details = `${daysSince} days (${Math.floor(daysSince/7)} weeks) of progress. This is the timeframe where initial physical changes become noticeable in photos. You should see subtle definition improvements, slight size changes, or reduced fat in this area.`;
                observations = [
                    '2-4 weeks of consistent work showing results',
                    `Beginning to see muscle tone in ${formatBodyPart(bodyPart)}`,
                    'Fat loss becoming visible if in caloric deficit',
                    'Muscle size increasing if in surplus',
                    'This is when progress accelerates - keep momentum going'
                ];
            } else if (daysSince < 60) {
                summary = `Significant progress visible in ${formatBodyPart(bodyPart)}`;
                details = `${Math.floor(daysSince/7)} weeks of dedicated training. Clear changes should be visible in your ${formatBodyPart(bodyPart)} - noticeable muscle definition, visible fat reduction, or measurable size changes. This is real transformation territory.`;
                observations = [
                    `4-8 weeks of progress in ${formatBodyPart(bodyPart)}`,
                    'Clear muscle definition emerging',
                    'Fat loss distinctly visible',
                    'Proportions noticeably changing',
                    'Others likely commenting on your transformation',
                    'Excellent progress - maintain current approach'
                ];
            } else {
                summary = `Major transformation achieved in ${formatBodyPart(bodyPart)}`;
                details = `${Math.floor(daysSince/30)} months of consistent work paying off. Dramatic changes should be visible in your ${formatBodyPart(bodyPart)} - significant fat reduction, clear muscle separation, complete body recomposition in this area. Outstanding dedication!`;
                observations = [
                    `${Math.floor(daysSince/30)} months of transformation visible`,
                    `Dramatic changes in ${formatBodyPart(bodyPart)} structure`,
                    'Clear muscle definition and separation',
                    'Major fat loss achieved',
                    'Complete body recomposition in this area',
                    'You should be incredibly proud of this progress',
                    'Consider tracking other angles for full documentation'
                ];
            }

            // Add weight comparison if available
            if (currentWeight && previousWeight) {
                const weightChange = currentWeight - previousWeight;
                if (weightChange < -2) {
                    observations.push(`Weight down ${Math.abs(weightChange)} lbs - excellent fat loss progress!`);
                } else if (weightChange < 0) {
                    observations.push(`Weight down ${Math.abs(weightChange)} lbs - steady progress`);
                } else if (weightChange > 2) {
                    observations.push(`Weight up ${weightChange} lbs - if training hard, this could be quality muscle gain`);
                } else if (weightChange > 0) {
                    observations.push(`Weight up ${weightChange} lbs - minor fluctuation, focus on visual changes`);
                } else {
                    observations.push('Weight stable - excellent if focusing on body recomposition');
                }
            }

            // Add body-part specific observations
            const specificObservations = getBodyPartSpecificObservations(bodyPart, daysSince);
            observations.push(...specificObservations);

            return { summary, details, observations };
        }

        // Get body part specific observations based on timeframe
        function getBodyPartSpecificObservations(bodyPart, days) {
            const observations = [];
            
            if (bodyPart.includes('full-body')) {
                if (days >= 30) {
                    observations.push('Overall silhouette changing - clothes fitting differently');
                    observations.push('Posture may be improving with strength gains');
                }
            } else if (bodyPart === 'chest') {
                if (days >= 21) {
                    observations.push('Chest responds well to progressive overload');
                    observations.push('Upper/lower pec definition may be emerging');
                }
            } else if (bodyPart === 'arms') {
                if (days >= 14) {
                    observations.push('Arms show fast visual changes due to smaller muscle groups');
                    observations.push('Vascularity may be increasing');
                }
            } else if (bodyPart === 'abs') {
                if (days >= 30) {
                    observations.push('Ab definition requires 12-15% body fat for men, 18-22% for women');
                    observations.push('Continue fat loss focus if abs are the goal');
                }
            } else if (bodyPart === 'legs') {
                if (days >= 21) {
                    observations.push('Quad sweep and hamstring separation developing');
                    observations.push('Legs have highest muscle-building potential');
                }
            } else if (bodyPart === 'face') {
                if (days >= 14) {
                    observations.push('Facial fat loss often appears before other areas');
                    observations.push('Jawline definition indicates overall body fat reduction');
                }
            }

            return observations;
        }

        function formatBodyPart(bodyPart) {
            return bodyPart.split('-').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        function renderProgressTimeline() {
            const timeline = document.getElementById('progressTimeline');
            
            if (appState.progressPhotos.length === 0) {
                timeline.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-light);">
                        <div style="font-size: 64px; margin-bottom: 20px;">üì∏</div>
                        <h3 style="margin-bottom: 10px;">No Progress Photos Yet</h3>
                        <p>Start tracking your transformation by adding your first progress photo!</p>
                    </div>
                `;
                return;
            }

            const sorted = [...appState.progressPhotos].sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );

            timeline.innerHTML = `
                <div class="timeline-container">
                    <div class="timeline-line"></div>
                    ${sorted.map((photo, index) => {
                        const date = new Date(photo.date);
                        const dateStr = date.toLocaleDateString('en-US', { 
                            month: 'short', 
                            day: 'numeric', 
                            year: 'numeric' 
                        });
                        const timeStr = date.toLocaleTimeString('en-US', { 
                            hour: 'numeric', 
                            minute: '2-digit' 
                        });

                        return `
                            <div class="timeline-item">
                                <div class="timeline-dot"></div>
                                <div class="timeline-meta">
                                    <span>üìÖ ${dateStr} at ${timeStr}</span>
                                    <span>üìç ${formatBodyPart(photo.bodyPart)}</span>
                                    ${photo.weight ? `<span>‚öñÔ∏è ${photo.weight} lbs</span>` : ''}
                                </div>
                                <img src="${photo.data}" class="timeline-photo" onclick="viewPhotoDetail(${sorted.length - 1 - index})" alt="Progress photo">
                                ${photo.analysis ? `
                                    <div class="timeline-analysis">
                                        <h4 style="margin-bottom: 10px; color: var(--primary);">
                                            ${photo.analysis.summary}
                                        </h4>
                                        <p style="color: var(--text-light); margin-bottom: 15px;">
                                            ${photo.analysis.details}
                                        </p>
                                        <strong style="display: block; margin-bottom: 8px;">Observations:</strong>
                                        <ul style="color: var(--text-light); padding-left: 25px;">
                                            ${photo.analysis.observations.map(obs => `<li>${obs}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Slideshow functionality
        function viewSlideshow() {
            if (appState.progressPhotos.length < 2) {
                showNotification('Add at least 2 progress photos to view slideshow', 'warning');
                return;
            }
            
            appState.slideshowIndex = 0;
            document.getElementById('slideshowModal').classList.add('active');
            updateSlideshow();
            generateSlideshowAnalysis();
        }

        function updateSlideshow() {
            const photos = appState.progressPhotos;
            const current = photos[appState.slideshowIndex];
            
            document.getElementById('slideshowImage').src = current.data;
            
            const date = new Date(current.date);
            const info = document.getElementById('slideshowInfo');
            info.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <h3 style="margin-bottom: 5px;">${formatBodyPart(current.bodyPart)}</h3>
                        <p style="opacity: 0.9; font-size: 14px;">
                            ${date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
                            ${current.weight ? ` ‚Ä¢ ${current.weight} lbs` : ''}
                        </p>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px;">
                        Photo ${appState.slideshowIndex + 1} of ${photos.length}
                    </div>
                </div>
            `;
        }

        function generateSlideshowAnalysis() {
            const photos = appState.progressPhotos;
            const analysisDiv = document.getElementById('slideshowAnalysis');
            
            if (photos.length < 2) {
                analysisDiv.innerHTML = '<p style="color: var(--text-light);">Add more photos to see transformation analysis</p>';
                return;
            }

            const first = photos[0];
            const last = photos[photos.length - 1];
            const daysDiff = Math.floor((new Date(last.date) - new Date(first.date)) / (1000 * 60 * 60 * 24));
            const weeksDiff = Math.floor(daysDiff / 7);

            let transformationText = '';
            if (daysDiff < 7) {
                transformationText = 'Keep taking photos weekly to track your progress over time.';
            } else if (daysDiff < 30) {
                transformationText = `${weeksDiff} week${weeksDiff !== 1 ? 's' : ''} of progress tracked. Early changes are forming - stay consistent!`;
            } else if (daysDiff < 90) {
                transformationText = `${weeksDiff} weeks of transformation captured. At this stage, significant changes should be visible. Your dedication is showing!`;
            } else {
                transformationText = `${Math.floor(daysDiff/30)} months of incredible transformation! This slideshow tells the story of your hard work and commitment.`;
            }

            let weightText = '';
            if (first.weight && last.weight) {
                const weightChange = last.weight - first.weight;
                if (weightChange < 0) {
                    weightText = `<div style="background: var(--secondary); color: white; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <strong>Weight Progress:</strong> Down ${Math.abs(weightChange)} lbs! üéâ
                    </div>`;
                }
            }

            analysisDiv.innerHTML = `
                <h3 style="margin-bottom: 15px;">üìä Transformation Overview</h3>
                <p style="color: var(--text-light); margin-bottom: 10px;">
                    <strong>Timeline:</strong> ${photos.length} photos over ${daysDiff} days
                </p>
                <p style="color: var(--text-light); margin-bottom: 15px;">
                    ${transformationText}
                </p>
                ${weightText}
                <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px;">
                    <strong>üí° Pro Tip:</strong> Take photos in the same lighting, same time of day, and same poses for the most accurate comparison. Morning photos work best!
                </div>
            `;
        }

        function nextSlide() {
            appState.slideshowIndex = (appState.slideshowIndex + 1) % appState.progressPhotos.length;
            updateSlideshow();
        }

        function previousSlide() {
            appState.slideshowIndex = (appState.slideshowIndex - 1 + appState.progressPhotos.length) % appState.progressPhotos.length;
            updateSlideshow();
        }

        function toggleAutoplay() {
            const btn = document.getElementById('autoplayBtn');
            
            if (appState.autoplayInterval) {
                clearInterval(appState.autoplayInterval);
                appState.autoplayInterval = null;
                btn.textContent = '‚ñ∂Ô∏è Autoplay';
            } else {
                appState.autoplayInterval = setInterval(nextSlide, 2000);
                btn.textContent = '‚è∏Ô∏è Pause';
            }
        }

        function closeSlideshow() {
            if (appState.autoplayInterval) {
                clearInterval(appState.autoplayInterval);
                appState.autoplayInterval = null;
            }
            document.getElementById('slideshowModal').classList.remove('active');
        }

        // Comparison functionality
        function comparePhotos() {
            if (appState.progressPhotos.length < 2) {
                showNotification('Add at least 2 photos to compare', 'warning');
                return;
            }

            const beforeSelect = document.getElementById('beforeSelect');
            const afterSelect = document.getElementById('afterSelect');
            
            // Populate selects
            const options = appState.progressPhotos.map((photo, index) => {
                const date = new Date(photo.date).toLocaleDateString();
                return `<option value="${index}">${formatBodyPart(photo.bodyPart)} - ${date}</option>`;
            }).join('');
            
            beforeSelect.innerHTML = options;
            afterSelect.innerHTML = options;
            
            // Set default selections (first and last)
            beforeSelect.value = '0';
            afterSelect.value = (appState.progressPhotos.length - 1).toString();
            
            document.getElementById('compareModal').classList.add('active');
            updateComparison();
        }

        function updateComparison() {
            const beforeIndex = parseInt(document.getElementById('beforeSelect').value);
            const afterIndex = parseInt(document.getElementById('afterSelect').value);
            
            if (isNaN(beforeIndex) || isNaN(afterIndex)) return;

            const beforePhoto = appState.progressPhotos[beforeIndex];
            const afterPhoto = appState.progressPhotos[afterIndex];
            
            document.getElementById('beforeImage').innerHTML = `
                <img src="${beforePhoto.data}" style="width: 100%; height: auto; border-radius: 12px;">
                <p style="text-align: center; margin-top: 10px; color: var(--text-light);">
                    ${new Date(beforePhoto.date).toLocaleDateString()}
                    ${beforePhoto.weight ? ` ‚Ä¢ ${beforePhoto.weight} lbs` : ''}
                </p>
            `;
            
            document.getElementById('afterImage').innerHTML = `
                <img src="${afterPhoto.data}" style="width: 100%; height: auto; border-radius: 12px;">
                <p style="text-align: center; margin-top: 10px; color: var(--text-light);">
                    ${new Date(afterPhoto.date).toLocaleDateString()}
                    ${afterPhoto.weight ? ` ‚Ä¢ ${afterPhoto.weight} lbs` : ''}
                </p>
            `;

            // Generate comparison analysis
            generateComparisonAnalysis(beforePhoto, afterPhoto);
        }

        function generateComparisonAnalysis(before, after) {
            const analysisDiv = document.getElementById('comparisonAnalysis');
            const daysDiff = Math.floor((new Date(after.date) - new Date(before.date)) / (1000 * 60 * 60 * 24));
            
            if (daysDiff <= 0) {
                analysisDiv.innerHTML = `
                    <h3 style="margin-bottom: 15px;">AI Analysis</h3>
                    <p style="color: var(--text-light);">Please select an earlier "Before" photo and a later "After" photo for comparison.</p>
                `;
                return;
            }

            const weeksDiff = Math.floor(daysDiff / 7);
            let assessment = '';

            if (daysDiff < 14) {
                assessment = `This comparison shows ${daysDiff} days of progress. This is a short timeframe - major visual changes typically require 3-4 weeks minimum. Continue your training and check back in a few weeks for more noticeable differences.`;
            } else if (daysDiff < 30) {
                assessment = `${weeksDiff} weeks of progress. At this point, you should start seeing early changes: slight reduction in bloating, improved muscle tone, better posture. The transformation is beginning - stay consistent!`;
            } else if (daysDiff < 60) {
                assessment = `${weeksDiff} weeks of solid work! Clear changes should be visible: noticeable fat loss, better muscle definition, improved body shape. This is where people start commenting on your progress.`;
            } else {
                assessment = `${Math.floor(daysDiff/30)} months of transformation! This comparison should show dramatic changes: significant fat reduction, clear muscle definition, completely different body composition. You've earned this progress!`;
            }

            let weightAnalysis = '';
            if (before.weight && after.weight) {
                const weightChange = after.weight - before.weight;
                if (weightChange < 0) {
                    weightAnalysis = `<div style="background: var(--secondary); color: white; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <strong>Weight Change:</strong> Down ${Math.abs(weightChange)} lbs! Outstanding progress! üéâ
                    </div>`;
                } else if (weightChange > 0) {
                    weightAnalysis = `<div style="background: var(--warning); color: white; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <strong>Weight Change:</strong> Up ${weightChange} lbs. If you're strength training consistently, this could be muscle gain. Focus on visual changes and how clothes fit.
                    </div>`;
                } else {
                    weightAnalysis = `<div style="background: var(--primary); color: white; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <strong>Weight:</strong> Stable at ${after.weight} lbs. Weight is just one metric - pay attention to body composition, strength gains, and how you feel.
                    </div>`;
                }
            }

            analysisDiv.innerHTML = `
                <h3 style="margin-bottom: 15px;">üîç Honest Comparison Analysis</h3>
                <p style="color: var(--text-light); margin-bottom: 10px;">
                    <strong>Time Period:</strong> ${daysDiff} days (${weeksDiff} weeks)
                </p>
                <p style="color: var(--text-light); margin-bottom: 15px;">
                    ${assessment}
                </p>
                ${weightAnalysis}
                <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px;">
                    <strong>üí™ Remember:</strong> Transformation takes time. Compare monthly photos for the most dramatic visual differences. Focus on consistency, not perfection!
                </div>
            `;
        }

        function closeComparison() {
            document.getElementById('compareModal').classList.remove('active');
        }

        // Notification System
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            
            const icons = {
                success: '‚úÖ',
                info: '‚ÑπÔ∏è',
                warning: '‚ö†Ô∏è'
            };
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 24px;">${icons[type]}</span>
                    <p style="margin: 0; font-weight: 500;">${message}</p>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.3s reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Request notification permission
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        appState.user.notificationsEnabled = true;
                        saveData();
                        showNotification('Notifications enabled! We\'ll remind you to workout.', 'success');
                        scheduleWorkoutReminder();
                    }
                });
            }
        }

        // Schedule daily workout reminder
        function scheduleWorkoutReminder() {
            if ('Notification' in window && Notification.permission === 'granted') {
                // Check every hour if user should be reminded
                setInterval(() => {
                    const now = new Date();
                    const hour = now.getHours();
                    
                    // Remind at 9 AM if they haven't worked out today
                    if (hour === 9 && !hasWorkedOutToday()) {
                        new Notification('FitQuest Reminder', {
                            body: 'üí™ Time to complete today\'s workout! Keep your streak alive! üî•',
                            icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">üí™</text></svg>',
                            badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">üî•</text></svg>'
                        });
                    }
                }, 3600000); // Check every hour
            }
        }

        function hasWorkedOutToday() {
            if (!appState.user.lastWorkoutDate) return false;
            const lastWorkout = new Date(appState.user.lastWorkoutDate);
            const today = new Date();
            return lastWorkout.toDateString() === today.toDateString();
        }

        // Weekly schedule
        function renderWeeklySchedule() {
            const scheduleDiv = document.getElementById('weeklySchedule');
            const schedule = [
                { day: 'Monday', workout: 'PUSH - Chest, Shoulders, Triceps', duration: '45 min' },
                { day: 'Tuesday', workout: 'LOWER BODY + CORE', duration: '50 min' },
                { day: 'Wednesday', workout: 'PULL - Back, Biceps', duration: '45 min' },
                { day: 'Thursday', workout: 'CONDITIONING - Cardio Circuit', duration: '40 min' },
                { day: 'Friday', workout: 'FULL BODY - Functional Training', duration: '50 min' },
                { day: 'Saturday', workout: 'Active Recovery - Walk', duration: '30 min' },
                { day: 'Sunday', workout: 'Rest Day', duration: '--' }
            ];

            scheduleDiv.innerHTML = schedule.map(day => `
                <div style="padding: 15px; background: white; border-radius: 8px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${day.day}</strong>
                            <p style="color: var(--text-light); font-size: 14px; margin-top: 5px;">${day.workout}</p>
                        </div>
                        <span style="color: var(--primary); font-weight: bold;">${day.duration}</span>
                    </div>
                </div>
            `).join('');
        }

        // Nutrition plan
        function renderNutritionPlan() {
            const nutritionDiv = document.getElementById('nutritionPlan');
            nutritionDiv.innerHTML = `
                <div style="padding: 15px; background: white; border-radius: 8px; margin-bottom: 10px;">
                    <strong>Daily Targets</strong>
                    <ul style="margin-top: 10px; padding-left: 20px; color: var(--text-light);">
                        <li>Calories: 2,200-2,400</li>
                        <li>Protein: 170-210g</li>
                        <li>Carbs: Moderate (focus around workouts)</li>
                        <li>Fats: Healthy sources</li>
                    </ul>
                </div>
                <div style="padding: 15px; background: white; border-radius: 8px;">
                    <strong>Budget-Friendly Staples</strong>
                    <p style="color: var(--text-light); margin-top: 10px;">
                        Eggs, chicken thighs, ground turkey, rice, frozen veggies, oats, peanut butter, Greek yogurt, canned tuna
                    </p>
                </div>
            `;
        }

        // Modal functions
        function customizePlan() {
            const modal = document.getElementById('customModal');
            const content = document.getElementById('modalContent');
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">Current Weight (lbs)</label>
                    <input type="number" id="customWeight" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px;" value="${appState.user.currentWeight || ''}">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">Goal Weight (lbs)</label>
                    <input type="number" id="customGoal" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px;" value="${appState.user.goalWeight || ''}">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">Your Name</label>
                    <input type="text" id="customName" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px;" value="${appState.user.name}">
                </div>
            `;
            
            modal.classList.add('active');
        }

        function closeModal() {
            const weight = document.getElementById('customWeight').value;
            const goal = document.getElementById('customGoal').value;
            const name = document.getElementById('customName').value;
            
            if (weight) appState.user.currentWeight = weight;
            if (goal) appState.user.goalWeight = goal;
            if (name) appState.user.name = name;
            
            saveData();
            updateUI();
            
            document.getElementById('customModal').classList.remove('active');
        }

        // Initialize app
        window.onload = async function() {
            // Initialize IndexedDB first (50MB storage)
            await initDB();
            
            loadData();
            generateFriendCode();
            renderExercises();
            renderAchievements();
            renderWeeklySchedule();
            renderNutritionPlan();
            renderProgressTimeline();
            renderProgressSummary();
            renderFriendsList();
            renderChallenges();
            loadSettings();
            updateStorageIndicator();
            checkForAutoSlideshow(); // Check if we should show slideshow
            
            // Set today's date as default for photo date picker
            const today = new Date().toISOString().split('T')[0];
            if (document.getElementById('photoDatePicker')) {
                document.getElementById('photoDatePicker').value = today;
            }
            
            // Show storage info
            if (db) {
                showNotification('üíæ Using IndexedDB - 50MB storage available (5x more space!)', 'success');
            } else {
                showNotification('üíæ Using localStorage - 10MB storage available', 'info');
            }
            
            // Request notification permission after a few seconds
            setTimeout(() => {
                if (!appState.user.notificationsEnabled) {
                    requestNotificationPermission();
                }
            }, 3000);

            // Mobile-specific optimizations
            if (isMobileDevice()) {
                document.addEventListener('touchstart', function(e) {
                    if (e.touches.length > 1) {
                        e.preventDefault();
                    }
                }, { passive: false });

                document.addEventListener('touchmove', function(e) {
                    if (e.scale !== 1) {
                        e.preventDefault();
                    }
                }, { passive: false });

                showNotification('üí° Add this app to your home screen for the best experience!', 'info');
            }

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').catch(() => {});
            }
        };

        // Storage Space Management
        function updateStorageIndicator() {
            try {
                const dataSize = new Blob([JSON.stringify(appState)]).size;
                const maxSize = db ? (50 * 1024 * 1024) : (10 * 1024 * 1024); // 50MB or 10MB
                const usedMB = (dataSize / (1024 * 1024)).toFixed(2);
                const percent = Math.min((dataSize / maxSize) * 100, 100);
                
                document.getElementById('storageBar').style.width = percent + '%';
                document.getElementById('storageUsed').textContent = usedMB + ' MB';
                document.getElementById('storagePercent').textContent = percent.toFixed(0) + '%';
                document.getElementById('storageTotal').textContent = db ? '~50 MB' : '~10 MB';
                
                // Photo count estimate
                const avgPhotoSize = 100 * 1024; // ~100KB per compressed photo
                const estimatedPhotos = Math.floor((maxSize - dataSize) / avgPhotoSize);
                
                const warning = document.getElementById('storageWarning');
                const warningText = document.getElementById('storageWarningText');
                
                if (percent > 90) {
                    document.getElementById('storageBar').style.background = 'var(--danger)';
                    warning.style.display = 'block';
                    warning.style.background = '#fee';
                    warningText.textContent = `Storage critically full! Only ~${estimatedPhotos} more photos possible. Delete old photos or export data.`;
                } else if (percent > 70) {
                    document.getElementById('storageBar').style.background = 'var(--warning)';
                    warning.style.display = 'block';
                    warningText.textContent = `Storage filling up. ~${estimatedPhotos} more photos possible. Consider deleting old photos soon.`;
                } else {
                    warning.style.display = 'none';
                }
            } catch (error) {
                console.error('Storage check error:', error);
            }
        }

        // Easy-Peasy AI Toggle
        function toggleEasyPeasyAI(enabled) {
            easyPeasyAI.setEnabled(enabled);
            const status = document.getElementById('easyPeasyStatus');
            if (enabled) {
                status.innerHTML = `‚úÖ <strong>Active:</strong> Your AI coach is using Easy-Peasy AI for intelligent, context-aware fitness guidance.`;
                status.style.background = 'rgba(255,255,255,0.15)';
            } else {
                status.innerHTML = `‚ö†Ô∏è <strong>Disabled:</strong> AI coach will use Gemini (if configured) or smart rule-based responses.`;
                status.style.background = 'rgba(0,0,0,0.2)';
            }
        }

        // Gemini API Key Management
        function saveGeminiApiKey() {
            const input = document.getElementById('geminiApiKeyInput');
            const key = input.value.trim();
            
            if (!key) {
                showNotification('Please enter your API key', 'warning');
                return;
            }
            
            if (key.length < 20) {
                showNotification('API key seems too short. Please check it.', 'warning');
                return;
            }
            
            geminiAI.setApiKey(key);
            
            const status = document.getElementById('geminiStatus');
            status.style.display = 'block';
            status.innerHTML = `
                <div class="connected-badge">‚úÖ Gemini AI Connected</div>
                <p style="color: var(--text-light); margin-top: 8px; font-size: 14px;">
                    Your chatbot now uses real AI! Try asking complex questions in the AI Coach tab.
                </p>
            `;
        }

        function toggleApiKeyVisibility() {
            const input = document.getElementById('geminiApiKeyInput');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        // Font Size Adjustment
        function adjustFontSize(value) {
            const percent = parseInt(value);
            document.documentElement.style.fontSize = percent + '%';
            document.getElementById('fontSizeValue').textContent = percent + '% ' + 
                (percent < 90 ? '(Small)' : percent > 110 ? '(Large)' : '(Normal)');
            
            appState.user.fontSize = percent;
            saveData();
        }

        // Button Size Adjustment
        function adjustButtonSize(value) {
            const percent = parseInt(value);
            const scale = percent / 100;
            
            document.querySelectorAll('.btn, .nav-tab, .workout-button').forEach(btn => {
                btn.style.transform = `scale(${scale})`;
                btn.style.transformOrigin = 'center';
            });
            
            document.getElementById('buttonSizeValue').textContent = percent + '% ' + 
                (percent < 90 ? '(Small)' : percent > 110 ? '(Large)' : '(Normal)');
            
            appState.user.buttonSize = percent;
            saveData();
        }

        // Progress Photo with Date Picker
        function processProgressPhoto(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showNotification('Processing photo...', 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    compressImage(img, function(compressedDataUrl) {
                        if (!compressedDataUrl) {
                            showNotification('Failed to process photo. Try a smaller image.', 'warning');
                            return;
                        }
                        
                        // Show preview
                        document.getElementById('photoPreviewContainer').style.display = 'block';
                        document.getElementById('photoPreviewImage').src = compressedDataUrl;
                        
                        // Store temporarily
                        appState.tempPhoto = compressedDataUrl;
                        
                        // Save photo with selected date
                        saveProgressPhotoWithDate();
                    });
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function saveProgressPhotoWithDate() {
            if (!appState.tempPhoto) {
                showNotification('Please select a photo first', 'warning');
                return;
            }
            
            const bodyPart = document.getElementById('bodyPartSelect').value;
            const weight = document.getElementById('photoWeight').value;
            const selectedDate = document.getElementById('photoDatePicker').value;
            
            // Use selected date or today
            const photoDate = selectedDate ? new Date(selectedDate + 'T12:00:00') : new Date();
            
            const photo = {
                id: Date.now(),
                bodyPart: bodyPart,
                date: photoDate.toISOString(),
                image: appState.tempPhoto,
                weight: weight ? parseFloat(weight) : null
            };
            
            appState.progressPhotos.push(photo);
            delete appState.tempPhoto;
            
            saveData();
            updateStorageIndicator();
            
            closeProgressUpload();
            renderProgressTimeline();
            
            showNotification('Progress photo saved! üì∏', 'success');
            
            // Check if we should trigger slideshow
            checkForAutoSlideshow();
            
            // Unlock achievement
            if (appState.progressPhotos.length === 1) {
                unlockAchievement(4);
            }
        }

        // Auto Slideshow Trigger
        function checkForAutoSlideshow() {
            const totalPhotos = appState.progressPhotos.length;
            
            // Trigger after 5 photos OR 5+ weeks of photos
            if (totalPhotos >= 5) {
                const sortedPhotos = appState.progressPhotos.sort((a, b) => 
                    new Date(a.date) - new Date(b.date)
                );
                
                const firstPhoto = new Date(sortedPhotos[0].date);
                const lastPhoto = new Date(sortedPhotos[sortedPhotos.length - 1].date);
                const daysDiff = Math.floor((lastPhoto - firstPhoto) / (1000 * 60 * 60 * 24));
                const weeksDiff = Math.floor(daysDiff / 7);
                
                // Check if we haven't shown slideshow yet for this milestone
                if (!appState.user.slideshowShown || appState.user.lastSlideshowCount < totalPhotos) {
                    if (weeksDiff >= 5 || totalPhotos >= 5) {
                        setTimeout(() => {
                            showAutoSlideshow(weeksDiff, totalPhotos);
                        }, 1000);
                    }
                }
            }
        }

        function showAutoSlideshow(weeks, photos) {
            const modal = document.getElementById('customModal');
            const content = document.getElementById('modalContent');
            
            content.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 80px; margin-bottom: 20px;">üéâ</div>
                    <h2 style="margin-bottom: 15px;">Transformation Milestone!</h2>
                    <p style="font-size: 18px; color: var(--text-light); margin-bottom: 30px;">
                        You've captured <strong>${photos} progress photos</strong> over <strong>${weeks} weeks</strong>!<br>
                        Ready to see your transformation journey?
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <button class="btn" onclick="closeModal()" style="padding: 20px;">
                            Later
                        </button>
                        <button class="btn btn-primary" onclick="viewSlideshow(); closeModal();" style="padding: 20px;">
                            üé¨ View Slideshow
                        </button>
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
            
            // Mark that we've shown this milestone
            appState.user.slideshowShown = true;
            appState.user.lastSlideshowCount = photos;
            saveData();
        }

        // Generate unique friend code
        function generateFriendCode() {
            if (!appState.user.friendCode) {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let code = 'FIT-';
                for (let i = 0; i < 6; i++) {
                    code += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                appState.user.friendCode = code;
                saveData();
            }
            document.getElementById('friendCode').textContent = appState.user.friendCode;
        }

        // Copy friend code
        function copyFriendCode() {
            const code = appState.user.friendCode;
            navigator.clipboard.writeText(code).then(() => {
                showNotification('Friend code copied to clipboard! üìã', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = code;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showNotification('Friend code copied! üìã', 'success');
            });
        }

        // Add friend
        function addFriend() {
            const input = document.getElementById('addFriendInput');
            const code = input.value.trim().toUpperCase();
            
            if (!code) {
                showNotification('Please enter a friend code', 'warning');
                return;
            }

            if (!code.startsWith('FIT-')) {
                showNotification('Invalid friend code format. Should start with FIT-', 'warning');
                return;
            }

            if (code === appState.user.friendCode) {
                showNotification('You cannot add yourself as a friend!', 'warning');
                return;
            }

            // Check if already friends
            if (appState.friends.some(f => f.friendCode === code)) {
                showNotification('You are already friends with this user!', 'warning');
                return;
            }

            // Simulate finding friend (in production, this would be a backend call)
            const friend = generateFriendData(code);
            appState.friends.push(friend);
            saveData();
            
            input.value = '';
            showNotification(`Added ${friend.name} as a friend! üéâ`, 'success');
            renderFriendsList();
            renderLeaderboard();
        }

        // Generate friend data (simulated - would come from backend)
        function generateFriendData(code) {
            const names = ['Alex', 'Jordan', 'Sam', 'Casey', 'Taylor', 'Morgan', 'Riley', 'Avery'];
            const randomName = names[Math.floor(Math.random() * names.length)];
            
            return {
                friendCode: code,
                name: randomName,
                level: Math.floor(Math.random() * 10) + 1,
                xp: Math.floor(Math.random() * 2000) + 100,
                streak: Math.floor(Math.random() * 30),
                totalWorkouts: Math.floor(Math.random() * 100) + 10,
                currentWeight: Math.floor(Math.random() * 50) + 180,
                startWeight: Math.floor(Math.random() * 50) + 220,
                lastActive: new Date().toISOString()
            };
        }

        // Render friends list
        function renderFriendsList() {
            const container = document.getElementById('friendsList');
            
            if (appState.friends.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë•</div>
                        <h3>No friends yet</h3>
                        <p>Add friends using their friend code to compare progress and compete!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = appState.friends.map(friend => {
                const weightLoss = friend.startWeight && friend.currentWeight ? 
                    friend.startWeight - friend.currentWeight : 0;
                
                return `
                    <div class="friend-card">
                        <div style="width: 100%;">
                            <div class="friend-info">
                                <div class="user-avatar">${friend.name.charAt(0)}</div>
                                <div style="flex: 1;">
                                    <div class="user-name">${friend.name}</div>
                                    <div class="user-stats">
                                        <span>‚≠ê Level ${friend.level}</span>
                                        <span>üî• ${friend.streak} day streak</span>
                                        <span>üí™ ${friend.totalWorkouts} workouts</span>
                                    </div>
                                </div>
                                <button class="btn" onclick="viewFriendProgress('${friend.friendCode}')" style="font-size: 14px; padding: 8px 16px;">
                                    View Progress
                                </button>
                            </div>
                            ${weightLoss > 0 ? `
                                <div style="margin-top: 15px; padding: 12px; background: var(--secondary); color: white; border-radius: 8px; text-align: center;">
                                    <strong>üéâ ${weightLoss} lbs lost!</strong>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // View friend's detailed progress
        function viewFriendProgress(friendCode) {
            const friend = appState.friends.find(f => f.friendCode === friendCode);
            if (!friend) return;

            const modal = document.getElementById('customModal');
            const content = document.getElementById('modalContent');
            
            const weightLoss = friend.startWeight && friend.currentWeight ? 
                friend.startWeight - friend.currentWeight : 0;
            
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div class="user-avatar" style="width: 100px; height: 100px; font-size: 48px; margin: 0 auto 15px;">
                        ${friend.name.charAt(0)}
                    </div>
                    <h2>${friend.name}</h2>
                    <p style="color: var(--text-light);">Level ${friend.level} ‚Ä¢ ${friend.friendCode}</p>
                </div>

                <div class="progress-grid">
                    <div class="progress-item" style="background: #f9fafb; padding: 20px; border-radius: 12px;">
                        <div style="font-size: 32px; font-weight: bold; color: var(--primary);">${friend.streak}</div>
                        <div style="color: var(--text-light); margin-top: 5px;">Day Streak üî•</div>
                    </div>
                    <div class="progress-item" style="background: #f9fafb; padding: 20px; border-radius: 12px;">
                        <div style="font-size: 32px; font-weight: bold; color: var(--primary);">${friend.totalWorkouts}</div>
                        <div style="color: var(--text-light); margin-top: 5px;">Total Workouts</div>
                    </div>
                    <div class="progress-item" style="background: #f9fafb; padding: 20px; border-radius: 12px;">
                        <div style="font-size: 32px; font-weight: bold; color: var(--primary);">${friend.xp}</div>
                        <div style="color: var(--text-light); margin-top: 5px;">Total XP</div>
                    </div>
                    <div class="progress-item" style="background: #f9fafb; padding: 20px; border-radius: 12px;">
                        <div style="font-size: 32px; font-weight: bold; color: ${weightLoss > 0 ? 'var(--secondary)' : 'var(--primary)'};">
                            ${weightLoss > 0 ? `-${weightLoss}` : '--'}
                        </div>
                        <div style="color: var(--text-light); margin-top: 5px;">Weight Loss (lbs)</div>
                    </div>
                </div>

                <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border-radius: 12px; text-align: center;">
                    <strong>üí™ Keep pushing! Compare your progress and stay motivated together!</strong>
                </div>
            `;
            
            modal.classList.add('active');
        }

        // Show different leaderboards
        function showLeaderboard(type) {
            appState.currentLeaderboard = type;
            
            // Update button states
            document.getElementById('friendsLeaderboardBtn').style.background = type === 'friends' ? 'var(--primary)' : '';
            document.getElementById('friendsLeaderboardBtn').style.color = type === 'friends' ? 'white' : '';
            document.getElementById('globalLeaderboardBtn').style.background = type === 'global' ? 'var(--primary)' : '';
            document.getElementById('globalLeaderboardBtn').style.color = type === 'global' ? 'white' : '';
            document.getElementById('streaksLeaderboardBtn').style.background = type === 'streaks' ? 'var(--primary)' : '';
            document.getElementById('streaksLeaderboardBtn').style.color = type === 'streaks' ? 'white' : '';
            
            renderLeaderboard();
        }

        // Render leaderboard
        function renderLeaderboard() {
            const container = document.getElementById('leaderboardContainer');
            let users = [];

            if (appState.currentLeaderboard === 'friends') {
                users = [...appState.friends, {
                    name: appState.user.name,
                    level: appState.user.level,
                    xp: appState.user.xp,
                    streak: appState.user.streak,
                    totalWorkouts: appState.user.totalWorkouts,
                    isCurrentUser: true
                }];
                users.sort((a, b) => b.xp - a.xp);
            } else if (appState.currentLeaderboard === 'global') {
                users = [...globalLeaderboard, {
                    name: appState.user.name,
                    level: appState.user.level,
                    xp: appState.user.xp,
                    streak: appState.user.streak,
                    totalWorkouts: appState.user.totalWorkouts,
                    isCurrentUser: true
                }];
                users.sort((a, b) => b.xp - a.xp);
            } else if (appState.currentLeaderboard === 'streaks') {
                users = [...appState.friends, {
                    name: appState.user.name,
                    level: appState.user.level,
                    xp: appState.user.xp,
                    streak: appState.user.streak,
                    totalWorkouts: appState.user.totalWorkouts,
                    isCurrentUser: true
                }];
                users.sort((a, b) => b.streak - a.streak);
            }

            if (users.length === 0 || (users.length === 1 && users[0].isCurrentUser)) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üèÜ</div>
                        <h3>No rankings yet</h3>
                        <p>${appState.currentLeaderboard === 'friends' ? 'Add friends to see rankings!' : 'Keep working out to climb the ranks!'}</p>
                    </div>
                `;
                return;
            }

            const sortKey = appState.currentLeaderboard === 'streaks' ? 'streak' : 'xp';
            
            container.innerHTML = users.map((user, index) => {
                const rank = index + 1;
                const rankClass = rank <= 3 ? `rank-${rank}` : '';
                const rankEmoji = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : rank;
                const highlightClass = user.isCurrentUser ? 'style="border: 3px solid var(--primary);"' : '';
                
                return `
                    <div class="leaderboard-item ${rankClass}" ${user.isCurrentUser ? highlightClass : ''}>
                        <div class="rank-badge">${rankEmoji}</div>
                        <div class="user-avatar">${user.name.charAt(0)}</div>
                        <div class="user-info">
                            <div class="user-name">
                                ${user.name}
                                ${user.isCurrentUser ? ' <span style="font-size: 14px; opacity: 0.8;">(You)</span>' : ''}
                            </div>
                            <div class="user-stats">
                                <span>‚≠ê Level ${user.level}</span>
                                <span>üî• ${user.streak} days</span>
                                <span>üí™ ${user.totalWorkouts} workouts</span>
                            </div>
                        </div>
                        <div class="score-badge">
                            ${sortKey === 'streak' ? `${user.streak}üî•` : `${user.xp} XP`}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render progress summary
        function renderProgressSummary() {
            const container = document.getElementById('progressSummary');
            
            const startWeight = appState.user.startWeight || appState.user.currentWeight;
            const currentWeight = appState.user.currentWeight;
            const weightLoss = startWeight && currentWeight ? startWeight - currentWeight : 0;
            
            const daysSinceStart = appState.user.startDate ? 
                Math.floor((new Date() - new Date(appState.user.startDate)) / (1000 * 60 * 60 * 24)) : 0;

            container.innerHTML = `
                <div class="progress-stat">
                    <div class="progress-stat-value">${appState.user.streak}</div>
                    <div class="progress-stat-label">Day Streak üî•</div>
                </div>
                <div class="progress-stat">
                    <div class="progress-stat-value">${appState.user.totalWorkouts}</div>
                    <div class="progress-stat-label">Total Workouts</div>
                </div>
                <div class="progress-stat">
                    <div class="progress-stat-value">${appState.user.level}</div>
                    <div class="progress-stat-label">Level Reached</div>
                </div>
                <div class="progress-stat">
                    <div class="progress-stat-value" style="color: ${weightLoss > 0 ? 'var(--secondary)' : 'inherit'}">
                        ${weightLoss > 0 ? `-${weightLoss}` : '--'}
                    </div>
                    <div class="progress-stat-label">Weight Loss (lbs)</div>
                </div>
                ${daysSinceStart > 0 ? `
                    <div class="progress-stat">
                        <div class="progress-stat-value">${daysSinceStart}</div>
                        <div class="progress-stat-label">Days Training</div>
                    </div>
                ` : ''}
                <div class="progress-stat">
                    <div class="progress-stat-value">${appState.user.achievements.length}</div>
                    <div class="progress-stat-label">Achievements</div>
                </div>
            `;
        }

        // Share progress
        function shareProgress() {
            const modal = document.getElementById('customModal');
            const content = document.getElementById('modalContent');
            
            const startWeight = appState.user.startWeight || appState.user.currentWeight;
            const currentWeight = appState.user.currentWeight;
            const weightLoss = startWeight && currentWeight ? startWeight - currentWeight : 0;
            
            // Generate shareable image/text
            const shareText = `üî• My Evol Fitnessgress üî•

‚≠ê Level ${appState.user.level}
üî• ${appState.user.streak} day streak
üí™ ${appState.user.totalWorkouts} total workouts
${weightLoss > 0 ? `üìâ ${weightLoss} lbs lost!` : ''}

Join me on FitQuest! Use my code: ${appState.user.friendCode}

#FitQuest #FitnessJourney #Transformation`;

            content.innerHTML = `
                <h2 style="margin-bottom: 20px;">Share Your Progress</h2>
                
                <div class="progress-share-card">
                    <h3 style="margin-bottom: 10px;">üî• ${appState.user.name}'s Journey</h3>
                    <div class="progress-grid">
                        <div class="progress-item">
                            <div class="progress-value">${appState.user.level}</div>
                            <div class="progress-label">Level</div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-value">${appState.user.streak}</div>
                            <div class="progress-label">Day Streak üî•</div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-value">${appState.user.totalWorkouts}</div>
                            <div class="progress-label">Workouts</div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-value">${weightLoss > 0 ? `-${weightLoss}` : '--'}</div>
                            <div class="progress-label">Weight Lost</div>
                        </div>
                    </div>
                    <div style="margin-top: 20px; text-align: center; font-size: 14px;">
                        Friend Code: <strong>${appState.user.friendCode}</strong>
                    </div>
                </div>

                <div class="share-options">
                    <div class="share-option" onclick="shareToClipboard(\`${shareText.replace(/`/g, '\\`')}\`)">
                        <div class="share-icon">üìã</div>
                        <strong>Copy Text</strong>
                    </div>
                    <div class="share-option" onclick="shareToSocial('twitter', \`${shareText.replace(/`/g, '\\`')}\`)">
                        <div class="share-icon">üê¶</div>
                        <strong>Twitter/X</strong>
                    </div>
                    <div class="share-option" onclick="shareToSocial('facebook', \`${shareText.replace(/`/g, '\\`')}\`)">
                        <div class="share-icon">üìò</div>
                        <strong>Facebook</strong>
                    </div>
                    <div class="share-option" onclick="shareNative(\`${shareText.replace(/`/g, '\\`')}\`)">
                        <div class="share-icon">üì§</div>
                        <strong>More Options</strong>
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
        }

        function shareToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('Progress copied to clipboard! üìã', 'success');
                closeModal();
            });
        }

        function shareToSocial(platform, text) {
            const encodedText = encodeURIComponent(text);
            let url = '';
            
            if (platform === 'twitter') {
                url = `https://twitter.com/intent/tweet?text=${encodedText}`;
            } else if (platform === 'facebook') {
                url = `https://www.facebook.com/sharer/sharer.php?quote=${encodedText}`;
            }
            
            window.open(url, '_blank', 'width=600,height=400');
            closeModal();
        }

        function shareNative(text) {
            if (navigator.share) {
                navigator.share({
                    title: 'My Evol Fitnessgress',
                    text: text
                }).then(() => {
                    showNotification('Progress shared! üéâ', 'success');
                    closeModal();
                }).catch(() => {
                    // User cancelled
                });
            } else {
                shareToClipboard(text);
            }
        }

        // Render challenges
        function renderChallenges() {
            const container = document.getElementById('challengesList');
            
            if (appState.challenges.length === 0) {
                container.innerHTML = `
                    <p style="opacity: 0.9;">No active challenges. Create one to compete with friends!</p>
                `;
                return;
            }

            container.innerHTML = appState.challenges.map(challenge => {
                const progress = (challenge.currentValue / challenge.targetValue) * 100;
                const daysLeft = Math.ceil((new Date(challenge.endDate) - new Date()) / (1000 * 60 * 60 * 24));
                
                return `
                    <div class="challenge-card">
                        <h4>${challenge.name}</h4>
                        <p style="opacity: 0.9; margin: 10px 0;">
                            ${challenge.description}
                        </p>
                        <div style="display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 5px;">
                            <span>${challenge.currentValue} / ${challenge.targetValue}</span>
                            <span>${daysLeft} days left</span>
                        </div>
                        <div class="challenge-progress-bar">
                            <div class="challenge-progress-fill" style="width: ${Math.min(progress, 100)}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Create challenge
        function createChallenge() {
            const modal = document.getElementById('customModal');
            const content = document.getElementById('modalContent');
            
            content.innerHTML = `
                <h2 style="margin-bottom: 20px;">Create Challenge</h2>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">Challenge Type</label>
                    <select id="challengeType" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 16px;">
                        <option value="streak">Longest Streak</option>
                        <option value="workouts">Most Workouts</option>
                        <option value="xp">Most XP Earned</option>
                        <option value="weightloss">Most Weight Lost</option>
                    </select>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">Duration (days)</label>
                    <input type="number" id="challengeDuration" value="7" min="1" max="30" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 16px;">
                </div>

                <button class="btn btn-primary" onclick="saveChallengeAndClose()" style="width: 100%;">
                    Create Challenge
                </button>
            `;
            
            modal.classList.add('active');
        }

        function saveChallengeAndClose() {
            const type = document.getElementById('challengeType').value;
            const duration = parseInt(document.getElementById('challengeDuration').value);
            
            const challengeNames = {
                streak: 'Streak Master',
                workouts: 'Workout Warrior',
                xp: 'XP Champion',
                weightloss: 'Transformation Challenge'
            };
            
            const challengeDescriptions = {
                streak: 'Who can maintain the longest workout streak?',
                workouts: 'Who can complete the most workouts?',
                xp: 'Who can earn the most XP?',
                weightloss: 'Who can lose the most weight?'
            };
            
            const challenge = {
                id: Date.now(),
                name: challengeNames[type],
                description: challengeDescriptions[type],
                type: type,
                startDate: new Date().toISOString(),
                endDate: new Date(Date.now() + duration * 24 * 60 * 60 * 1000).toISOString(),
                currentValue: 0,
                targetValue: type === 'streak' ? duration : type === 'workouts' ? duration * 2 : 500,
                participants: [appState.user.friendCode, ...appState.friends.map(f => f.friendCode)]
            };
            
            appState.challenges.push(challenge);
            saveData();
            renderChallenges();
            closeModal();
            showNotification('Challenge created! üèÜ Invite your friends!', 'success');
        }

        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // Add viewport meta tag fix for iOS
        if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
            const meta = document.querySelector('meta[name="viewport"]');
            if (meta) {
                meta.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
            }
        }

        // Settings Functions

        // Connect Apple Watch via Bluetooth (HONEST implementation)
        function connectAppleWatchBluetooth() {
            const btn = document.getElementById('appleWatchBtn');
            const status = document.getElementById('appleWatchStatus');
            
            if (!navigator.bluetooth) {
                status.style.display = 'block';
                status.innerHTML = `
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px;">
                        <strong>‚ö†Ô∏è Bluetooth Not Available</strong>
                        <p style="margin-top: 8px; font-size: 14px;">
                            Web Bluetooth API is not supported in this browser. Requirements:
                        </p>
                        <ul style="margin-top: 8px; padding-left: 20px; font-size: 13px;">
                            <li>Use Chrome, Edge, or Opera browser</li>
                            <li>Must be on HTTPS (secure connection)</li>
                            <li>Not supported in Safari or Firefox</li>
                        </ul>
                    </div>
                `;
                showNotification('Bluetooth not supported in this browser', 'warning');
                return;
            }

            btn.disabled = true;
            btn.textContent = '‚åö Searching for devices...';
            
            // Request Bluetooth device with heart rate service
            navigator.bluetooth.requestDevice({
                filters: [
                    { services: ['heart_rate'] }
                ],
                optionalServices: ['battery_service', 'device_information']
            })
            .then(device => {
                appState.user.appleWatchConnected = true;
                appState.user.connectedWatchName = device.name;
                saveData();
                
                status.style.display = 'block';
                status.innerHTML = `
                    <div class="connected-badge">‚úÖ Connected to ${device.name}</div>
                    <p style="color: var(--text-light); margin-top: 10px; font-size: 14px;">
                        Heart rate monitoring active during workouts
                    </p>
                `;
                btn.style.display = 'none';
                showNotification(`Connected to ${device.name}! üéâ`, 'success');
            })
            .catch(error => {
                btn.disabled = false;
                btn.textContent = 'üîó Connect via Bluetooth';
                
                if (error.name === 'NotFoundError') {
                    showNotification('No device selected', 'info');
                } else {
                    status.style.display = 'block';
                    status.innerHTML = `
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; font-size: 13px;">
                            <strong>Connection Failed</strong>
                            <p style="margin-top: 8px;">
                                Make sure your watch is:
                            </p>
                            <ul style="margin-top: 5px; padding-left: 20px;">
                                <li>Turned on and nearby</li>
                                <li>Bluetooth enabled</li>
                                <li>Not already connected to another device</li>
                            </ul>
                        </div>
                    `;
                    showNotification('Bluetooth connection failed', 'warning');
                    console.error('Bluetooth error:', error);
                }
            });
        }

        // Music Integration Functions

        function saveSpotifyPlaylist() {
            const input = document.getElementById('spotifyPlaylistInput');
            const url = input.value.trim();
            const status = document.getElementById('spotifyStatus');
            
            if (!url) {
                showNotification('Please enter a Spotify playlist URL', 'warning');
                return;
            }
            
            // Validate Spotify URL
            if (!url.includes('spotify.com') && !url.includes('open.spotify')) {
                showNotification('Please enter a valid Spotify URL', 'warning');
                return;
            }
            
            appState.user.spotifyPlaylist = url;
            saveData();
            
            status.style.display = 'block';
            status.innerHTML = `
                <div class="connected-badge">‚úÖ Spotify Playlist Saved</div>
                <p style="color: var(--text-light); margin-top: 8px; font-size: 14px;">
                    Music will be available during workouts
                </p>
            `;
            
            showNotification('Spotify playlist saved! üéµ', 'success');
        }

        function saveAppleMusicPlaylist() {
            const input = document.getElementById('appleMusicPlaylistInput');
            const url = input.value.trim();
            const status = document.getElementById('appleMusicStatus');
            
            if (!url) {
                showNotification('Please enter an Apple Music playlist URL', 'warning');
                return;
            }
            
            // Validate Apple Music URL
            if (!url.includes('music.apple.com')) {
                showNotification('Please enter a valid Apple Music URL', 'warning');
                return;
            }
            
            appState.user.appleMusicPlaylist = url;
            saveData();
            
            status.style.display = 'block';
            status.innerHTML = `
                <div class="connected-badge">‚úÖ Apple Music Playlist Saved</div>
                <p style="color: var(--text-light); margin-top: 8px; font-size: 14px;">
                    Music will be available during workouts
                </p>
            `;
            
            showNotification('Apple Music playlist saved! üéµ', 'success');
        }

        function saveYoutubePlaylist() {
            const input = document.getElementById('youtubePlaylistInput');
            const url = input.value.trim();
            const status = document.getElementById('youtubeStatus');
            
            if (!url) {
                showNotification('Please enter a YouTube playlist URL', 'warning');
                return;
            }
            
            // Validate YouTube URL
            if (!url.includes('youtube.com') && !url.includes('youtu.be')) {
                showNotification('Please enter a valid YouTube URL', 'warning');
                return;
            }
            
            appState.user.youtubePlaylist = url;
            saveData();
            
            status.style.display = 'block';
            status.innerHTML = `
                <div class="connected-badge">‚úÖ YouTube Playlist Saved</div>
                <p style="color: var(--text-light); margin-top: 8px; font-size: 14px;">
                    Music will be available during workouts
                </p>
            `;
            
            showNotification('YouTube playlist saved! üì∫', 'success');
        }

        // Open music during workout
        function openWorkoutMusic() {
            const playlists = [];
            
            if (appState.user.spotifyPlaylist) {
                playlists.push({ name: 'Spotify', url: appState.user.spotifyPlaylist, icon: 'üéµ' });
            }
            if (appState.user.appleMusicPlaylist) {
                playlists.push({ name: 'Apple Music', url: appState.user.appleMusicPlaylist, icon: 'üéµ' });
            }
            if (appState.user.youtubePlaylist) {
                playlists.push({ name: 'YouTube', url: appState.user.youtubePlaylist, icon: 'üì∫' });
            }
            
            if (playlists.length === 0) {
                showNotification('No playlists configured. Add one in Settings!', 'info');
                return;
            }
            
            if (playlists.length === 1) {
                window.open(playlists[0].url, '_blank');
                showNotification(`Opening ${playlists[0].name}...`, 'success');
            } else {
                // Show choice modal
                const modal = document.getElementById('customModal');
                const content = document.getElementById('modalContent');
                
                content.innerHTML = `
                    <h2 style="margin-bottom: 20px;">üéµ Choose Your Music</h2>
                    <div style="display: grid; gap: 15px;">
                        ${playlists.map(playlist => `
                            <button 
                                class="btn btn-primary" 
                                onclick="window.open('${playlist.url}', '_blank'); closeModal();"
                                style="width: 100%; padding: 20px; font-size: 18px;"
                            >
                                ${playlist.icon} Open ${playlist.name}
                            </button>
                        `).join('')}
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 15px;">
                        Cancel
                    </button>
                `;
                
                modal.classList.add('active');
            }
        }

        // Connect Bluetooth Device
        function connectBluetoothDevice() {
            const btn = document.getElementById('bluetoothBtn');
            const status = document.getElementById('bluetoothStatus');
            
            if (!navigator.bluetooth) {
                showNotification('Bluetooth not supported on this browser', 'warning');
                status.style.display = 'block';
                status.innerHTML = '<p style="color: var(--danger); margin-top: 10px;">Bluetooth Web API not supported. Try Chrome on Android or enable flags.</p>';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'üîµ Searching for devices...';
            
            navigator.bluetooth.requestDevice({
                acceptAllDevices: true,
                optionalServices: ['heart_rate', 'battery_service']
            })
            .then(device => {
                appState.user.bluetoothDevice = {
                    name: device.name,
                    id: device.id
                };
                status.style.display = 'block';
                status.innerHTML = `<div class="connected-badge">‚úÖ Connected to ${device.name}</div><p style="color: var(--text-light); margin-top: 10px; font-size: 14px;">Syncing fitness data</p>`;
                btn.style.display = 'none';
                showNotification(`Connected to ${device.name}! üéâ`, 'success');
                saveData();
            })
            .catch(error => {
                btn.disabled = false;
                btn.textContent = 'üîµ Connect via Bluetooth';
                if (error.name === 'NotFoundError') {
                    showNotification('No device selected', 'info');
                } else {
                    showNotification('Bluetooth connection failed', 'warning');
                    console.error('Bluetooth error:', error);
                }
            });
        }

        // Connect Google Account (HONEST - requires OAuth setup)
        function connectGoogle() {
            const btn = document.getElementById('googleBtn');
            const status = document.getElementById('googleStatus');
            
            status.style.display = 'block';
            status.innerHTML = `
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px;">
                    <strong>‚ö†Ô∏è Google Drive Integration Not Available</strong>
                    <p style="margin-top: 8px; font-size: 14px;">
                        Google Drive sync requires OAuth 2.0 authentication which needs:
                    </p>
                    <ul style="margin-top: 8px; padding-left: 20px; font-size: 13px;">
                        <li>Backend server for secure token storage</li>
                        <li>Google Cloud Project with Drive API enabled</li>
                        <li>OAuth 2.0 client credentials</li>
                        <li>Redirect URI configuration</li>
                    </ul>
                    <p style="margin-top: 10px; font-size: 14px;">
                        <strong>Alternative:</strong> Use the "Export Data" feature below to manually backup your data as a JSON file.
                    </p>
                </div>
            `;
            
            showNotification('Google Drive requires OAuth setup. Use Export Data instead!', 'info');
        }

        // Setup Email Backup (HONEST - just saves email for future use)
        function setupEmailBackup() {
            const emailInput = document.getElementById('emailInput');
            const status = document.getElementById('emailStatus');
            const email = emailInput.value.trim();
            
            if (!email) {
                showNotification('Please enter your email address', 'warning');
                return;
            }
            
            // Basic email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showNotification('Please enter a valid email address', 'warning');
                return;
            }
            
            appState.user.backupEmail = email;
            saveData();
            
            status.style.display = 'block';
            status.innerHTML = `
                <div class="connected-badge">‚úÖ Email Saved</div>
                <p style="color: var(--text-light); margin-top: 10px; font-size: 14px;">
                    Your email (${email}) is saved for future email report features. 
                    No emails will be sent until backend server is configured.
                </p>
            `;
            emailInput.disabled = true;
            
            showNotification('Email saved for future reports! üìß', 'success');
        }

        // Toggle Notifications
        function toggleNotifications() {
            const toggle = document.getElementById('notificationToggle');
            appState.user.notificationsEnabled = toggle.checked;
            saveData();
            
            if (toggle.checked) {
                requestNotificationPermission();
            } else {
                showNotification('Daily reminders disabled', 'info');
            }
        }

        // Toggle Weekly Reports
        function toggleWeeklyReports() {
            const toggle = document.getElementById('weeklyReportToggle');
            appState.user.weeklyReports = toggle.checked;
            saveData();
            
            showNotification(toggle.checked ? 'Weekly reports enabled üìä' : 'Weekly reports disabled', 'info');
        }

        // Toggle Friend Activity
        function toggleFriendActivity() {
            const toggle = document.getElementById('friendActivityToggle');
            appState.user.friendActivity = toggle.checked;
            saveData();
            
            showNotification(toggle.checked ? 'Friend activity notifications enabled üë•' : 'Friend activity notifications disabled', 'info');
        }

        // Export Data
        function exportData() {
            const dataStr = JSON.stringify(appState, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `fitquest-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            showNotification('Data exported successfully! üì•', 'success');
        }

        // Import Data
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        
                        // Validate the data structure
                        if (importedData.user && importedData.todayExercises) {
                            if (confirm('This will replace all your current data. Are you sure?')) {
                                appState = importedData;
                                saveData();
                                updateUI();
                                showNotification('Data imported successfully! üì§', 'success');
                                location.reload(); // Refresh to show imported data
                            }
                        } else {
                            showNotification('Invalid backup file format', 'warning');
                        }
                    } catch (error) {
                        showNotification('Failed to import data. Invalid file.', 'warning');
                        console.error('Import error:', error);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // Clear Cache
        function clearCache() {
            if (confirm('This will clear temporary data but keep your progress. Continue?')) {
                // Clear service worker cache if available
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => caches.delete(name));
                    });
                }
                showNotification('Cache cleared! üóëÔ∏è', 'success');
            }
        }

        // Reset App
        function resetApp() {
            const confirmation = prompt('‚ö†Ô∏è WARNING: This will delete ALL your data permanently. Type "DELETE" to confirm:');
            
            if (confirmation === 'DELETE') {
                localStorage.clear();
                showNotification('All data has been reset. Refreshing app...', 'warning');
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else if (confirmation !== null) {
                showNotification('Reset cancelled - incorrect confirmation', 'info');
            }
        }

        // Load settings on page load
        function loadSettings() {
            if (appState.user.notificationsEnabled) {
                document.getElementById('notificationToggle').checked = true;
            }
            if (appState.user.weeklyReports !== false) {
                document.getElementById('weeklyReportToggle').checked = true;
            }
            if (appState.user.friendActivity) {
                document.getElementById('friendActivityToggle').checked = true;
            }
            if (appState.user.backupEmail) {
                document.getElementById('emailInput').value = appState.user.backupEmail;
                document.getElementById('emailInput').disabled = true;
                document.getElementById('emailStatus').style.display = 'block';
                document.getElementById('emailStatus').innerHTML = `<div class="connected-badge">‚úÖ Email Backup Active</div>`;
            }
            if (appState.user.appleWatchConnected) {
                document.getElementById('appleWatchBtn').style.display = 'none';
                document.getElementById('appleWatchStatus').style.display = 'block';
                document.getElementById('appleWatchStatus').innerHTML = '<div class="connected-badge">‚úÖ Connected to Apple Watch</div>';
            }
            if (appState.user.googleConnected) {
                document.getElementById('googleBtn').style.display = 'none';
                document.getElementById('googleStatus').style.display = 'block';
                document.getElementById('googleStatus').innerHTML = '<div class="connected-badge">‚úÖ Connected to Google Drive</div>';
            }
            if (appState.user.bluetoothDevice) {
                document.getElementById('bluetoothBtn').style.display = 'none';
                document.getElementById('bluetoothStatus').style.display = 'block';
                document.getElementById('bluetoothStatus').innerHTML = `<div class="connected-badge">‚úÖ Connected to ${appState.user.bluetoothDevice.name}</div>`;
            }
            
            // Load background theme
            if (appState.user.backgroundTheme) {
                applyBackgroundTheme(appState.user.backgroundTheme);
            }
            if (appState.user.customBackground) {
                applyCustomBackground(appState.user.customBackground);
                document.getElementById('removeBackgroundBtn').style.display = 'inline-block';
                document.getElementById('backgroundPreview').style.display = 'block';
                document.getElementById('backgroundPreviewImage').src = appState.user.customBackground;
            }
            if (appState.user.backgroundOpacity !== undefined) {
                document.getElementById('opacitySlider').value = appState.user.backgroundOpacity;
                applyBackgroundOpacity(appState.user.backgroundOpacity);
            }
            
            // Load music playlists
            if (appState.user.spotifyPlaylist) {
                document.getElementById('spotifyPlaylistInput').value = appState.user.spotifyPlaylist;
                document.getElementById('spotifyStatus').style.display = 'block';
                document.getElementById('spotifyStatus').innerHTML = '<div class="connected-badge">‚úÖ Spotify Playlist Saved</div>';
            }
            if (appState.user.appleMusicPlaylist) {
                document.getElementById('appleMusicPlaylistInput').value = appState.user.appleMusicPlaylist;
                document.getElementById('appleMusicStatus').style.display = 'block';
                document.getElementById('appleMusicStatus').innerHTML = '<div class="connected-badge">‚úÖ Apple Music Playlist Saved</div>';
            }
            if (appState.user.youtubePlaylist) {
                document.getElementById('youtubePlaylistInput').value = appState.user.youtubePlaylist;
                document.getElementById('youtubeStatus').style.display = 'block';
                document.getElementById('youtubeStatus').innerHTML = '<div class="connected-badge">‚úÖ YouTube Playlist Saved</div>';
            }
            
            // Load font and button sizes
            if (appState.user.fontSize) {
                document.getElementById('fontSizeSlider').value = appState.user.fontSize;
                adjustFontSize(appState.user.fontSize);
            }
            if (appState.user.buttonSize) {
                document.getElementById('buttonSizeSlider').value = appState.user.buttonSize;
                adjustButtonSize(appState.user.buttonSize);
            }
            
            // Load Gemini API key if saved
            if (appState.user.geminiApiKey) {
                geminiAI.apiKey = appState.user.geminiApiKey;
                if (document.getElementById('geminiApiKeyInput')) {
                    document.getElementById('geminiApiKeyInput').value = appState.user.geminiApiKey;
                    document.getElementById('geminiStatus').style.display = 'block';
                    document.getElementById('geminiStatus').innerHTML = '<div class="connected-badge">‚úÖ Gemini AI Connected</div>';
                }
            }
            
            // Load Easy-Peasy AI settings
            if (appState.user.easyPeasyEnabled !== undefined) {
                easyPeasyAI.enabled = appState.user.easyPeasyEnabled;
                if (document.getElementById('easyPeasyToggle')) {
                    document.getElementById('easyPeasyToggle').checked = easyPeasyAI.enabled;
                    toggleEasyPeasyAI(easyPeasyAI.enabled);
                }
            } else {
                // Default to enabled
                appState.user.easyPeasyEnabled = true;
                easyPeasyAI.enabled = true;
            }
        }

        // Background Theme Functions
        const backgroundThemes = {
            default: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            ocean: 'linear-gradient(135deg, #2196F3 0%, #00BCD4 100%)',
            sunset: 'linear-gradient(135deg, #FF6B6B 0%, #FFE66D 100%)',
            forest: 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)',
            dark: 'linear-gradient(135deg, #232526 0%, #414345 100%)',
            fire: 'linear-gradient(135deg, #f12711 0%, #f5af19 100%)'
        };

        function setBackgroundTheme(theme) {
            appState.user.backgroundTheme = theme;
            appState.user.customBackground = null; // Clear custom background
            saveData();
            
            applyBackgroundTheme(theme);
            showNotification('Background theme updated! üé®', 'success');
            
            // Hide remove custom background button
            document.getElementById('removeBackgroundBtn').style.display = 'none';
            document.getElementById('backgroundPreview').style.display = 'none';
        }

        function applyBackgroundTheme(theme) {
            // Clear any custom background image first
            document.body.style.backgroundImage = '';
            document.body.style.backgroundSize = '';
            document.body.style.backgroundPosition = '';
            document.body.style.backgroundAttachment = '';
            document.body.style.backgroundRepeat = '';
            
            // Apply gradient theme
            document.body.style.background = backgroundThemes[theme] || backgroundThemes.default;
            
            // Update active theme indicator
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('active');
                if (option.dataset.theme === theme) {
                    option.classList.add('active');
                }
            });
        }

        // Custom Background Functions with Image Compression
        function uploadCustomBackground(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check if it's an image
            if (!file.type.match('image.*')) {
                showNotification('Please select an image file (JPG, PNG, GIF, WebP)', 'warning');
                event.target.value = '';
                return;
            }
            
            showNotification('Processing image... Please wait.', 'info');
            
            const reader = new FileReader();
            
            reader.onerror = function() {
                showNotification('Failed to read image file. Please try again.', 'warning');
                event.target.value = '';
            };
            
            reader.onload = function(e) {
                try {
                    const img = new Image();
                    
                    img.onload = function() {
                        // Compress image to fit in localStorage
                        compressImage(img, function(compressedDataUrl) {
                            if (!compressedDataUrl) {
                                showNotification('Failed to compress image. Try a smaller file.', 'warning');
                                event.target.value = '';
                                return;
                            }
                            
                            // Check if compressed image fits in storage
                            const sizeInMB = (compressedDataUrl.length * 0.75) / (1024 * 1024);
                            
                            if (sizeInMB > 3) {
                                showNotification(`Image still too large (${sizeInMB.toFixed(1)}MB). Please use a smaller image or lower resolution photo.`, 'warning');
                                event.target.value = '';
                                return;
                            }
                            
                            try {
                                appState.user.customBackground = compressedDataUrl;
                                appState.user.backgroundTheme = null;
                                saveData();
                                
                                applyCustomBackground(compressedDataUrl);
                                showNotification(`Background applied! (${sizeInMB.toFixed(1)}MB) üñºÔ∏è`, 'success');
                                
                                document.getElementById('removeBackgroundBtn').style.display = 'inline-block';
                                document.getElementById('backgroundPreview').style.display = 'block';
                                document.getElementById('backgroundPreviewImage').src = compressedDataUrl;
                                
                                document.querySelectorAll('.theme-option').forEach(option => {
                                    option.classList.remove('active');
                                });
                            } catch (saveError) {
                                console.error('Save error:', saveError);
                                showNotification('Image too large for browser storage. Try a much smaller image.', 'warning');
                                event.target.value = '';
                            }
                        });
                    };
                    
                    img.onerror = function() {
                        showNotification('Failed to load image. Please try a different file.', 'warning');
                        event.target.value = '';
                    };
                    
                    img.src = e.target.result;
                    
                } catch (error) {
                    console.error('Background upload error:', error);
                    showNotification('Failed to process image. Please try again.', 'warning');
                    event.target.value = '';
                }
            };
            
            reader.readAsDataURL(file);
        }

        // Compress image to fit in storage - MAXIMUM COMPRESSION
        function compressImage(img, callback) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Calculate new dimensions (max 1280x720 for maximum storage)
            let width = img.width;
            let height = img.height;
            const maxWidth = 1280; // Reduced from 1920
            const maxHeight = 720;  // Reduced from 1080
            
            if (width > maxWidth || height > maxHeight) {
                const ratio = Math.min(maxWidth / width, maxHeight / height);
                width = Math.floor(width * ratio);
                height = Math.floor(height * ratio);
            }
            
            canvas.width = width;
            canvas.height = height;
            
            // Draw image
            ctx.drawImage(img, 0, 0, width, height);
            
            // Try WebP first (50% smaller than JPEG!)
            let dataUrl = null;
            try {
                dataUrl = canvas.toDataURL('image/webp', 0.75);
                // Check if browser supports WebP
                if (!dataUrl.includes('data:image/webp')) {
                    dataUrl = null; // WebP not supported
                }
            } catch (e) {
                dataUrl = null;
            }
            
            // Fallback to JPEG with aggressive compression
            if (!dataUrl) {
                let quality = 0.7; // Start at 70%
                dataUrl = canvas.toDataURL('image/jpeg', quality);
                
                // Reduce quality until under 80KB target
                while (dataUrl.length > 80 * 1024 && quality > 0.3) {
                    quality -= 0.05;
                    dataUrl = canvas.toDataURL('image/jpeg', quality);
                }
            }
            
            callback(dataUrl);
        }

        function applyCustomBackground(imageData) {
            try {
                // Clear gradient background first
                document.body.style.background = '';
                
                // Apply custom image
                document.body.style.backgroundImage = `url('${imageData}')`;
                document.body.style.backgroundSize = 'cover';
                document.body.style.backgroundPosition = 'center';
                document.body.style.backgroundAttachment = 'fixed';
                document.body.style.backgroundRepeat = 'no-repeat';
                document.body.style.backgroundColor = '#667eea'; // Fallback color
            } catch (error) {
                console.error('Failed to apply background:', error);
                showNotification('Failed to apply background. Image may be corrupted.', 'warning');
            }
        }

        function removeCustomBackground() {
            if (confirm('Remove your custom background and return to default theme?')) {
                appState.user.customBackground = null;
                appState.user.backgroundTheme = 'default';
                saveData();
                
                applyBackgroundTheme('default');
                document.getElementById('removeBackgroundBtn').style.display = 'none';
                document.getElementById('backgroundPreview').style.display = 'none';
                document.getElementById('backgroundUpload').value = '';
                
                showNotification('Custom background removed', 'info');
            }
        }

        // Background Opacity Functions
        function adjustBackgroundOpacity(value) {
            appState.user.backgroundOpacity = parseInt(value);
            saveData();
            applyBackgroundOpacity(value);
        }

        function applyBackgroundOpacity(value) {
            const opacity = value / 100;
            document.documentElement.style.setProperty('--overlay-opacity', opacity);
            document.getElementById('opacityValue').textContent = `${value}% overlay`;
            
            if (value > 0) {
                document.body.classList.add('has-overlay');
            } else {
                document.body.classList.remove('has-overlay');
            }
        }

        // Start Workout (with device integration)
        function startWorkout() {
            // Check if devices are connected
            let message = 'üèãÔ∏è Starting workout mode!\n\n';
            
            if (appState.user.appleWatchConnected) {
                message += '‚åö Apple Watch will track your heart rate and calories\n';
            }
            if (appState.user.bluetoothDevice) {
                message += `üîµ ${appState.user.bluetoothDevice.name} connected\n`;
            }
            
            // Initialize workout state
            appState.workoutState = {
                currentExerciseIndex: 0,
                currentSet: 0,
                inRest: false,
                startTime: new Date(),
                completedSets: []
            };
            
            // Show workout mode
            enterWorkoutMode();
        }

        // Enter full-screen workout mode
        function enterWorkoutMode() {
            document.getElementById('workoutModeOverlay').classList.add('active');
            displayCurrentExercise();
            
            // Show music notification if playlists are configured
            if (appState.user.spotifyPlaylist || appState.user.appleMusicPlaylist || appState.user.youtubePlaylist) {
                setTimeout(() => {
                    showNotification('üéµ Tap the music button to play your workout playlist!', 'info');
                }, 1000);
            }
        }

        // Exit workout mode
        function exitWorkoutMode() {
            if (confirm('Are you sure you want to exit? Your progress will be saved.')) {
                document.getElementById('workoutModeOverlay').classList.remove('active');
                
                // Save completed exercises
                if (appState.workoutState && appState.workoutState.completedSets) {
                    appState.workoutState.completedSets.forEach(exerciseIndex => {
                        if (!appState.todayExercises[exerciseIndex].completed) {
                            appState.todayExercises[exerciseIndex].completed = true;
                        }
                    });
                }
                
                saveData();
                updateUI();
                appState.workoutState = null;
            }
        }

        // Display current exercise
        function displayCurrentExercise() {
            const state = appState.workoutState;
            const exercise = appState.todayExercises[state.currentExerciseIndex];
            const workoutMain = document.getElementById('workoutMain');
            
            // Update progress header
            document.getElementById('workoutProgress').textContent = 
                `Exercise ${state.currentExerciseIndex + 1} of ${appState.todayExercises.length}`;
            
            // Parse sets (e.g., "4 sets" -> 4)
            const totalSets = parseInt(exercise.sets.split(' ')[0]);
            
            // Create set indicators
            let setIndicators = '';
            for (let i = 0; i < totalSets; i++) {
                let className = 'set-indicator';
                if (i < state.currentSet) {
                    className += ' completed';
                } else if (i === state.currentSet) {
                    className += ' active';
                }
                setIndicators += `<div class="${className}">${i + 1}</div>`;
            }
            
            // Check if exercise uses weights
            const usesWeights = ['Backpack Floor Press', 'Lateral Raises', 'Dumbbell', 'Barbell'].some(term => 
                exercise.name.includes(term)
            );
            
            // Initialize weight tracking if not exists
            if (!exercise.weightLog) {
                exercise.weightLog = [];
            }
            
            workoutMain.innerHTML = `
                <div class="exercise-card-large">
                    <div class="exercise-name-large">${exercise.name}</div>
                    <div class="exercise-details-large">
                        ${exercise.reps}
                    </div>
                    
                    <div class="set-tracker">
                        ${setIndicators}
                    </div>
                    
                    <div class="timer-label">Current Set: ${state.currentSet + 1} of ${totalSets}</div>
                    
                    ${usesWeights ? `
                        <div style="margin: 20px 0; padding: 20px; background: #f9fafb; border-radius: 12px;">
                            <label style="display: block; font-weight: bold; margin-bottom: 10px;">
                                Weight Used (optional)
                            </label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input 
                                    type="number" 
                                    id="weightInput" 
                                    placeholder="e.g., 25"
                                    style="flex: 1; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 18px;"
                                    min="0"
                                    step="5"
                                >
                                <span style="font-size: 18px; font-weight: bold;">lbs</span>
                            </div>
                            <p style="font-size: 13px; color: var(--text-light); margin-top: 8px;">
                                Track your weight to see strength progress over time
                            </p>
                        </div>
                    ` : ''}
                    
                    <div class="workout-instructions">
                        <h4>How to perform:</h4>
                        <ul>
                            ${getExerciseInstructions(exercise.name)}
                        </ul>
                    </div>
                    
                    <button class="workout-button btn-set-done" onclick="completeSet()">
                        ‚úì Set ${state.currentSet + 1} Done
                    </button>
                </div>
            `;
        }

        // Get exercise instructions
        function getExerciseInstructions(exerciseName) {
            const instructions = {
                'Push-ups': `
                    <li>Start in plank position with hands shoulder-width apart</li>
                    <li>Lower your body until chest nearly touches the floor</li>
                    <li>Push back up to starting position</li>
                    <li>Keep core tight and back straight throughout</li>
                `,
                'Pike Push-ups': `
                    <li>Start in downward dog position with hips raised high</li>
                    <li>Lower your head toward the ground between your hands</li>
                    <li>Press back up to starting position</li>
                    <li>Focus on shoulders and upper chest</li>
                `,
                'Chair Dips': `
                    <li>Place hands on edge of chair behind you</li>
                    <li>Lower body by bending elbows to 90 degrees</li>
                    <li>Push back up to straighten arms</li>
                    <li>Keep shoulders down away from ears</li>
                `,
                'Backpack Floor Press': `
                    <li>Lie on back holding loaded backpack at chest</li>
                    <li>Press backpack up until arms are fully extended</li>
                    <li>Lower back to chest with control</li>
                    <li>Keep shoulder blades squeezed together</li>
                `,
                'Lateral Raises': `
                    <li>Stand with dumbbells or resistance bands at sides</li>
                    <li>Raise arms out to sides until parallel to floor</li>
                    <li>Lower with control back to starting position</li>
                    <li>Keep slight bend in elbows throughout</li>
                `
            };
            
            return instructions[exerciseName] || '<li>Perform the exercise with proper form</li>';
        }

        // Complete a set
        function completeSet() {
            const state = appState.workoutState;
            const exercise = appState.todayExercises[state.currentExerciseIndex];
            const totalSets = parseInt(exercise.sets.split(' ')[0]);
            
            // Record weight if entered
            const weightInput = document.getElementById('weightInput');
            if (weightInput && weightInput.value) {
                const weight = parseInt(weightInput.value);
                if (!exercise.weightLog) exercise.weightLog = [];
                exercise.weightLog.push({
                    date: new Date().toISOString(),
                    set: state.currentSet + 1,
                    weight: weight
                });
                saveData();
            }
            
            // Increment set counter
            state.currentSet++;
            
            // Check if all sets are done for this exercise
            if (state.currentSet >= totalSets) {
                // Mark exercise as completed
                if (!state.completedSets.includes(state.currentExerciseIndex)) {
                    state.completedSets.push(state.currentExerciseIndex);
                }
                
                // Move to next exercise or finish workout
                if (state.currentExerciseIndex < appState.todayExercises.length - 1) {
                    // Show rest period before next exercise
                    showRestPeriod(90); // 90 seconds between exercises
                } else {
                    // Workout complete!
                    finishWorkout();
                }
            } else {
                // Show rest period between sets
                showRestPeriod(60); // 60 seconds between sets
            }
        }

        // Show rest period
        function showRestPeriod(seconds) {
            const state = appState.workoutState;
            const workoutMain = document.getElementById('workoutMain');
            
            state.inRest = true;
            state.restTimeRemaining = seconds;
            
            workoutMain.innerHTML = `
                <div class="rest-timer">
                    <h2 style="margin-bottom: 20px;">üí™ Rest Period</h2>
                    <div class="timer-label">Take a breather...</div>
                    <div class="timer-display" id="restTimer">${formatTime(seconds)}</div>
                    <div style="margin-top: 20px; font-size: 18px; opacity: 0.9;">
                        Next: ${state.currentSet >= parseInt(appState.todayExercises[state.currentExerciseIndex].sets.split(' ')[0]) 
                            ? (state.currentExerciseIndex < appState.todayExercises.length - 1 
                                ? appState.todayExercises[state.currentExerciseIndex + 1].name 
                                : 'Workout Complete!')
                            : `Set ${state.currentSet + 1} of ${appState.todayExercises[state.currentExerciseIndex].name}`
                        }
                    </div>
                    <button class="workout-button btn-skip-rest" onclick="skipRest()">
                        Skip Rest ‚è≠Ô∏è
                    </button>
                </div>
            `;
            
            // Start countdown
            startRestTimer();
        }

        // Start rest timer countdown
        function startRestTimer() {
            const state = appState.workoutState;
            
            if (state.restInterval) {
                clearInterval(state.restInterval);
            }
            
            state.restInterval = setInterval(() => {
                state.restTimeRemaining--;
                
                const timerDisplay = document.getElementById('restTimer');
                if (timerDisplay) {
                    timerDisplay.textContent = formatTime(state.restTimeRemaining);
                }
                
                if (state.restTimeRemaining <= 0) {
                    clearInterval(state.restInterval);
                    endRest();
                }
            }, 1000);
        }

        // Format time as MM:SS
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Skip rest period
        function skipRest() {
            if (appState.workoutState.restInterval) {
                clearInterval(appState.workoutState.restInterval);
            }
            endRest();
        }

        // End rest period
        function endRest() {
            const state = appState.workoutState;
            state.inRest = false;
            
            const exercise = appState.todayExercises[state.currentExerciseIndex];
            const totalSets = parseInt(exercise.sets.split(' ')[0]);
            
            // Check if moving to next exercise
            if (state.currentSet >= totalSets) {
                state.currentExerciseIndex++;
                state.currentSet = 0;
            }
            
            displayCurrentExercise();
        }

        // Finish workout
        function finishWorkout() {
            const state = appState.workoutState;
            const workoutMain = document.getElementById('workoutMain');
            
            // Calculate workout duration
            const duration = Math.floor((new Date() - state.startTime) / 1000 / 60); // in minutes
            
            // Mark all exercises as completed
            state.completedSets.forEach(index => {
                appState.todayExercises[index].completed = true;
            });
            
            const xpEarned = state.completedSets.length * 10;
            
            workoutMain.innerHTML = `
                <div class="exercise-card-large celebration">
                    <div style="font-size: 80px; margin-bottom: 20px;">üéâ</div>
                    <div class="exercise-name-large">Workout Complete!</div>
                    <div class="exercise-details-large">
                        Amazing job!
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin: 30px 0;">
                        <div style="background: #f9fafb; padding: 20px; border-radius: 12px;">
                            <div style="font-size: 36px; font-weight: bold; color: var(--primary);">${state.completedSets.length}</div>
                            <div style="color: var(--text-light); margin-top: 5px;">Exercises</div>
                        </div>
                        <div style="background: #f9fafb; padding: 20px; border-radius: 12px;">
                            <div style="font-size: 36px; font-weight: bold; color: var(--primary);">${duration}</div>
                            <div style="color: var(--text-light); margin-top: 5px;">Minutes</div>
                        </div>
                        <div style="background: #f9fafb; padding: 20px; border-radius: 12px;">
                            <div style="font-size: 36px; font-weight: bold; color: var(--secondary);">+${xpEarned}</div>
                            <div style="color: var(--text-light); margin-top: 5px;">XP Earned</div>
                        </div>
                        <div style="background: #f9fafb; padding: 20px; border-radius: 12px;">
                            <div style="font-size: 36px; font-weight: bold; color: var(--warning);">üî•</div>
                            <div style="color: var(--text-light); margin-top: 5px;">Streak +1</div>
                        </div>
                    </div>
                    
                    <button class="workout-button" style="background: var(--secondary); color: white;" onclick="saveAndExitWorkout()">
                        ‚úì Finish & Save Progress
                    </button>
                </div>
            `;
        }

        // Save and exit workout
        function saveAndExitWorkout() {
            const state = appState.workoutState;
            
            // Set start date if first workout
            if (appState.user.totalWorkouts === 0) {
                appState.user.startDate = new Date().toISOString();
                if (appState.user.currentWeight) {
                    appState.user.startWeight = appState.user.currentWeight;
                }
            }
            
            // Calculate XP
            const xpEarned = state.completedSets.length * 10;
            
            // Add XP
            appState.user.xp += xpEarned;
            appState.user.totalWorkouts++;
            appState.user.streak++;
            appState.user.lastWorkoutDate = new Date().toISOString();

            // Level up check
            while (appState.user.xp >= appState.user.maxXP) {
                appState.user.xp -= appState.user.maxXP;
                appState.user.level++;
                appState.user.maxXP = Math.floor(appState.user.maxXP * 1.5);
                
                if (appState.user.level === 5) {
                    unlockAchievement(3);
                }
            }

            // Check achievements
            if (appState.user.totalWorkouts === 1) {
                unlockAchievement(1);
            }
            if (appState.user.streak === 7) {
                unlockAchievement(2);
            }
            if (appState.user.totalWorkouts === 25) {
                unlockAchievement(5);
            }

            // Reset exercises for tomorrow
            appState.todayExercises.forEach(e => e.completed = false);
            
            // Clear workout state
            appState.workoutState = null;
            
            // Save and update
            saveData();
            updateUI();
            
            // Exit workout mode
            document.getElementById('workoutModeOverlay').classList.remove('active');
            
            showNotification(`üéâ Workout Complete! +${xpEarned} XP earned! Streak: ${appState.user.streak} days üî•`, 'success');
        }
    </script>
</body>
</html>
