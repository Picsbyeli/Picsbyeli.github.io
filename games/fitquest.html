<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <title>FitQuest - Level Up Your Fitness</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-dark: #1f2937;
            --bg-light: #f3f4f6;
            --text-dark: #111827;
            --text-light: #6b7280;
            --border: #e5e7eb;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-dark);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header with User Stats */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            position: relative;
        }

        .avatar-upload {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 28px;
            height: 28px;
            background: var(--secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 3px solid white;
        }

        .user-info h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .level-badge {
            display: inline-block;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        /* XP Progress Bar */
        .xp-container {
            margin-top: 15px;
        }

        .xp-bar {
            height: 30px;
            background: #e5e7eb;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .xp-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            z-index: 1;
            color: var(--text-dark);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary);
            display: block;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-light);
            margin-top: 5px;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 10px;
            background: white;
            padding: 10px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .nav-tab {
            padding: 12px 25px;
            border: none;
            background: transparent;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-light);
            transition: all 0.3s;
            white-space: nowrap;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        /* Content Sections */
        .content-section {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            animation: fadeIn 0.3s;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Today's Workout Section */
        .workout-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .workout-card h2 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .workout-meta {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn {
            background: white;
            color: var(--primary);
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-success {
            background: var(--secondary);
            color: white;
        }

        /* Exercise List */
        .exercise-list {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .exercise-item {
            background: #f9fafb;
            padding: 20px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--primary);
        }

        .exercise-info h3 {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .exercise-details {
            color: var(--text-light);
            font-size: 14px;
        }

        .exercise-checkbox {
            width: 30px;
            height: 30px;
            cursor: pointer;
        }

        /* AI Chat Interface - ChatGPT Style */
        .chat-container {
            border: 1px solid #d1d5db;
            border-radius: 12px;
            height: 600px;
            display: flex;
            flex-direction: column;
            background: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .chat-messages {
            flex: 1;
            padding: 0;
            overflow-y: auto;
            background: white;
        }

        .message {
            padding: 24px;
            border-bottom: 1px solid #f0f0f0;
            animation: fadeIn 0.3s;
            display: flex;
            gap: 16px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .message-content {
            flex: 1;
            line-height: 1.6;
        }

        .message.user {
            background: white;
        }

        .message.user .message-avatar {
            background: #19c37d;
            color: white;
        }

        .message.ai {
            background: #f7f7f8;
        }

        .message.ai .message-avatar {
            background: #19c37d;
            color: white;
        }

        .chat-input-container {
            display: flex;
            padding: 16px;
            gap: 10px;
            border-top: 1px solid #d1d5db;
            background: white;
            align-items: flex-end;
        }

        .chat-input-wrapper {
            flex: 1;
            position: relative;
        }

        .chat-input {
            width: 100%;
            padding: 12px 80px 12px 12px;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            font-size: 16px;
            resize: none;
            font-family: inherit;
            max-height: 200px;
            min-height: 48px;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
        }

        .input-actions {
            position: absolute;
            right: 8px;
            bottom: 8px;
            display: flex;
            gap: 6px;
        }

        .icon-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: background 0.2s;
        }

        .icon-btn:hover {
            background: #f3f4f6;
        }

        .send-btn {
            background: var(--primary);
            color: white;
        }

        .send-btn:hover {
            background: var(--primary-dark);
        }

        .send-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #9ca3af;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        #imagePreview {
            display: none;
            margin-top: 10px;
            padding: 8px;
            background: #f3f4f6;
            border-radius: 8px;
        }

        #imagePreview img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 6px;
            display: block;
        }

        #imagePreview .remove-image {
            margin-top: 6px;
            padding: 4px 12px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        /* Body Scan Section */
        .camera-container {
            background: #1f2937;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .camera-preview {
            width: 100%;
            max-width: 400px;
            height: 400px;
            background: #374151;
            border-radius: 12px;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .camera-preview video,
        .camera-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-upload-zone {
            border: 3px dashed var(--border);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .photo-upload-zone:hover {
            border-color: var(--primary);
            background: #f9fafb;
        }

        /* Progress Photos Gallery */
        .photo-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .photo-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 1;
            cursor: pointer;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-date {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px;
            font-size: 12px;
            text-align: center;
        }

        /* Achievement Cards */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .achievement-card {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            transition: transform 0.3s;
        }

        .achievement-card:hover {
            transform: translateY(-5px);
        }

        .achievement-card.unlocked {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
        }

        .achievement-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        /* Progress Timeline */
        .timeline-container {
            position: relative;
            padding-left: 40px;
        }

        .timeline-line {
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(to bottom, var(--primary), var(--secondary));
        }

        .timeline-item {
            position: relative;
            margin-bottom: 30px;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .timeline-dot {
            position: absolute;
            left: -29px;
            top: 20px;
            width: 20px;
            height: 20px;
            background: var(--primary);
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .timeline-photo {
            width: 100%;
            max-width: 300px;
            height: 300px;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .timeline-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
            font-size: 14px;
            color: var(--text-light);
        }

        .timeline-analysis {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        /* Notification System */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 2000;
            min-width: 300px;
            animation: slideInRight 0.3s;
        }

        @keyframes slideInRight {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification-success {
            border-left: 4px solid var(--secondary);
        }

        .notification-info {
            border-left: 4px solid var(--primary);
        }

        .notification-warning {
            border-left: 4px solid var(--warning);
        }

        /* iOS-specific styles */
        @supports (-webkit-touch-callout: none) {
            body {
                -webkit-user-select: none;
                -webkit-tap-highlight-color: transparent;
            }
            
            .btn {
                -webkit-appearance: none;
                cursor: pointer;
            }
            
            input, select, textarea {
                font-size: 16px; /* Prevents zoom on iOS */
                -webkit-appearance: none;
            }
        }

        /* Pull to refresh indicator (mobile) */
        .refresh-indicator {
            position: absolute;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: top 0.3s;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                padding: 20px 15px;
            }

            .user-profile {
                flex-direction: column;
                text-align: center;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .stat-card {
                padding: 12px;
            }

            .stat-value {
                font-size: 24px;
            }

            .message {
                max-width: 90%;
            }

            .nav-tabs {
                padding: 8px;
                gap: 5px;
            }

            .nav-tab {
                padding: 10px 15px;
                font-size: 14px;
            }

            .content-section {
                padding: 20px 15px;
            }

            .workout-card {
                padding: 20px;
            }

            .workout-card h2 {
                font-size: 22px;
            }

            .btn {
                padding: 12px 20px;
                font-size: 14px;
            }

            .modal-content {
                width: 95%;
                padding: 25px 20px;
                max-height: 90vh;
            }

            .timeline-container {
                padding-left: 25px;
            }

            .timeline-photo {
                max-width: 100%;
                height: auto;
            }

            .notification {
                right: 10px;
                left: 10px;
                min-width: auto;
            }

            .chat-container {
                height: 400px;
            }

            .camera-preview {
                height: 300px;
            }
        }

        /* Extra small devices */
        @media (max-width: 380px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .workout-meta {
                flex-direction: column;
                gap: 10px;
            }

            .nav-tab {
                padding: 8px 12px;
                font-size: 13px;
            }
        }

        /* Landscape mobile */
        @media (max-height: 500px) and (orientation: landscape) {
            .modal-content {
                max-height: 95vh;
                overflow-y: auto;
            }
        }

        /* Touch-friendly spacing */
        @media (hover: none) and (pointer: coarse) {
            .btn {
                min-height: 44px; /* iOS recommended touch target */
            }

            .exercise-checkbox {
                width: 40px;
                height: 40px;
            }

            .nav-tab {
                min-height: 44px;
            }
        }

        /* Leaderboard Styles */
        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            margin-bottom: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid var(--border);
        }

        .leaderboard-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }

        .leaderboard-item.rank-1 {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            border: none;
        }

        .leaderboard-item.rank-2 {
            background: linear-gradient(135deg, #e5e7eb, #d1d5db);
            border: none;
        }

        .leaderboard-item.rank-3 {
            background: linear-gradient(135deg, #fed7aa, #fb923c);
            border: none;
        }

        .rank-badge {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            background: var(--bg-light);
            flex-shrink: 0;
        }

        .leaderboard-item.rank-1 .rank-badge,
        .leaderboard-item.rank-2 .rank-badge,
        .leaderboard-item.rank-3 .rank-badge {
            background: rgba(255,255,255,0.3);
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-stats {
            display: flex;
            gap: 15px;
            font-size: 14px;
            opacity: 0.9;
            flex-wrap: wrap;
        }

        .score-badge {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            flex-shrink: 0;
        }

        .leaderboard-item.rank-1 .score-badge,
        .leaderboard-item.rank-2 .score-badge,
        .leaderboard-item.rank-3 .score-badge {
            color: white;
        }

        /* Friend Cards */
        .friend-card {
            background: #f9fafb;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .friend-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .friend-progress {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .progress-stat {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }

        .progress-stat-value {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary);
        }

        /* Friends Tab Styles */
        .friends-tab {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-light);
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .friends-tab:hover {
            background: rgba(99, 102, 241, 0.05);
            color: var(--primary);
        }
        
        .friends-tab.active {
            background: white;
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }

        .progress-stat-label {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 3px;
        }

        /* Challenge Cards */
        .challenge-card {
            background: rgba(255,255,255,0.2);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .challenge-progress-bar {
            height: 10px;
            background: rgba(255,255,255,0.3);
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }

        .challenge-progress-fill {
            height: 100%;
            background: white;
            transition: width 0.3s;
        }

        /* Share Modal */
        .share-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .share-option {
            padding: 20px;
            border: 2px solid var(--border);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .share-option:hover {
            border-color: var(--primary);
            background: #f9fafb;
        }

        .share-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        /* Progress Card for Sharing */
        .progress-share-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            margin: 20px 0;
        }

        .progress-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .progress-item {
            text-align: center;
        }

        .progress-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .progress-label {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* Settings Styles */
        .setting-item {
            padding: 20px;
            background: #f9fafb;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .setting-item h4 {
            margin-bottom: 5px;
            font-size: 18px;
        }

        .setting-info {
            margin-bottom: 10px;
        }

        .connected-badge {
            display: inline-block;
            background: var(--secondary);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-top: 10px;
        }

        .disconnected-badge {
            display: inline-block;
            background: var(--text-light);
            color: white;
        }

        /* Music Player Styles */
        .music-player-modal {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            z-index: 2500;
            display: none;
            color: white;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
            max-height: 70vh;
            overflow-y: auto;
        }

        .music-player-modal.minimized {
            max-height: 80px;
            overflow: hidden;
        }

        .music-player-container {
            padding: 20px;
        }

        .music-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255,255,255,0.2);
        }

        .music-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .minimize-btn, .close-music-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 20px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }

        .minimize-btn:hover, .close-music-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .quick-playlists {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .playlist-link-btn {
            padding: 10px 20px;
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .playlist-link-btn:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
        }

        .playlist-link-btn.remove {
            background: rgba(239,68,68,0.3);
            border-color: rgba(239,68,68,0.5);
        }

        .music-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .music-tab {
            padding: 12px 24px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .music-tab.active {
            background: rgba(255,255,255,0.3);
        }

        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 15px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 16px;
        }

        .search-input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .search-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(16,185,129,0.3);
        }

        .music-results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .music-card {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .music-card:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.3);
            transform: translateY(-5px);
        }

        .music-thumbnail {
            width: 100%;
            height: 140px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .music-title {
            font-weight: bold;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .music-artist {
            color: rgba(255,255,255,0.7);
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .now-playing {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
        }

        .now-playing.active {
            display: block;
        }

        .youtube-player-container {
            width: 100%;
            max-width: 640px;
            margin: 0 auto;
        }

        .audio-player {
            width: 100%;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .music-player-container {
                margin: 20px;
                padding: 20px;
            }

            .music-results {
                grid-template-columns: 1fr;
            }

            .music-tabs {
                flex-wrap: wrap;
            }
        }
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-top: 10px;
        }

        /* Background Theme Styles */
        .theme-option {
            cursor: pointer;
            padding: 10px;
            border: 3px solid transparent;
            border-radius: 12px;
            transition: all 0.3s;
        }

        .theme-option:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .theme-option.active {
            border-color: var(--primary);
            background: #f9fafb;
        }

        /* Background overlay for opacity control */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0);
            pointer-events: none;
            z-index: 0;
            transition: background 0.3s;
        }

        body.has-overlay::before {
            background: rgba(0, 0, 0, var(--overlay-opacity, 0));
        }

        .container {
            position: relative;
            z-index: 1;
        }

        .workout-mode-overlay {
            z-index: 3000;
        }

        /* Workout Mode Styles */
        .workout-mode-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 3000;
            display: none;
            flex-direction: column;
        }

        .workout-mode-overlay.active {
            display: flex;
        }

        .workout-header {
            padding: 20px;
            background: rgba(0,0,0,0.3);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .workout-progress {
            font-size: 18px;
            font-weight: bold;
        }

        .workout-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            overflow-y: auto;
        }

        .exercise-card-large {
            background: white;
            border-radius: 25px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.4s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .exercise-name-large {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--primary);
        }

        .exercise-details-large {
            font-size: 24px;
            color: var(--text-light);
            margin-bottom: 30px;
        }

        .set-tracker {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .set-indicator {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .set-indicator.completed {
            background: var(--secondary);
            color: white;
            transform: scale(1.1);
        }

        .set-indicator.active {
            background: var(--primary);
            color: white;
            transform: scale(1.2);
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
        }

        .timer-display {
            font-size: 72px;
            font-weight: bold;
            color: var(--primary);
            margin: 30px 0;
            font-variant-numeric: tabular-nums;
        }

        .timer-label {
            font-size: 18px;
            color: var(--text-light);
            margin-bottom: 10px;
        }

        .rest-timer {
            background: var(--warning);
            color: white;
            padding: 40px;
            border-radius: 25px;
            text-align: center;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .rest-timer .timer-display {
            color: white;
            font-size: 96px;
        }

        .workout-button {
            padding: 20px 50px;
            font-size: 24px;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            margin-top: 30px;
            transition: transform 0.2s;
        }

        .workout-button:active {
            transform: scale(0.95);
        }

        .btn-set-done {
            background: var(--secondary);
            color: white;
        }

        .btn-skip-rest {
            background: white;
            color: var(--warning);
        }

        .btn-exit-workout {
            background: var(--danger);
            color: white;
            padding: 10px 20px;
            font-size: 16px;
        }

        .workout-instructions {
            background: #f9fafb;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            text-align: left;
        }

        .workout-instructions h4 {
            margin-bottom: 10px;
            color: var(--primary);
        }

        .workout-instructions ul {
            padding-left: 25px;
            color: var(--text-light);
        }

        .workout-instructions li {
            margin: 8px 0;
        }

        /* Progress Ring */
        .progress-ring {
            width: 200px;
            height: 200px;
            margin: 30px auto;
        }

        .progress-ring-circle {
            transition: stroke-dashoffset 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        /* Celebration Animation */
        @keyframes celebrate {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .celebration {
            animation: celebrate 0.6s ease-in-out;
        }

        /* Hidden file input */
        input[type="file"] {
            display: none;
        }

        .streak-flame {
            font-size: 24px;
            animation: flicker 1.5s infinite;
        }

        @keyframes flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; transform: scale(1.1); }
        }

        /* Auth Modal Styles */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 4000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .auth-modal.active {
            display: flex;
        }

        .auth-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 450px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease-out;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h2 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .auth-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .google-btn {
            width: 100%;
            padding: 15px;
            background: white;
            border: 2px solid var(--border);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .google-btn:hover {
            background: #f9fafb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .divider {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 20px 0;
            color: var(--text-light);
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid var(--border);
        }

        .divider span {
            padding: 0 10px;
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        .user-badge:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Challenge Planner Styles */
        .challenge-nav-btn {
            padding: 12px 24px;
            border: 2px solid var(--border);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .challenge-nav-btn:hover {
            background: #f9fafb;
            border-color: var(--primary);
        }

        .challenge-nav-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .challenge-tab-content {
            display: none;
        }

        .template-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .template-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        /* Stay on the Grind Button Styles */
        .grind-button {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
        }

        .grind-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.5);
        }

        .grind-button:disabled {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            cursor: default;
            transform: none;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .grind-timer {
            font-size: 14px;
            color: var(--text-light);
            text-align: center;
            margin-top: 10px;
        }

        .daily-tracker-card {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .tracker-status-active {
            background: #10b981;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .tracker-status-waiting {
            background: #f59e0b;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Hamburger Menu */
        .hamburger-menu {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: white;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 5px;
            transition: transform 0.2s;
        }

        .hamburger-menu:hover {
            transform: scale(1.05);
        }

        .hamburger-line {
            width: 24px;
            height: 3px;
            background: var(--primary);
            border-radius: 2px;
            transition: 0.3s;
        }

        .hamburger-menu.active .hamburger-line:nth-child(1) {
            transform: rotate(45deg) translate(6px, 6px);
        }

        .hamburger-menu.active .hamburger-line:nth-child(2) {
            opacity: 0;
        }

        .hamburger-menu.active .hamburger-line:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -6px);
        }

        /* Slide-out Navigation */
        .slide-nav {
            position: fixed;
            top: 0;
            left: -320px;
            width: 300px;
            height: 100vh;
            background: white;
            z-index: 1000;
            box-shadow: 5px 0 30px rgba(0,0,0,0.2);
            transition: left 0.3s ease;
            overflow-y: auto;
            padding: 80px 20px 20px;
        }

        .slide-nav.active {
            left: 0;
        }

        .slide-nav-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: 0.3s;
        }

        .slide-nav-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .nav-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px 18px;
            margin-bottom: 8px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 16px;
            font-weight: 500;
            color: var(--text-dark);
        }

        .nav-menu-item:hover {
            background: var(--bg-light);
        }

        .nav-menu-item.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .nav-menu-item .nav-icon {
            font-size: 22px;
            width: 28px;
            text-align: center;
        }

        .nav-section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 20px 18px 10px;
            margin-top: 10px;
            border-top: 1px solid var(--border);
        }

        /* Modal Close Button */
        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #f3f4f6;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--text-dark);
            transition: all 0.2s;
            z-index: 10;
        }

        .modal-close-btn:hover {
            background: #e5e7eb;
            transform: scale(1.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .modal-back-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #f3f4f6;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-dark);
            transition: all 0.2s;
        }

        .modal-back-btn:hover {
            background: #e5e7eb;
        }

        /* Settings gear button */
        .settings-gear {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            background: white;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            cursor: pointer;
            font-size: 24px;
            transition: transform 0.3s;
        }

        .settings-gear:hover {
            transform: rotate(90deg);
        }

        /* Hide old nav tabs by default on mobile */
        @media (max-width: 768px) {
            .nav-tabs {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- Hamburger Menu Button -->
    <div class="hamburger-menu" onclick="toggleSlideNav()">
        <div class="hamburger-line"></div>
        <div class="hamburger-line"></div>
        <div class="hamburger-line"></div>
    </div>

    <!-- Settings Gear -->
    <div class="settings-gear" onclick="showSection('settings')"></div>

    <!-- Slide-out Navigation Overlay -->
    <div class="slide-nav-overlay" onclick="toggleSlideNav()"></div>

    <!-- Slide-out Navigation -->
    <div class="slide-nav">
        <div class="nav-menu-item active" onclick="showSectionAndClose('workout')">
            <span class="nav-icon"></span>
            <span>Today's Workout</span>
        </div>
        <div class="nav-menu-item" onclick="showSectionAndClose('challenges')">
            <span class="nav-icon"></span>
            <span>Challenges</span>
        </div>
        <div class="nav-menu-item" onclick="showSectionAndClose('ai-coach')">
            <span class="nav-icon"></span>
            <span>AI Coach</span>
        </div>
        <div class="nav-menu-item" onclick="showSectionAndClose('friends')">
            <span class="nav-icon"></span>
            <span>Friends</span>
        </div>
        <div class="nav-menu-item" onclick="showSectionAndClose('leaderboard')">
            <span class="nav-icon"></span>
            <span>Leaderboard</span>
        </div>
        <div class="nav-menu-item" onclick="showSectionAndClose('body-scan')">
            <span class="nav-icon"></span>
            <span>Body Analysis</span>
        </div>
        <div class="nav-menu-item" onclick="showSectionAndClose('achievements')">
            <span class="nav-icon"></span>
            <span>Achievements</span>
        </div>
        <div class="nav-menu-item" onclick="showSectionAndClose('progress')">
            <span class="nav-icon"></span>
            <span>Progress Photos</span>
        </div>
    </div>

    <div class="container">
        <!-- Header with User Stats -->
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div class="user-profile">
                    <div class="avatar" onclick="document.getElementById('avatarUpload').click()">
                        <span id="avatarInitial">U</span>
                        <div class="avatar-upload"></div>
                    </div>
                    <input type="file" id="avatarUpload" accept="image/*">
                    <div class="user-info">
                        <h1 id="userName">Warrior</h1>
                        <span class="level-badge">Level <span id="userLevel">1</span></span>
                        <div style="margin-top: 10px; color: var(--text-light);">
                            <span class="streak-flame"></span>
                            <strong id="streakDays">0</strong> day streak
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <!-- Auth Status / Login Button -->
                    <div id="authButtonContainer">
                        <button onclick="openAuthModal()" id="loginBtn" style="background: linear-gradient(135deg, #10b981, #059669); border: none; border-radius: 12px; padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 16px; font-weight: 600; color: white; transition: all 0.3s; box-shadow: 0 4px 15px rgba(16,185,129,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(16,185,129,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(16,185,129,0.3)'">
                             Login / Sign Up
                        </button>
                        <div id="userBadge" style="display: none;" class="user-badge" onclick="toggleUserMenu()">
                            <span id="userEmailBadge"></span>
                            <span></span>
                        </div>
                    </div>
                    <button onclick="openMusicPlayer()" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); border: none; border-radius: 12px; padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 16px; font-weight: 600; color: white; transition: all 0.3s; box-shadow: 0 4px 15px rgba(139,92,246,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(139,92,246,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(139,92,246,0.3)'">
                         Music
                    </button>
                    <button onclick="showSection('settings')" style="background: white; border: 2px solid var(--border); border-radius: 12px; padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 16px; font-weight: 600; transition: all 0.3s;">
                         Settings
                    </button>
                </div>
            </div>

            <!-- XP Progress -->
            <div class="xp-container">
                <div class="xp-bar">
                    <div class="xp-fill" id="xpFill" style="width: 0%">
                        <span class="xp-text"><span id="currentXP">0</span> / <span id="maxXP">100</span> XP</span>
                    </div>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-value" id="totalWorkouts">0</span>
                    <span class="stat-label">Total Workouts</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="currentWeight">---</span>
                    <span class="stat-label">Current Weight</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="goalWeight">---</span>
                    <span class="stat-label">Goal Weight</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="achievements">0</span>
                    <span class="stat-label">Achievements</span>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs (Desktop fallback) -->
        <div class="nav-tabs" style="display: none;">
            <button class="nav-tab active" onclick="showSection('workout')"> Today's Workout</button>
            <button class="nav-tab" onclick="showSection('challenges')"> Challenges</button>
            <button class="nav-tab" onclick="showSection('ai-coach')"> AI Coach</button>
            <button class="nav-tab" onclick="showSection('friends')"> Friends</button>
            <button class="nav-tab" onclick="showSection('leaderboard')"> Leaderboard</button>
            <button class="nav-tab" onclick="showSection('body-scan')"> Body Analysis</button>
            <button class="nav-tab" onclick="showSection('achievements')"> Achievements</button>
            <button class="nav-tab" onclick="showSection('progress')"> Progress Photos</button>
        </div>

        <!-- Today's Workout Section -->
        <div id="workout" class="content-section active">
            <div class="workout-card">
                <h2> Today's Challenge</h2>
                <p>Complete today's workout to maintain your streak!</p>
                <div class="workout-meta">
                    <div class="meta-item"> 45 minutes</div>
                    <div class="meta-item"> 250 calories</div>
                    <div class="meta-item"> +50 XP</div>
                </div>
                <button class="btn" onclick="startWorkout()">Start Workout</button>
            </div>

            <h3 style="margin-bottom: 15px;">Today's Exercises</h3>
            <div class="exercise-list" id="exerciseList">
                <!-- Exercises will be populated here -->
            </div>

            <button class="btn btn-success" onclick="completeWorkout()" style="width: 100%; margin-top: 20px;">
                 Complete Workout & Earn XP
            </button>
        </div>

        <!-- Challenges Section -->
        <div id="challenges" class="content-section">
            <h2 style="margin-bottom: 20px;"> FitQuest Challenge Planner</h2>
            
            <!-- Challenge Navigation -->
            <div style="display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap; border-bottom: 2px solid var(--border); padding-bottom: 15px;">
                <button class="challenge-nav-btn active" onclick="showChallengeTab('my-challenges')" id="myChallengesTab">
                     My Challenges
                </button>
                <button class="challenge-nav-btn" onclick="showChallengeTab('create')" id="createTab">
                     Create
                </button>
                <button class="challenge-nav-btn" onclick="showChallengeTab('templates')" id="templatesTab">
                     Templates
                </button>
                <button class="challenge-nav-btn" onclick="showChallengeTab('calendar')" id="calendarTab">
                     Calendar
                </button>
                <button class="challenge-nav-btn" onclick="showChallengeTab('notifications')" id="notificationsTab">
                     Notifications
                </button>
            </div>

            <!-- My Challenges Tab -->
            <div id="my-challenges-tab" class="challenge-tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <h3>Active Challenges</h3>
                    <button class="btn btn-primary" onclick="showChallengeTab('create')">
                         New Challenge
                    </button>
                </div>
                
                <!-- Active Challenges Grid -->
                <div id="activeChallengesGrid" style="display: grid; gap: 20px; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));">
                    <!-- Challenges will be populated here -->
                </div>

                <!-- Completed Challenges -->
                <div style="margin-top: 40px;">
                    <h3 style="margin-bottom: 20px;"> Completed Challenges</h3>
                    <div id="completedChallengesGrid" style="display: grid; gap: 20px; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));">
                        <!-- Completed challenges will be populated here -->
                    </div>
                </div>

                <!-- Empty State -->
                <div id="emptyChallengesState" style="display: none; text-align: center; padding: 60px 20px; background: #f9fafb; border-radius: 15px;">
                    <div style="font-size: 72px; margin-bottom: 20px;"></div>
                    <h3 style="color: var(--text-light);">No active challenges yet</h3>
                    <p style="color: var(--text-light); margin: 15px 0;">Create your first challenge to start building habits!</p>
                    <button class="btn btn-primary" onclick="showChallengeTab('create')" style="margin-top: 15px;">
                         Create Your First Challenge
                    </button>
                </div>
            </div>

            <!-- Create Challenge Tab -->
            <div id="create-tab" class="challenge-tab-content" style="display: none;">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 25px;">
                    <h3 style="margin-bottom: 10px;"> Create Your Challenge</h3>
                    <p style="opacity: 0.9; font-size: 14px;">Describe your challenge naturally - our AI will parse it!</p>
                </div>

                <!-- Natural Language Input -->
                <div style="background: white; padding: 25px; border-radius: 15px; border: 2px solid var(--border); margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">
                         Describe Your Challenge
                    </label>
                    <textarea 
                        id="challengeDescription" 
                        placeholder="Examples:&#10;- 30 day yoga challenge, practice every morning&#10;- Run 5K three times a week for 8 weeks&#10;- 75 Hard: workout twice daily, read 10 pages, drink a gallon of water&#10;- Meditation challenge: 10 minutes daily for 21 days"
                        style="width: 100%; min-height: 120px; padding: 15px; border: 2px solid var(--border); border-radius: 8px; font-size: 16px; resize: vertical;"
                    ></textarea>
                    <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="parseChallenge()">
                             Parse Challenge
                        </button>
                        <button class="btn" onclick="startVoiceInput()" id="voiceInputBtn">
                             Voice Input
                        </button>
                    </div>
                </div>

                <!-- Parsed Challenge Preview -->
                <div id="parsedChallengePreview" style="display: none; background: white; padding: 25px; border-radius: 15px; border: 2px solid var(--success); margin-bottom: 25px;">
                    <h3 style="margin-bottom: 20px; color: var(--success);"> Challenge Parsed Successfully</h3>
                    
                    <div style="display: grid; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Challenge Name</label>
                            <input type="text" id="challengeName" class="form-input" placeholder="e.g., 30 Day Yoga Journey">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Duration (days)</label>
                                <input type="number" id="challengeDuration" class="form-input" placeholder="30">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Start Date</label>
                                <input type="date" id="challengeStartDate" class="form-input">
                            </div>
                        </div>

                        <!-- Tasks List -->
                        <div>
                            <label style="display: block; margin-bottom: 10px; font-weight: 600;">Daily Tasks</label>
                            <div id="challengeTasksList" style="display: grid; gap: 10px;">
                                <!-- Tasks will be added here -->
                            </div>
                            <button class="btn" onclick="addChallengeTask()" style="margin-top: 10px; width: 100%;">
                                 Add Task
                            </button>
                        </div>

                        <!-- Challenge Settings -->
                        <div>
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="allowRestDays">
                                <span>Allow rest days (1 per week)</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-top: 10px;">
                                <input type="checkbox" id="sendReminders" checked>
                                <span>Send daily reminders</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-top: 10px;">
                                <input type="checkbox" id="trackProgress">
                                <span>Track progress with photos</span>
                            </label>
                        </div>

                        <!-- Create Button -->
                        <button class="btn btn-success" onclick="createParsedChallenge()" style="width: 100%; margin-top: 10px;">
                             Create Challenge
                        </button>
                    </div>
                </div>
            </div>

            <!-- Templates Tab -->
            <div id="templates-tab" class="challenge-tab-content" style="display: none;">
                <h3 style="margin-bottom: 20px;"> Challenge Templates</h3>
                <p style="color: var(--text-light); margin-bottom: 25px;">Start with proven challenge templates used by millions!</p>

                <div style="display: grid; gap: 20px; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));">
                    <!-- 75 Hard Template -->
                    <div class="template-card" style="background: white; padding: 20px; border-radius: 12px; border: 2px solid var(--border); cursor: pointer; transition: transform 0.2s;" onclick="loadTemplate('75hard')">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <h4 style="margin: 0;"> 75 Hard</h4>
                            <span style="background: #ef4444; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">EXTREME</span>
                        </div>
                        <p style="color: var(--text-light); font-size: 14px; margin-bottom: 15px;">75 days of intense discipline: 2 workouts daily, gallon of water, 10 pages reading, diet, progress photo</p>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <span style="background: #f3f4f6; padding: 4px 8px; border-radius: 6px; font-size: 12px;">75 days</span>
                            <span style="background: #f3f4f6; padding: 4px 8px; border-radius: 6px; font-size: 12px;">No rest days</span>
                        </div>
                    </div>

                    <!-- 30 Day Shred Template -->
                    <div class="template-card" style="background: white; padding: 20px; border-radius: 12px; border: 2px solid var(--border); cursor: pointer; transition: transform 0.2s;" onclick="loadTemplate('30dayshred')">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <h4 style="margin: 0;"> 30 Day Shred</h4>
                            <span style="background: #f59e0b; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">HARD</span>
                        </div>
                        <p style="color: var(--text-light); font-size: 14px; margin-bottom: 15px;">Transform your body in 30 days with daily 20-minute high-intensity workouts</p>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <span style="background: #f3f4f6; padding: 4px 8px; border-radius: 6px; font-size: 12px;">30 days</span>
                            <span style="background: #f3f4f6; padding: 4px 8px; border-radius: 6px; font-size: 12px;">Daily workout</span>
                        </div>
                    </div>

                    <!-- Couch to 5K Template -->
                    <div class="template-card" style="background: white; padding: 20px; border-radius: 12px; border: 2px solid var(--border); cursor: pointer; transition: transform 0.2s;" onclick="loadTemplate('couch25k')">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <h4 style="margin: 0;"> Couch to 5K</h4>
                            <span style="background: #10b981; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">BEGINNER</span>
                        </div>
                        <p style="color: var(--text-light); font-size: 14px; margin-bottom: 15px;">Build running endurance from zero to 5K in 9 weeks with progressive training</p>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <span style="background: #f3f4f6; padding: 4px 8px; border-radius: 6px; font-size: 12px;">63 days</span>
                            <span style="background: #f3f4f6; padding: 4px 8px; border-radius: 6px; font-size: 12px;">3x per week</span>
                        </div>
                    </div>

                    <!-- 21 Day Habit Builder Template -->
                    <div class="template-card" style="background: white; padding: 20px; border-radius: 12px; border: 2px solid var(--border); cursor: pointer; transition: transform 0.2s;" onclick="loadTemplate('21dayhabit')">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <h4 style="margin: 0;"> 21 Day Habit</h4>
                            <span style="background: #6366f1; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">MEDIUM</span>
                        </div>
                        <p style="color: var(--text-light); font-size: 14px; margin-bottom: 15px;">Form a lasting habit with consistent daily practice for 21 days</p>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <span style="background: #f3f4f6; padding: 4px 8px; border-radius: 6px; font-size: 12px;">21 days</span>
                            <span style="background: #f3f4f6; padding: 4px 8px; border-radius: 6px; font-size: 12px;">Customizable</span>
                        </div>
                    </div>

                    <!-- Morning Routine Template -->
                    <div class="template-card" style="background: white; padding: 20px; border-radius: 12px; border: 2px solid var(--border); cursor: pointer; transition: transform 0.2s;" onclick="loadTemplate('morningroutine')">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <h4 style="margin: 0;"> Morning Routine</h4>
                            <span style="background: #10b981; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">EASY</span>
                        </div>
                        <p style="color: var(--text-light); font-size: 14px; margin-bottom: 15px;">Build a powerful morning routine: meditation, exercise, journaling, healthy breakfast</p>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <span style="background: #f3f4f6; padding: 4px 8px; border-radius: 6px; font-size: 12px;">30 days</span>
                            <span style="background: #f3f4f6; padding: 4px 8px; border-radius: 6px; font-size: 12px;">Every morning</span>
                        </div>
                    </div>

                    <!-- Hydration Challenge Template -->
                    <div class="template-card" style="background: white; padding: 20px; border-radius: 12px; border: 2px solid var(--border); cursor: pointer; transition: transform 0.2s;" onclick="loadTemplate('hydration')">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <h4 style="margin: 0;"> Hydration</h4>
                            <span style="background: #10b981; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">EASY</span>
                        </div>
                        <p style="color: var(--text-light); font-size: 14px; margin-bottom: 15px;">Drink 8 glasses of water daily for 14 days and build a hydration habit</p>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <span style="background: #f3f4f6; padding: 4px 8px; border-radius: 6px; font-size: 12px;">14 days</span>
                            <span style="background: #f3f4f6; padding: 4px 8px; border-radius: 6px; font-size: 12px;">Simple tracking</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar Tab -->
            <div id="calendar-tab" class="challenge-tab-content" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 10px;">
                    <h3> Challenge Calendar</h3>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" onclick="changeCalendarView('month')" id="monthViewBtn">Month</button>
                        <button class="btn" onclick="changeCalendarView('week')" id="weekViewBtn">Week</button>
                        <button class="btn" onclick="changeCalendarView('day')" id="dayViewBtn">Day</button>
                    </div>
                </div>

                <!-- Calendar Navigation -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <button class="btn" onclick="navigateCalendar(-1)"> Previous</button>
                    <h3 id="calendarTitle">January 2024</h3>
                    <button class="btn" onclick="navigateCalendar(1)">Next </button>
                </div>

                <!-- Calendar Grid -->
                <div id="calendarGrid" style="background: white; padding: 20px; border-radius: 15px; border: 2px solid var(--border);">
                    <!-- Calendar will be rendered here -->
                </div>

                <!-- Today's Tasks -->
                <div style="margin-top: 30px; background: white; padding: 25px; border-radius: 15px; border: 2px solid var(--border);">
                    <h3 style="margin-bottom: 20px;">Today's Challenge Tasks</h3>
                    <div id="todayTasksList">
                        <!-- Today's tasks will be listed here -->
                    </div>
                </div>
            </div>

            <!-- Notifications Tab -->
            <div id="notifications-tab" class="challenge-tab-content" style="display: none;">
                <h3 style="margin-bottom: 20px;"> Notifications & Reminders</h3>
                
                <!-- Notification Settings -->
                <div style="background: white; padding: 25px; border-radius: 15px; border: 2px solid var(--border); margin-bottom: 25px;">
                    <h4 style="margin-bottom: 15px;"> Notification Settings</h4>
                    
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 15px;">
                        <input type="checkbox" id="enableNotifications" onchange="toggleNotifications()">
                        <span>Enable push notifications</span>
                    </label>

                    <div id="notificationTimePicker" style="display: none;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600;">Daily Reminder Time</label>
                        <input type="time" id="reminderTime" class="form-input" value="09:00">
                        <button class="btn btn-primary" onclick="saveNotificationSettings()" style="margin-top: 10px;">
                            Save Settings
                        </button>
                    </div>
                </div>

                <!-- Recent Notifications -->
                <div style="background: white; padding: 25px; border-radius: 15px; border: 2px solid var(--border);">
                    <h4 style="margin-bottom: 15px;">Recent Notifications</h4>
                    <div id="notificationsList">
                        <!-- Notifications will be listed here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Coach Section -->
        <div id="ai-coach" class="content-section">
            <h2 style="margin-bottom: 20px;"> Your AI Fitness Coach</h2>

            <div class="chat-container" style="height: 700px;">
                <iframe 
                    src="https://bots.easy-peasy.ai/bot/b0a8df9c-9a01-4d51-a052-81d6f0ddac59?mode=embedded" 
                    width="100%" 
                    height="100%"
                    style="border: none; border-radius: 12px; display: block;"
                    title="AI Fitness Coach"
                ></iframe>
            </div>

            <div style="background: #f0f9ff; padding: 20px; border-radius: 12px; margin-top: 20px;">
                <h4 style="color: var(--primary); margin-bottom: 10px;"> Pro Tips</h4>
                <ul style="color: var(--text-dark); font-size: 14px; padding-left: 20px; line-height: 1.8;">
                    <li>Click the  button in the chat to upload progress photos for AI analysis</li>
                    <li>Share your current fitness level and goals for personalized advice</li>
                    <li>Ask specific questions about workouts, nutrition, or form</li>
                    <li>Upload meal photos for nutrition feedback and calorie estimates</li>
                    <li>The AI is available 24/7 - chat anytime you need support</li>
                </ul>
            </div>
        </div>

        <!-- Body Scan Section -->
        <div id="body-scan" class="content-section">
            <h2 style="margin-bottom: 20px;"> AI Body Analysis</h2>
            <p style="color: var(--text-light); margin-bottom: 20px;">
                Upload your body photos and get instant AI-powered analysis with personalized fitness recommendations.
            </p>

            <!-- AI Bot Integration with Image Upload -->
            <div style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px;">
                <div style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); padding: 20px; border-radius: 12px; color: white; margin-bottom: 20px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 10px;"></div>
                    <h3 style="color: white; margin-bottom: 10px;">AI-Powered Body Analysis</h3>
                    <p style="opacity: 0.95; font-size: 15px;">
                        Upload your body photos below and our AI will analyze your physique,<br>
                        body type, muscle development, and provide personalized workout recommendations!
                    </p>
                </div>

                <!-- Easy-Peasy AI Bot with Image Support -->
                <div style="border: 2px solid #e5e7eb; border-radius: 12px; overflow: hidden; background: #f9fafb;">
                    <iframe 
                        src="https://bots.easy-peasy.ai/bot/847c6d63-a766-4394-87a2-348b462e8e0a?mode=embedded" 
                        width="100%" 
                        height="700" 
                        style="border: none; display: block;"
                        title="AI Body Analysis Assistant"
                    ></iframe>
                </div>

                <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-top: 20px; font-size: 13px;">
                    <strong> How to Use:</strong>
                    <ol style="margin-top: 8px; padding-left: 20px; line-height: 1.8;">
                        <li><strong>Click the image icon</strong>  in the chat to upload your body photo</li>
                        <li><strong>Upload photos:</strong> Front view, side view, or specific muscle groups</li>
                        <li><strong>Ask questions:</strong> "Analyze my body type", "What exercises should I focus on?", "Estimate my body fat %"</li>
                        <li><strong>Get personalized advice:</strong> Workout plans, nutrition tips, form corrections</li>
                        <li><strong>Track progress:</strong> Upload comparison photos over time</li>
                    </ol>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                        <strong> Best Photo Tips:</strong>
                        <ul style="margin-top: 8px; padding-left: 20px; line-height: 1.8;">
                            <li>Good lighting (natural daylight is best)</li>
                            <li>Wear fitted clothing or workout attire</li>
                            <li>Stand straight with relaxed posture</li>
                            <li>Take front, side, and back views for complete analysis</li>
                            <li>Same time of day for consistent tracking</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Quick Upload Section -->
            <div style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                    <h3 style="margin: 0;"> Instant AI Photo Analysis</h3>
                    <span style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">AUTO-ANALYZE</span>
                </div>
                <p style="color: var(--text-light); margin-bottom: 15px;">
                    Upload a photo and get <strong>instant AI analysis</strong> automatically! No manual upload needed.
                </p>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="document.getElementById('quickCameraInput').click()" style="padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                        <span style="font-size: 32px;"></span>
                        <span>Take Photo Now</span>
                        <span style="font-size: 11px; opacity: 0.8;">Auto AI Analysis</span>
                    </button>
                    <button class="btn btn-primary" onclick="document.getElementById('quickGalleryInput').click()" style="padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                        <span style="font-size: 32px;"></span>
                        <span>Choose from Gallery</span>
                        <span style="font-size: 11px; opacity: 0.8;">Auto AI Analysis</span>
                    </button>
                </div>
                <input type="file" id="quickCameraInput" accept="image/*" capture="environment" onchange="handleQuickPhotoUpload(event)" style="display: none;">
                <input type="file" id="quickGalleryInput" accept="image/*" onchange="handleQuickPhotoUpload(event)" style="display: none;">

                <div id="quickPhotoPreview" style="display: none; margin-top: 15px;">
                    <img id="quickPhotoImage" style="width: 100%; max-height: 400px; object-fit: contain; border-radius: 12px; border: 2px solid var(--border);">
                    <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 12px; border-radius: 8px; text-align: center; margin-top: 10px; font-weight: bold;">
                         AI Analysis in progress... Check results below!
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="btn btn-success" onclick="downloadQuickPhoto()" style="flex: 1;">
                             Save Photo
                        </button>
                        <button class="btn" onclick="clearQuickPhoto()" style="flex: 1;">
                             Clear & Retry
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Photos Section -->
        <div id="progress" class="content-section">
            <h2 style="margin-bottom: 20px;"> Progress Tracker</h2>
            <p style="color: var(--text-light); margin-bottom: 20px;">
                Track your transformation with detailed progress photos and AI analysis over time.
            </p>

            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="openProgressUpload()">
                     Add Progress Photo
                </button>
                <button class="btn btn-success" onclick="viewSlideshow()" id="slideshowBtn" style="display: none;">
                     View Transformation Slideshow
                </button>
                <button class="btn" onclick="comparePhotos()" id="compareBtn" style="display: none;">
                     Compare Photos
                </button>
            </div>

            <!-- Progress upload modal -->
            <div class="modal" id="progressUploadModal">
                <div class="modal-content">
                    <h2 style="margin-bottom: 20px;">Add Progress Photo</h2>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">Select Body Part to Track</label>
                        <select id="bodyPartSelect" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 16px;">
                            <option value="full-body-front">Full Body - Front</option>
                            <option value="full-body-side">Full Body - Side</option>
                            <option value="full-body-back">Full Body - Back</option>
                            <option value="face">Face/Neck</option>
                            <option value="chest">Chest</option>
                            <option value="arms">Arms</option>
                            <option value="abs">Abs/Core</option>
                            <option value="legs">Legs</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;"> Photo Date</label>
                        <input 
                            type="date" 
                            id="photoDatePicker" 
                            style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 16px;"
                        >
                        <p style="font-size: 13px; color: var(--text-light); margin-top: 5px;">
                            Select when this photo was taken (defaults to today)
                        </p>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">Current Weight (optional)</label>
                        <input type="number" id="photoWeight" placeholder="e.g., 245" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 16px;">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 12px; font-weight: bold;">Choose Photo Source</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <button class="btn btn-primary" onclick="document.getElementById('cameraInput').click()" style="padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                <span style="font-size: 32px;"></span>
                                <span>Take Photo</span>
                            </button>
                            <button class="btn btn-primary" onclick="document.getElementById('galleryInput').click()" style="padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                <span style="font-size: 32px;"></span>
                                <span>From Gallery</span>
                            </button>
                        </div>
                        <input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="processProgressPhoto(event)" style="display: none;">
                        <input type="file" id="galleryInput" accept="image/*" onchange="processProgressPhoto(event)" style="display: none;">
                    </div>

                    <div id="photoPreviewContainer" style="display: none; margin-bottom: 20px;">
                        <img id="photoPreviewImage" style="width: 100%; border-radius: 12px; max-height: 300px; object-fit: cover;">
                        <p style="text-align: center; margin-top: 10px; color: var(--secondary); font-weight: bold;">
                             Photo selected
                        </p>
                    </div>

                    <button class="btn" onclick="closeProgressUpload()" style="width: 100%;">
                        Cancel
                    </button>
                </div>
            </div>

            <!-- Photo timeline -->
            <div id="progressTimeline" style="margin-top: 30px;">
                <!-- Timeline will be populated here -->
            </div>

            <!-- Slideshow modal -->
            <div class="modal" id="slideshowModal">
                <div class="modal-content" style="max-width: 900px; padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2> Your Transformation Journey</h2>
                        <button onclick="closeSlideshow()" style="background: none; border: none; font-size: 28px; cursor: pointer;"></button>
                    </div>
                    
                    <div id="slideshowContainer" style="position: relative; background: #000; border-radius: 15px; overflow: hidden; min-height: 500px;">
                        <img id="slideshowImage" style="width: 100%; height: auto; display: block;">
                        <div id="slideshowInfo" style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.8); color: white; padding: 20px;">
                            <!-- Slideshow info -->
                        </div>
                    </div>

                    <div style="display: flex; justify-content: center; gap: 15px; margin-top: 20px;">
                        <button class="btn" onclick="previousSlide()"> Previous</button>
                        <button class="btn btn-primary" onclick="toggleAutoplay()" id="autoplayBtn"> Autoplay</button>
                        <button class="btn" onclick="nextSlide()">Next </button>
                    </div>

                    <div id="slideshowAnalysis" style="margin-top: 30px; background: #f9fafb; padding: 25px; border-radius: 15px;">
                        <!-- AI analysis will appear here -->
                    </div>
                </div>
            </div>

            <!-- Comparison modal -->
            <div class="modal" id="compareModal">
                <div class="modal-content" style="max-width: 1000px;">
                    <h2 style="margin-bottom: 20px;"> Photo Comparison</h2>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">Before</label>
                            <select id="beforeSelect" onchange="updateComparison()" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 16px; margin-bottom: 15px;">
                                <!-- Options populated by JS -->
                            </select>
                            <div id="beforeImage" style="background: #f3f4f6; border-radius: 12px; min-height: 400px; display: flex; align-items: center; justify-content: center;">
                                <p style="color: var(--text-light);">Select a photo</p>
                            </div>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">After</label>
                            <select id="afterSelect" onchange="updateComparison()" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 16px; margin-bottom: 15px;">
                                <!-- Options populated by JS -->
                            </select>
                            <div id="afterImage" style="background: #f3f4f6; border-radius: 12px; min-height: 400px; display: flex; align-items: center; justify-content: center;">
                                <p style="color: var(--text-light);">Select a photo</p>
                            </div>
                        </div>
                    </div>

                    <div id="comparisonAnalysis" style="background: #f9fafb; padding: 25px; border-radius: 15px; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 15px;">AI Analysis</h3>
                        <p style="color: var(--text-light);">Select two photos to compare</p>
                    </div>

                    <button class="btn btn-primary" onclick="closeComparison()" style="width: 100%;">
                        Close
                    </button>
                </div>
            </div>
        </div>

        <!-- Achievements Section -->
        <div id="achievements" class="content-section">
            <h2 style="margin-bottom: 20px;"> Achievements</h2>
            <p style="color: var(--text-light); margin-bottom: 20px;">
                Unlock achievements as you progress on your fitness journey!
            </p>

            <div class="achievements-grid" id="achievementsGrid">
                <!-- Achievements will be populated here -->
            </div>
        </div>

        <!-- Friends Section -->
        <div id="friends" class="content-section">
            <!-- Discord-style Header -->
            <div style="background: white; padding: 20px 25px; border-radius: 15px; margin-bottom: 20px; border: 2px solid var(--border);">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <h2 style="margin: 0;">Friends</h2>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span style="color: var(--text-light); font-size: 14px;">Your Username:</span>
                        <strong style="color: var(--primary); letter-spacing: 1px; font-size: 16px;" id="friendCodeHeader">@loading...</strong>
                        <button class="btn" onclick="copyFriendCode()" style="padding: 6px 12px; font-size: 13px;"> Copy</button>
                    </div>
                </div>
            </div>

            <!-- Discord-style Tabs -->
            <div style="background: white; border-radius: 15px; border: 2px solid var(--border); overflow: hidden;">
                <!-- Tab Navigation -->
                <div style="display: flex; border-bottom: 2px solid var(--border); background: #f9fafb;">
                    <button id="friendsTabAll" onclick="switchFriendsTab('all')" class="friends-tab active">
                         All Friends
                    </button>
                    <button id="friendsTabPending" onclick="switchFriendsTab('pending')" class="friends-tab">
                         Pending <span id="pendingBadge" style="display: none; background: #ef4444; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 5px;">0</span>
                    </button>
                    <button id="friendsTabAdd" onclick="switchFriendsTab('add')" class="friends-tab">
                         Add Friend
                    </button>
                </div>

                <!-- Tab Content -->
                <div style="padding: 25px;">
                    <!-- All Friends Tab -->
                    <div id="friendsContentAll">
                        <div style="margin-bottom: 15px; color: var(--text-light); font-size: 13px; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">
                            All Friends  <span id="friendsCount">0</span>
                        </div>
                        <div id="friendsList"></div>
                        <div id="emptyFriendsState" style="display: none; text-align: center; padding: 50px 20px;">
                            <div style="font-size: 60px; margin-bottom: 15px;"></div>
                            <h4 style="color: var(--text-dark); margin-bottom: 10px;">No friends yet</h4>
                            <p style="color: var(--text-light); font-size: 14px; margin-bottom: 20px;">Add friends to see them here!</p>
                            <button class="btn btn-primary" onclick="switchFriendsTab('add')">Add Friend</button>
                        </div>
                    </div>

                    <!-- Pending Tab -->
                    <div id="friendsContentPending" style="display: none;">
                        <div id="friendRequestsContainer"></div>
                        <div id="emptyPendingState" style="text-align: center; padding: 50px 20px;">
                            <div style="font-size: 60px; margin-bottom: 15px;"></div>
                            <h4 style="color: var(--text-dark); margin-bottom: 10px;">No pending requests</h4>
                            <p style="color: var(--text-light); font-size: 14px;">Friend requests you send or receive will appear here.</p>
                        </div>
                    </div>

                    <!-- Add Friend Tab -->
                    <div id="friendsContentAdd" style="display: none;">
                        <h3 style="margin-bottom: 10px; font-size: 16px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Add Friend</h3>
                        <p style="color: var(--text-light); font-size: 14px; margin-bottom: 20px;">You can add friends by their username.</p>
                        
                        <div style="display: flex; gap: 10px; padding: 15px; background: var(--bg-light); border-radius: 10px; border: 2px solid var(--border); margin-bottom: 25px;">
                            <input type="text" id="addFriendInput" placeholder="Enter username (e.g., fitnessfan123)" 
                                   style="flex: 1; padding: 12px 15px; border: none; background: white; border-radius: 8px; font-size: 15px; outline: none;"
                                   onkeypress="if(event.key==='Enter') addFriend()">
                            <button class="btn btn-primary" onclick="addFriend()" style="padding: 12px 24px; white-space: nowrap;">Send Request</button>
                        </div>

                        <div style="padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px;">
                            <h4 style="margin-bottom: 10px; font-size: 14px;"> YOUR USERNAME</h4>
                            <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap;">
                                <div style="font-size: 22px; font-weight: bold; letter-spacing: 1px;" id="friendCode">LOADING...</div>
                                <button onclick="copyFriendCode()" style="padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; cursor: pointer; font-weight: 600;">Copy</button>
                            </div>
                            <p style="margin-top: 10px; font-size: 13px; opacity: 0.9;">Share your username with friends so they can add you!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Progress Summary (Shareable) -->
            <div style="background: white; padding: 25px; border-radius: 15px; margin-top: 25px; border: 2px solid var(--border);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <h3> My Progress Summary</h3>
                    <button class="btn btn-success" onclick="shareProgress()"> Share Progress</button>
                </div>
                <div id="progressSummary" style="display: grid; gap: 15px;"></div>
            </div>
        </div>

        <!-- Leaderboard Section -->
        <div id="leaderboard" class="content-section">
            <h2 style="margin-bottom: 20px;"> Leaderboard</h2>
            
            <!-- Tabs for different leaderboards -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <button class="btn" onclick="showLeaderboard('friends')" id="friendsLeaderboardBtn" style="background: var(--primary); color: white;">
                     Friends
                </button>
                <button class="btn" onclick="showLeaderboard('global')" id="globalLeaderboardBtn">
                     Global
                </button>
                <button class="btn" onclick="showLeaderboard('streaks')" id="streaksLeaderboardBtn">
                     Streaks
                </button>
            </div>

            <!-- Leaderboard Display -->
            <div id="leaderboardContainer">
                <!-- Leaderboard will be populated here -->
            </div>

            <!-- Weekly Challenges -->
            <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 25px; border-radius: 15px; margin-top: 25px;">
                <h3 style="margin-bottom: 15px;"> Weekly Challenges</h3>
                <p style="margin-bottom: 20px; opacity: 0.9;">Compete with friends in weekly fitness challenges!</p>
                <div id="challengesList">
                    <!-- Active challenges -->
                </div>
                <button class="btn" onclick="createChallenge()" style="background: white; color: var(--secondary); margin-top: 15px;">
                     Create Challenge
                </button>
            </div>
        </div>

        <!-- Achievements Section -->
        <div id="achievements" class="content-section">
            <h2 style="margin-bottom: 20px;"> Achievements</h2>
            <p style="color: var(--text-light); margin-bottom: 20px;">
                Unlock achievements as you progress on your fitness journey!
            </p>

            <div class="achievements-grid" id="achievementsGrid">
                <!-- Achievements will be populated here -->
            </div>
        </div>

        <!-- My Plan Section -->
        <div id="plan" class="content-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2> My Weekly Plans</h2>
                <button class="btn btn-primary" onclick="openCreatePlanModal()">
                     Create New Plan
                </button>
            </div>
            
            <div id="weeklyPlansContainer"></div>
            
            <div id="emptyPlansState" style="display: none; text-align: center; padding: 60px 20px; background: #f9fafb; border-radius: 15px;">
                <div style="font-size: 72px; margin-bottom: 20px;"></div>
                <h3 style="color: var(--text-light);">No weekly plans yet</h3>
                <p style="color: var(--text-light); margin: 15px 0;">Create your first weekly plan with custom requirements and checklists!</p>
                <button class="btn btn-primary" onclick="openCreatePlanModal()" style="margin-top: 15px;">
                     Create Your First Plan
                </button>
            </div>
        </div>

        <!-- My Profile Section -->
        <div id="profile" class="content-section">
            <h2 style="margin-bottom: 20px;"> My Profile</h2>
            
            <!-- Profile Card -->
            <div style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); padding: 30px; border-radius: 20px; margin-bottom: 25px; color: white; text-align: center;">
                <div style="width: 100px; height: 100px; background: white; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 48px;">
                    <span id="profileAvatar"></span>
                </div>
                <h3 id="profileDisplayName" style="color: white; font-size: 24px; margin-bottom: 5px;">Warrior</h3>
                <p id="profileUsername" style="opacity: 0.9; margin-bottom: 10px;">@warrior</p>
                <div style="display: flex; justify-content: center; gap: 20px; margin-top: 15px;">
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold;" id="profileLevel">1</div>
                        <div style="font-size: 12px; opacity: 0.8;">Level</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold;" id="profileStreak">0</div>
                        <div style="font-size: 12px; opacity: 0.8;">Day Streak</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold;" id="profileWorkouts">0</div>
                        <div style="font-size: 12px; opacity: 0.8;">Workouts</div>
                    </div>
                </div>
            </div>

            <!-- Personal Information -->
            <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; border: 2px solid var(--border);">
                <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;"> Personal Information</h3>
                
                <div style="display: grid; gap: 20px;">
                    <!-- Display Name -->
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark);">Display Name</label>
                        <input 
                            type="text" 
                            id="profileNameInput" 
                            placeholder="Your display name"
                            style="width: 100%; padding: 14px; border: 2px solid var(--border); border-radius: 10px; font-size: 16px; transition: border-color 0.3s;"
                            onchange="updateProfileField('name', this.value)"
                        >
                    </div>
                    
                    <!-- Username -->
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark);">Username</label>
                        <div style="position: relative;">
                            <span style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-light);">@</span>
                            <input 
                                type="text" 
                                id="profileUsernameInput" 
                                placeholder="username"
                                maxlength="20"
                                style="width: 100%; padding: 14px 14px 14px 32px; border: 2px solid var(--border); border-radius: 10px; font-size: 16px;"
                                oninput="validateUsernameInput(this)"
                                onchange="updateProfileField('username', this.value.toLowerCase())"
                            >
                            <span id="usernameStatus" style="position: absolute; right: 14px; top: 50%; transform: translateY(-50%); font-size: 18px;"></span>
                        </div>
                        <p id="usernameHelp" style="font-size: 12px; color: var(--text-light); margin-top: 5px;">3-20 characters. Letters, numbers, underscores, and periods only.</p>
                    </div>
                    
                    <!-- Friend Code (Read Only) - Hidden since we use usernames now -->
                    <div style="display: none;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark);">Your Friend Code</label>
                        <div style="display: flex; gap: 10px;">
                            <input 
                                type="text" 
                                id="profileFriendCode" 
                                readonly
                                style="flex: 1; padding: 14px; border: 2px solid var(--border); border-radius: 10px; font-size: 16px; background: #f5f5f5; font-family: monospace; font-weight: bold;"
                            >
                            <button onclick="copyFriendCode()" style="padding: 14px 20px; background: var(--primary); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
                                 Copy
                            </button>
                        </div>
                        <p style="font-size: 12px; color: var(--text-light); margin-top: 5px;">Share this code with friends so they can add you</p>
                    </div>
                </div>
            </div>

            <!-- Weight & Goals -->
            <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; border: 2px solid var(--border);">
                <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;"> Weight & Goals</h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px;">
                    <!-- Start Weight -->
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark);">Start Weight</label>
                        <div style="position: relative;">
                            <input 
                                type="number" 
                                id="profileStartWeight" 
                                placeholder="0"
                                step="0.1"
                                style="width: 100%; padding: 14px; border: 2px solid var(--border); border-radius: 10px; font-size: 16px;"
                                onchange="updateProfileField('startWeight', this.value)"
                            >
                            <span style="position: absolute; right: 14px; top: 50%; transform: translateY(-50%); color: var(--text-light);">lbs</span>
                        </div>
                        <p style="font-size: 12px; color: var(--text-light); margin-top: 5px;">When you started</p>
                    </div>
                    
                    <!-- Current Weight -->
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark);">Current Weight</label>
                        <div style="position: relative;">
                            <input 
                                type="number" 
                                id="profileCurrentWeight" 
                                placeholder="0"
                                step="0.1"
                                style="width: 100%; padding: 14px; border: 2px solid var(--border); border-radius: 10px; font-size: 16px;"
                                onchange="updateProfileField('currentWeight', this.value)"
                            >
                            <span style="position: absolute; right: 14px; top: 50%; transform: translateY(-50%); color: var(--text-light);">lbs</span>
                        </div>
                    </div>
                    
                    <!-- Goal Weight -->
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark);">Goal Weight</label>
                        <div style="position: relative;">
                            <input 
                                type="number" 
                                id="profileGoalWeight" 
                                placeholder="0"
                                step="0.1"
                                style="width: 100%; padding: 14px; border: 2px solid var(--border); border-radius: 10px; font-size: 16px;"
                                onchange="updateProfileField('goalWeight', this.value)"
                            >
                            <span style="position: absolute; right: 14px; top: 50%; transform: translateY(-50%); color: var(--text-light);">lbs</span>
                        </div>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div id="weightProgressContainer" style="margin-top: 25px; display: none;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-weight: 600;">Weight Progress</span>
                        <span id="weightProgressPercent" style="color: var(--secondary); font-weight: bold;">0%</span>
                    </div>
                    <div style="height: 12px; background: #e5e7eb; border-radius: 6px; overflow: hidden;">
                        <div id="weightProgressBar" style="height: 100%; background: linear-gradient(90deg, var(--secondary), #34d399); border-radius: 6px; transition: width 0.5s ease; width: 0%;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 12px; color: var(--text-light);">
                        <span id="weightStart">Start: --</span>
                        <span id="weightCurrent">Current: --</span>
                        <span id="weightGoal">Goal: --</span>
                    </div>
                </div>
            </div>

            <!-- Health Concerns -->
            <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; border: 2px solid var(--border);">
                <h3 style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;"> Health Concerns & Limitations</h3>
                <p style="color: var(--text-light); margin-bottom: 20px; font-size: 14px;">This information helps us customize exercises that are safe for you. Your AI coach will take these into account.</p>
                
                <!-- Common Health Conditions -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 12px; font-weight: 600; color: var(--text-dark);">Select any that apply:</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;" id="healthConditionsGrid">
                        <label class="health-tag" style="display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: #f3f4f6; border-radius: 25px; cursor: pointer; transition: all 0.3s;">
                            <input type="checkbox" value="back-pain" onchange="updateHealthConditions()" style="width: 18px; height: 18px;">
                            <span> Back Pain</span>
                        </label>
                        <label class="health-tag" style="display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: #f3f4f6; border-radius: 25px; cursor: pointer; transition: all 0.3s;">
                            <input type="checkbox" value="knee-issues" onchange="updateHealthConditions()" style="width: 18px; height: 18px;">
                            <span> Knee Issues</span>
                        </label>
                        <label class="health-tag" style="display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: #f3f4f6; border-radius: 25px; cursor: pointer; transition: all 0.3s;">
                            <input type="checkbox" value="shoulder-injury" onchange="updateHealthConditions()" style="width: 18px; height: 18px;">
                            <span> Shoulder Injury</span>
                        </label>
                        <label class="health-tag" style="display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: #f3f4f6; border-radius: 25px; cursor: pointer; transition: all 0.3s;">
                            <input type="checkbox" value="wrist-issues" onchange="updateHealthConditions()" style="width: 18px; height: 18px;">
                            <span> Wrist Issues</span>
                        </label>
                        <label class="health-tag" style="display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: #f3f4f6; border-radius: 25px; cursor: pointer; transition: all 0.3s;">
                            <input type="checkbox" value="heart-condition" onchange="updateHealthConditions()" style="width: 18px; height: 18px;">
                            <span> Heart Condition</span>
                        </label>
                        <label class="health-tag" style="display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: #f3f4f6; border-radius: 25px; cursor: pointer; transition: all 0.3s;">
                            <input type="checkbox" value="asthma" onchange="updateHealthConditions()" style="width: 18px; height: 18px;">
                            <span> Asthma</span>
                        </label>
                        <label class="health-tag" style="display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: #f3f4f6; border-radius: 25px; cursor: pointer; transition: all 0.3s;">
                            <input type="checkbox" value="diabetes" onchange="updateHealthConditions()" style="width: 18px; height: 18px;">
                            <span> Diabetes</span>
                        </label>
                        <label class="health-tag" style="display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: #f3f4f6; border-radius: 25px; cursor: pointer; transition: all 0.3s;">
                            <input type="checkbox" value="pregnancy" onchange="updateHealthConditions()" style="width: 18px; height: 18px;">
                            <span> Pregnancy</span>
                        </label>
                        <label class="health-tag" style="display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: #f3f4f6; border-radius: 25px; cursor: pointer; transition: all 0.3s;">
                            <input type="checkbox" value="arthritis" onchange="updateHealthConditions()" style="width: 18px; height: 18px;">
                            <span> Arthritis</span>
                        </label>
                        <label class="health-tag" style="display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: #f3f4f6; border-radius: 25px; cursor: pointer; transition: all 0.3s;">
                            <input type="checkbox" value="high-blood-pressure" onchange="updateHealthConditions()" style="width: 18px; height: 18px;">
                            <span> High Blood Pressure</span>
                        </label>
                    </div>
                </div>
                
                <!-- Additional Notes -->
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark);">Additional Health Notes</label>
                    <textarea 
                        id="healthNotesInput" 
                        placeholder="Describe any other health concerns, injuries, or limitations that might affect your workouts..."
                        style="width: 100%; padding: 14px; border: 2px solid var(--border); border-radius: 10px; font-size: 14px; min-height: 100px; resize: vertical; font-family: inherit;"
                        onchange="updateProfileField('healthNotes', this.value)"
                    ></textarea>
                    <p style="font-size: 12px; color: var(--text-light); margin-top: 5px;"> Always consult with a healthcare provider before starting any exercise program</p>
                </div>
            </div>

            <!-- Fitness Level -->
            <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; border: 2px solid var(--border);">
                <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;"> Fitness Level</h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px;">
                    <button class="fitness-level-btn" onclick="setFitnessLevel('beginner')" data-level="beginner" style="padding: 20px; border: 2px solid var(--border); border-radius: 12px; background: white; cursor: pointer; transition: all 0.3s; text-align: center;">
                        <div style="font-size: 32px; margin-bottom: 8px;"></div>
                        <div style="font-weight: 600;">Beginner</div>
                        <div style="font-size: 12px; color: var(--text-light); margin-top: 5px;">New to fitness</div>
                    </button>
                    <button class="fitness-level-btn" onclick="setFitnessLevel('intermediate')" data-level="intermediate" style="padding: 20px; border: 2px solid var(--border); border-radius: 12px; background: white; cursor: pointer; transition: all 0.3s; text-align: center;">
                        <div style="font-size: 32px; margin-bottom: 8px;"></div>
                        <div style="font-weight: 600;">Intermediate</div>
                        <div style="font-size: 12px; color: var(--text-light); margin-top: 5px;">Some experience</div>
                    </button>
                    <button class="fitness-level-btn" onclick="setFitnessLevel('advanced')" data-level="advanced" style="padding: 20px; border: 2px solid var(--border); border-radius: 12px; background: white; cursor: pointer; transition: all 0.3s; text-align: center;">
                        <div style="font-size: 32px; margin-bottom: 8px;"></div>
                        <div style="font-weight: 600;">Advanced</div>
                        <div style="font-size: 12px; color: var(--text-light); margin-top: 5px;">Very experienced</div>
                    </button>
                    <button class="fitness-level-btn" onclick="setFitnessLevel('athlete')" data-level="athlete" style="padding: 20px; border: 2px solid var(--border); border-radius: 12px; background: white; cursor: pointer; transition: all 0.3s; text-align: center;">
                        <div style="font-size: 32px; margin-bottom: 8px;"></div>
                        <div style="font-weight: 600;">Athlete</div>
                        <div style="font-size: 12px; color: var(--text-light); margin-top: 5px;">Pro level</div>
                    </button>
                </div>
            </div>

            <!-- Sync Status -->
            <div id="profileSyncStatus" style="background: #f0fdf4; padding: 15px; border-radius: 12px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; border: 2px solid #86efac;">
                <span id="syncIcon"></span>
                <div>
                    <strong id="syncStatusText">Ready to sync</strong>
                    <p style="font-size: 12px; color: var(--text-light); margin-top: 3px;" id="syncStatusDetails">Changes will be saved to Firebase when logged in</p>
                </div>
            </div>

            <!-- Save Profile Button -->
            <button onclick="saveProfile()" class="btn btn-primary" style="width: 100%; padding: 18px; font-size: 18px; font-weight: bold;" id="saveProfileBtn">
                 Save Profile Changes
            </button>
            
            <!-- Debug: Test Firebase Connection -->
            <button onclick="testFirebaseConnection()" class="btn" style="width: 100%; padding: 14px; font-size: 14px; margin-top: 10px; background: #f3f4f6; color: var(--text-dark);">
                 Test Firebase Connection
            </button>
        </div>

        <!-- Settings Section -->
        <div id="settings" class="content-section">
            <h2 style="margin-bottom: 20px;"> Settings</h2>

            <!-- Quick Links -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px;">
                <div onclick="showSection('profile')" style="background: white; padding: 20px; border-radius: 15px; border: 2px solid var(--border); cursor: pointer; text-align: center; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div style="font-size: 40px; margin-bottom: 10px;"></div>
                    <h4>My Profile</h4>
                    <p style="font-size: 12px; color: var(--text-light); margin-top: 5px;">Edit your info</p>
                </div>
                <div onclick="showSection('plan')" style="background: white; padding: 20px; border-radius: 15px; border: 2px solid var(--border); cursor: pointer; text-align: center; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div style="font-size: 40px; margin-bottom: 10px;"></div>
                    <h4>My Plan</h4>
                    <p style="font-size: 12px; color: var(--text-light); margin-top: 5px;">Workout schedule</p>
                </div>
            </div>

            <!-- Quick Playlist Links -->
            <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; border: 2px solid var(--border);">
                <h3 style="margin-bottom: 20px;"> Quick Playlist Links</h3>
                <p style="color: var(--text-light); font-size: 14px; margin-bottom: 15px;">
                    Save direct links to your favorite workout playlists for quick access
                </p>
                <div style="margin-bottom: 15px;">
                    <input 
                        type="text" 
                        id="spotifyPlaylistInput" 
                        placeholder="Paste Spotify or YouTube playlist URL"
                        style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 14px; margin-bottom: 10px;"
                    >
                    <button class="btn btn-success" onclick="saveSpotifyPlaylist()" style="width: 100%;">
                         Add Playlist
                    </button>
                </div>
                <div id="savedPlaylistsList" style="margin-top: 15px;"></div>
            </div>

            <!-- Background & Appearance -->
            <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; border: 2px solid var(--border);">
                <h3 style="margin-bottom: 20px;"> Background & Appearance</h3>
                
                <!-- Background Themes -->
                <div style="margin-bottom: 25px;">
                    <h4 style="margin-bottom: 15px;">Choose Background Theme</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px;">
                        <div class="theme-option" onclick="setBackgroundTheme('default')" data-theme="default" style="cursor: pointer; padding: 5px; border-radius: 10px; border: 2px solid transparent;">
                            <div style="height: 60px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px;"></div>
                            <p style="text-align: center; font-size: 11px; margin-top: 5px;">Purple</p>
                        </div>
                        <div class="theme-option" onclick="setBackgroundTheme('ocean')" data-theme="ocean" style="cursor: pointer; padding: 5px; border-radius: 10px; border: 2px solid transparent;">
                            <div style="height: 60px; background: linear-gradient(135deg, #2196F3 0%, #00BCD4 100%); border-radius: 8px;"></div>
                            <p style="text-align: center; font-size: 11px; margin-top: 5px;">Ocean</p>
                        </div>
                        <div class="theme-option" onclick="setBackgroundTheme('sunset')" data-theme="sunset" style="cursor: pointer; padding: 5px; border-radius: 10px; border: 2px solid transparent;">
                            <div style="height: 60px; background: linear-gradient(135deg, #FF6B6B 0%, #FFE66D 100%); border-radius: 8px;"></div>
                            <p style="text-align: center; font-size: 11px; margin-top: 5px;">Sunset</p>
                        </div>
                        <div class="theme-option" onclick="setBackgroundTheme('forest')" data-theme="forest" style="cursor: pointer; padding: 5px; border-radius: 10px; border: 2px solid transparent;">
                            <div style="height: 60px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); border-radius: 8px;"></div>
                            <p style="text-align: center; font-size: 11px; margin-top: 5px;">Forest</p>
                        </div>
                        <div class="theme-option" onclick="setBackgroundTheme('dark')" data-theme="dark" style="cursor: pointer; padding: 5px; border-radius: 10px; border: 2px solid transparent;">
                            <div style="height: 60px; background: linear-gradient(135deg, #232526 0%, #414345 100%); border-radius: 8px;"></div>
                            <p style="text-align: center; font-size: 11px; margin-top: 5px;">Dark</p>
                        </div>
                        <div class="theme-option" onclick="setBackgroundTheme('fire')" data-theme="fire" style="cursor: pointer; padding: 5px; border-radius: 10px; border: 2px solid transparent;">
                            <div style="height: 60px; background: linear-gradient(135deg, #f12711 0%, #f5af19 100%); border-radius: 8px;"></div>
                            <p style="text-align: center; font-size: 11px; margin-top: 5px;">Fire</p>
                        </div>
                    </div>
                </div>

                <div style="height: 1px; background: var(--border); margin: 20px 0;"></div>

                <!-- Custom Background Upload -->
                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px;">Custom Background Image</h4>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="document.getElementById('backgroundUpload').click()">
                             Choose Image
                        </button>
                        <button class="btn" onclick="removeCustomBackground()" id="removeBackgroundBtn" style="display: none;">
                             Remove
                        </button>
                    </div>
                    <input type="file" id="backgroundUpload" accept="image/*" style="display: none;" onchange="uploadCustomBackground(event)">
                    <div id="backgroundPreview" style="margin-top: 15px; display: none;">
                        <img id="backgroundPreviewImage" style="width: 100%; max-height: 150px; object-fit: cover; border-radius: 12px;">
                    </div>
                </div>

                <div style="height: 1px; background: var(--border); margin: 20px 0;"></div>

                <!-- Background Opacity -->
                <div>
                    <h4 style="margin-bottom: 10px;">Background Darkness</h4>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 12px;">Light</span>
                        <input type="range" id="opacitySlider" min="0" max="100" value="0" style="flex: 1;" oninput="adjustBackgroundOpacity(this.value)">
                        <span style="font-size: 12px;">Dark</span>
                    </div>
                </div>
            </div>

            <!-- Google Drive Backup -->
            <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; border: 2px solid var(--border);">
                <h3 style="margin-bottom: 20px;"> Google Drive Backup</h3>
                <p style="color: var(--text-light); font-size: 14px; margin-bottom: 15px;">
                    Backup your progress to Google Drive
                </p>
                <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <p style="font-size: 14px;"> Your data is automatically saved with your Google account when you sign in.</p>
                </div>
                <button class="btn btn-success" onclick="exportData()" style="width: 100%;">
                     Download Local Backup
                </button>
            </div>

            <!-- Email Progress Reports -->
            <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; border: 2px solid var(--border);">
                <h3 style="margin-bottom: 20px;"> Email Progress Reports</h3>
                <p style="color: var(--text-light); font-size: 14px; margin-bottom: 15px;">
                    Save your email to receive weekly progress summaries
                </p>
                <input 
                    type="email" 
                    id="emailInput" 
                    placeholder="your.email@example.com"
                    style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 16px; margin-bottom: 10px;"
                >
                <button class="btn btn-success" onclick="setupEmailBackup()" style="width: 100%;">
                     Save Email
                </button>
            </div>

            <!-- Data Management -->
            <div style="background: white; padding: 25px; border-radius: 15px; border: 2px solid var(--border);">
                <h3 style="margin-bottom: 20px;"> Data Management</h3>
                <div style="display: grid; gap: 12px;">
                    <button class="btn" onclick="exportData()"> Export Data</button>
                    <button class="btn" onclick="importData()"> Import Data</button>
                    <button class="btn" onclick="resetApp()" style="background: var(--danger); color: white;"> Reset All Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Workout Mode Overlay -->
    <div class="workout-mode-overlay" id="workoutModeOverlay">
        <div class="workout-header">
            <div class="workout-progress" id="workoutProgress">
                Exercise 1 of 5
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn" onclick="openWorkoutMusic()" style="background: var(--secondary); color: white; padding: 10px 20px; font-size: 16px;">
                     Music
                </button>
                <button class="btn-exit-workout" onclick="exitWorkoutMode()">
                     Exit
                </button>
            </div>
        </div>
        
        <div class="workout-main" id="workoutMain">
            <!-- Content will be dynamically inserted here -->
        </div>
    </div>

    <!-- Modal for customization -->
    <div class="modal" id="customModal" onclick="if(event.target === this) closeModal()">
        <div class="modal-content" style="position: relative;">
            <button class="modal-close-btn" onclick="closeModal()" title="Close"></button>
            <div id="modalContent"></div>
            <button class="btn btn-primary" onclick="closeModal()" style="width: 100%; margin-top: 20px;">
                Close
            </button>
        </div>
    </div>

    <!-- Music Player Mini-Player -->
    <div id="musicPlayerModal" class="music-player-modal">
        <div class="music-player-container">
            <div class="music-header">
                <h3 style="margin: 0; font-size: 18px;"> Workout Music</h3>
                <div class="music-controls">
                    <button onclick="toggleMinimizeMusic()" class="minimize-btn" title="Minimize/Expand">
                        <span id="minimizeIcon"></span>
                    </button>
                    <button onclick="closeMusicPlayer()" class="close-music-btn" title="Close">
                        
                    </button>
                </div>
            </div>

            <!-- Quick Playlist Links -->
            <div id="quickPlaylistsSection">
                <div class="quick-playlists" id="savedPlaylists">
                    <!-- Saved playlists will appear here -->
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="playlistLinkInput" class="search-input" placeholder="Paste Spotify or YouTube playlist URL" style="flex: 1; padding: 10px;">
                    <button onclick="savePlaylistLink()" class="search-btn" style="padding: 10px 20px; font-size: 14px;">+ Add</button>
                </div>
            </div>

            <!-- Now Playing -->
            <div id="nowPlayingSection" class="now-playing">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0; font-size: 14px;"> Now Playing</h4>
                    <button onclick="stopAllMusic()" style="background: rgba(239,68,68,0.3); border: none; color: white; padding: 5px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;"> Stop</button>
                </div>
                <div id="youtubePlayerContainer" class="youtube-player-container" style="display: none;">
                    <div id="youtubePlayer"></div>
                </div>
                <div id="spotifyPlayerContainer" style="display: none;">
                    <div style="font-weight: bold; font-size: 14px; margin-bottom: 5px;" id="spotifyNowPlayingTitle"></div>
                    <div style="color: rgba(255,255,255,0.7); font-size: 13px; margin-bottom: 8px;" id="spotifyNowPlayingArtist"></div>
                    <audio id="spotifyAudioPlayer" class="audio-player" controls style="width: 100%; height: 40px;"></audio>
                </div>
            </div>

            <!-- Music Source Tabs -->
            <div class="music-tabs">
                <button class="music-tab active" onclick="switchMusicTab('youtube')">
                     YouTube Music
                </button>
                <button class="music-tab" onclick="switchMusicTab('spotify')">
                     Spotify
                </button>
            </div>

            <!-- YouTube Section -->
            <div id="youtubeSection" class="music-section">
                <div class="search-container">
                    <input type="text" id="youtubeSearchInput" class="search-input" placeholder="Search for workout music..." onkeypress="if(event.key==='Enter') searchYouTube()">
                    <button class="search-btn" onclick="searchYouTube()"> Search</button>
                </div>
                <div id="youtubeResults" class="music-results"></div>
            </div>

            <!-- Spotify Section -->
            <div id="spotifySection" class="music-section" style="display: none;">
                <div class="search-container">
                    <input type="text" id="spotifySearchInput" class="search-input" placeholder="Search Spotify..." onkeypress="if(event.key==='Enter') searchSpotify()">
                    <button class="search-btn" onclick="searchSpotify()"> Search</button>
                </div>
                <div id="spotifyResults" class="music-results"></div>
            </div>

            <!-- API Status -->
            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; margin-top: 20px; font-size: 14px;">
                <strong> Music Status:</strong>
                <div style="margin-top: 10px; display: flex; gap: 20px; flex-wrap: wrap;">
                    <div>
                        <span id="youtubeMusicStatus"> YouTube: Checking...</span>
                    </div>
                    <div>
                        <span id="spotifyMusicStatus"> Spotify: Checking...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Authentication Modal -->
    <div id="authModal" class="auth-modal">
        <div class="auth-container">
            <div class="auth-header">
                <h2> Welcome to FitQuest!</h2>
                <p style="color: var(--text-light);">Sign in to save your progress and compete with friends</p>
            </div>

            <!-- Google Sign In -->
            <button class="google-btn" onclick="signInWithGoogle()">
                <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                <span>Continue with Google</span>
            </button>

            <div class="divider">
                <span>OR</span>
            </div>

            <!-- Auth Tabs -->
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
                <button class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</button>
            </div>

            <!-- Login Form -->
            <form id="loginForm" class="auth-form active" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" required placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" required placeholder="">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 15px; font-size: 16px;">
                    Login
                </button>
            </form>

            <!-- Signup Form -->
            <form id="signupForm" class="auth-form" onsubmit="handleSignup(event)">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="signupName" required placeholder="Your Name">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="signupEmail" required placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="signupPassword" required placeholder="" minlength="6">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 15px; font-size: 16px;">
                    Create Account
                </button>
            </form>

            <button onclick="closeAuthModal()" class="btn" style="width: 100%; margin-top: 15px;">
                Cancel
            </button>
        </div>
    </div>

    <!-- Firebase SDKs - Compat Version (Global Scope) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>

    <script>
        // ==========================================
        // FIREBASE INITIALIZATION (COMPAT - GLOBAL SCOPE)
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyAHag-EmC2aBgC_trA2YJVssiSZmvJbxFw",
            authDomain: "evolfitness-42b94.firebaseapp.com",
            databaseURL: "https://evolfitness-42b94-default-rtdb.firebaseio.com",
            projectId: "evolfitness-42b94",
            storageBucket: "evolfitness-42b94.firebasestorage.app",
            messagingSenderId: "664990825140",
            appId: "1:664990825140:web:f5706d6bdb7a02864075e1",
            measurementId: "G-20PYX40RC6"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        const analytics = firebase.analytics();

        // Current user
        let currentUser = null;
        
        // Make Firebase available globally
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseStorage = storage;

        // ==========================================
        // INDEXEDDB SETUP - 50MB Storage (5x more than localStorage)
        // ==========================================
        let indexedDB_db;
        const DB_NAME = 'FitQuestDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'appData';

        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => {
                    console.log('IndexedDB not available, falling back to localStorage');
                    resolve(null);
                };
                
                request.onsuccess = (event) => {
                    indexedDB_db = event.target.result;
                    console.log('IndexedDB initialized - 50MB storage available');
                    resolve(indexedDB_db);
                };
                
                request.onupgradeneeded = (event) => {
                    indexedDB_db = event.target.result;
                    if (!indexedDB_db.objectStoreNames.contains(STORE_NAME)) {
                        indexedDB_db.createObjectStore(STORE_NAME);
                    }
                };
            });
        }

        // ==========================================
        // SMART AI CHATBOT - Contextual & Personalized
        // ==========================================
        const smartChatbot = {
            conversationHistory: [],
            lastTopic: null,
            
            // Analyze user's current state
            analyzeUserState() {
                const user = appState.user;
                const today = new Date();
                const startDate = user.startDate ? new Date(user.startDate) : today;
                const daysSinceStart = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
                const weeksSinceStart = Math.floor(daysSinceStart / 7);
                
                return {
                    level: user.level,
                    xp: user.xp,
                    maxXP: user.maxXP,
                    streak: user.streak,
                    totalWorkouts: user.totalWorkouts,
                    currentWeight: user.currentWeight,
                    startWeight: user.startWeight,
                    goalWeight: user.goalWeight,
                    weightLost: user.startWeight - user.currentWeight,
                    weightToGo: user.currentWeight - user.goalWeight,
                    achievements: user.achievements.length,
                    photos: appState.progressPhotos.length,
                    daysSinceStart: daysSinceStart,
                    weeksSinceStart: weeksSinceStart,
                    hasPhotos: appState.progressPhotos.length > 0,
                    recentWorkout: appState.user.lastWorkoutDate
                };
            },
            
            // Generate smart, contextual response
            generateResponse(userMessage) {
                const state = this.analyzeUserState();
                const msg = userMessage.toLowerCase();
                
                // Store conversation
                this.conversationHistory.push({ user: userMessage, time: Date.now() });
                
                // Weight progress questions
                if (msg.includes('weight') || msg.includes('lost') || msg.includes('progress')) {
                    if (state.weightLost > 0) {
                        return `Amazing work!  You've lost ${state.weightLost.toFixed(1)} lbs since you started ${state.weeksSinceStart} weeks ago. That's an average of ${(state.weightLost / state.weeksSinceStart).toFixed(1)} lbs per week! You're ${state.weightToGo.toFixed(1)} lbs away from your goal of ${state.goalWeight} lbs. Keep crushing it! `;
                    } else if (state.currentWeight && state.goalWeight) {
                        return `You're at ${state.currentWeight} lbs with a goal of ${state.goalWeight} lbs. You have ${state.weightToGo.toFixed(1)} lbs to go! Let's make it happen together! `;
                    } else {
                        return `I don't see your weight data yet. Go to Profile and add your current and goal weight so I can track your progress! `;
                    }
                }
                
                // Streak questions
                if (msg.includes('streak') || msg.includes('consistent')) {
                    if (state.streak >= 30) {
                        return `INCREDIBLE!  You have a ${state.streak} day streak! You're in the top 1% of users. Your consistency is legendary! Keep this momentum going! `;
                    } else if (state.streak >= 7) {
                        return `Awesome ${state.streak} day streak!  You're building serious habits. Just ${30 - state.streak} more days to hit the legendary 30-day mark! You got this! `;
                    } else if (state.streak > 0) {
                        return `You're on a ${state.streak} day streak!  Every day counts. Keep showing up and watch your streak grow! Tomorrow makes ${state.streak + 1}! `;
                    } else {
                        return `Your streak is at 0 right now, but that's okay! Today is the perfect day to start a new streak. One workout at a time! Let's do this! `;
                    }
                }
                
                // Workout questions
                if (msg.includes('workout') || msg.includes('exercise') || msg.includes('train')) {
                    if (state.totalWorkouts > 50) {
                        return `Wow! You've completed ${state.totalWorkouts} workouts!  You're Level ${state.level} now! That's some serious dedication. Your body is transforming! Keep going! `;
                    } else if (state.totalWorkouts > 10) {
                        return `You've done ${state.totalWorkouts} workouts and reached Level ${state.level}!  You're building momentum. Every workout makes you stronger! Let's keep this going! `;
                    } else if (state.totalWorkouts > 0) {
                        return `You've completed ${state.totalWorkouts} workouts!  Great start! Consistency is key. Try to hit at least 3 workouts per week for best results! You're on the right track! `;
                    } else {
                        return `I see you haven't started working out yet! No problem - today is perfect to begin! Check out the Exercises tab and pick a routine. Start with Day 1 and let's build this habit together! `;
                    }
                }
                
                // Photo/transformation questions
                if (msg.includes('photo') || msg.includes('picture') || msg.includes('transformation') || msg.includes('look')) {
                    if (state.photos >= 5) {
                        return `You have ${state.photos} progress photos!  That's amazing! Have you checked out your slideshow in Progress Photos? You can see your transformation journey! Your hard work is visible! `;
                    } else if (state.photos > 0) {
                        return `You have ${state.photos} progress photos so far!  Keep taking photos weekly. After 5 photos, you'll unlock an automatic transformation slideshow! ${5 - state.photos} more to go! `;
                    } else {
                        return `You haven't added any progress photos yet!  Photos are THE best way to track your transformation. Go to Progress Photos and take your first "before" pic. You'll thank yourself later! Trust me! `;
                    }
                }
                
                // Achievement questions
                if (msg.includes('achievement') || msg.includes('badge') || msg.includes('unlock')) {
                    return `You've unlocked ${state.achievements} out of 8 achievements!  Your current level is ${state.level}. Keep working out, taking photos, and maintaining your streak to unlock more! Every achievement is a milestone! `;
                }
                
                // Motivation/encouragement
                if (msg.includes('motivate') || msg.includes('encourage') || msg.includes('tired') || msg.includes('hard')) {
                    const responses = [
                        `You've already done ${state.totalWorkouts} workouts and built a ${state.streak} day streak! You're capable of amazing things! Don't stop now! `,
                        `Look at you - Level ${state.level}! You didn't get here by accident. You earned it! Keep pushing! The best version of you is coming! `,
                        `Progress isn't always visible day-to-day, but look at your ${state.weeksSinceStart} weeks of commitment! You're building something incredible! `,
                        `Every champion was once a beginner who refused to give up. You're ${state.daysSinceStart} days in - that's ${state.daysSinceStart} days of choosing yourself! Keep going! `
                    ];
                    return responses[Math.floor(Math.random() * responses.length)];
                }
                
                // Level/XP questions
                if (msg.includes('level') || msg.includes('xp') || msg.includes('experience')) {
                    const xpToNext = state.maxXP - state.xp;
                    return `You're Level ${state.level} with ${state.xp}/${state.maxXP} XP!  Just ${xpToNext} XP until Level ${state.level + 1}! Complete workouts to gain XP. Each workout gives you 50 XP! Let's level up! `;
                }
                
                // Greeting
                if (msg.includes('hello') || msg.includes('hi ') || msg.includes('hey')) {
                    if (state.streak > 0) {
                        return `Hey there, warrior!  ${state.streak} day streak looking strong! What can I help you with today? Let's keep this momentum going! `;
                    } else {
                        return `Hey! Welcome back!  What brings you here today? Need workout tips? Want to check your progress? I'm here to help! `;
                    }
                }
                
                // Help/general
                if (msg.includes('help') || msg.includes('what can') || msg.includes('how do')) {
                    return `I can help you with:  Progress tracking (weight, streak, workouts),  Workout advice,  Progress photos,  Achievements,  Goal setting. I also know YOUR specific stats! Ask me about your weight loss, streak, or transformation! What would you like to know?`;
                }
                
                // Default contextual response
                const defaults = [
                    `You're doing great! ${state.weeksSinceStart} weeks in, Level ${state.level}, ${state.totalWorkouts} workouts completed! What else would you like to know? `,
                    `I'm here to support your journey! You've already made ${state.weeksSinceStart} weeks of progress. Ask me about your weight, streak, workouts, or photos! `,
                    `Your stats: Level ${state.level}, ${state.streak} day streak, ${state.totalWorkouts} workouts! What can I help you with today? `
                ];
                
                return defaults[Math.floor(Math.random() * defaults.length)];
            }
        };

        // ==========================================
        // EASY-PEASY AI INTEGRATION
        // ==========================================
        const easyPeasyAI = {
            botId: 'b0a8df9c-9a01-4d51-a052-81d6f0ddac59',
            apiEndpoint: 'https://api.easy-peasy.ai/v1/chat',
            enabled: true,
            
            isEnabled() {
                return this.enabled;
            },
            
            setEnabled(value) {
                this.enabled = value;
                appState.user.easyPeasyEnabled = value;
                saveData();
                showNotification(value ? 'Easy-Peasy AI enabled! ' : 'Easy-Peasy AI disabled', 'success');
            },
            
            async sendToEasyPeasy(userMessage) {
                if (!this.isEnabled()) {
                    return null; // Fall through to next AI
                }
                
                try {
                    const state = smartChatbot.analyzeUserState();
                    const context = `User's fitness stats: Level ${state.level}, ${state.streak} day streak, ${state.totalWorkouts} workouts completed, current weight ${state.currentWeight}lbs, goal ${state.goalWeight}lbs, lost ${state.weightLost}lbs, ${state.photos} progress photos, ${state.weeksSinceStart} weeks of training.`;
                    
                    // Attempt to communicate with Easy-Peasy AI bot
                    // Using their iframe/widget approach
                    const fullMessage = `${context}\n\nUser question: ${userMessage}`;
                    
                    // Since Easy-Peasy typically uses iframe embedding, we'll try their API
                    // If this doesn't work, the fallback will catch it
                    const response = await fetch(`https://bots.easy-peasy.ai/api/chat/${this.botId}`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: fullMessage,
                            context: context
                        })
                    });
                    
                    if (!response.ok) {
                        console.log('Easy-Peasy API not accessible, falling back...');
                        return null; // Fall through to Gemini or smart chatbot
                    }
                    
                    const data = await response.json();
                    if (data.response || data.message || data.text) {
                        return data.response || data.message || data.text;
                    }
                    
                    return null; // Fall through if no valid response
                } catch (error) {
                    console.log('Easy-Peasy AI unavailable, using fallback:', error.message);
                    return null; // Fall through to next AI option
                }
            }
        };

        // GOOGLE GEMINI FREE AI - User Provides Their Own Free API Key
        // ==========================================
        const geminiAI = {
            apiKey: null,
            conversationHistory: [],
            
            hasApiKey() {
                return this.apiKey && this.apiKey.length > 20;
            },
            
            setApiKey(key) {
                this.apiKey = key;
                appState.user.geminiApiKey = key;
                saveData();
                showNotification('Gemini AI connected! ', 'success');
            },
            
            async sendToGemini(userMessage) {
                if (!this.hasApiKey()) {
                    return this.getApiKeyPrompt();
                }
                
                try {
                    const state = smartChatbot.analyzeUserState();
                    const context = `You are a fitness coach. User's stats: Level ${state.level}, ${state.streak} day streak, ${state.totalWorkouts} workouts, ${state.currentWeight}lbs current, ${state.goalWeight}lbs goal, ${state.weightLost}lbs lost, ${state.photos} photos, ${state.weeksSinceStart} weeks training. Be encouraging and reference their data.`;
                    
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${this.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: `${context}\n\nUser: ${userMessage}` }]
                            }]
                        })
                    });
                    
                    if (!response.ok) {
                        if (response.status === 400) {
                            return 'Invalid API key. Please check your Gemini API key in Settings  AI Settings.';
                        }
                        throw new Error('API error');
                    }
                    
                    const data = await response.json();
                    if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
                        return data.candidates[0].content.parts[0].text;
                    }
                    
                    return smartChatbot.generateResponse(userMessage);
                } catch (error) {
                    console.error('Gemini error:', error);
                    return smartChatbot.generateResponse(userMessage);
                }
            },
            
            getApiKeyPrompt() {
                return ` <strong>Real AI Available!</strong><br><br>
                Connect to Google's Gemini AI for natural conversations!<br><br>
                <strong>FREE but needs your API key:</strong><br>
                1. Visit <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a><br>
                2. Click "Create API Key"<br>
                3. Copy your key<br>
                4. Add it in Settings  AI Configuration<br><br>
                Using smart rule-based responses until then! `;
            }
        };

        // App State
        let appState = {
            user: {
                name: 'Warrior',
                username: '',
                level: 1,
                xp: 0,
                maxXP: 100,
                streak: 0,
                totalWorkouts: 0,
                currentWeight: null,
                goalWeight: null,
                bodyType: 'Endomorph-Mesomorph',
                achievements: [],
                notificationsEnabled: false,
                lastWorkoutDate: null,
                friendCode: null,
                startWeight: null,
                startDate: null,
                healthConditions: [],
                healthNotes: '',
                fitnessLevel: 'beginner'
            },
            friends: [],
            workouts: [],
            progressPhotos: [],
            weeklyPlans: [],
            todayExercises: [
                { name: 'Push-ups', sets: '4 sets', reps: '10-20 reps', xp: 10, completed: false, category: 'Push' },
                { name: 'Pike Push-ups', sets: '3 sets', reps: '8-12 reps', xp: 10, completed: false, category: 'Push' },
                { name: 'Chair Dips', sets: '3 sets', reps: '10-15 reps', xp: 10, completed: false, category: 'Push' },
                { name: 'Backpack Floor Press', sets: '3 sets', reps: '12 reps', xp: 10, completed: false, category: 'Push' },
                { name: 'Lateral Raises', sets: '3 sets', reps: '15 reps', xp: 10, completed: false, category: 'Push' }
            ],
            achievements: [
                { id: 1, name: 'First Workout', icon: '', unlocked: false, description: 'Complete your first workout' },
                { id: 2, name: '7 Day Streak', icon: '', unlocked: false, description: 'Maintain a 7-day workout streak' },
                { id: 3, name: 'Level 5', icon: '', unlocked: false, description: 'Reach level 5' },
                { id: 4, name: 'Body Scan', icon: '', unlocked: false, description: 'Complete your first body scan' },
                { id: 5, name: '25 Workouts', icon: '', unlocked: false, description: 'Complete 25 total workouts' },
                { id: 6, name: 'Goal Weight', icon: '', unlocked: false, description: 'Reach your goal weight' }
            ],
            challenges: [],
            slideshowIndex: 0,
            autoplayInterval: null,
            currentLeaderboard: 'friends'
        };

        // Simulated global leaderboard data (in production, this would come from a backend)
        const globalLeaderboard = [
            { name: 'FitGod_Mike', level: 15, xp: 3450, streak: 45, totalWorkouts: 156, username: 'fitgod_mike' },
            { name: 'IronSarah', level: 12, xp: 2890, streak: 32, totalWorkouts: 134, username: 'ironsarah' },
            { name: 'BeastMode_Jay', level: 11, xp: 2670, streak: 28, totalWorkouts: 98, username: 'beastmode_jay' },
            { name: 'HealthyHabits', level: 10, xp: 2340, streak: 40, totalWorkouts: 112, username: 'healthyhabits' },
            { name: 'FlexAppeal', level: 9, xp: 2100, streak: 21, totalWorkouts: 87, username: 'flexappeal' }
        ];

        // Load saved data
        function loadData() {
            if (indexedDB_db) {
                // Use IndexedDB (50MB)
                const transaction = indexedDB_db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get('appState');
                
                request.onsuccess = () => {
                    if (request.result) {
                        Object.assign(appState, request.result);
                    }
                    updateUI();
                };
                
                request.onerror = () => {
                    console.log('IndexedDB load failed, using localStorage');
                    loadFromLocalStorage();
                };
            } else {
                // Fallback to localStorage (10MB)
                loadFromLocalStorage();
            }
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('fitQuestData');
            if (saved) {
                appState = JSON.parse(saved);
            }
            updateUI();
        }

        // Save data
        function saveData() {
            if (indexedDB_db) {
                // Use IndexedDB (50MB storage)
                try {
                    const transaction = indexedDB_db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    store.put(appState, 'appState');
                    
                    transaction.oncomplete = () => {
                        updateStorageIndicator();
                    };
                } catch (error) {
                    console.error('IndexedDB save failed:', error);
                    saveToLocalStorage();
                }
            } else {
                // Fallback to localStorage (10MB)
                saveToLocalStorage();
            }
        }

        function saveToLocalStorage() {
            try {
                localStorage.setItem('fitQuestData', JSON.stringify(appState));
            } catch (e) {
                showNotification('Storage full! Export your data.', 'warning');
            }
        }

        // Update UI
        function updateUI() {
            document.getElementById('userName').textContent = appState.user.name;
            document.getElementById('userLevel').textContent = appState.user.level;
            document.getElementById('currentXP').textContent = appState.user.xp;
            document.getElementById('maxXP').textContent = appState.user.maxXP;
            document.getElementById('streakDays').textContent = appState.user.streak;
            document.getElementById('totalWorkouts').textContent = appState.user.totalWorkouts;
            document.getElementById('currentWeight').textContent = appState.user.currentWeight || '---';
            document.getElementById('goalWeight').textContent = appState.user.goalWeight || '---';
            document.getElementById('achievements').textContent = appState.user.achievements.length;

            const xpPercent = (appState.user.xp / appState.user.maxXP) * 100;
            document.getElementById('xpFill').style.width = xpPercent + '%';
            
            // Update username display (for friend adding)
            const friendCodeEl = document.getElementById('friendCode');
            if (friendCodeEl) {
                const displayUsername = appState.user.username || appState.user.name || 'Set username';
                friendCodeEl.textContent = displayUsername.startsWith('@') ? displayUsername : '@' + displayUsername;
            }
            
            // Update header username display
            const friendCodeHeader = document.getElementById('friendCodeHeader');
            if (friendCodeHeader) {
                const displayUsername = appState.user.username || appState.user.name || 'Set username';
                friendCodeHeader.textContent = displayUsername.startsWith('@') ? displayUsername : '@' + displayUsername;
            }

            renderExercises();
            renderAchievements();
            renderWeeklySchedule();
            renderNutritionPlan();
            renderProgressTimeline();
            renderProgressSummary();
            renderFriendsList();
            renderLeaderboard();
            renderChallenges();
            renderWeeklyPlans();
        }

        // Render exercises
        function renderExercises() {
            const list = document.getElementById('exerciseList');
            if (!list) return; // Safety check
            
            list.innerHTML = '';
            
            appState.todayExercises.forEach((exercise, index) => {
                const item = document.createElement('div');
                item.className = 'exercise-item';
                
                const exerciseInfo = document.createElement('div');
                exerciseInfo.className = 'exercise-info';
                exerciseInfo.innerHTML = `
                    <h3>${exercise.name}</h3>
                    <div class="exercise-details">
                        ${exercise.sets}  ${exercise.reps}  +${exercise.xp} XP
                    </div>
                `;
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'exercise-checkbox';
                checkbox.checked = exercise.completed;
                checkbox.addEventListener('change', function() {
                    toggleExercise(index);
                });
                
                item.appendChild(exerciseInfo);
                item.appendChild(checkbox);
                list.appendChild(item);
            });
        }

        // Toggle exercise completion
        function toggleExercise(index) {
            appState.todayExercises[index].completed = !appState.todayExercises[index].completed;
            saveData();
            renderExercises();
        }

        // Complete workout
        function completeWorkout() {
            const completed = appState.todayExercises.filter(e => e.completed).length;
            const total = appState.todayExercises.length;

            if (completed === 0) {
                showNotification('Complete at least one exercise before finishing your workout!', 'warning');
                return;
            }

            const xpEarned = appState.todayExercises
                .filter(e => e.completed)
                .reduce((sum, e) => sum + e.xp, 0);

            // Set start date if first workout
            if (appState.user.totalWorkouts === 0) {
                appState.user.startDate = new Date().toISOString();
                if (appState.user.currentWeight) {
                    appState.user.startWeight = appState.user.currentWeight;
                }
            }

            // Add XP
            appState.user.xp += xpEarned;
            appState.user.totalWorkouts++;
            appState.user.streak++;
            appState.user.lastWorkoutDate = new Date().toISOString();

            // Level up check
            while (appState.user.xp >= appState.user.maxXP) {
                appState.user.xp -= appState.user.maxXP;
                appState.user.level++;
                appState.user.maxXP = Math.floor(appState.user.maxXP * 1.5);
                showNotification(` LEVEL UP! You're now Level ${appState.user.level}!`, 'success');
                
                if (appState.user.level === 5) {
                    unlockAchievement(3);
                }
            }

            // Check achievements
            if (appState.user.totalWorkouts === 1) {
                unlockAchievement(1);
            }
            if (appState.user.streak === 7) {
                unlockAchievement(2);
            }
            if (appState.user.totalWorkouts === 25) {
                unlockAchievement(5);
            }

            // Reset exercises
            appState.todayExercises.forEach(e => e.completed = false);

            showNotification(` Workout Complete! +${xpEarned} XP earned! Streak: ${appState.user.streak} days `, 'success');
            
            saveData();
            updateUI();
        }

        // Unlock achievement
        function unlockAchievement(id) {
            const achievement = appState.achievements.find(a => a.id === id);
            if (achievement && !achievement.unlocked) {
                achievement.unlocked = true;
                appState.user.achievements.push(id);
                alert(` Achievement Unlocked!\n${achievement.name}\n${achievement.description}`);
            }
        }

        // Render achievements
        function renderAchievements() {
            const grid = document.getElementById('achievementsGrid');
            grid.innerHTML = '';

            appState.achievements.forEach(achievement => {
                const card = document.createElement('div');
                card.className = `achievement-card ${achievement.unlocked ? 'unlocked' : ''}`;
                card.innerHTML = `
                    <div class="achievement-icon">${achievement.icon}</div>
                    <h3>${achievement.name}</h3>
                    <p style="font-size: 14px; margin-top: 8px; opacity: 0.8;">
                        ${achievement.description}
                    </p>
                    ${achievement.unlocked ? '<p style="margin-top: 10px; font-weight: bold;"> Unlocked</p>' : '<p style="margin-top: 10px; opacity: 0.6;"> Locked</p>'}
                `;
                grid.appendChild(card);
            });
        }

        // Show section
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Update slide nav active state
            document.querySelectorAll('.nav-menu-item').forEach(item => {
                item.classList.remove('active');
            });
            const slideNavItem = document.querySelector(`.nav-menu-item[onclick*="${sectionId}"]`);
            if (slideNavItem) {
                slideNavItem.classList.add('active');
            }
            
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.add('active');
            }
            
            // Find and activate the corresponding nav button
            const navButton = document.querySelector(`[onclick*="showSection('${sectionId}')"]`);
            if (navButton) {
                navButton.classList.add('active');
            }
            
            // Load profile data when switching to profile tab
            if (sectionId === 'profile') {
                loadProfileData();
            }
            
            // Refresh friends data when switching to friends tab
            if (sectionId === 'friends') {
                if (currentUser) {
                    // Render current friends list
                    renderFriendsList();
                    // FriendsManager already has real-time listeners, but we can force refresh UI
                    if (typeof friendsManager !== 'undefined') {
                        friendsManager.renderFriendRequests();
                    }
                }
            }
        }
        
        // Make globally accessible
        window.showSection = showSection;
        
        // Toggle hamburger slide navigation
        function toggleSlideNav() {
            const hamburger = document.querySelector('.hamburger-menu');
            const slideNav = document.querySelector('.slide-nav');
            const overlay = document.querySelector('.slide-nav-overlay');
            
            hamburger.classList.toggle('active');
            slideNav.classList.toggle('active');
            overlay.classList.toggle('active');
        }
        window.toggleSlideNav = toggleSlideNav;
        
        // Show section and close nav
        function showSectionAndClose(sectionId) {
            showSection(sectionId);
            toggleSlideNav();
        }
        window.showSectionAndClose = showSectionAndClose;

        // Start workout (placeholder)
        function startWorkout() {
            alert(' Starting workout mode! Complete each exercise and check them off as you go.');
        }
        window.startWorkout = startWorkout;

        // ==========================================
        // PROFILE FUNCTIONS
        // ==========================================

        // Debounced save to avoid too many Firebase writes
        let profileSaveTimeout = null;
        function debouncedSaveProfile() {
            if (profileSaveTimeout) {
                clearTimeout(profileSaveTimeout);
            }
            profileSaveTimeout = setTimeout(() => {
                saveProfile();
            }, 1500); // Save 1.5 seconds after last change
        }

        // Load profile data into form
        function loadProfileData() {
            // Personal info
            const nameInput = document.getElementById('profileNameInput');
            const usernameInput = document.getElementById('profileUsernameInput');
            const friendCodeInput = document.getElementById('profileFriendCode');
            
            if (nameInput) nameInput.value = appState.user.name || '';
            if (usernameInput) usernameInput.value = appState.user.username || '';
            if (friendCodeInput) friendCodeInput.value = appState.user.friendCode || 'FIT-XXXXXX';
            
            // Display name and username in header
            const displayName = document.getElementById('profileDisplayName');
            const displayUsername = document.getElementById('profileUsername');
            if (displayName) displayName.textContent = appState.user.name || 'Warrior';
            if (displayUsername) displayUsername.textContent = '@' + (appState.user.username || 'warrior');
            
            // Stats
            const levelEl = document.getElementById('profileLevel');
            const streakEl = document.getElementById('profileStreak');
            const workoutsEl = document.getElementById('profileWorkouts');
            if (levelEl) levelEl.textContent = appState.user.level || 1;
            if (streakEl) streakEl.textContent = appState.user.streak || 0;
            if (workoutsEl) workoutsEl.textContent = appState.user.totalWorkouts || 0;
            
            // Weight
            const startWeight = document.getElementById('profileStartWeight');
            const currentWeight = document.getElementById('profileCurrentWeight');
            const goalWeight = document.getElementById('profileGoalWeight');
            if (startWeight) startWeight.value = appState.user.startWeight || '';
            if (currentWeight) currentWeight.value = appState.user.currentWeight || '';
            if (goalWeight) goalWeight.value = appState.user.goalWeight || '';
            
            // Update weight progress
            updateWeightProgress();
            
            // Health conditions
            const checkboxes = document.querySelectorAll('#healthConditionsGrid input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = appState.user.healthConditions && appState.user.healthConditions.includes(cb.value);
                // Update styling
                const label = cb.closest('label');
                if (label) {
                    if (cb.checked) {
                        label.style.background = '#dbeafe';
                        label.style.borderColor = 'var(--primary)';
                    } else {
                        label.style.background = '#f3f4f6';
                        label.style.borderColor = 'transparent';
                    }
                }
            });
            
            // Health notes
            const healthNotes = document.getElementById('healthNotesInput');
            if (healthNotes) healthNotes.value = appState.user.healthNotes || '';
            
            // Fitness level
            updateFitnessLevelUI(appState.user.fitnessLevel || 'beginner');
        }
        
        // Update a profile field
        function updateProfileField(field, value) {
            if (field === 'startWeight' || field === 'currentWeight' || field === 'goalWeight') {
                appState.user[field] = value ? parseFloat(value) : null;
                updateWeightProgress();
            } else {
                appState.user[field] = value;
            }
            
            // Update display elements if name/username changed
            if (field === 'name') {
                const displayName = document.getElementById('profileDisplayName');
                if (displayName) displayName.textContent = value || 'Warrior';
                // Also update header name
                const headerName = document.querySelector('.user-info h2');
                if (headerName) headerName.textContent = value || 'Warrior';
            }
            if (field === 'username') {
                const displayUsername = document.getElementById('profileUsername');
                if (displayUsername) displayUsername.textContent = '@' + (value || 'warrior');
            }
            
            // Auto-save to Firebase (debounced)
            debouncedSaveProfile();
        }
        window.updateProfileField = updateProfileField;
        
        // Update health conditions from checkboxes
        function updateHealthConditions() {
            const checkboxes = document.querySelectorAll('#healthConditionsGrid input[type="checkbox"]');
            const conditions = [];
            checkboxes.forEach(cb => {
                const label = cb.closest('label');
                if (cb.checked) {
                    conditions.push(cb.value);
                    if (label) {
                        label.style.background = '#dbeafe';
                        label.style.border = '2px solid var(--primary)';
                    }
                } else {
                    if (label) {
                        label.style.background = '#f3f4f6';
                        label.style.border = '2px solid transparent';
                    }
                }
            });
            appState.user.healthConditions = conditions;
            // Auto-save when conditions change
            debouncedSaveProfile();
        }
        window.updateHealthConditions = updateHealthConditions;
        
        // Set fitness level
        function setFitnessLevel(level) {
            appState.user.fitnessLevel = level;
            updateFitnessLevelUI(level);
            // Auto-save when level changes
            debouncedSaveProfile();
        }
        window.setFitnessLevel = setFitnessLevel;
        
        // Update fitness level button styling
        function updateFitnessLevelUI(activeLevel) {
            const buttons = document.querySelectorAll('.fitness-level-btn');
            buttons.forEach(btn => {
                const level = btn.getAttribute('data-level');
                if (level === activeLevel) {
                    btn.style.background = 'var(--primary)';
                    btn.style.color = 'white';
                    btn.style.borderColor = 'var(--primary)';
                } else {
                    btn.style.background = 'white';
                    btn.style.color = 'var(--text-dark)';
                    btn.style.borderColor = 'var(--border)';
                }
            });
        }
        
        // Update weight progress bar
        function updateWeightProgress() {
            const container = document.getElementById('weightProgressContainer');
            const bar = document.getElementById('weightProgressBar');
            const percent = document.getElementById('weightProgressPercent');
            const startLabel = document.getElementById('weightStart');
            const currentLabel = document.getElementById('weightCurrent');
            const goalLabel = document.getElementById('weightGoal');
            
            const start = appState.user.startWeight;
            const current = appState.user.currentWeight;
            const goal = appState.user.goalWeight;
            
            if (start && goal && container) {
                container.style.display = 'block';
                
                // Calculate progress (works for both losing and gaining weight)
                const totalChange = Math.abs(goal - start);
                const currentChange = Math.abs(current - start);
                let progress = totalChange > 0 ? (currentChange / totalChange) * 100 : 0;
                
                // Check if going in the right direction
                if ((goal < start && current > start) || (goal > start && current < start)) {
                    progress = 0; // Going wrong way
                } else if ((goal < start && current < goal) || (goal > start && current > goal)) {
                    progress = 100; // Passed goal
                }
                
                progress = Math.min(100, Math.max(0, progress));
                
                if (bar) bar.style.width = progress + '%';
                if (percent) percent.textContent = Math.round(progress) + '%';
                if (startLabel) startLabel.textContent = 'Start: ' + start + ' lbs';
                if (currentLabel) currentLabel.textContent = 'Current: ' + (current || '--') + ' lbs';
                if (goalLabel) goalLabel.textContent = 'Goal: ' + goal + ' lbs';
            } else if (container) {
                container.style.display = 'none';
            }
        }
        
        // Copy username to clipboard (for friend adding)
        function copyFriendCode() {
            const username = appState.user.username || appState.user.name;
            if (username) {
                navigator.clipboard.writeText(username).then(() => {
                    showNotification('Username copied! ', 'success');
                }).catch(() => {
                    // Fallback for older browsers
                    const tempInput = document.createElement('input');
                    tempInput.value = username;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);
                    showNotification('Username copied! ', 'success');
                });
            } else {
                showNotification('Set a username first in your profile settings', 'warning');
            }
        }
        window.copyFriendCode = copyFriendCode;
        
        // List of inappropriate words to filter (basic list - expand as needed)
        const inappropriateWords = [
            'fuck', 'shit', 'ass', 'bitch', 'damn', 'hell', 'crap', 'dick', 'cock', 'pussy',
            'nigger', 'nigga', 'faggot', 'fag', 'retard', 'slut', 'whore', 'cunt',
            'penis', 'vagina', 'sex', 'porn', 'xxx', 'nude', 'naked',
            'kill', 'murder', 'rape', 'terrorist', 'nazi', 'hitler',
            'admin', 'moderator', 'owner', 'staff', 'official', 'support'
        ];
        
        // Check if username contains inappropriate words
        function containsInappropriateWords(username) {
            const lowerUsername = username.toLowerCase();
            for (const word of inappropriateWords) {
                if (lowerUsername.includes(word)) {
                    return true;
                }
            }
            return false;
        }
        
        // Validate username format
        function validateUsernameFormat(username) {
            // Must be 3-20 characters
            if (username.length < 3) {
                return { valid: false, error: 'Username must be at least 3 characters' };
            }
            if (username.length > 20) {
                return { valid: false, error: 'Username must be 20 characters or less' };
            }
            // Only allow letters, numbers, underscores, and periods
            if (!/^[a-zA-Z0-9_.]+$/.test(username)) {
                return { valid: false, error: 'Username can only contain letters, numbers, underscores, and periods' };
            }
            // Cannot start or end with underscore or period
            if (/^[_.]|[_.]$/.test(username)) {
                return { valid: false, error: 'Username cannot start or end with underscore or period' };
            }
            // Check for inappropriate content
            if (containsInappropriateWords(username)) {
                return { valid: false, error: 'Username contains inappropriate content' };
            }
            return { valid: true };
        }
        
        // Check if username is unique in Firebase
        async function isUsernameUnique(username, currentUid) {
            try {
                const lowerUsername = username.toLowerCase();
                const snapshot = await db.collection('users')
                    .where('username', '==', lowerUsername)
                    .get();
                
                if (snapshot.empty) {
                    return true; // No one has this username
                }
                
                // Check if the only user with this username is the current user
                let isOwnUsername = true;
                snapshot.forEach(doc => {
                    if (doc.id !== currentUid) {
                        isOwnUsername = false;
                    }
                });
                
                return isOwnUsername;
            } catch (error) {
                console.error('Error checking username uniqueness:', error);
                return false; // Assume not unique if we can't check
            }
        }
        
        // Validate username (format + uniqueness)
        async function validateUsername(username) {
            // First check format
            const formatCheck = validateUsernameFormat(username);
            if (!formatCheck.valid) {
                return formatCheck;
            }
            
            // Then check uniqueness
            if (!currentUser) {
                return { valid: false, error: 'You must be logged in to set a username' };
            }
            
            const isUnique = await isUsernameUnique(username, currentUser.uid);
            if (!isUnique) {
                return { valid: false, error: 'This username is already taken. Try another one!' };
            }
            
            return { valid: true };
        }
        
        // Save profile to Firebase and local storage
        async function saveProfile() {
            const usernameInput = document.getElementById('profileUsernameInput');
            const newUsername = usernameInput ? usernameInput.value.trim().toLowerCase() : '';
            const oldUsername = appState.user.username || '';
            
            // Validate username if it changed
            if (newUsername && newUsername !== oldUsername.toLowerCase()) {
                const validation = await validateUsername(newUsername);
                if (!validation.valid) {
                    showNotification(validation.error, 'warning');
                    // Reset input to old username
                    if (usernameInput) usernameInput.value = oldUsername;
                    return;
                }
                // Update appState with validated username
                appState.user.username = newUsername;
            }
            
            // Save locally first
            saveData();
            
            // Save to Firebase if logged in
            if (currentUser) {
                try {
                    console.log(' Saving profile to Firebase for user:', currentUser.uid);
                    console.log('Profile data:', {
                        displayName: appState.user.name,
                        username: appState.user.username,
                        startWeight: appState.user.startWeight,
                        currentWeight: appState.user.currentWeight,
                        goalWeight: appState.user.goalWeight,
                        healthConditions: appState.user.healthConditions,
                        healthNotes: appState.user.healthNotes,
                        fitnessLevel: appState.user.fitnessLevel
                    });
                    
                    // Use set with merge to create or update
                    await db.collection('users').doc(currentUser.uid).set({
                        displayName: appState.user.name || '',
                        username: appState.user.username || '',
                        startWeight: appState.user.startWeight || null,
                        currentWeight: appState.user.currentWeight || null,
                        goalWeight: appState.user.goalWeight || null,
                        healthConditions: appState.user.healthConditions || [],
                        healthNotes: appState.user.healthNotes || '',
                        fitnessLevel: appState.user.fitnessLevel || 'beginner',
                        lastActive: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    
                    // Update the username display
                    generateFriendCode();
                    
                    console.log(' Profile saved to Firebase successfully!');
                    updateSyncStatus('success', 'Synced to cloud!', 'Last saved: ' + new Date().toLocaleTimeString());
                    showNotification('Profile saved to cloud! ', 'success');
                } catch (error) {
                    console.error(' Error saving profile to Firebase:', error);
                    console.error('Error code:', error.code);
                    console.error('Error message:', error.message);
                    updateSyncStatus('error', 'Sync failed', error.message);
                    showNotification('Cloud sync failed: ' + error.message, 'warning');
                }
            } else {
                console.log(' No user logged in, saving locally only');
                updateSyncStatus('warning', 'Saved locally', 'Sign in to sync to cloud');
                showNotification('Profile saved locally! Sign in to sync across devices.', 'info');
            }
            
            // Update header
            const headerName = document.querySelector('.user-info h2');
            if (headerName) headerName.textContent = appState.user.name || 'Warrior';
        }
        window.saveProfile = saveProfile;
        
        // Real-time username validation as user types
        let usernameCheckTimeout = null;
        async function validateUsernameInput(input) {
            const username = input.value.trim().toLowerCase();
            const statusEl = document.getElementById('usernameStatus');
            const helpEl = document.getElementById('usernameHelp');
            
            // Clear previous timeout
            if (usernameCheckTimeout) {
                clearTimeout(usernameCheckTimeout);
            }
            
            // If empty, reset to default
            if (!username) {
                if (statusEl) statusEl.textContent = '';
                if (helpEl) {
                    helpEl.textContent = '3-20 characters. Letters, numbers, underscores, and periods only.';
                    helpEl.style.color = 'var(--text-light)';
                }
                input.style.borderColor = 'var(--border)';
                return;
            }
            
            // Show checking status
            if (statusEl) statusEl.textContent = '';
            
            // First do instant format validation
            const formatCheck = validateUsernameFormat(username);
            if (!formatCheck.valid) {
                if (statusEl) statusEl.textContent = '';
                if (helpEl) {
                    helpEl.textContent = formatCheck.error;
                    helpEl.style.color = '#ef4444';
                }
                input.style.borderColor = '#ef4444';
                return;
            }
            
            // Debounce the uniqueness check (only check after user stops typing)
            usernameCheckTimeout = setTimeout(async () => {
                if (!currentUser) {
                    if (statusEl) statusEl.textContent = '';
                    if (helpEl) {
                        helpEl.textContent = 'Login to set a username';
                        helpEl.style.color = '#f59e0b';
                    }
                    return;
                }
                
                const isUnique = await isUsernameUnique(username, currentUser.uid);
                
                if (isUnique) {
                    if (statusEl) statusEl.textContent = '';
                    if (helpEl) {
                        helpEl.textContent = 'Username is available!';
                        helpEl.style.color = '#10b981';
                    }
                    input.style.borderColor = '#10b981';
                } else {
                    if (statusEl) statusEl.textContent = '';
                    if (helpEl) {
                        helpEl.textContent = 'Username is already taken';
                        helpEl.style.color = '#ef4444';
                    }
                    input.style.borderColor = '#ef4444';
                }
            }, 500); // Wait 500ms after user stops typing
        }
        window.validateUsernameInput = validateUsernameInput;
        
        // Update sync status display
        function updateSyncStatus(status, title, details) {
            const container = document.getElementById('profileSyncStatus');
            const icon = document.getElementById('syncIcon');
            const text = document.getElementById('syncStatusText');
            const detailsEl = document.getElementById('syncStatusDetails');
            
            if (!container) return;
            
            if (status === 'success') {
                container.style.background = '#f0fdf4';
                container.style.borderColor = '#86efac';
                if (icon) icon.textContent = '';
            } else if (status === 'error') {
                container.style.background = '#fef2f2';
                container.style.borderColor = '#fca5a5';
                if (icon) icon.textContent = '';
            } else if (status === 'warning') {
                container.style.background = '#fffbeb';
                container.style.borderColor = '#fcd34d';
                if (icon) icon.textContent = '';
            } else if (status === 'syncing') {
                container.style.background = '#eff6ff';
                container.style.borderColor = '#93c5fd';
                if (icon) icon.textContent = '';
            }
            
            if (text) text.textContent = title;
            if (detailsEl) detailsEl.textContent = details;
        }
        
        // Test Firebase connection
        async function testFirebaseConnection() {
            console.log(' Testing Firebase connection...');
            showNotification('Testing Firebase connection...', 'info');
            
            // Check auth state
            console.log('Current user:', currentUser ? currentUser.email : 'Not logged in');
            
            if (!currentUser) {
                showNotification('Please login first to test Firebase connection', 'warning');
                updateSyncStatus('warning', 'Not logged in', 'Please sign in to sync data');
                return;
            }
            
            try {
                // Try to read from Firestore
                console.log('Reading user doc...');
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                console.log('User doc exists:', userDoc.exists);
                if (userDoc.exists) {
                    console.log('User data:', userDoc.data());
                }
                
                // Try to write a test field
                console.log('Writing test field...');
                await db.collection('users').doc(currentUser.uid).set({
                    testField: 'Connection test at ' + new Date().toISOString(),
                    lastActive: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                console.log(' Firebase connection test successful!');
                showNotification('Firebase connection working! ', 'success');
                updateSyncStatus('success', 'Connection OK', 'Firebase is working properly');
                
            } catch (error) {
                console.error(' Firebase test failed:', error);
                showNotification('Firebase test failed: ' + error.message, 'warning');
                updateSyncStatus('error', 'Connection failed', error.message);
            }
        }
        window.testFirebaseConnection = testFirebaseConnection;

        // AI Chat functionality - ChatGPT Style
        let uploadedImage = null;

        function handleChatKeypress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedImage = {
                    data: e.target.result,
                    name: file.name
                };
                
                const preview = document.getElementById('imagePreview');
                preview.style.display = 'block';
                preview.innerHTML = `
                    <img src="${e.target.result}" alt="Upload preview">
                    <button class="remove-image" onclick="removeImage()"> Remove</button>
                `;
            };
            reader.readAsDataURL(file);
        }

        function removeImage() {
            uploadedImage = null;
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('chatImageUpload').value = '';
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message && !uploadedImage) return;

            // Add user message
            const messagesDiv = document.getElementById('chatMessages');
            const userMsg = document.createElement('div');
            userMsg.className = 'message user';
            
            let messageContent = '';
            if (uploadedImage) {
                messageContent += `<img src="${uploadedImage.data}" style="max-width: 300px; border-radius: 8px; margin-bottom: 8px; display: block;">`;
            }
            if (message) {
                messageContent += `<p style="margin: 0;">${message}</p>`;
            }
            
            userMsg.innerHTML = `
                <div class="message-avatar"></div>
                <div class="message-content">${messageContent}</div>
            `;
            messagesDiv.appendChild(userMsg);

            input.value = '';
            input.style.height = 'auto';
            removeImage();
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            // Show typing indicator
            const typingMsg = document.createElement('div');
            typingMsg.className = 'message ai';
            typingMsg.id = 'typingIndicator';
            typingMsg.innerHTML = `
                <div class="message-avatar"></div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            messagesDiv.appendChild(typingMsg);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            // Get AI response (async)
            const fullMessage = uploadedImage ? 
                `[User uploaded an image: ${uploadedImage.name}] ${message}` : 
                message;
                
            generateAIResponse(fullMessage).then(response => {
                // Remove typing indicator
                const typing = document.getElementById('typingIndicator');
                if (typing) typing.remove();
                
                // Add AI response
                const aiMsg = document.createElement('div');
                aiMsg.className = 'message ai';
                aiMsg.innerHTML = `
                    <div class="message-avatar"></div>
                    <div class="message-content">
                        <strong style="display: block; margin-bottom: 8px;">AI Coach</strong>
                        <div>${response.replace(/\n/g, '<br>')}</div>
                    </div>
                `;
                messagesDiv.appendChild(aiMsg);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            });
        }

        // Generate AI response - tries Easy-Peasy first, then Gemini if available, then smart chatbot
        async function generateAIResponse(message) {
            // Try Easy-Peasy AI first
            if (easyPeasyAI.isEnabled()) {
                const easyPeasyResponse = await easyPeasyAI.sendToEasyPeasy(message);
                if (easyPeasyResponse) {
                    return easyPeasyResponse;
                }
                // If Easy-Peasy fails or returns null, fall through to Gemini
            }
            
            // Try Gemini if API key is set
            if (geminiAI.hasApiKey()) {
                return await geminiAI.sendToGemini(message);
            }
            
            // Fallback to smart contextual chatbot
            return smartChatbot.generateResponse(message);
        }

        // Body scan analysis
        function analyzebodyPhotos(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            const resultsDiv = document.getElementById('analysisResults');
            const contentDiv = document.getElementById('analysisContent');
            
            resultsDiv.style.display = 'block';
            contentDiv.innerHTML = '<div class="loading"></div> Analyzing your photos...';

            // Simulate analysis
            setTimeout(() => {
                contentDiv.innerHTML = `
                    <h3 style="color: var(--primary); margin-bottom: 15px;">Body Type Assessment</h3>
                    <p><strong>Current Classification:</strong> Endomorph-Mesomorph Mix</p>
                    <p style="margin-top: 10px; color: var(--text-light);">
                        You have a naturally strong build with good muscle potential. Your body stores fat easily but responds well to training.
                    </p>
                    
                    <h4 style="margin-top: 20px; margin-bottom: 10px;">Key Observations:</h4>
                    <ul style="color: var(--text-light); padding-left: 25px;">
                        <li>Broader torso with natural strength base</li>
                        <li>Higher fat storage around midsection</li>
                        <li>Solid muscle foundation in arms and legs</li>
                        <li>High muscle-building potential</li>
                    </ul>

                    <h4 style="margin-top: 20px; margin-bottom: 10px;">Transformation Potential:</h4>
                    <p style="color: var(--text-light);">
                        With fat loss and consistent training, you'll shift toward a Mesomorph-dominant physique. At 210-230 lbs, you'll have:
                    </p>
                    <ul style="color: var(--text-light); padding-left: 25px; margin-top: 10px;">
                        <li>Tighter waist and defined core</li>
                        <li>Broad shoulders and V-taper</li>
                        <li>Dense, powerful muscle structure</li>
                        <li>Athletic, strong appearance</li>
                    </ul>

                    <h4 style="margin-top: 20px; margin-bottom: 10px;">Recommendations:</h4>
                    <ul style="color: var(--text-light); padding-left: 25px;">
                        <li>Focus on 500-700 calorie deficit</li>
                        <li>Strength training 4x per week</li>
                        <li>High protein intake (170-210g/day)</li>
                        <li>Progressive overload for muscle retention</li>
                    </ul>
                `;

                unlockAchievement(4);
            }, 2000);
        }

        // Camera functionality
        let stream = null;
        function enableCamera() {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(s => {
                    stream = s;
                    const preview = document.getElementById('cameraPreview');
                    const video = document.createElement('video');
                    video.srcObject = stream;
                    video.autoplay = true;
                    preview.innerHTML = '';
                    preview.appendChild(video);
                    document.getElementById('captureBtn').style.display = 'inline-block';
                })
                .catch(err => {
                    alert('Camera access denied. Please enable camera permissions.');
                });
        }

        function capturePhoto() {
            const video = document.querySelector('#cameraPreview video');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            const photoData = canvas.toDataURL('image/png');
            
            // Add to progress photos
            appState.progressPhotos.push({
                data: photoData,
                date: new Date().toISOString()
            });
            
            saveData();
            alert(' Photo captured and added to your progress gallery!');
            renderProgressPhotos();
        }

        // Progress photos
        function openProgressUpload() {
            document.getElementById('progressUploadModal').classList.add('active');
        }

        function closeProgressUpload() {
            document.getElementById('progressUploadModal').classList.remove('active');
            document.getElementById('progressPhotoUpload').value = '';
            document.getElementById('photoWeight').value = '';
        }

        function processProgressPhoto(event) {
            const file = event.target.files[0];
            if (!file) return;

            const bodyPart = document.getElementById('bodyPartSelect').value;
            const weight = document.getElementById('photoWeight').value;

            const reader = new FileReader();
            reader.onload = function(e) {
                const photoData = {
                    data: e.target.result,
                    date: new Date().toISOString(),
                    bodyPart: bodyPart,
                    weight: weight || null,
                    analysis: null
                };

                // Simulate AI analysis
                showNotification('Analyzing your photo...', 'info');
                
                setTimeout(() => {
                    photoData.analysis = generatePhotoAnalysis(photoData, appState.progressPhotos);
                    appState.progressPhotos.push(photoData);
                    saveData();
                    closeProgressUpload();
                    renderProgressTimeline();
                    showNotification('Progress photo added successfully! ', 'success');
                    
                    // Show slideshow button if we have 2+ photos
                    if (appState.progressPhotos.length >= 2) {
                        document.getElementById('slideshowBtn').style.display = 'inline-block';
                        document.getElementById('compareBtn').style.display = 'inline-block';
                    }
                }, 2000);
            };
            reader.readAsDataURL(file);
        }

        // AI Photo Analysis (Honest assessment with detailed body type analysis)
        function generatePhotoAnalysis(currentPhoto, previousPhotos) {
            const bodyPart = currentPhoto.bodyPart;
            const previousSame = previousPhotos.filter(p => p.bodyPart === bodyPart);
            
            if (previousSame.length === 0) {
                // First photo - provide detailed body type analysis
                return generateInitialBodyTypeAnalysis(bodyPart);
            }

            const mostRecent = previousSame[previousSame.length - 1];
            const daysSince = Math.floor((new Date(currentPhoto.date) - new Date(mostRecent.date)) / (1000 * 60 * 60 * 24));
            
            // Realistic progress analysis based on timeframe
            return generateProgressAnalysis(daysSince, bodyPart, currentPhoto.weight, mostRecent.weight);
        }

        // Generate detailed body type analysis from photo
        function generateInitialBodyTypeAnalysis(bodyPart) {
            // Simulate detailed body scanning (in production, this would use image recognition AI)
            const analyses = {
                'full-body-front': {
                    summary: 'Full body baseline established',
                    details: `Initial full body assessment captured. This photo will serve as your primary reference point for tracking overall transformation. For best accuracy, take this photo weekly in consistent lighting (preferably morning, natural light) and same clothing.`,
                    observations: [
                        'Front view baseline captured',
                        'Full body proportions recorded',
                        'Starting point for transformation tracking',
                        'Take weekly photos at same time/lighting for accurate comparison'
                    ],
                    bodyTypeAssessment: 'Based on this baseline photo, a detailed body composition analysis will be available after your next photo for comparison. Keep consistent with your nutrition and training plan.'
                },
                'full-body-side': {
                    summary: 'Side profile baseline established',
                    details: `Side profile captured showing posture and body composition. This angle is crucial for tracking abdominal changes and overall posture improvements. The side view often shows progress that front photos miss.`,
                    observations: [
                        'Side profile baseline recorded',
                        'Posture assessment captured',
                        'Torso depth and core positioning documented',
                        'Compare this angle weekly for best results'
                    ],
                    bodyTypeAssessment: 'Side view provides insights into core development and fat distribution patterns. Continue regular photos to track midsection changes over time.'
                },
                'full-body-back': {
                    summary: 'Back view baseline established',
                    details: `Back profile captured. This view is essential for tracking shoulder width, back development, and posterior chain progress. Many people neglect back photos but they reveal significant changes.`,
                    observations: [
                        'Back view baseline documented',
                        'Shoulder width and lat development recorded',
                        'Lower back and glute positioning captured',
                        'Weekly back photos show muscle definition progress'
                    ],
                    bodyTypeAssessment: 'Back development is key for achieving a V-taper physique. Track this view to monitor lat spread and shoulder development.'
                },
                'chest': {
                    summary: 'Chest area baseline captured',
                    details: `Chest and upper body baseline established. This region responds well to upper body training and shows definition changes within 4-6 weeks of consistent training.`,
                    observations: [
                        'Chest baseline recorded',
                        'Pec development starting point captured',
                        'Upper body fat distribution documented',
                        'Focus on progressive overload in chest exercises'
                    ],
                    bodyTypeAssessment: 'Chest development varies by body type - consistent pressing movements and adequate protein intake drive visible changes here.'
                },
                'arms': {
                    summary: 'Arm development baseline',
                    details: `Arm size and definition baseline captured. Arms typically show visible changes within 3-4 weeks of consistent training, making them great for tracking progress.`,
                    observations: [
                        'Arm circumference baseline documented',
                        'Bicep and tricep development starting point',
                        'Forearm size recorded',
                        'Track weekly - arms show fast visual changes'
                    ],
                    bodyTypeAssessment: 'Arm development responds quickly to training. Focus on both bicep and tricep work for balanced growth.'
                },
                'abs': {
                    summary: 'Core/abdominal baseline established',
                    details: `Midsection baseline captured. This area typically takes the longest to show definition as it requires lower overall body fat percentage (12-15% for visible abs). Core photos are most telling of overall progress.`,
                    observations: [
                        'Abdominal baseline documented',
                        'Core fat distribution recorded',
                        'Starting point for definition tracking',
                        'Visible abs require 12-15% body fat - be patient and consistent'
                    ],
                    bodyTypeAssessment: 'Abs are revealed through fat loss, not just built through training. Nutrition consistency is critical for this area.'
                },
                'legs': {
                    summary: 'Lower body baseline captured',
                    details: `Leg development and lower body composition baseline established. Legs often hold the most muscle potential and respond well to compound movements like squats and lunges.`,
                    observations: [
                        'Leg development baseline recorded',
                        'Quadriceps and hamstring size documented',
                        'Calf development captured',
                        'Lower body holds largest muscle groups - train consistently'
                    ],
                    bodyTypeAssessment: 'Lower body development is crucial for overall physique balance. Strong legs support metabolic rate and overall strength.'
                },
                'face': {
                    summary: 'Facial baseline established',
                    details: `Face and neck baseline captured. Facial definition is one of the first areas people notice when you lose fat. Jawline definition typically appears at 15-18% body fat for men, 20-24% for women.`,
                    observations: [
                        'Facial structure baseline documented',
                        'Neck and jawline starting point captured',
                        'Face often shows changes before other areas',
                        'Jawline definition appears with consistent fat loss'
                    ],
                    bodyTypeAssessment: 'Facial definition is directly tied to overall body fat percentage. As you lean down, this area will show dramatic improvements.'
                }
            };

            return analyses[bodyPart] || analyses['full-body-front'];
        }

        // Generate progress analysis between photos
        function generateProgressAnalysis(daysSince, bodyPart, currentWeight, previousWeight) {
            let summary, details, observations;

            if (daysSince < 7) {
                summary = 'Too early for visible changes';
                details = `Only ${daysSince} days since your last ${formatBodyPart(bodyPart)} photo. Physical changes in this area typically require 2-4 weeks minimum to become photographically noticeable. Continue your current routine - consistency is key.`;
                observations = [
                    `Less than 1 week of progress in ${formatBodyPart(bodyPart)}`,
                    'No significant visual changes expected yet',
                    'Body is adapting at cellular level even if not visible',
                    'Stay consistent - take next photo in 1-2 weeks',
                    'Water retention and lighting can mask early changes'
                ];
            } else if (daysSince < 14) {
                summary = 'Early adaptation phase';
                details = `${daysSince} days of training progress in your ${formatBodyPart(bodyPart)}. At this stage, internal adaptations are occurring (increased glycogen storage, improved muscle recruitment) but external changes are subtle. Continue pushing - week 3-4 is when visible changes typically emerge.`;
                observations = [
                    '1-2 weeks of consistent training',
                    'Neurological adaptations occurring',
                    'Muscle glycogen increasing (better pump)',
                    'Possible reduction in bloating/water retention',
                    'Continue current program for 2-3 more weeks for visible results'
                ];
            } else if (daysSince < 30) {
                summary = `Early visible changes in ${formatBodyPart(bodyPart)}`;
                details = `${daysSince} days (${Math.floor(daysSince/7)} weeks) of progress. This is the timeframe where initial physical changes become noticeable in photos. You should see subtle definition improvements, slight size changes, or reduced fat in this area.`;
                observations = [
                    '2-4 weeks of consistent work showing results',
                    `Beginning to see muscle tone in ${formatBodyPart(bodyPart)}`,
                    'Fat loss becoming visible if in caloric deficit',
                    'Muscle size increasing if in surplus',
                    'This is when progress accelerates - keep momentum going'
                ];
            } else if (daysSince < 60) {
                summary = `Significant progress visible in ${formatBodyPart(bodyPart)}`;
                details = `${Math.floor(daysSince/7)} weeks of dedicated training. Clear changes should be visible in your ${formatBodyPart(bodyPart)} - noticeable muscle definition, visible fat reduction, or measurable size changes. This is real transformation territory.`;
                observations = [
                    `4-8 weeks of progress in ${formatBodyPart(bodyPart)}`,
                    'Clear muscle definition emerging',
                    'Fat loss distinctly visible',
                    'Proportions noticeably changing',
                    'Others likely commenting on your transformation',
                    'Excellent progress - maintain current approach'
                ];
            } else {
                summary = `Major transformation achieved in ${formatBodyPart(bodyPart)}`;
                details = `${Math.floor(daysSince/30)} months of consistent work paying off. Dramatic changes should be visible in your ${formatBodyPart(bodyPart)} - significant fat reduction, clear muscle separation, complete body recomposition in this area. Outstanding dedication!`;
                observations = [
                    `${Math.floor(daysSince/30)} months of transformation visible`,
                    `Dramatic changes in ${formatBodyPart(bodyPart)} structure`,
                    'Clear muscle definition and separation',
                    'Major fat loss achieved',
                    'Complete body recomposition in this area',
                    'You should be incredibly proud of this progress',
                    'Consider tracking other angles for full documentation'
                ];
            }

            // Add weight comparison if available
            if (currentWeight && previousWeight) {
                const weightChange = currentWeight - previousWeight;
                if (weightChange < -2) {
                    observations.push(`Weight down ${Math.abs(weightChange)} lbs - excellent fat loss progress!`);
                } else if (weightChange < 0) {
                    observations.push(`Weight down ${Math.abs(weightChange)} lbs - steady progress`);
                } else if (weightChange > 2) {
                    observations.push(`Weight up ${weightChange} lbs - if training hard, this could be quality muscle gain`);
                } else if (weightChange > 0) {
                    observations.push(`Weight up ${weightChange} lbs - minor fluctuation, focus on visual changes`);
                } else {
                    observations.push('Weight stable - excellent if focusing on body recomposition');
                }
            }

            // Add body-part specific observations
            const specificObservations = getBodyPartSpecificObservations(bodyPart, daysSince);
            observations.push(...specificObservations);

            return { summary, details, observations };
        }

        // Get body part specific observations based on timeframe
        function getBodyPartSpecificObservations(bodyPart, days) {
            const observations = [];
            
            if (bodyPart.includes('full-body')) {
                if (days >= 30) {
                    observations.push('Overall silhouette changing - clothes fitting differently');
                    observations.push('Posture may be improving with strength gains');
                }
            } else if (bodyPart === 'chest') {
                if (days >= 21) {
                    observations.push('Chest responds well to progressive overload');
                    observations.push('Upper/lower pec definition may be emerging');
                }
            } else if (bodyPart === 'arms') {
                if (days >= 14) {
                    observations.push('Arms show fast visual changes due to smaller muscle groups');
                    observations.push('Vascularity may be increasing');
                }
            } else if (bodyPart === 'abs') {
                if (days >= 30) {
                    observations.push('Ab definition requires 12-15% body fat for men, 18-22% for women');
                    observations.push('Continue fat loss focus if abs are the goal');
                }
            } else if (bodyPart === 'legs') {
                if (days >= 21) {
                    observations.push('Quad sweep and hamstring separation developing');
                    observations.push('Legs have highest muscle-building potential');
                }
            } else if (bodyPart === 'face') {
                if (days >= 14) {
                    observations.push('Facial fat loss often appears before other areas');
                    observations.push('Jawline definition indicates overall body fat reduction');
                }
            }

            return observations;
        }

        function formatBodyPart(bodyPart) {
            return bodyPart.split('-').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        // ============================================
        // QUICK PHOTO UPLOAD FOR AI BODY ANALYSIS
        // ============================================
        
        let quickPhotoData = null;
        const BODY_ANALYSIS_API_KEY = '83a72fe3-b705-40d4-8122-543770479436';
        const BODY_ANALYSIS_BOT_ID = '847c6d63-a766-4394-87a2-348b462e8e0a';

        // Handle quick photo upload with instant AI analysis
        async function handleQuickPhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                quickPhotoData = e.target.result;
                
                // Display preview
                const previewContainer = document.getElementById('quickPhotoPreview');
                const previewImage = document.getElementById('quickPhotoImage');
                
                previewImage.src = quickPhotoData;
                previewContainer.style.display = 'block';
                
                showNotification(' Photo uploaded! Analyzing with AI...', 'info');
                
                // Trigger instant AI analysis
                await analyzePhotoWithAI(quickPhotoData);
            };
            reader.readAsDataURL(file);
        }

        // Analyze photo with Easy-Peasy AI Bot API
        async function analyzePhotoWithAI(photoData) {
            try {
                // Convert base64 to blob for API upload
                const response = await fetch(photoData);
                const blob = await response.blob();
                
                // Create form data with image
                const formData = new FormData();
                formData.append('image', blob, 'body-photo.jpg');
                formData.append('message', 'Please analyze this body photo. Provide detailed analysis of: 1) Body type (ectomorph/mesomorph/endomorph), 2) Current muscle development, 3) Estimated body fat percentage, 4) Key strengths and areas to improve, 5) Specific workout recommendations, 6) Nutrition advice for my body type.');
                
                showNotification(' AI is analyzing your photo...', 'info');
                
                // Call Easy-Peasy AI Bot API
                const apiResponse = await fetch(`https://bots.easy-peasy.ai/bot/${BODY_ANALYSIS_BOT_ID}/api`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${BODY_ANALYSIS_API_KEY}`
                    },
                    body: formData
                });

                if (!apiResponse.ok) {
                    throw new Error('AI analysis failed');
                }

                const analysisResult = await apiResponse.json();
                
                // Display AI analysis result
                displayAIAnalysisResult(analysisResult);
                
                showNotification(' AI analysis complete!', 'success');
                
            } catch (error) {
                console.error('AI Analysis Error:', error);
                showNotification(' AI analysis unavailable. Please use the chat interface above to upload and analyze your photo.', 'warning');
            }
        }

        // Display AI analysis results
        function displayAIAnalysisResult(result) {
            // Find or create analysis results section
            let resultsSection = document.getElementById('aiAnalysisResults');
            
            if (!resultsSection) {
                // Create new results section
                const bodyScanSection = document.getElementById('body-scan');
                resultsSection = document.createElement('div');
                resultsSection.id = 'aiAnalysisResults';
                resultsSection.style.cssText = 'background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-top: 20px;';
                
                const quickUploadSection = bodyScanSection.querySelector('#quickPhotoPreview').parentElement;
                quickUploadSection.parentElement.insertBefore(resultsSection, quickUploadSection.nextSibling);
            }

            const aiMessage = result.message || result.response || 'Analysis complete. Please check the chat above for detailed results.';
            
            resultsSection.innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                    <div style="font-size: 48px;"></div>
                    <div>
                        <h3 style="margin: 0;">AI Body Analysis Results</h3>
                        <p style="color: var(--text-light); margin: 5px 0 0 0; font-size: 14px;">
                            Powered by Easy-Peasy AI
                        </p>
                    </div>
                </div>
                
                <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #6366f1; white-space: pre-wrap; line-height: 1.8;">
                    ${aiMessage}
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn btn-primary" onclick="scrollToAIChat()" style="flex: 1;">
                         Ask Follow-up Questions
                    </button>
                    <button class="btn" onclick="saveAnalysisToProgress()" style="flex: 1;">
                         Save to Progress
                    </button>
                </div>
            `;
        }

        // Scroll to AI chat for follow-up questions
        function scrollToAIChat() {
            const bodyScanSection = document.getElementById('body-scan');
            const aiChatFrame = bodyScanSection.querySelector('iframe');
            
            if (aiChatFrame) {
                aiChatFrame.scrollIntoView({ behavior: 'smooth', block: 'center' });
                showNotification(' Ask the AI any follow-up questions!', 'info');
            }
        }

        // Save AI analysis to progress photos
        function saveAnalysisToProgress() {
            if (!quickPhotoData) {
                showNotification('No photo to save', 'warning');
                return;
            }

            const aiResults = document.getElementById('aiAnalysisResults');
            const analysisText = aiResults ? aiResults.textContent : 'AI Analysis completed';

            const photoData = {
                data: quickPhotoData,
                date: new Date().toISOString(),
                bodyPart: 'ai-analysis',
                weight: appState.user.currentWeight || null,
                analysis: {
                    summary: 'AI Body Analysis',
                    details: analysisText,
                    aiGenerated: true,
                    timestamp: new Date().toISOString()
                }
            };

            appState.progressPhotos.push(photoData);
            saveData();
            
            showNotification(' Analysis saved to Progress Photos!', 'success');
            
            // Show slideshow button if we have 2+ photos
            if (appState.progressPhotos.length >= 2) {
                document.getElementById('slideshowBtn').style.display = 'inline-block';
                document.getElementById('compareBtn').style.display = 'inline-block';
            }
        }

        // Download quick photo
        function downloadQuickPhoto() {
            if (!quickPhotoData) {
                showNotification('No photo to download', 'warning');
                return;
            }

            const link = document.createElement('a');
            link.href = quickPhotoData;
            link.download = `body-analysis-${Date.now()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification(' Photo downloaded to your device!', 'success');
        }

        // Clear quick photo
        function clearQuickPhoto() {
            quickPhotoData = null;
            document.getElementById('quickPhotoPreview').style.display = 'none';
            document.getElementById('quickPhotoImage').src = '';
            document.getElementById('quickCameraInput').value = '';
            document.getElementById('quickGalleryInput').value = '';
        }

        // ============================================
        // PROGRESS TIMELINE & PHOTO MANAGEMENT
        // ============================================

        function renderProgressTimeline() {
            const timeline = document.getElementById('progressTimeline');
            
            if (appState.progressPhotos.length === 0) {
                timeline.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-light);">
                        <div style="font-size: 64px; margin-bottom: 20px;"></div>
                        <h3 style="margin-bottom: 10px;">No Progress Photos Yet</h3>
                        <p>Start tracking your transformation by adding your first progress photo!</p>
                    </div>
                `;
                return;
            }

            const sorted = [...appState.progressPhotos].sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );

            timeline.innerHTML = `
                <div class="timeline-container">
                    <div class="timeline-line"></div>
                    ${sorted.map((photo, index) => {
                        const date = new Date(photo.date);
                        const dateStr = date.toLocaleDateString('en-US', { 
                            month: 'short', 
                            day: 'numeric', 
                            year: 'numeric' 
                        });
                        const timeStr = date.toLocaleTimeString('en-US', { 
                            hour: 'numeric', 
                            minute: '2-digit' 
                        });

                        return `
                            <div class="timeline-item">
                                <div class="timeline-dot"></div>
                                <div class="timeline-meta">
                                    <span> ${dateStr} at ${timeStr}</span>
                                    <span> ${formatBodyPart(photo.bodyPart)}</span>
                                    ${photo.weight ? `<span> ${photo.weight} lbs</span>` : ''}
                                </div>
                                <img src="${photo.data}" class="timeline-photo" onclick="viewPhotoDetail(${sorted.length - 1 - index})" alt="Progress photo">
                                ${photo.analysis ? `
                                    <div class="timeline-analysis">
                                        <h4 style="margin-bottom: 10px; color: var(--primary);">
                                            ${photo.analysis.summary}
                                        </h4>
                                        <p style="color: var(--text-light); margin-bottom: 15px;">
                                            ${photo.analysis.details}
                                        </p>
                                        <strong style="display: block; margin-bottom: 8px;">Observations:</strong>
                                        <ul style="color: var(--text-light); padding-left: 25px;">
                                            ${photo.analysis.observations.map(obs => `<li>${obs}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Slideshow functionality
        function viewSlideshow() {
            if (appState.progressPhotos.length < 2) {
                showNotification('Add at least 2 progress photos to view slideshow', 'warning');
                return;
            }
            
            appState.slideshowIndex = 0;
            document.getElementById('slideshowModal').classList.add('active');
            updateSlideshow();
            generateSlideshowAnalysis();
        }

        function updateSlideshow() {
            const photos = appState.progressPhotos;
            const current = photos[appState.slideshowIndex];
            
            document.getElementById('slideshowImage').src = current.data;
            
            const date = new Date(current.date);
            const info = document.getElementById('slideshowInfo');
            info.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <h3 style="margin-bottom: 5px;">${formatBodyPart(current.bodyPart)}</h3>
                        <p style="opacity: 0.9; font-size: 14px;">
                            ${date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
                            ${current.weight ? `  ${current.weight} lbs` : ''}
                        </p>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px;">
                        Photo ${appState.slideshowIndex + 1} of ${photos.length}
                    </div>
                </div>
            `;
        }

        function generateSlideshowAnalysis() {
            const photos = appState.progressPhotos;
            const analysisDiv = document.getElementById('slideshowAnalysis');
            
            if (photos.length < 2) {
                analysisDiv.innerHTML = '<p style="color: var(--text-light);">Add more photos to see transformation analysis</p>';
                return;
            }

            const first = photos[0];
            const last = photos[photos.length - 1];
            const daysDiff = Math.floor((new Date(last.date) - new Date(first.date)) / (1000 * 60 * 60 * 24));
            const weeksDiff = Math.floor(daysDiff / 7);

            let transformationText = '';
            if (daysDiff < 7) {
                transformationText = 'Keep taking photos weekly to track your progress over time.';
            } else if (daysDiff < 30) {
                transformationText = `${weeksDiff} week${weeksDiff !== 1 ? 's' : ''} of progress tracked. Early changes are forming - stay consistent!`;
            } else if (daysDiff < 90) {
                transformationText = `${weeksDiff} weeks of transformation captured. At this stage, significant changes should be visible. Your dedication is showing!`;
            } else {
                transformationText = `${Math.floor(daysDiff/30)} months of incredible transformation! This slideshow tells the story of your hard work and commitment.`;
            }

            let weightText = '';
            if (first.weight && last.weight) {
                const weightChange = last.weight - first.weight;
                if (weightChange < 0) {
                    weightText = `<div style="background: var(--secondary); color: white; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <strong>Weight Progress:</strong> Down ${Math.abs(weightChange)} lbs! 
                    </div>`;
                }
            }

            analysisDiv.innerHTML = `
                <h3 style="margin-bottom: 15px;"> Transformation Overview</h3>
                <p style="color: var(--text-light); margin-bottom: 10px;">
                    <strong>Timeline:</strong> ${photos.length} photos over ${daysDiff} days
                </p>
                <p style="color: var(--text-light); margin-bottom: 15px;">
                    ${transformationText}
                </p>
                ${weightText}
                <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px;">
                    <strong> Pro Tip:</strong> Take photos in the same lighting, same time of day, and same poses for the most accurate comparison. Morning photos work best!
                </div>
            `;
        }

        function nextSlide() {
            appState.slideshowIndex = (appState.slideshowIndex + 1) % appState.progressPhotos.length;
            updateSlideshow();
        }

        function previousSlide() {
            appState.slideshowIndex = (appState.slideshowIndex - 1 + appState.progressPhotos.length) % appState.progressPhotos.length;
            updateSlideshow();
        }

        function toggleAutoplay() {
            const btn = document.getElementById('autoplayBtn');
            
            if (appState.autoplayInterval) {
                clearInterval(appState.autoplayInterval);
                appState.autoplayInterval = null;
                btn.textContent = ' Autoplay';
            } else {
                appState.autoplayInterval = setInterval(nextSlide, 2000);
                btn.textContent = ' Pause';
            }
        }

        function closeSlideshow() {
            if (appState.autoplayInterval) {
                clearInterval(appState.autoplayInterval);
                appState.autoplayInterval = null;
            }
            document.getElementById('slideshowModal').classList.remove('active');
        }

        // Comparison functionality
        function comparePhotos() {
            if (appState.progressPhotos.length < 2) {
                showNotification('Add at least 2 photos to compare', 'warning');
                return;
            }

            const beforeSelect = document.getElementById('beforeSelect');
            const afterSelect = document.getElementById('afterSelect');
            
            // Populate selects
            const options = appState.progressPhotos.map((photo, index) => {
                const date = new Date(photo.date).toLocaleDateString();
                return `<option value="${index}">${formatBodyPart(photo.bodyPart)} - ${date}</option>`;
            }).join('');
            
            beforeSelect.innerHTML = options;
            afterSelect.innerHTML = options;
            
            // Set default selections (first and last)
            beforeSelect.value = '0';
            afterSelect.value = (appState.progressPhotos.length - 1).toString();
            
            document.getElementById('compareModal').classList.add('active');
            updateComparison();
        }

        function updateComparison() {
            const beforeIndex = parseInt(document.getElementById('beforeSelect').value);
            const afterIndex = parseInt(document.getElementById('afterSelect').value);
            
            if (isNaN(beforeIndex) || isNaN(afterIndex)) return;

            const beforePhoto = appState.progressPhotos[beforeIndex];
            const afterPhoto = appState.progressPhotos[afterIndex];
            
            document.getElementById('beforeImage').innerHTML = `
                <img src="${beforePhoto.data}" style="width: 100%; height: auto; border-radius: 12px;">
                <p style="text-align: center; margin-top: 10px; color: var(--text-light);">
                    ${new Date(beforePhoto.date).toLocaleDateString()}
                    ${beforePhoto.weight ? `  ${beforePhoto.weight} lbs` : ''}
                </p>
            `;
            
            document.getElementById('afterImage').innerHTML = `
                <img src="${afterPhoto.data}" style="width: 100%; height: auto; border-radius: 12px;">
                <p style="text-align: center; margin-top: 10px; color: var(--text-light);">
                    ${new Date(afterPhoto.date).toLocaleDateString()}
                    ${afterPhoto.weight ? `  ${afterPhoto.weight} lbs` : ''}
                </p>
            `;

            // Generate comparison analysis
            generateComparisonAnalysis(beforePhoto, afterPhoto);
        }

        function generateComparisonAnalysis(before, after) {
            const analysisDiv = document.getElementById('comparisonAnalysis');
            const daysDiff = Math.floor((new Date(after.date) - new Date(before.date)) / (1000 * 60 * 60 * 24));
            
            if (daysDiff <= 0) {
                analysisDiv.innerHTML = `
                    <h3 style="margin-bottom: 15px;">AI Analysis</h3>
                    <p style="color: var(--text-light);">Please select an earlier "Before" photo and a later "After" photo for comparison.</p>
                `;
                return;
            }

            const weeksDiff = Math.floor(daysDiff / 7);
            let assessment = '';

            if (daysDiff < 14) {
                assessment = `This comparison shows ${daysDiff} days of progress. This is a short timeframe - major visual changes typically require 3-4 weeks minimum. Continue your training and check back in a few weeks for more noticeable differences.`;
            } else if (daysDiff < 30) {
                assessment = `${weeksDiff} weeks of progress. At this point, you should start seeing early changes: slight reduction in bloating, improved muscle tone, better posture. The transformation is beginning - stay consistent!`;
            } else if (daysDiff < 60) {
                assessment = `${weeksDiff} weeks of solid work! Clear changes should be visible: noticeable fat loss, better muscle definition, improved body shape. This is where people start commenting on your progress.`;
            } else {
                assessment = `${Math.floor(daysDiff/30)} months of transformation! This comparison should show dramatic changes: significant fat reduction, clear muscle definition, completely different body composition. You've earned this progress!`;
            }

            let weightAnalysis = '';
            if (before.weight && after.weight) {
                const weightChange = after.weight - before.weight;
                if (weightChange < 0) {
                    weightAnalysis = `<div style="background: var(--secondary); color: white; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <strong>Weight Change:</strong> Down ${Math.abs(weightChange)} lbs! Outstanding progress! 
                    </div>`;
                } else if (weightChange > 0) {
                    weightAnalysis = `<div style="background: var(--warning); color: white; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <strong>Weight Change:</strong> Up ${weightChange} lbs. If you're strength training consistently, this could be muscle gain. Focus on visual changes and how clothes fit.
                    </div>`;
                } else {
                    weightAnalysis = `<div style="background: var(--primary); color: white; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <strong>Weight:</strong> Stable at ${after.weight} lbs. Weight is just one metric - pay attention to body composition, strength gains, and how you feel.
                    </div>`;
                }
            }

            analysisDiv.innerHTML = `
                <h3 style="margin-bottom: 15px;"> Honest Comparison Analysis</h3>
                <p style="color: var(--text-light); margin-bottom: 10px;">
                    <strong>Time Period:</strong> ${daysDiff} days (${weeksDiff} weeks)
                </p>
                <p style="color: var(--text-light); margin-bottom: 15px;">
                    ${assessment}
                </p>
                ${weightAnalysis}
                <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px;">
                    <strong> Remember:</strong> Transformation takes time. Compare monthly photos for the most dramatic visual differences. Focus on consistency, not perfection!
                </div>
            `;
        }

        function closeComparison() {
            document.getElementById('compareModal').classList.remove('active');
        }

        // Notification System
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            
            const icons = {
                success: '',
                info: '',
                warning: ''
            };
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 24px;">${icons[type]}</span>
                    <p style="margin: 0; font-weight: 500;">${message}</p>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.3s reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Request notification permission
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        appState.user.notificationsEnabled = true;
                        saveData();
                        showNotification('Notifications enabled! We\'ll remind you to workout.', 'success');
                        scheduleWorkoutReminder();
                    }
                });
            }
        }

        // Schedule daily workout reminder
        function scheduleWorkoutReminder() {
            if ('Notification' in window && Notification.permission === 'granted') {
                // Check every hour if user should be reminded
                setInterval(() => {
                    const now = new Date();
                    const hour = now.getHours();
                    
                    // Remind at 9 AM if they haven't worked out today
                    if (hour === 9 && !hasWorkedOutToday()) {
                        new Notification('FitQuest Reminder', {
                            body: ' Time to complete today\'s workout! Keep your streak alive! ',
                            icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75"></text></svg>',
                            badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75"></text></svg>'
                        });
                    }
                }, 3600000); // Check every hour
            }
        }

        function hasWorkedOutToday() {
            if (!appState.user.lastWorkoutDate) return false;
            const lastWorkout = new Date(appState.user.lastWorkoutDate);
            const today = new Date();
            return lastWorkout.toDateString() === today.toDateString();
        }

        // Weekly schedule
        function renderWeeklySchedule() {
            const scheduleDiv = document.getElementById('weeklySchedule');
            const schedule = [
                { day: 'Monday', workout: 'PUSH - Chest, Shoulders, Triceps', duration: '45 min' },
                { day: 'Tuesday', workout: 'LOWER BODY + CORE', duration: '50 min' },
                { day: 'Wednesday', workout: 'PULL - Back, Biceps', duration: '45 min' },
                { day: 'Thursday', workout: 'CONDITIONING - Cardio Circuit', duration: '40 min' },
                { day: 'Friday', workout: 'FULL BODY - Functional Training', duration: '50 min' },
                { day: 'Saturday', workout: 'Active Recovery - Walk', duration: '30 min' },
                { day: 'Sunday', workout: 'Rest Day', duration: '--' }
            ];

            scheduleDiv.innerHTML = schedule.map(day => `
                <div style="padding: 15px; background: white; border-radius: 8px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${day.day}</strong>
                            <p style="color: var(--text-light); font-size: 14px; margin-top: 5px;">${day.workout}</p>
                        </div>
                        <span style="color: var(--primary); font-weight: bold;">${day.duration}</span>
                    </div>
                </div>
            `).join('');
        }

        // Nutrition plan
        function renderNutritionPlan() {
            const nutritionDiv = document.getElementById('nutritionPlan');
            nutritionDiv.innerHTML = `
                <div style="padding: 15px; background: white; border-radius: 8px; margin-bottom: 10px;">
                    <strong>Daily Targets</strong>
                    <ul style="margin-top: 10px; padding-left: 20px; color: var(--text-light);">
                        <li>Calories: 2,200-2,400</li>
                        <li>Protein: 170-210g</li>
                        <li>Carbs: Moderate (focus around workouts)</li>
                        <li>Fats: Healthy sources</li>
                    </ul>
                </div>
                <div style="padding: 15px; background: white; border-radius: 8px;">
                    <strong>Budget-Friendly Staples</strong>
                    <p style="color: var(--text-light); margin-top: 10px;">
                        Eggs, chicken thighs, ground turkey, rice, frozen veggies, oats, peanut butter, Greek yogurt, canned tuna
                    </p>
                </div>
            `;
        }

        // Modal functions
        function customizePlan() {
            const modal = document.getElementById('customModal');
            const content = document.getElementById('modalContent');
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">Current Weight (lbs)</label>
                    <input type="number" id="customWeight" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px;" value="${appState.user.currentWeight || ''}">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">Goal Weight (lbs)</label>
                    <input type="number" id="customGoal" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px;" value="${appState.user.goalWeight || ''}">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">Your Name</label>
                    <input type="text" id="customName" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px;" value="${appState.user.name}">
                </div>
            `;
            
            modal.classList.add('active');
        }

        function closeModal() {
            const weight = document.getElementById('customWeight').value;
            const goal = document.getElementById('customGoal').value;
            const name = document.getElementById('customName').value;
            
            if (weight) appState.user.currentWeight = weight;
            if (goal) appState.user.goalWeight = goal;
            if (name) appState.user.name = name;
            
            saveData();
            updateUI();
            
            document.getElementById('customModal').classList.remove('active');
        }

        // Weekly Plan Management Functions
        function renderWeeklyPlans() {
            const container = document.getElementById('weeklyPlansContainer');
            const emptyState = document.getElementById('emptyPlansState');
            
            if (!appState.weeklyPlans || appState.weeklyPlans.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            container.style.display = 'block';
            emptyState.style.display = 'none';
            
            container.innerHTML = appState.weeklyPlans.map((plan, index) => {
                const startDate = new Date(plan.startDate);
                const currentWeek = Math.floor((new Date() - startDate) / (7 * 24 * 60 * 60 * 1000));
                const totalChecked = plan.checklist.filter(item => item.completed).length;
                const totalItems = plan.checklist.length;
                const completionRate = totalItems > 0 ? Math.round((totalChecked / totalItems) * 100) : 0;
                
                return `
                    <div style="background: white; border: 2px solid var(--border); border-radius: 15px; padding: 25px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                            <div style="flex: 1;">
                                <h3 style="margin: 0;">${plan.title}</h3>
                                <p style="color: var(--text-light); margin: 8px 0 0 0;">${plan.description || 'No description'}</p>
                                <div style="margin-top: 10px; display: flex; gap: 15px; flex-wrap: wrap;">
                                    <span style="background: #e3f2fd; color: #1976d2; padding: 6px 12px; border-radius: 20px; font-size: 14px;">
                                         Week ${currentWeek + 1}
                                    </span>
                                    <span style="background: #f3e5f5; color: #7b1fa2; padding: 6px 12px; border-radius: 20px; font-size: 14px;">
                                         ${plan.streak} day streak
                                    </span>
                                    <span style="background: #e8f5e9; color: #388e3c; padding: 6px 12px; border-radius: 20px; font-size: 14px;">
                                         ${completionRate}% complete
                                    </span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn" onclick="editPlan(${index})" style="padding: 8px 12px;"> Edit</button>
                                <button class="btn" onclick="deletePlan(${index})" style="padding: 8px 12px; background: #fee; color: #c33;"></button>
                            </div>
                        </div>
                        
                        ${plan.requirements && plan.requirements.length > 0 ? `
                            <div style="background: #f9fafb; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                                <h4 style="margin: 0 0 10px 0;"> Requirements</h4>
                                <ul style="margin: 0; padding-left: 20px; color: var(--text-light);">
                                    ${plan.requirements.map(req => `<li>${req}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        <div style="background: #f9fafb; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 15px 0;"> Weekly Calendar</h4>
                            <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;">
                                ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map((day, dayIndex) => {
                                    const dayDate = new Date(startDate);
                                    dayDate.setDate(startDate.getDate() + (currentWeek * 7) + dayIndex);
                                    const isToday = dayDate.toDateString() === new Date().toDateString();
                                    const isPast = dayDate < new Date() && !isToday;
                                    const dayData = plan.calendar && plan.calendar[currentWeek] && plan.calendar[currentWeek][dayIndex];
                                    const isCompleted = dayData && dayData.completed;
                                    
                                    return `
                                        <div onclick="toggleDayComplete(${index}, ${currentWeek}, ${dayIndex})" 
                                             style="background: ${isCompleted ? '#4caf50' : isToday ? '#fff9c4' : isPast ? '#f5f5f5' : 'white'}; 
                                                    border: 2px solid ${isCompleted ? '#4caf50' : isToday ? '#fbc02d' : '#e0e0e0'}; 
                                                    border-radius: 8px; 
                                                    padding: 12px 8px; 
                                                    text-align: center; 
                                                    cursor: pointer;
                                                    transition: all 0.3s;">
                                            <div style="font-size: 12px; font-weight: bold; color: ${isCompleted ? 'white' : 'var(--text-light)'};">${day}</div>
                                            <div style="font-size: 20px; margin-top: 5px;">${isCompleted ? '' : isToday ? '' : isPast ? '' : ''}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        
                        <div>
                            <h4 style="margin: 0 0 15px 0;"> Checklist (${totalChecked}/${totalItems})</h4>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                ${plan.checklist.map((item, itemIndex) => `
                                    <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: ${item.completed ? '#e8f5e9' : 'white'}; border: 2px solid ${item.completed ? '#4caf50' : 'var(--border)'}; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                                        <input type="checkbox" ${item.completed ? 'checked' : ''} onchange="toggleChecklistItem(${index}, ${itemIndex})" style="width: 20px; height: 20px; cursor: pointer;">
                                        <span style="flex: 1; ${item.completed ? 'text-decoration: line-through; color: var(--text-light);' : ''}">${item.text}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openCreatePlanModal() {
            if (!currentUser) {
                showNotification('Please login to create weekly plans', 'warning');
                openAuthModal();
                return;
            }
            
            const modal = document.getElementById('customModal');
            const content = document.getElementById('modalContent');
            
            content.innerHTML = `
                <h2 style="margin-bottom: 20px;"> Create New Weekly Plan</h2>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">Plan Title *</label>
                    <input type="text" id="planTitle" placeholder="e.g., Summer Body Challenge" 
                           style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px;">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">Description</label>
                    <textarea id="planDescription" placeholder="Brief description of your plan..." 
                              style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; min-height: 80px; resize: vertical;"></textarea>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">Requirements (one per line)</label>
                    <textarea id="planRequirements" placeholder="e.g.&#10;Workout 5 days/week&#10;Drink 8 glasses of water&#10;Sleep 7+ hours" 
                              style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; min-height: 100px; resize: vertical;"></textarea>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">Checklist Items (one per line) *</label>
                    <textarea id="planChecklist" placeholder="e.g.&#10;Complete morning workout&#10;Track calories&#10;Hit protein goal&#10;Evening walk" 
                              style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; min-height: 120px; resize: vertical;"></textarea>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">Start Date</label>
                    <input type="date" id="planStartDate" value="${new Date().toISOString().split('T')[0]}" 
                           style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px;">
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 25px;">
                    <button class="btn btn-primary" onclick="savePlan()" style="flex: 1;"> Create Plan</button>
                    <button class="btn" onclick="closeCreatePlanModal()" style="flex: 1;">Cancel</button>
                </div>
            `;
            
            modal.classList.add('active');
        }

        function savePlan(editIndex = null) {
            const title = document.getElementById('planTitle').value.trim();
            const description = document.getElementById('planDescription').value.trim();
            const requirementsText = document.getElementById('planRequirements').value.trim();
            const checklistText = document.getElementById('planChecklist').value.trim();
            const startDate = document.getElementById('planStartDate').value;
            
            if (!title) {
                showNotification('Please enter a plan title', 'warning');
                return;
            }
            
            if (!checklistText) {
                showNotification('Please add at least one checklist item', 'warning');
                return;
            }
            
            const requirements = requirementsText ? requirementsText.split('\n').filter(r => r.trim()) : [];
            const checklist = checklistText.split('\n').filter(c => c.trim()).map(text => ({ text, completed: false }));
            
            const plan = {
                title,
                description,
                requirements,
                checklist,
                startDate: startDate || new Date().toISOString().split('T')[0],
                streak: 0,
                calendar: {} // Week number -> day index -> {completed: boolean}
            };
            
            if (editIndex !== null) {
                // Preserve existing calendar and streak data when editing
                plan.calendar = appState.weeklyPlans[editIndex].calendar || {};
                plan.streak = appState.weeklyPlans[editIndex].streak || 0;
                appState.weeklyPlans[editIndex] = plan;
                showNotification('Plan updated! ', 'success');
            } else {
                appState.weeklyPlans.push(plan);
                showNotification('Plan created! ', 'success');
            }
            
            saveData();
            renderWeeklyPlans();
            closeCreatePlanModal();
        }

        function editPlan(index) {
            const plan = appState.weeklyPlans[index];
            const modal = document.getElementById('customModal');
            const content = document.getElementById('modalContent');
            
            content.innerHTML = `
                <h2 style="margin-bottom: 20px;"> Edit Weekly Plan</h2>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">Plan Title *</label>
                    <input type="text" id="planTitle" value="${plan.title}" 
                           style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px;">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">Description</label>
                    <textarea id="planDescription" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; min-height: 80px; resize: vertical;">${plan.description || ''}</textarea>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">Requirements (one per line)</label>
                    <textarea id="planRequirements" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; min-height: 100px; resize: vertical;">${plan.requirements ? plan.requirements.join('\n') : ''}</textarea>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">Checklist Items (one per line) *</label>
                    <textarea id="planChecklist" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; min-height: 120px; resize: vertical;">${plan.checklist.map(item => item.text).join('\n')}</textarea>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">Start Date</label>
                    <input type="date" id="planStartDate" value="${plan.startDate}" 
                           style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px;">
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 25px;">
                    <button class="btn btn-primary" onclick="savePlan(${index})" style="flex: 1;"> Save Changes</button>
                    <button class="btn" onclick="closeCreatePlanModal()" style="flex: 1;">Cancel</button>
                </div>
            `;
            
            modal.classList.add('active');
        }

        function deletePlan(index) {
            if (confirm('Are you sure you want to delete this plan? This cannot be undone.')) {
                appState.weeklyPlans.splice(index, 1);
                saveData();
                renderWeeklyPlans();
                showNotification('Plan deleted', 'info');
            }
        }

        function toggleChecklistItem(planIndex, itemIndex) {
            appState.weeklyPlans[planIndex].checklist[itemIndex].completed = !appState.weeklyPlans[planIndex].checklist[itemIndex].completed;
            saveData();
            renderWeeklyPlans();
        }

        function toggleDayComplete(planIndex, weekIndex, dayIndex) {
            const plan = appState.weeklyPlans[planIndex];
            
            if (!plan.calendar[weekIndex]) {
                plan.calendar[weekIndex] = {};
            }
            
            if (!plan.calendar[weekIndex][dayIndex]) {
                plan.calendar[weekIndex][dayIndex] = { completed: false };
            }
            
            plan.calendar[weekIndex][dayIndex].completed = !plan.calendar[weekIndex][dayIndex].completed;
            
            // Update streak
            updatePlanStreak(planIndex);
            
            saveData();
            renderWeeklyPlans();
            showNotification(plan.calendar[weekIndex][dayIndex].completed ? ' Day completed!' : 'Day unmarked', 'success');
        }

        function updatePlanStreak(planIndex) {
            const plan = appState.weeklyPlans[planIndex];
            const startDate = new Date(plan.startDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let streak = 0;
            let checkDate = new Date(today);
            
            // Count backwards from today to find consecutive completed days
            while (checkDate >= startDate) {
                const daysSinceStart = Math.floor((checkDate - startDate) / (24 * 60 * 60 * 1000));
                const weekIndex = Math.floor(daysSinceStart / 7);
                const dayIndex = daysSinceStart % 7;
                
                if (plan.calendar[weekIndex] && plan.calendar[weekIndex][dayIndex] && plan.calendar[weekIndex][dayIndex].completed) {
                    streak++;
                } else {
                    break;
                }
                
                checkDate.setDate(checkDate.getDate() - 1);
            }
            
            plan.streak = streak;
        }

        function closeCreatePlanModal() {
            document.getElementById('customModal').classList.remove('active');
        }

        // Initialize app
        window.onload = async function() {
            // Initialize IndexedDB first (50MB storage)
            await initDB();
            
            loadData();
            loadMusicAPIKeys(); // Load YouTube/Spotify API keys
            generateFriendCode();
            renderExercises();
            renderAchievements();
            renderWeeklySchedule();
            renderNutritionPlan();
            renderProgressTimeline();
            renderProgressSummary();
            renderFriendsList();
            renderChallenges();
            renderWeeklyPlans(); // Render weekly plans
            loadSettings();
            updateStorageIndicator();
            checkForAutoSlideshow(); // Check if we should show slideshow
            
            // Set today's date as default for photo date picker
            const today = new Date().toISOString().split('T')[0];
            if (document.getElementById('photoDatePicker')) {
                document.getElementById('photoDatePicker').value = today;
            }
            
            // Show storage info
            if (db) {
                showNotification(' Using IndexedDB - 50MB storage available (5x more space!)', 'success');
            } else {
                showNotification(' Using localStorage - 10MB storage available', 'info');
            }
            
            // Request notification permission after a few seconds
            setTimeout(() => {
                if (!appState.user.notificationsEnabled) {
                    requestNotificationPermission();
                }
            }, 3000);

            // Mobile-specific optimizations
            if (isMobileDevice()) {
                document.addEventListener('touchstart', function(e) {
                    if (e.touches.length > 1) {
                        e.preventDefault();
                    }
                }, { passive: false });

                document.addEventListener('touchmove', function(e) {
                    if (e.scale !== 1) {
                        e.preventDefault();
                    }
                }, { passive: false });

                showNotification(' Add this app to your home screen for the best experience!', 'info');
            }

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').catch(() => {});
            }
            
            // Initialize the first nav tab as active
            const firstNavTab = document.querySelector('.nav-tab');
            if (firstNavTab) {
                firstNavTab.classList.add('active');
            }
        };

        // Storage Space Management
        function updateStorageIndicator() {
            try {
                const dataSize = new Blob([JSON.stringify(appState)]).size;
                const maxSize = db ? (50 * 1024 * 1024) : (10 * 1024 * 1024); // 50MB or 10MB
                const usedMB = (dataSize / (1024 * 1024)).toFixed(2);
                const percent = Math.min((dataSize / maxSize) * 100, 100);
                
                document.getElementById('storageBar').style.width = percent + '%';
                document.getElementById('storageUsed').textContent = usedMB + ' MB';
                document.getElementById('storagePercent').textContent = percent.toFixed(0) + '%';
                document.getElementById('storageTotal').textContent = db ? '~50 MB' : '~10 MB';
                
                // Photo count estimate
                const avgPhotoSize = 100 * 1024; // ~100KB per compressed photo
                const estimatedPhotos = Math.floor((maxSize - dataSize) / avgPhotoSize);
                
                const warning = document.getElementById('storageWarning');
                const warningText = document.getElementById('storageWarningText');
                
                if (percent > 90) {
                    document.getElementById('storageBar').style.background = 'var(--danger)';
                    warning.style.display = 'block';
                    warning.style.background = '#fee';
                    warningText.textContent = `Storage critically full! Only ~${estimatedPhotos} more photos possible. Delete old photos or export data.`;
                } else if (percent > 70) {
                    document.getElementById('storageBar').style.background = 'var(--warning)';
                    warning.style.display = 'block';
                    warningText.textContent = `Storage filling up. ~${estimatedPhotos} more photos possible. Consider deleting old photos soon.`;
                } else {
                    warning.style.display = 'none';
                }
            } catch (error) {
                console.error('Storage check error:', error);
            }
        }

        // Easy-Peasy AI Toggle
        function toggleEasyPeasyAI(enabled) {
            easyPeasyAI.setEnabled(enabled);
            const status = document.getElementById('easyPeasyStatus');
            if (enabled) {
                status.innerHTML = ` <strong>Active:</strong> Your AI coach is using Easy-Peasy AI for intelligent, context-aware fitness guidance.`;
                status.style.background = 'rgba(255,255,255,0.15)';
            } else {
                status.innerHTML = ` <strong>Disabled:</strong> AI coach will use Gemini (if configured) or smart rule-based responses.`;
                status.style.background = 'rgba(0,0,0,0.2)';
            }
        }

        // Gemini API Key Management
        function saveGeminiApiKey() {
            const input = document.getElementById('geminiApiKeyInput');
            const key = input.value.trim();
            
            if (!key) {
                showNotification('Please enter your API key', 'warning');
                return;
            }
            
            if (key.length < 20) {
                showNotification('API key seems too short. Please check it.', 'warning');
                return;
            }
            
            geminiAI.setApiKey(key);
            
            const status = document.getElementById('geminiStatus');
            status.style.display = 'block';
            status.innerHTML = `
                <div class="connected-badge"> Gemini AI Connected</div>
                <p style="color: var(--text-light); margin-top: 8px; font-size: 14px;">
                    Your chatbot now uses real AI! Try asking complex questions in the AI Coach tab.
                </p>
            `;
        }

        function toggleApiKeyVisibility() {
            const input = document.getElementById('geminiApiKeyInput');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        // Font Size Adjustment
        function adjustFontSize(value) {
            const percent = parseInt(value);
            document.documentElement.style.fontSize = percent + '%';
            document.getElementById('fontSizeValue').textContent = percent + '% ' + 
                (percent < 90 ? '(Small)' : percent > 110 ? '(Large)' : '(Normal)');
            
            appState.user.fontSize = percent;
            saveData();
        }

        // Button Size Adjustment
        function adjustButtonSize(value) {
            const percent = parseInt(value);
            const scale = percent / 100;
            
            document.querySelectorAll('.btn, .nav-tab, .workout-button').forEach(btn => {
                btn.style.transform = `scale(${scale})`;
                btn.style.transformOrigin = 'center';
            });
            
            document.getElementById('buttonSizeValue').textContent = percent + '% ' + 
                (percent < 90 ? '(Small)' : percent > 110 ? '(Large)' : '(Normal)');
            
            appState.user.buttonSize = percent;
            saveData();
        }

        // Progress Photo with Date Picker
        function processProgressPhoto(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showNotification('Processing photo...', 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    compressImage(img, function(compressedDataUrl) {
                        if (!compressedDataUrl) {
                            showNotification('Failed to process photo. Try a smaller image.', 'warning');
                            return;
                        }
                        
                        // Show preview
                        document.getElementById('photoPreviewContainer').style.display = 'block';
                        document.getElementById('photoPreviewImage').src = compressedDataUrl;
                        
                        // Store temporarily
                        appState.tempPhoto = compressedDataUrl;
                        
                        // Save photo with selected date
                        saveProgressPhotoWithDate();
                    });
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function saveProgressPhotoWithDate() {
            if (!appState.tempPhoto) {
                showNotification('Please select a photo first', 'warning');
                return;
            }
            
            const bodyPart = document.getElementById('bodyPartSelect').value;
            const weight = document.getElementById('photoWeight').value;
            const selectedDate = document.getElementById('photoDatePicker').value;
            
            // Use selected date or today
            const photoDate = selectedDate ? new Date(selectedDate + 'T12:00:00') : new Date();
            
            const photo = {
                id: Date.now(),
                bodyPart: bodyPart,
                date: photoDate.toISOString(),
                image: appState.tempPhoto,
                weight: weight ? parseFloat(weight) : null
            };
            
            appState.progressPhotos.push(photo);
            delete appState.tempPhoto;
            
            saveData();
            updateStorageIndicator();
            
            closeProgressUpload();
            renderProgressTimeline();
            
            showNotification('Progress photo saved! ', 'success');
            
            // Check if we should trigger slideshow
            checkForAutoSlideshow();
            
            // Unlock achievement
            if (appState.progressPhotos.length === 1) {
                unlockAchievement(4);
            }
        }

        // Auto Slideshow Trigger
        function checkForAutoSlideshow() {
            const totalPhotos = appState.progressPhotos.length;
            
            // Trigger after 5 photos OR 5+ weeks of photos
            if (totalPhotos >= 5) {
                const sortedPhotos = appState.progressPhotos.sort((a, b) => 
                    new Date(a.date) - new Date(b.date)
                );
                
                const firstPhoto = new Date(sortedPhotos[0].date);
                const lastPhoto = new Date(sortedPhotos[sortedPhotos.length - 1].date);
                const daysDiff = Math.floor((lastPhoto - firstPhoto) / (1000 * 60 * 60 * 24));
                const weeksDiff = Math.floor(daysDiff / 7);
                
                // Check if we haven't shown slideshow yet for this milestone
                if (!appState.user.slideshowShown || appState.user.lastSlideshowCount < totalPhotos) {
                    if (weeksDiff >= 5 || totalPhotos >= 5) {
                        setTimeout(() => {
                            showAutoSlideshow(weeksDiff, totalPhotos);
                        }, 1000);
                    }
                }
            }
        }

        function showAutoSlideshow(weeks, photos) {
            const modal = document.getElementById('customModal');
            const content = document.getElementById('modalContent');
            
            content.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 80px; margin-bottom: 20px;"></div>
                    <h2 style="margin-bottom: 15px;">Transformation Milestone!</h2>
                    <p style="font-size: 18px; color: var(--text-light); margin-bottom: 30px;">
                        You've captured <strong>${photos} progress photos</strong> over <strong>${weeks} weeks</strong>!<br>
                        Ready to see your transformation journey?
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <button class="btn" onclick="closeModal()" style="padding: 20px;">
                            Later
                        </button>
                        <button class="btn btn-primary" onclick="viewSlideshow(); closeModal();" style="padding: 20px;">
                             View Slideshow
                        </button>
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
            
            // Mark that we've shown this milestone
            appState.user.slideshowShown = true;
            appState.user.lastSlideshowCount = photos;
            saveData();
        }

        // Display username for friend adding (replaces old friend code display)
        function generateFriendCode() {
            // Now displays username instead of friend code
            const friendCodeEl = document.getElementById('friendCode');
            if (friendCodeEl) {
                if (currentUser && appState.user.username) {
                    friendCodeEl.textContent = appState.user.username;
                } else if (currentUser && appState.user.name) {
                    friendCodeEl.textContent = appState.user.name;
                } else if (!currentUser) {
                    friendCodeEl.textContent = 'Login to see your username';
                } else {
                    friendCodeEl.textContent = 'Set a username in settings';
                }
            }
            
            // Also update header display
            const friendCodeHeader = document.getElementById('friendCodeHeader');
            if (friendCodeHeader) {
                if (currentUser && appState.user.username) {
                    friendCodeHeader.textContent = appState.user.username;
                } else if (currentUser && appState.user.name) {
                    friendCodeHeader.textContent = appState.user.name;
                } else if (!currentUser) {
                    friendCodeHeader.textContent = 'Login';
                } else {
                    friendCodeHeader.textContent = 'Set username';
                }
            }
        }

        // Switch between Friends tabs (Discord-style)
        function switchFriendsTab(tab) {
            // Hide all content
            const allContent = document.getElementById('friendsContentAll');
            const pendingContent = document.getElementById('friendsContentPending');
            const addContent = document.getElementById('friendsContentAdd');
            
            if (allContent) allContent.style.display = 'none';
            if (pendingContent) pendingContent.style.display = 'none';
            if (addContent) addContent.style.display = 'none';
            
            // Remove active class from all tabs
            document.querySelectorAll('.friends-tab').forEach(t => t.classList.remove('active'));
            
            // Show selected tab and activate button
            if (tab === 'all') {
                if (allContent) allContent.style.display = 'block';
                document.getElementById('friendsTabAll')?.classList.add('active');
            } else if (tab === 'pending') {
                if (pendingContent) pendingContent.style.display = 'block';
                document.getElementById('friendsTabPending')?.classList.add('active');
            } else if (tab === 'add') {
                if (addContent) addContent.style.display = 'block';
                document.getElementById('friendsTabAdd')?.classList.add('active');
            }
        }
        window.switchFriendsTab = switchFriendsTab;

        // Add friend - uses friend request system if logged in
        async function addFriend() {
            if (currentUser) {
                // Use FriendsManager for friend request system
                if (typeof friendsManager !== 'undefined' && friendsManager.sendFriendRequest) {
                    const input = document.getElementById('addFriendInput');
                    const username = input ? input.value.trim() : '';
                    
                    if (!username) {
                        showNotification('Please enter a username', 'warning');
                        return;
                    }
                    
                    // Show loading state
                    const btn = event?.target;
                    const originalText = btn?.textContent;
                    if (btn) {
                        btn.textContent = 'Searching...';
                        btn.disabled = true;
                    }
                    
                    try {
                        console.log(' Attempting to add friend with username:', username);
                        await friendsManager.sendFriendRequest(username);
                        input.value = '';
                    } catch (error) {
                        console.error('Error sending friend request:', error);
                        showNotification('Error: ' + error.message, 'warning');
                    } finally {
                        if (btn) {
                            btn.textContent = originalText || 'Send Request';
                            btn.disabled = false;
                        }
                    }
                } else {
                    console.log('FriendsManager not available, using fallback');
                    // Fallback to direct add
                    addFriendByCode();
                }
            } else {
                // Require login to add friends
                showNotification('Please login to add friends with real people! ', 'warning');
                openAuthModal();
            }
        }

        // Render friends list
        function renderFriendsList() {
            const container = document.getElementById('friendsList');
            const emptyState = document.getElementById('emptyFriendsState');
            const friendsCount = document.getElementById('friendsCount');
            
            // Update friends count
            if (friendsCount) {
                friendsCount.textContent = appState.friends.length;
            }
            
            if (appState.friends.length === 0) {
                if (container) container.innerHTML = '';
                if (emptyState) emptyState.style.display = 'block';
                return;
            }

            if (emptyState) emptyState.style.display = 'none';
            
            container.innerHTML = appState.friends.map(friend => {
                const weightLoss = friend.startWeight && friend.currentWeight ? 
                    friend.startWeight - friend.currentWeight : 0;
                
                // Use displayName from Firebase, fallback to name or email
                const displayName = friend.displayName || friend.name || friend.email || 'Friend';
                const level = friend.level || 1;
                const streak = friend.streak || 0;
                const totalWorkouts = friend.totalWorkouts || 0;
                const username = friend.username || '';
                
                return `
                    <div class="friend-card" style="margin-bottom: 15px;">
                        <div style="width: 100%;">
                            <div class="friend-info">
                                <div class="user-avatar">${displayName.charAt(0).toUpperCase()}</div>
                                <div style="flex: 1;">
                                    <div class="user-name">${displayName}</div>
                                    ${username ? `<div style="color: var(--text-light); font-size: 13px; margin-top: 2px;">@${username}</div>` : ''}
                                    <div class="user-stats" style="margin-top: 8px;">
                                        <span> Level ${level}</span>
                                        <span> ${streak} day streak</span>
                                        <span> ${totalWorkouts} workouts</span>
                                    </div>
                                </div>
                                <button class="btn" onclick="viewFriendProgress('${friend.uid}')" style="font-size: 14px; padding: 8px 16px;">
                                    View Progress
                                </button>
                            </div>
                            ${weightLoss > 0 ? `
                                <div style="margin-top: 15px; padding: 12px; background: var(--secondary); color: white; border-radius: 8px; text-align: center;">
                                    <strong> ${weightLoss} lbs lost!</strong>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // View friend's detailed progress
        function viewFriendProgress(friendUid) {
            const friend = appState.friends.find(f => f.uid === friendUid || f.friendCode === friendUid);
            if (!friend) return;

            const modal = document.getElementById('customModal');
            const content = document.getElementById('modalContent');
            
            const weightLoss = friend.startWeight && friend.currentWeight ? 
                friend.startWeight - friend.currentWeight : 0;
            
            // Use displayName from Firebase, fallback to name or email
            const displayName = friend.displayName || friend.name || friend.email || 'Friend';
            const level = friend.level || 1;
            const streak = friend.streak || 0;
            const totalWorkouts = friend.totalWorkouts || 0;
            const xp = friend.xp || 0;
            const username = friend.username || '';
            
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div class="user-avatar" style="width: 100px; height: 100px; font-size: 48px; margin: 0 auto 15px;">
                        ${displayName.charAt(0).toUpperCase()}
                    </div>
                    <h2>${displayName}</h2>
                    <p style="color: var(--text-light);">Level ${level}${username ? '  @' + username : ''}</p>
                </div>

                <div class="progress-grid">
                    <div class="progress-item" style="background: #f9fafb; padding: 20px; border-radius: 12px;">
                        <div style="font-size: 32px; font-weight: bold; color: var(--primary);">${streak}</div>
                        <div style="color: var(--text-light); margin-top: 5px;">Day Streak </div>
                    </div>
                    <div class="progress-item" style="background: #f9fafb; padding: 20px; border-radius: 12px;">
                        <div style="font-size: 32px; font-weight: bold; color: var(--primary);">${totalWorkouts}</div>
                        <div style="color: var(--text-light); margin-top: 5px;">Total Workouts</div>
                    </div>
                    <div class="progress-item" style="background: #f9fafb; padding: 20px; border-radius: 12px;">
                        <div style="font-size: 32px; font-weight: bold; color: var(--primary);">${xp}</div>
                        <div style="color: var(--text-light); margin-top: 5px;">Total XP</div>
                    </div>
                    <div class="progress-item" style="background: #f9fafb; padding: 20px; border-radius: 12px;">
                        <div style="font-size: 32px; font-weight: bold; color: ${weightLoss > 0 ? 'var(--secondary)' : 'var(--primary)'};">  
                            ${weightLoss > 0 ? `-${weightLoss}` : '--'}
                        </div>
                        <div style="color: var(--text-light); margin-top: 5px;">Weight Loss (lbs)</div>
                    </div>
                </div>

                <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border-radius: 12px; text-align: center;">
                    <strong> Real data from ${displayName}'s actual workouts!</strong>
                </div>
            `;            modal.classList.add('active');
        }

        // Show different leaderboards
        function showLeaderboard(type) {
            appState.currentLeaderboard = type;
            
            // Update button states
            document.getElementById('friendsLeaderboardBtn').style.background = type === 'friends' ? 'var(--primary)' : '';
            document.getElementById('friendsLeaderboardBtn').style.color = type === 'friends' ? 'white' : '';
            document.getElementById('globalLeaderboardBtn').style.background = type === 'global' ? 'var(--primary)' : '';
            document.getElementById('globalLeaderboardBtn').style.color = type === 'global' ? 'white' : '';
            document.getElementById('streaksLeaderboardBtn').style.background = type === 'streaks' ? 'var(--primary)' : '';
            document.getElementById('streaksLeaderboardBtn').style.color = type === 'streaks' ? 'white' : '';
            
            renderLeaderboard();
        }

        // Render leaderboard
        function renderLeaderboard() {
            const container = document.getElementById('leaderboardContainer');
            let users = [];

            if (appState.currentLeaderboard === 'friends') {
                users = [...appState.friends, {
                    name: appState.user.name,
                    level: appState.user.level,
                    xp: appState.user.xp,
                    streak: appState.user.streak,
                    totalWorkouts: appState.user.totalWorkouts,
                    isCurrentUser: true
                }];
                users.sort((a, b) => b.xp - a.xp);
            } else if (appState.currentLeaderboard === 'global') {
                users = [...globalLeaderboard, {
                    name: appState.user.name,
                    level: appState.user.level,
                    xp: appState.user.xp,
                    streak: appState.user.streak,
                    totalWorkouts: appState.user.totalWorkouts,
                    isCurrentUser: true
                }];
                users.sort((a, b) => b.xp - a.xp);
            } else if (appState.currentLeaderboard === 'streaks') {
                users = [...appState.friends, {
                    name: appState.user.name,
                    level: appState.user.level,
                    xp: appState.user.xp,
                    streak: appState.user.streak,
                    totalWorkouts: appState.user.totalWorkouts,
                    isCurrentUser: true
                }];
                users.sort((a, b) => b.streak - a.streak);
            }

            if (users.length === 0 || (users.length === 1 && users[0].isCurrentUser)) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <h3>No rankings yet</h3>
                        <p>${appState.currentLeaderboard === 'friends' ? 'Add friends to see rankings!' : 'Keep working out to climb the ranks!'}</p>
                    </div>
                `;
                return;
            }

            const sortKey = appState.currentLeaderboard === 'streaks' ? 'streak' : 'xp';
            
            container.innerHTML = users.map((user, index) => {
                const rank = index + 1;
                const rankClass = rank <= 3 ? `rank-${rank}` : '';
                const rankEmoji = rank === 1 ? '' : rank === 2 ? '' : rank === 3 ? '' : rank;
                const highlightClass = user.isCurrentUser ? 'style="border: 3px solid var(--primary);"' : '';
                
                return `
                    <div class="leaderboard-item ${rankClass}" ${user.isCurrentUser ? highlightClass : ''}>
                        <div class="rank-badge">${rankEmoji}</div>
                        <div class="user-avatar">${user.name.charAt(0)}</div>
                        <div class="user-info">
                            <div class="user-name">
                                ${user.name}
                                ${user.isCurrentUser ? ' <span style="font-size: 14px; opacity: 0.8;">(You)</span>' : ''}
                            </div>
                            <div class="user-stats">
                                <span> Level ${user.level}</span>
                                <span> ${user.streak} days</span>
                                <span> ${user.totalWorkouts} workouts</span>
                            </div>
                        </div>
                        <div class="score-badge">
                            ${sortKey === 'streak' ? `${user.streak}` : `${user.xp} XP`}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render progress summary
        function renderProgressSummary() {
            const container = document.getElementById('progressSummary');
            
            const startWeight = appState.user.startWeight || appState.user.currentWeight;
            const currentWeight = appState.user.currentWeight;
            const weightLoss = startWeight && currentWeight ? startWeight - currentWeight : 0;
            
            const daysSinceStart = appState.user.startDate ? 
                Math.floor((new Date() - new Date(appState.user.startDate)) / (1000 * 60 * 60 * 24)) : 0;

            container.innerHTML = `
                <div class="progress-stat">
                    <div class="progress-stat-value">${appState.user.streak}</div>
                    <div class="progress-stat-label">Day Streak </div>
                </div>
                <div class="progress-stat">
                    <div class="progress-stat-value">${appState.user.totalWorkouts}</div>
                    <div class="progress-stat-label">Total Workouts</div>
                </div>
                <div class="progress-stat">
                    <div class="progress-stat-value">${appState.user.level}</div>
                    <div class="progress-stat-label">Level Reached</div>
                </div>
                <div class="progress-stat">
                    <div class="progress-stat-value" style="color: ${weightLoss > 0 ? 'var(--secondary)' : 'inherit'}">
                        ${weightLoss > 0 ? `-${weightLoss}` : '--'}
                    </div>
                    <div class="progress-stat-label">Weight Loss (lbs)</div>
                </div>
                ${daysSinceStart > 0 ? `
                    <div class="progress-stat">
                        <div class="progress-stat-value">${daysSinceStart}</div>
                        <div class="progress-stat-label">Days Training</div>
                    </div>
                ` : ''}
                <div class="progress-stat">
                    <div class="progress-stat-value">${appState.user.achievements.length}</div>
                    <div class="progress-stat-label">Achievements</div>
                </div>
            `;
        }

        // Share progress
        function shareProgress() {
            const modal = document.getElementById('customModal');
            const content = document.getElementById('modalContent');
            
            const startWeight = appState.user.startWeight || appState.user.currentWeight;
            const currentWeight = appState.user.currentWeight;
            const weightLoss = startWeight && currentWeight ? startWeight - currentWeight : 0;
            
            // Generate shareable image/text
            const shareText = ` My Evol Fitnessgress 

 Level ${appState.user.level}
 ${appState.user.streak} day streak
 ${appState.user.totalWorkouts} total workouts
${weightLoss > 0 ? ` ${weightLoss} lbs lost!` : ''}

Join me on FitQuest! Use my code: ${appState.user.friendCode}

#FitQuest #FitnessJourney #Transformation`;

            content.innerHTML = `
                <h2 style="margin-bottom: 20px;">Share Your Progress</h2>
                
                <div class="progress-share-card">
                    <h3 style="margin-bottom: 10px;"> ${appState.user.name}'s Journey</h3>
                    <div class="progress-grid">
                        <div class="progress-item">
                            <div class="progress-value">${appState.user.level}</div>
                            <div class="progress-label">Level</div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-value">${appState.user.streak}</div>
                            <div class="progress-label">Day Streak </div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-value">${appState.user.totalWorkouts}</div>
                            <div class="progress-label">Workouts</div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-value">${weightLoss > 0 ? `-${weightLoss}` : '--'}</div>
                            <div class="progress-label">Weight Lost</div>
                        </div>
                    </div>
                    <div style="margin-top: 20px; text-align: center; font-size: 14px;">
                        Friend Code: <strong>${appState.user.friendCode}</strong>
                    </div>
                </div>

                <div class="share-options">
                    <div class="share-option" onclick="shareToClipboard(\`${shareText.replace(/`/g, '\\`')}\`)">
                        <div class="share-icon"></div>
                        <strong>Copy Text</strong>
                    </div>
                    <div class="share-option" onclick="shareToSocial('twitter', \`${shareText.replace(/`/g, '\\`')}\`)">
                        <div class="share-icon"></div>
                        <strong>Twitter/X</strong>
                    </div>
                    <div class="share-option" onclick="shareToSocial('facebook', \`${shareText.replace(/`/g, '\\`')}\`)">
                        <div class="share-icon"></div>
                        <strong>Facebook</strong>
                    </div>
                    <div class="share-option" onclick="shareNative(\`${shareText.replace(/`/g, '\\`')}\`)">
                        <div class="share-icon"></div>
                        <strong>More Options</strong>
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
        }

        function shareToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('Progress copied to clipboard! ', 'success');
                closeModal();
            });
        }

        function shareToSocial(platform, text) {
            const encodedText = encodeURIComponent(text);
            let url = '';
            
            if (platform === 'twitter') {
                url = `https://twitter.com/intent/tweet?text=${encodedText}`;
            } else if (platform === 'facebook') {
                url = `https://www.facebook.com/sharer/sharer.php?quote=${encodedText}`;
            }
            
            window.open(url, '_blank', 'width=600,height=400');
            closeModal();
        }

        function shareNative(text) {
            if (navigator.share) {
                navigator.share({
                    title: 'My Evol Fitnessgress',
                    text: text
                }).then(() => {
                    showNotification('Progress shared! ', 'success');
                    closeModal();
                }).catch(() => {
                    // User cancelled
                });
            } else {
                shareToClipboard(text);
            }
        }

        // Render challenges
        function renderChallenges() {
            const container = document.getElementById('challengesList');
            
            if (appState.challenges.length === 0) {
                container.innerHTML = `
                    <p style="opacity: 0.9;">No active challenges. Create one to compete with friends!</p>
                `;
                return;
            }

            container.innerHTML = appState.challenges.map(challenge => {
                const progress = (challenge.currentValue / challenge.targetValue) * 100;
                const daysLeft = Math.ceil((new Date(challenge.endDate) - new Date()) / (1000 * 60 * 60 * 24));
                
                return `
                    <div class="challenge-card">
                        <h4>${challenge.name}</h4>
                        <p style="opacity: 0.9; margin: 10px 0;">
                            ${challenge.description}
                        </p>
                        <div style="display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 5px;">
                            <span>${challenge.currentValue} / ${challenge.targetValue}</span>
                            <span>${daysLeft} days left</span>
                        </div>
                        <div class="challenge-progress-bar">
                            <div class="challenge-progress-fill" style="width: ${Math.min(progress, 100)}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Create challenge
        function createChallenge() {
            const modal = document.getElementById('customModal');
            const content = document.getElementById('modalContent');
            
            content.innerHTML = `
                <h2 style="margin-bottom: 20px;">Create Challenge</h2>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">Challenge Type</label>
                    <select id="challengeType" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 16px;">
                        <option value="streak">Longest Streak</option>
                        <option value="workouts">Most Workouts</option>
                        <option value="xp">Most XP Earned</option>
                        <option value="weightloss">Most Weight Lost</option>
                    </select>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">Duration (days)</label>
                    <input type="number" id="challengeDuration" value="7" min="1" max="30" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 16px;">
                </div>

                <button class="btn btn-primary" onclick="saveChallengeAndClose()" style="width: 100%;">
                    Create Challenge
                </button>
            `;
            
            modal.classList.add('active');
        }

        function saveChallengeAndClose() {
            const type = document.getElementById('challengeType').value;
            const duration = parseInt(document.getElementById('challengeDuration').value);
            
            const challengeNames = {
                streak: 'Streak Master',
                workouts: 'Workout Warrior',
                xp: 'XP Champion',
                weightloss: 'Transformation Challenge'
            };
            
            const challengeDescriptions = {
                streak: 'Who can maintain the longest workout streak?',
                workouts: 'Who can complete the most workouts?',
                xp: 'Who can earn the most XP?',
                weightloss: 'Who can lose the most weight?'
            };
            
            // Generate unique invite code
            const inviteCode = 'CH-' + Math.random().toString(36).substring(2, 8).toUpperCase();
            
            const challenge = {
                name: challengeNames[type],
                description: challengeDescriptions[type],
                type: type,
                inviteCode: inviteCode,
                startDate: new Date().toISOString(),
                endDate: new Date(Date.now() + duration * 24 * 60 * 60 * 1000).toISOString(),
                currentValue: 0,
                targetValue: type === 'streak' ? duration : type === 'workouts' ? duration * 2 : 500,
                participants: currentUser ? [currentUser.uid] : [],
                createdBy: currentUser ? currentUser.uid : null
            };
            
            appState.challenges.push(challenge);
            
            // Save to Firestore if logged in
            if (currentUser) {
                saveChallengesToFirebase(currentUser.uid).then(() => {
                    renderChallenges();
                    showNotification(`Challenge created! Share invite code: ${inviteCode} `, 'success');
                });
            } else {
                saveData();
                renderChallenges();
                showNotification('Challenge created!  Login to share with friends!', 'success');
            }
            
            closeModal();
        }

        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // Add viewport meta tag fix for iOS
        if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
            const meta = document.querySelector('meta[name="viewport"]');
            if (meta) {
                meta.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
            }
        }

        // Settings Functions

        // Connect Apple Watch via Bluetooth (HONEST implementation)
        function connectAppleWatchBluetooth() {
            const btn = document.getElementById('appleWatchBtn');
            const status = document.getElementById('appleWatchStatus');
            
            if (!navigator.bluetooth) {
                status.style.display = 'block';
                status.innerHTML = `
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px;">
                        <strong> Bluetooth Not Available</strong>
                        <p style="margin-top: 8px; font-size: 14px;">
                            Web Bluetooth API is not supported in this browser. Requirements:
                        </p>
                        <ul style="margin-top: 8px; padding-left: 20px; font-size: 13px;">
                            <li>Use Chrome, Edge, or Opera browser</li>
                            <li>Must be on HTTPS (secure connection)</li>
                            <li>Not supported in Safari or Firefox</li>
                        </ul>
                    </div>
                `;
                showNotification('Bluetooth not supported in this browser', 'warning');
                return;
            }

            btn.disabled = true;
            btn.textContent = ' Searching for devices...';
            
            // Request Bluetooth device with heart rate service
            navigator.bluetooth.requestDevice({
                filters: [
                    { services: ['heart_rate'] }
                ],
                optionalServices: ['battery_service', 'device_information']
            })
            .then(device => {
                appState.user.appleWatchConnected = true;
                appState.user.connectedWatchName = device.name;
                saveData();
                
                status.style.display = 'block';
                status.innerHTML = `
                    <div class="connected-badge"> Connected to ${device.name}</div>
                    <p style="color: var(--text-light); margin-top: 10px; font-size: 14px;">
                        Heart rate monitoring active during workouts
                    </p>
                `;
                btn.style.display = 'none';
                showNotification(`Connected to ${device.name}! `, 'success');
            })
            .catch(error => {
                btn.disabled = false;
                btn.textContent = ' Connect via Bluetooth';
                
                if (error.name === 'NotFoundError') {
                    showNotification('No device selected', 'info');
                } else {
                    status.style.display = 'block';
                    status.innerHTML = `
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; font-size: 13px;">
                            <strong>Connection Failed</strong>
                            <p style="margin-top: 8px;">
                                Make sure your watch is:
                            </p>
                            <ul style="margin-top: 5px; padding-left: 20px;">
                                <li>Turned on and nearby</li>
                                <li>Bluetooth enabled</li>
                                <li>Not already connected to another device</li>
                            </ul>
                        </div>
                    `;
                    showNotification('Bluetooth connection failed', 'warning');
                    console.error('Bluetooth error:', error);
                }
            });
        }

        // Music Integration Functions

        function saveSpotifyPlaylist() {
            const input = document.getElementById('spotifyPlaylistInput');
            const url = input.value.trim();
            const status = document.getElementById('spotifyStatus');
            
            if (!url) {
                showNotification('Please enter a Spotify playlist URL', 'warning');
                return;
            }
            
            // Validate Spotify URL
            if (!url.includes('spotify.com') && !url.includes('open.spotify')) {
                showNotification('Please enter a valid Spotify URL', 'warning');
                return;
            }
            
            appState.user.spotifyPlaylist = url;
            saveData();
            
            status.style.display = 'block';
            status.innerHTML = `
                <div class="connected-badge"> Spotify Playlist Saved</div>
                <p style="color: var(--text-light); margin-top: 8px; font-size: 14px;">
                    Music will be available during workouts
                </p>
            `;
            
            showNotification('Spotify playlist saved! ', 'success');
        }

        function saveAppleMusicPlaylist() {
            const input = document.getElementById('appleMusicPlaylistInput');
            const url = input.value.trim();
            const status = document.getElementById('appleMusicStatus');
            
            if (!url) {
                showNotification('Please enter an Apple Music playlist URL', 'warning');
                return;
            }
            
            // Validate Apple Music URL
            if (!url.includes('music.apple.com')) {
                showNotification('Please enter a valid Apple Music URL', 'warning');
                return;
            }
            
            appState.user.appleMusicPlaylist = url;
            saveData();
            
            status.style.display = 'block';
            status.innerHTML = `
                <div class="connected-badge"> Apple Music Playlist Saved</div>
                <p style="color: var(--text-light); margin-top: 8px; font-size: 14px;">
                    Music will be available during workouts
                </p>
            `;
            
            showNotification('Apple Music playlist saved! ', 'success');
        }

        function saveYoutubePlaylist() {
            const input = document.getElementById('youtubePlaylistInput');
            const url = input.value.trim();
            const status = document.getElementById('youtubeStatus');
            
            if (!url) {
                showNotification('Please enter a YouTube playlist URL', 'warning');
                return;
            }
            
            // Validate YouTube URL
            if (!url.includes('youtube.com') && !url.includes('youtu.be')) {
                showNotification('Please enter a valid YouTube URL', 'warning');
                return;
            }
            
            appState.user.youtubePlaylist = url;
            saveData();
            
            status.style.display = 'block';
            status.innerHTML = `
                <div class="connected-badge"> YouTube Playlist Saved</div>
                <p style="color: var(--text-light); margin-top: 8px; font-size: 14px;">
                    Music will be available during workouts
                </p>
            `;
            
            showNotification('YouTube playlist saved! ', 'success');
        }

        // ==========================================
        // YOUTUBE & SPOTIFY API INTEGRATION
        // ==========================================
        
        // YouTube API Key Management
        function saveYouTubeApiKey() {
            const input = document.getElementById('youtubeApiKeyInput');
            const key = input.value.trim();
            const status = document.getElementById('youtubeApiStatus');
            const testBtn = document.getElementById('testYouTubeBtn');
            
            if (!key) {
                showNotification('Please enter your YouTube API key', 'warning');
                return;
            }
            
            if (key.length < 30) {
                showNotification('API key seems too short. Please check it.', 'warning');
                return;
            }
            
            // Save to localStorage
            localStorage.setItem('youtube_api_key', key);
            appState.user.youtubeApiKey = key;
            saveData();
            
            status.style.display = 'block';
            status.innerHTML = `
                <div class="connected-badge"> YouTube API Connected</div>
                <p style="color: var(--text-light); margin-top: 8px; font-size: 14px;">
                    You can now search YouTube music! Try the test button.
                </p>
            `;
            testBtn.style.display = 'inline-block';
            showNotification('YouTube API connected! ', 'success');
        }

        function toggleYouTubeKeyVisibility() {
            const input = document.getElementById('youtubeApiKeyInput');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        async function testYouTubeAPI() {
            const apiKey = localStorage.getItem('youtube_api_key') || 'AIzaSyAtTsnqvnVajLBFyP69xqcD2EJC7h9nV1Q';
            if (!apiKey) {
                showNotification('No API key configured', 'warning');
                return;
            }

            const status = document.getElementById('youtubeApiStatus');
            status.innerHTML = '<div style="padding: 10px; background: #e3f2fd; border-radius: 6px;"> Testing YouTube API...</div>';

            try {
                const response = await fetch(
                    `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&videoCategoryId=10&maxResults=1&q=workout music&key=${apiKey}`
                );
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.items && data.items.length > 0) {
                    status.innerHTML = `
                        <div class="connected-badge"> YouTube API Working!</div>
                        <p style="color: var(--text-light); margin-top: 8px; font-size: 13px;">
                            Test search returned: "${data.items[0].snippet.title}"
                        </p>
                    `;
                    showNotification('YouTube API test successful! ', 'success');
                } else {
                    status.innerHTML = '<div style="padding: 10px; background: #fff3cd; border-radius: 6px;"> API works but no results found</div>';
                }
            } catch (error) {
                status.innerHTML = `
                    <div style="padding: 10px; background: #fee; border-radius: 6px; color: #c00;">
                         Test failed: ${error.message}
                        <br><small>Check your API key and make sure YouTube Data API v3 is enabled</small>
                    </div>
                `;
                showNotification('YouTube API test failed', 'warning');
            }
        }

        // Spotify API Key Management
        function saveSpotifyApiKeys() {
            const clientIdInput = document.getElementById('spotifyClientIdInput');
            const clientSecretInput = document.getElementById('spotifyClientSecretInput');
            const clientId = clientIdInput.value.trim();
            const clientSecret = clientSecretInput.value.trim();
            const status = document.getElementById('spotifyApiStatus');
            const testBtn = document.getElementById('testSpotifyBtn');
            
            if (!clientId || !clientSecret) {
                showNotification('Please enter both Client ID and Client Secret', 'warning');
                return;
            }
            
            // Save to localStorage
            localStorage.setItem('spotify_client_id', clientId);
            localStorage.setItem('spotify_client_secret', clientSecret);
            appState.user.spotifyClientId = clientId;
            appState.user.spotifyClientSecret = clientSecret;
            saveData();
            
            status.style.display = 'block';
            status.innerHTML = `
                <div class="connected-badge"> Spotify API Connected</div>
                <p style="color: var(--text-light); margin-top: 8px; font-size: 14px;">
                    You can now search Spotify's music library! Try the test button.
                </p>
            `;
            testBtn.style.display = 'inline-block';
            showNotification('Spotify API connected! ', 'success');
        }

        function toggleSpotifyKeysVisibility() {
            const clientIdInput = document.getElementById('spotifyClientIdInput');
            const clientSecretInput = document.getElementById('spotifyClientSecretInput');
            const newType = clientIdInput.type === 'password' ? 'text' : 'password';
            clientIdInput.type = newType;
            clientSecretInput.type = newType;
        }

        async function getSpotifyAccessToken() {
            // Use user's keys if available, otherwise use default keys for free access
            const clientId = localStorage.getItem('spotify_client_id') || '836517f7831341f3a342af90f5c1390e';
            const clientSecret = localStorage.getItem('spotify_client_secret') || '07f314daeaad4525bbad0cbe3901487a';
            
            if (!clientId || !clientSecret) {
                return null;
            }

            try {
                const response = await fetch('https://accounts.spotify.com/api/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Authorization': 'Basic ' + btoa(clientId + ':' + clientSecret)
                    },
                    body: 'grant_type=client_credentials'
                });

                if (!response.ok) {
                    throw new Error('Failed to get access token');
                }

                const data = await response.json();
                return data.access_token;
            } catch (error) {
                console.error('Spotify auth error:', error);
                return null;
            }
        }

        async function testSpotifyAPI() {
            const status = document.getElementById('spotifyApiStatus');
            status.innerHTML = '<div style="padding: 10px; background: #e8f5e9; border-radius: 6px;"> Testing Spotify API...</div>';

            try {
                const accessToken = await getSpotifyAccessToken();
                
                if (!accessToken) {
                    throw new Error('Failed to get access token');
                }

                const response = await fetch(
                    'https://api.spotify.com/v1/search?q=workout&type=track&limit=1',
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();

                if (data.tracks && data.tracks.items.length > 0) {
                    const track = data.tracks.items[0];
                    status.innerHTML = `
                        <div class="connected-badge"> Spotify API Working!</div>
                        <p style="color: var(--text-light); margin-top: 8px; font-size: 13px;">
                            Test search returned: "${track.name}" by ${track.artists[0].name}
                        </p>
                    `;
                    showNotification('Spotify API test successful! ', 'success');
                } else {
                    status.innerHTML = '<div style="padding: 10px; background: #fff3cd; border-radius: 6px;"> API works but no results found</div>';
                }
            } catch (error) {
                status.innerHTML = `
                    <div style="padding: 10px; background: #fee; border-radius: 6px; color: #c00;">
                         Test failed: ${error.message}
                        <br><small>Check your Client ID and Client Secret</small>
                    </div>
                `;
                showNotification('Spotify API test failed', 'warning');
            }
        }

        // Load saved API keys on startup
        function loadMusicAPIKeys() {
            // Default API keys are built-in - users can use music features for FREE!
            const youtubeKey = localStorage.getItem('youtube_api_key') || 'AIzaSyAtTsnqvnVajLBFyP69xqcD2EJC7h9nV1Q';
            const spotifyClientId = localStorage.getItem('spotify_client_id') || '836517f7831341f3a342af90f5c1390e';
            const spotifyClientSecret = localStorage.getItem('spotify_client_secret') || '07f314daeaad4525bbad0cbe3901487a';
            
            // Always show as connected since we have default keys
            const youtubeStatus = document.getElementById('youtubeApiStatus');
            const youtubeTestBtn = document.getElementById('testYouTubeBtn');
            if (youtubeStatus) {
                youtubeStatus.style.display = 'block';
                const isDefault = !localStorage.getItem('youtube_api_key');
                youtubeStatus.innerHTML = isDefault ? 
                    '<div class="connected-badge"> YouTube Music Ready (Using Shared API)</div>' :
                    '<div class="connected-badge"> YouTube API Connected (Your Key)</div>';
            }
            if (youtubeTestBtn) youtubeTestBtn.style.display = 'inline-block';

            const spotifyStatus = document.getElementById('spotifyApiStatus');
            const spotifyTestBtn = document.getElementById('testSpotifyBtn');
            if (spotifyStatus) {
                spotifyStatus.style.display = 'block';
                const isDefault = !localStorage.getItem('spotify_client_id');
                spotifyStatus.innerHTML = isDefault ?
                    '<div class="connected-badge"> Spotify Ready (Using Shared API)</div>' :
                    '<div class="connected-badge"> Spotify API Connected (Your Key)</div>';
            }
            if (spotifyTestBtn) spotifyTestBtn.style.display = 'inline-block';
            
            appState.user.youtubeApiKey = youtubeKey;
            appState.user.spotifyClientId = spotifyClientId;
            appState.user.spotifyClientSecret = spotifyClientSecret;
        }

        // Open music during workout
        function openWorkoutMusic() {
            const playlists = [];
            
            if (appState.user.spotifyPlaylist) {
                playlists.push({ name: 'Spotify', url: appState.user.spotifyPlaylist, icon: '' });
            }
            if (appState.user.appleMusicPlaylist) {
                playlists.push({ name: 'Apple Music', url: appState.user.appleMusicPlaylist, icon: '' });
            }
            if (appState.user.youtubePlaylist) {
                playlists.push({ name: 'YouTube', url: appState.user.youtubePlaylist, icon: '' });
            }
            
            if (playlists.length === 0) {
                showNotification('No playlists configured. Add one in Settings!', 'info');
                return;
            }
            
            if (playlists.length === 1) {
                window.open(playlists[0].url, '_blank');
                showNotification(`Opening ${playlists[0].name}...`, 'success');
            } else {
                // Show choice modal
                const modal = document.getElementById('customModal');
                const content = document.getElementById('modalContent');
                
                content.innerHTML = `
                    <h2 style="margin-bottom: 20px;"> Choose Your Music</h2>
                    <div style="display: grid; gap: 15px;">
                        ${playlists.map(playlist => `
                            <button 
                                class="btn btn-primary" 
                                onclick="window.open('${playlist.url}', '_blank'); closeModal();"
                                style="width: 100%; padding: 20px; font-size: 18px;"
                            >
                                ${playlist.icon} Open ${playlist.name}
                            </button>
                        `).join('')}
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 15px;">
                        Cancel
                    </button>
                `;
                
                modal.classList.add('active');
            }
        }

        // Connect Bluetooth Device
        function connectBluetoothDevice() {
            const btn = document.getElementById('bluetoothBtn');
            const status = document.getElementById('bluetoothStatus');
            
            if (!navigator.bluetooth) {
                showNotification('Bluetooth not supported on this browser', 'warning');
                status.style.display = 'block';
                status.innerHTML = '<p style="color: var(--danger); margin-top: 10px;">Bluetooth Web API not supported. Try Chrome on Android or enable flags.</p>';
                return;
            }

            btn.disabled = true;
            btn.textContent = ' Searching for devices...';
            
            navigator.bluetooth.requestDevice({
                acceptAllDevices: true,
                optionalServices: ['heart_rate', 'battery_service']
            })
            .then(device => {
                appState.user.bluetoothDevice = {
                    name: device.name,
                    id: device.id
                };
                status.style.display = 'block';
                status.innerHTML = `<div class="connected-badge"> Connected to ${device.name}</div><p style="color: var(--text-light); margin-top: 10px; font-size: 14px;">Syncing fitness data</p>`;
                btn.style.display = 'none';
                showNotification(`Connected to ${device.name}! `, 'success');
                saveData();
            })
            .catch(error => {
                btn.disabled = false;
                btn.textContent = ' Connect via Bluetooth';
                if (error.name === 'NotFoundError') {
                    showNotification('No device selected', 'info');
                } else {
                    showNotification('Bluetooth connection failed', 'warning');
                    console.error('Bluetooth error:', error);
                }
            });
        }

        // Connect Google Account (HONEST - requires OAuth setup)
        function connectGoogle() {
            const btn = document.getElementById('googleBtn');
            const status = document.getElementById('googleStatus');
            
            status.style.display = 'block';
            status.innerHTML = `
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px;">
                    <strong> Google Drive Integration Not Available</strong>
                    <p style="margin-top: 8px; font-size: 14px;">
                        Google Drive sync requires OAuth 2.0 authentication which needs:
                    </p>
                    <ul style="margin-top: 8px; padding-left: 20px; font-size: 13px;">
                        <li>Backend server for secure token storage</li>
                        <li>Google Cloud Project with Drive API enabled</li>
                        <li>OAuth 2.0 client credentials</li>
                        <li>Redirect URI configuration</li>
                    </ul>
                    <p style="margin-top: 10px; font-size: 14px;">
                        <strong>Alternative:</strong> Use the "Export Data" feature below to manually backup your data as a JSON file.
                    </p>
                </div>
            `;
            
            showNotification('Google Drive requires OAuth setup. Use Export Data instead!', 'info');
        }

        // Setup Email Backup (HONEST - just saves email for future use)
        function setupEmailBackup() {
            const emailInput = document.getElementById('emailInput');
            const status = document.getElementById('emailStatus');
            const email = emailInput.value.trim();
            
            if (!email) {
                showNotification('Please enter your email address', 'warning');
                return;
            }
            
            // Basic email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showNotification('Please enter a valid email address', 'warning');
                return;
            }
            
            appState.user.backupEmail = email;
            saveData();
            
            status.style.display = 'block';
            status.innerHTML = `
                <div class="connected-badge"> Email Saved</div>
                <p style="color: var(--text-light); margin-top: 10px; font-size: 14px;">
                    Your email (${email}) is saved for future email report features. 
                    No emails will be sent until backend server is configured.
                </p>
            `;
            emailInput.disabled = true;
            
            showNotification('Email saved for future reports! ', 'success');
        }

        // Toggle Notifications
        function toggleNotifications() {
            const toggle = document.getElementById('notificationToggle');
            appState.user.notificationsEnabled = toggle.checked;
            saveData();
            
            if (toggle.checked) {
                requestNotificationPermission();
            } else {
                showNotification('Daily reminders disabled', 'info');
            }
        }

        // Toggle Weekly Reports
        function toggleWeeklyReports() {
            const toggle = document.getElementById('weeklyReportToggle');
            appState.user.weeklyReports = toggle.checked;
            saveData();
            
            showNotification(toggle.checked ? 'Weekly reports enabled ' : 'Weekly reports disabled', 'info');
        }

        // Toggle Friend Activity
        function toggleFriendActivity() {
            const toggle = document.getElementById('friendActivityToggle');
            appState.user.friendActivity = toggle.checked;
            saveData();
            
            showNotification(toggle.checked ? 'Friend activity notifications enabled ' : 'Friend activity notifications disabled', 'info');
        }

        // Export Data
        function exportData() {
            const dataStr = JSON.stringify(appState, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `fitquest-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            showNotification('Data exported successfully! ', 'success');
        }

        // Import Data
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        
                        // Validate the data structure
                        if (importedData.user && importedData.todayExercises) {
                            if (confirm('This will replace all your current data. Are you sure?')) {
                                appState = importedData;
                                saveData();
                                updateUI();
                                showNotification('Data imported successfully! ', 'success');
                                location.reload(); // Refresh to show imported data
                            }
                        } else {
                            showNotification('Invalid backup file format', 'warning');
                        }
                    } catch (error) {
                        showNotification('Failed to import data. Invalid file.', 'warning');
                        console.error('Import error:', error);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // Clear Cache
        function clearCache() {
            if (confirm('This will clear temporary data but keep your progress. Continue?')) {
                // Clear service worker cache if available
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => caches.delete(name));
                    });
                }
                showNotification('Cache cleared! ', 'success');
            }
        }

        // Reset App
        function resetApp() {
            const confirmation = prompt(' WARNING: This will delete ALL your data permanently. Type "DELETE" to confirm:');
            
            if (confirmation === 'DELETE') {
                localStorage.clear();
                showNotification('All data has been reset. Refreshing app...', 'warning');
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else if (confirmation !== null) {
                showNotification('Reset cancelled - incorrect confirmation', 'info');
            }
        }

        // Load settings on page load
        function loadSettings() {
            if (appState.user.notificationsEnabled) {
                document.getElementById('notificationToggle').checked = true;
            }
            if (appState.user.weeklyReports !== false) {
                document.getElementById('weeklyReportToggle').checked = true;
            }
            if (appState.user.friendActivity) {
                document.getElementById('friendActivityToggle').checked = true;
            }
            if (appState.user.backupEmail) {
                document.getElementById('emailInput').value = appState.user.backupEmail;
                document.getElementById('emailInput').disabled = true;
                document.getElementById('emailStatus').style.display = 'block';
                document.getElementById('emailStatus').innerHTML = `<div class="connected-badge"> Email Backup Active</div>`;
            }
            if (appState.user.appleWatchConnected) {
                document.getElementById('appleWatchBtn').style.display = 'none';
                document.getElementById('appleWatchStatus').style.display = 'block';
                document.getElementById('appleWatchStatus').innerHTML = '<div class="connected-badge"> Connected to Apple Watch</div>';
            }
            if (appState.user.googleConnected) {
                document.getElementById('googleBtn').style.display = 'none';
                document.getElementById('googleStatus').style.display = 'block';
                document.getElementById('googleStatus').innerHTML = '<div class="connected-badge"> Connected to Google Drive</div>';
            }
            if (appState.user.bluetoothDevice) {
                document.getElementById('bluetoothBtn').style.display = 'none';
                document.getElementById('bluetoothStatus').style.display = 'block';
                document.getElementById('bluetoothStatus').innerHTML = `<div class="connected-badge"> Connected to ${appState.user.bluetoothDevice.name}</div>`;
            }
            
            // Load background theme
            if (appState.user.backgroundTheme) {
                applyBackgroundTheme(appState.user.backgroundTheme);
            }
            if (appState.user.customBackground) {
                applyCustomBackground(appState.user.customBackground);
                document.getElementById('removeBackgroundBtn').style.display = 'inline-block';
                document.getElementById('backgroundPreview').style.display = 'block';
                document.getElementById('backgroundPreviewImage').src = appState.user.customBackground;
            }
            if (appState.user.backgroundOpacity !== undefined) {
                document.getElementById('opacitySlider').value = appState.user.backgroundOpacity;
                applyBackgroundOpacity(appState.user.backgroundOpacity);
            }
            
            // Load music playlists
            if (appState.user.spotifyPlaylist) {
                document.getElementById('spotifyPlaylistInput').value = appState.user.spotifyPlaylist;
                document.getElementById('spotifyStatus').style.display = 'block';
                document.getElementById('spotifyStatus').innerHTML = '<div class="connected-badge"> Spotify Playlist Saved</div>';
            }
            if (appState.user.appleMusicPlaylist) {
                document.getElementById('appleMusicPlaylistInput').value = appState.user.appleMusicPlaylist;
                document.getElementById('appleMusicStatus').style.display = 'block';
                document.getElementById('appleMusicStatus').innerHTML = '<div class="connected-badge"> Apple Music Playlist Saved</div>';
            }
            if (appState.user.youtubePlaylist) {
                document.getElementById('youtubePlaylistInput').value = appState.user.youtubePlaylist;
                document.getElementById('youtubeStatus').style.display = 'block';
                document.getElementById('youtubeStatus').innerHTML = '<div class="connected-badge"> YouTube Playlist Saved</div>';
            }
            
            // Load font and button sizes
            if (appState.user.fontSize) {
                document.getElementById('fontSizeSlider').value = appState.user.fontSize;
                adjustFontSize(appState.user.fontSize);
            }
            if (appState.user.buttonSize) {
                document.getElementById('buttonSizeSlider').value = appState.user.buttonSize;
                adjustButtonSize(appState.user.buttonSize);
            }
            
            // Load Gemini API key if saved
            if (appState.user.geminiApiKey) {
                geminiAI.apiKey = appState.user.geminiApiKey;
                if (document.getElementById('geminiApiKeyInput')) {
                    document.getElementById('geminiApiKeyInput').value = appState.user.geminiApiKey;
                    document.getElementById('geminiStatus').style.display = 'block';
                    document.getElementById('geminiStatus').innerHTML = '<div class="connected-badge"> Gemini AI Connected</div>';
                }
            }
            
            // Load Easy-Peasy AI settings
            if (appState.user.easyPeasyEnabled !== undefined) {
                easyPeasyAI.enabled = appState.user.easyPeasyEnabled;
                if (document.getElementById('easyPeasyToggle')) {
                    document.getElementById('easyPeasyToggle').checked = easyPeasyAI.enabled;
                    toggleEasyPeasyAI(easyPeasyAI.enabled);
                }
            } else {
                // Default to enabled
                appState.user.easyPeasyEnabled = true;
                easyPeasyAI.enabled = true;
            }
        }

        // Background Theme Functions
        const backgroundThemes = {
            default: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            ocean: 'linear-gradient(135deg, #2196F3 0%, #00BCD4 100%)',
            sunset: 'linear-gradient(135deg, #FF6B6B 0%, #FFE66D 100%)',
            forest: 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)',
            dark: 'linear-gradient(135deg, #232526 0%, #414345 100%)',
            fire: 'linear-gradient(135deg, #f12711 0%, #f5af19 100%)'
        };

        function setBackgroundTheme(theme) {
            appState.user.backgroundTheme = theme;
            appState.user.customBackground = null; // Clear custom background
            saveData();
            
            applyBackgroundTheme(theme);
            showNotification('Background theme updated! ', 'success');
            
            // Hide remove custom background button
            document.getElementById('removeBackgroundBtn').style.display = 'none';
            document.getElementById('backgroundPreview').style.display = 'none';
        }

        function applyBackgroundTheme(theme) {
            // Clear any custom background image first
            document.body.style.backgroundImage = '';
            document.body.style.backgroundSize = '';
            document.body.style.backgroundPosition = '';
            document.body.style.backgroundAttachment = '';
            document.body.style.backgroundRepeat = '';
            
            // Apply gradient theme
            document.body.style.background = backgroundThemes[theme] || backgroundThemes.default;
            
            // Update active theme indicator
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('active');
                if (option.dataset.theme === theme) {
                    option.classList.add('active');
                }
            });
        }

        // Custom Background Functions with Image Compression
        function uploadCustomBackground(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check if it's an image
            if (!file.type.match('image.*')) {
                showNotification('Please select an image file (JPG, PNG, GIF, WebP)', 'warning');
                event.target.value = '';
                return;
            }
            
            showNotification('Processing image... Please wait.', 'info');
            
            const reader = new FileReader();
            
            reader.onerror = function() {
                showNotification('Failed to read image file. Please try again.', 'warning');
                event.target.value = '';
            };
            
            reader.onload = function(e) {
                try {
                    const img = new Image();
                    
                    img.onload = function() {
                        // Compress image to fit in localStorage
                        compressImage(img, function(compressedDataUrl) {
                            if (!compressedDataUrl) {
                                showNotification('Failed to compress image. Try a smaller file.', 'warning');
                                event.target.value = '';
                                return;
                            }
                            
                            // Check if compressed image fits in storage
                            const sizeInMB = (compressedDataUrl.length * 0.75) / (1024 * 1024);
                            
                            if (sizeInMB > 3) {
                                showNotification(`Image still too large (${sizeInMB.toFixed(1)}MB). Please use a smaller image or lower resolution photo.`, 'warning');
                                event.target.value = '';
                                return;
                            }
                            
                            try {
                                appState.user.customBackground = compressedDataUrl;
                                appState.user.backgroundTheme = null;
                                saveData();
                                
                                applyCustomBackground(compressedDataUrl);
                                showNotification(`Background applied! (${sizeInMB.toFixed(1)}MB) `, 'success');
                                
                                document.getElementById('removeBackgroundBtn').style.display = 'inline-block';
                                document.getElementById('backgroundPreview').style.display = 'block';
                                document.getElementById('backgroundPreviewImage').src = compressedDataUrl;
                                
                                document.querySelectorAll('.theme-option').forEach(option => {
                                    option.classList.remove('active');
                                });
                            } catch (saveError) {
                                console.error('Save error:', saveError);
                                showNotification('Image too large for browser storage. Try a much smaller image.', 'warning');
                                event.target.value = '';
                            }
                        });
                    };
                    
                    img.onerror = function() {
                        showNotification('Failed to load image. Please try a different file.', 'warning');
                        event.target.value = '';
                    };
                    
                    img.src = e.target.result;
                    
                } catch (error) {
                    console.error('Background upload error:', error);
                    showNotification('Failed to process image. Please try again.', 'warning');
                    event.target.value = '';
                }
            };
            
            reader.readAsDataURL(file);
        }

        // Compress image to fit in storage - MAXIMUM COMPRESSION
        function compressImage(img, callback) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Calculate new dimensions (max 1280x720 for maximum storage)
            let width = img.width;
            let height = img.height;
            const maxWidth = 1280; // Reduced from 1920
            const maxHeight = 720;  // Reduced from 1080
            
            if (width > maxWidth || height > maxHeight) {
                const ratio = Math.min(maxWidth / width, maxHeight / height);
                width = Math.floor(width * ratio);
                height = Math.floor(height * ratio);
            }
            
            canvas.width = width;
            canvas.height = height;
            
            // Draw image
            ctx.drawImage(img, 0, 0, width, height);
            
            // Try WebP first (50% smaller than JPEG!)
            let dataUrl = null;
            try {
                dataUrl = canvas.toDataURL('image/webp', 0.75);
                // Check if browser supports WebP
                if (!dataUrl.includes('data:image/webp')) {
                    dataUrl = null; // WebP not supported
                }
            } catch (e) {
                dataUrl = null;
            }
            
            // Fallback to JPEG with aggressive compression
            if (!dataUrl) {
                let quality = 0.7; // Start at 70%
                dataUrl = canvas.toDataURL('image/jpeg', quality);
                
                // Reduce quality until under 80KB target
                while (dataUrl.length > 80 * 1024 && quality > 0.3) {
                    quality -= 0.05;
                    dataUrl = canvas.toDataURL('image/jpeg', quality);
                }
            }
            
            callback(dataUrl);
        }

        function applyCustomBackground(imageData) {
            try {
                // Clear gradient background first
                document.body.style.background = '';
                
                // Apply custom image
                document.body.style.backgroundImage = `url('${imageData}')`;
                document.body.style.backgroundSize = 'cover';
                document.body.style.backgroundPosition = 'center';
                document.body.style.backgroundAttachment = 'fixed';
                document.body.style.backgroundRepeat = 'no-repeat';
                document.body.style.backgroundColor = '#667eea'; // Fallback color
            } catch (error) {
                console.error('Failed to apply background:', error);
                showNotification('Failed to apply background. Image may be corrupted.', 'warning');
            }
        }

        function removeCustomBackground() {
            if (confirm('Remove your custom background and return to default theme?')) {
                appState.user.customBackground = null;
                appState.user.backgroundTheme = 'default';
                saveData();
                
                applyBackgroundTheme('default');
                document.getElementById('removeBackgroundBtn').style.display = 'none';
                document.getElementById('backgroundPreview').style.display = 'none';
                document.getElementById('backgroundUpload').value = '';
                
                showNotification('Custom background removed', 'info');
            }
        }

        // Background Opacity Functions
        function adjustBackgroundOpacity(value) {
            appState.user.backgroundOpacity = parseInt(value);
            saveData();
            applyBackgroundOpacity(value);
        }

        function applyBackgroundOpacity(value) {
            const opacity = value / 100;
            document.documentElement.style.setProperty('--overlay-opacity', opacity);
            document.getElementById('opacityValue').textContent = `${value}% overlay`;
            
            if (value > 0) {
                document.body.classList.add('has-overlay');
            } else {
                document.body.classList.remove('has-overlay');
            }
        }

        // Start Workout (with device integration)
        function startWorkout() {
            // Check if devices are connected
            let message = ' Starting workout mode!\n\n';
            
            if (appState.user.appleWatchConnected) {
                message += ' Apple Watch will track your heart rate and calories\n';
            }
            if (appState.user.bluetoothDevice) {
                message += ` ${appState.user.bluetoothDevice.name} connected\n`;
            }
            
            // Initialize workout state
            appState.workoutState = {
                currentExerciseIndex: 0,
                currentSet: 0,
                inRest: false,
                startTime: new Date(),
                completedSets: []
            };
            
            // Show workout mode
            enterWorkoutMode();
        }

        // Enter full-screen workout mode
        function enterWorkoutMode() {
            document.getElementById('workoutModeOverlay').classList.add('active');
            displayCurrentExercise();
            
            // Show music notification if playlists are configured
            if (appState.user.spotifyPlaylist || appState.user.appleMusicPlaylist || appState.user.youtubePlaylist) {
                setTimeout(() => {
                    showNotification(' Tap the music button to play your workout playlist!', 'info');
                }, 1000);
            }
        }

        // Exit workout mode
        function exitWorkoutMode() {
            if (confirm('Are you sure you want to exit? Your progress will be saved.')) {
                document.getElementById('workoutModeOverlay').classList.remove('active');
                
                // Save completed exercises
                if (appState.workoutState && appState.workoutState.completedSets) {
                    appState.workoutState.completedSets.forEach(exerciseIndex => {
                        if (!appState.todayExercises[exerciseIndex].completed) {
                            appState.todayExercises[exerciseIndex].completed = true;
                        }
                    });
                }
                
                saveData();
                updateUI();
                appState.workoutState = null;
            }
        }

        // Display current exercise
        function displayCurrentExercise() {
            const state = appState.workoutState;
            const exercise = appState.todayExercises[state.currentExerciseIndex];
            const workoutMain = document.getElementById('workoutMain');
            
            // Update progress header
            document.getElementById('workoutProgress').textContent = 
                `Exercise ${state.currentExerciseIndex + 1} of ${appState.todayExercises.length}`;
            
            // Parse sets (e.g., "4 sets" -> 4)
            const totalSets = parseInt(exercise.sets.split(' ')[0]);
            
            // Create set indicators
            let setIndicators = '';
            for (let i = 0; i < totalSets; i++) {
                let className = 'set-indicator';
                if (i < state.currentSet) {
                    className += ' completed';
                } else if (i === state.currentSet) {
                    className += ' active';
                }
                setIndicators += `<div class="${className}">${i + 1}</div>`;
            }
            
            // Check if exercise uses weights
            const usesWeights = ['Backpack Floor Press', 'Lateral Raises', 'Dumbbell', 'Barbell'].some(term => 
                exercise.name.includes(term)
            );
            
            // Initialize weight tracking if not exists
            if (!exercise.weightLog) {
                exercise.weightLog = [];
            }
            
            workoutMain.innerHTML = `
                <div class="exercise-card-large">
                    <div class="exercise-name-large">${exercise.name}</div>
                    <div class="exercise-details-large">
                        ${exercise.reps}
                    </div>
                    
                    <div class="set-tracker">
                        ${setIndicators}
                    </div>
                    
                    <div class="timer-label">Current Set: ${state.currentSet + 1} of ${totalSets}</div>
                    
                    ${usesWeights ? `
                        <div style="margin: 20px 0; padding: 20px; background: #f9fafb; border-radius: 12px;">
                            <label style="display: block; font-weight: bold; margin-bottom: 10px;">
                                Weight Used (optional)
                            </label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input 
                                    type="number" 
                                    id="weightInput" 
                                    placeholder="e.g., 25"
                                    style="flex: 1; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 18px;"
                                    min="0"
                                    step="5"
                                >
                                <span style="font-size: 18px; font-weight: bold;">lbs</span>
                            </div>
                            <p style="font-size: 13px; color: var(--text-light); margin-top: 8px;">
                                Track your weight to see strength progress over time
                            </p>
                        </div>
                    ` : ''}
                    
                    <div class="workout-instructions">
                        <h4>How to perform:</h4>
                        <ul>
                            ${getExerciseInstructions(exercise.name)}
                        </ul>
                    </div>
                    
                    <button class="workout-button btn-set-done" onclick="completeSet()">
                         Set ${state.currentSet + 1} Done
                    </button>
                </div>
            `;
        }

        // Get exercise instructions
        function getExerciseInstructions(exerciseName) {
            const instructions = {
                'Push-ups': `
                    <li>Start in plank position with hands shoulder-width apart</li>
                    <li>Lower your body until chest nearly touches the floor</li>
                    <li>Push back up to starting position</li>
                    <li>Keep core tight and back straight throughout</li>
                `,
                'Pike Push-ups': `
                    <li>Start in downward dog position with hips raised high</li>
                    <li>Lower your head toward the ground between your hands</li>
                    <li>Press back up to starting position</li>
                    <li>Focus on shoulders and upper chest</li>
                `,
                'Chair Dips': `
                    <li>Place hands on edge of chair behind you</li>
                    <li>Lower body by bending elbows to 90 degrees</li>
                    <li>Push back up to straighten arms</li>
                    <li>Keep shoulders down away from ears</li>
                `,
                'Backpack Floor Press': `
                    <li>Lie on back holding loaded backpack at chest</li>
                    <li>Press backpack up until arms are fully extended</li>
                    <li>Lower back to chest with control</li>
                    <li>Keep shoulder blades squeezed together</li>
                `,
                'Lateral Raises': `
                    <li>Stand with dumbbells or resistance bands at sides</li>
                    <li>Raise arms out to sides until parallel to floor</li>
                    <li>Lower with control back to starting position</li>
                    <li>Keep slight bend in elbows throughout</li>
                `
            };
            
            return instructions[exerciseName] || '<li>Perform the exercise with proper form</li>';
        }

        // Complete a set
        function completeSet() {
            const state = appState.workoutState;
            const exercise = appState.todayExercises[state.currentExerciseIndex];
            const totalSets = parseInt(exercise.sets.split(' ')[0]);
            
            // Record weight if entered
            const weightInput = document.getElementById('weightInput');
            if (weightInput && weightInput.value) {
                const weight = parseInt(weightInput.value);
                if (!exercise.weightLog) exercise.weightLog = [];
                exercise.weightLog.push({
                    date: new Date().toISOString(),
                    set: state.currentSet + 1,
                    weight: weight
                });
                saveData();
            }
            
            // Increment set counter
            state.currentSet++;
            
            // Check if all sets are done for this exercise
            if (state.currentSet >= totalSets) {
                // Mark exercise as completed
                if (!state.completedSets.includes(state.currentExerciseIndex)) {
                    state.completedSets.push(state.currentExerciseIndex);
                }
                
                // Move to next exercise or finish workout
                if (state.currentExerciseIndex < appState.todayExercises.length - 1) {
                    // Show rest period before next exercise
                    showRestPeriod(90); // 90 seconds between exercises
                } else {
                    // Workout complete!
                    finishWorkout();
                }
            } else {
                // Show rest period between sets
                showRestPeriod(60); // 60 seconds between sets
            }
        }

        // Show rest period
        function showRestPeriod(seconds) {
            const state = appState.workoutState;
            const workoutMain = document.getElementById('workoutMain');
            
            state.inRest = true;
            state.restTimeRemaining = seconds;
            
            workoutMain.innerHTML = `
                <div class="rest-timer">
                    <h2 style="margin-bottom: 20px;"> Rest Period</h2>
                    <div class="timer-label">Take a breather...</div>
                    <div class="timer-display" id="restTimer">${formatTime(seconds)}</div>
                    <div style="margin-top: 20px; font-size: 18px; opacity: 0.9;">
                        Next: ${state.currentSet >= parseInt(appState.todayExercises[state.currentExerciseIndex].sets.split(' ')[0]) 
                            ? (state.currentExerciseIndex < appState.todayExercises.length - 1 
                                ? appState.todayExercises[state.currentExerciseIndex + 1].name 
                                : 'Workout Complete!')
                            : `Set ${state.currentSet + 1} of ${appState.todayExercises[state.currentExerciseIndex].name}`
                        }
                    </div>
                    <button class="workout-button btn-skip-rest" onclick="skipRest()">
                        Skip Rest 
                    </button>
                </div>
            `;
            
            // Start countdown
            startRestTimer();
        }

        // Start rest timer countdown
        function startRestTimer() {
            const state = appState.workoutState;
            
            if (state.restInterval) {
                clearInterval(state.restInterval);
            }
            
            state.restInterval = setInterval(() => {
                state.restTimeRemaining--;
                
                const timerDisplay = document.getElementById('restTimer');
                if (timerDisplay) {
                    timerDisplay.textContent = formatTime(state.restTimeRemaining);
                }
                
                if (state.restTimeRemaining <= 0) {
                    clearInterval(state.restInterval);
                    endRest();
                }
            }, 1000);
        }

        // Format time as MM:SS
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Skip rest period
        function skipRest() {
            if (appState.workoutState.restInterval) {
                clearInterval(appState.workoutState.restInterval);
            }
            endRest();
        }

        // End rest period
        function endRest() {
            const state = appState.workoutState;
            state.inRest = false;
            
            const exercise = appState.todayExercises[state.currentExerciseIndex];
            const totalSets = parseInt(exercise.sets.split(' ')[0]);
            
            // Check if moving to next exercise
            if (state.currentSet >= totalSets) {
                state.currentExerciseIndex++;
                state.currentSet = 0;
            }
            
            displayCurrentExercise();
        }

        // Finish workout
        function finishWorkout() {
            const state = appState.workoutState;
            const workoutMain = document.getElementById('workoutMain');
            
            // Calculate workout duration
            const duration = Math.floor((new Date() - state.startTime) / 1000 / 60); // in minutes
            
            // Mark all exercises as completed
            state.completedSets.forEach(index => {
                appState.todayExercises[index].completed = true;
            });
            
            const xpEarned = state.completedSets.length * 10;
            
            workoutMain.innerHTML = `
                <div class="exercise-card-large celebration">
                    <div style="font-size: 80px; margin-bottom: 20px;"></div>
                    <div class="exercise-name-large">Workout Complete!</div>
                    <div class="exercise-details-large">
                        Amazing job!
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin: 30px 0;">
                        <div style="background: #f9fafb; padding: 20px; border-radius: 12px;">
                            <div style="font-size: 36px; font-weight: bold; color: var(--primary);">${state.completedSets.length}</div>
                            <div style="color: var(--text-light); margin-top: 5px;">Exercises</div>
                        </div>
                        <div style="background: #f9fafb; padding: 20px; border-radius: 12px;">
                            <div style="font-size: 36px; font-weight: bold; color: var(--primary);">${duration}</div>
                            <div style="color: var(--text-light); margin-top: 5px;">Minutes</div>
                        </div>
                        <div style="background: #f9fafb; padding: 20px; border-radius: 12px;">
                            <div style="font-size: 36px; font-weight: bold; color: var(--secondary);">+${xpEarned}</div>
                            <div style="color: var(--text-light); margin-top: 5px;">XP Earned</div>
                        </div>
                        <div style="background: #f9fafb; padding: 20px; border-radius: 12px;">
                            <div style="font-size: 36px; font-weight: bold; color: var(--warning);"></div>
                            <div style="color: var(--text-light); margin-top: 5px;">Streak +1</div>
                        </div>
                    </div>
                    
                    <button class="workout-button" style="background: var(--secondary); color: white;" onclick="saveAndExitWorkout()">
                         Finish & Save Progress
                    </button>
                </div>
            `;
        }

        // Save and exit workout
        function saveAndExitWorkout() {
            const state = appState.workoutState;
            
            // Set start date if first workout
            if (appState.user.totalWorkouts === 0) {
                appState.user.startDate = new Date().toISOString();
                if (appState.user.currentWeight) {
                    appState.user.startWeight = appState.user.currentWeight;
                }
            }
            
            // Calculate XP
            const xpEarned = state.completedSets.length * 10;
            
            // Add XP
            appState.user.xp += xpEarned;
            appState.user.totalWorkouts++;
            appState.user.streak++;
            appState.user.lastWorkoutDate = new Date().toISOString();

            // Level up check
            while (appState.user.xp >= appState.user.maxXP) {
                appState.user.xp -= appState.user.maxXP;
                appState.user.level++;
                appState.user.maxXP = Math.floor(appState.user.maxXP * 1.5);
                
                if (appState.user.level === 5) {
                    unlockAchievement(3);
                }
            }

            // Check achievements
            if (appState.user.totalWorkouts === 1) {
                unlockAchievement(1);
            }
            if (appState.user.streak === 7) {
                unlockAchievement(2);
            }
            if (appState.user.totalWorkouts === 25) {
                unlockAchievement(5);
            }

            // Reset exercises for tomorrow
            appState.todayExercises.forEach(e => e.completed = false);
            
            // Clear workout state
            appState.workoutState = null;
            
            // Save and update
            saveData();
            updateUI();
            
            // Exit workout mode
            document.getElementById('workoutModeOverlay').classList.remove('active');
            
            showNotification(` Workout Complete! +${xpEarned} XP earned! Streak: ${appState.user.streak} days `, 'success');
        }

        // ============================================
        // MUSIC PLAYER FUNCTIONS
        // ============================================

        let currentMusicTab = 'youtube';
        let youtubePlayerInstance = null;
        let spotifyAccessToken = null;
        let savedPlaylistLinks = JSON.parse(localStorage.getItem('playlistLinks') || '[]');
        let isMusicMinimized = false;

        // Open music player mini-player
        function openMusicPlayer() {
            const modal = document.getElementById('musicPlayerModal');
            modal.style.display = 'block';
            modal.classList.remove('minimized');
            isMusicMinimized = false;
            document.getElementById('minimizeIcon').textContent = '';
            checkMusicAPIStatus();
            loadSavedPlaylists();
            
            // Load YouTube IFrame API if not already loaded
            if (!window.YT) {
                const tag = document.createElement('script');
                tag.src = 'https://www.youtube.com/iframe_api';
                const firstScriptTag = document.getElementsByTagName('script')[0];
                firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
            }
        }

        // Toggle minimize music player
        function toggleMinimizeMusic() {
            const modal = document.getElementById('musicPlayerModal');
            isMusicMinimized = !isMusicMinimized;
            
            if (isMusicMinimized) {
                modal.classList.add('minimized');
                document.getElementById('minimizeIcon').textContent = '';
            } else {
                modal.classList.remove('minimized');
                document.getElementById('minimizeIcon').textContent = '';
            }
        }

        // Close music player (keeps music playing)
        function closeMusicPlayer() {
            document.getElementById('musicPlayerModal').style.display = 'none';
            // Don't stop the music - let it play in background
        }

        // Save playlist link
        function savePlaylistLink() {
            const input = document.getElementById('playlistLinkInput');
            const url = input.value.trim();
            
            if (!url) {
                showNotification('Please paste a playlist URL', 'warning');
                return;
            }
            
            // Detect platform
            let platform = 'other';
            let name = 'Custom Playlist';
            
            if (url.includes('spotify.com')) {
                platform = 'spotify';
                name = 'Spotify Playlist';
            } else if (url.includes('youtube.com') || url.includes('youtu.be')) {
                platform = 'youtube';
                name = 'YouTube Playlist';
            }
            
            const playlist = {
                id: Date.now(),
                url: url,
                platform: platform,
                name: name,
                addedAt: new Date().toISOString()
            };
            
            savedPlaylistLinks.push(playlist);
            localStorage.setItem('playlistLinks', JSON.stringify(savedPlaylistLinks));
            
            input.value = '';
            loadSavedPlaylists();
            showNotification(' Playlist link saved!', 'success');
        }

        // Load saved playlists
        function loadSavedPlaylists() {
            const container = document.getElementById('savedPlaylists');
            
            if (savedPlaylistLinks.length === 0) {
                container.innerHTML = '<div style="color: rgba(255,255,255,0.5); padding: 10px; font-size: 14px;">No saved playlists. Add your favorite workout playlists above! </div>';
                return;
            }
            
            container.innerHTML = savedPlaylistLinks.map(playlist => {
                const icon = playlist.platform === 'spotify' ? '' : playlist.platform === 'youtube' ? '' : '';
                return `
                    <div class="playlist-link-btn" onclick="openPlaylist('${playlist.url}')">
                        ${icon} ${playlist.name}
                    </div>
                    <button class="playlist-link-btn remove" onclick="removePlaylist(${playlist.id}); event.stopPropagation();" title="Remove">
                        
                    </button>
                `;
            }).join('');
        }

        // Open playlist in new tab
        function openPlaylist(url) {
            window.open(url, '_blank');
            showNotification(' Opening playlist...', 'info');
        }

        // Remove playlist
        function removePlaylist(id) {
            savedPlaylistLinks = savedPlaylistLinks.filter(p => p.id !== id);
            localStorage.setItem('playlistLinks', JSON.stringify(savedPlaylistLinks));
            loadSavedPlaylists();
            showNotification('Playlist removed', 'info');
        }

        // Stop all music playback
        function stopAllMusic() {
            // Stop YouTube
            if (youtubePlayerInstance) {
                youtubePlayerInstance.stopVideo();
            }
            
            // Stop Spotify
            const audioPlayer = document.getElementById('spotifyAudioPlayer');
            if (audioPlayer) {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
            }
            
            // Hide now playing section
            document.getElementById('nowPlayingSection').classList.remove('active');
            document.getElementById('youtubePlayerContainer').style.display = 'none';
            document.getElementById('spotifyPlayerContainer').style.display = 'none';
            
            showNotification(' Music stopped', 'info');
        }

        // Switch between YouTube and Spotify tabs
        function switchMusicTab(tab) {
            currentMusicTab = tab;
            
            // Update tab buttons
            const tabs = document.querySelectorAll('.music-tab');
            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show/hide sections
            document.getElementById('youtubeSection').style.display = tab === 'youtube' ? 'block' : 'none';
            document.getElementById('spotifySection').style.display = tab === 'spotify' ? 'block' : 'none';
        }

        // Check music API status
        function checkMusicAPIStatus() {
            const youtubeKey = localStorage.getItem('youtubeApiKey') || 'AIzaSyAtTsnqvnVajLBFyP69xqcD2EJC7h9nV1Q';
            const spotifyClientId = localStorage.getItem('spotifyClientId') || '836517f7831341f3a342af90f5c1390e';
            
            const youtubeStatus = document.getElementById('youtubeMusicStatus');
            const spotifyStatus = document.getElementById('spotifyMusicStatus');
            
            if (youtubeKey) {
                youtubeStatus.innerHTML = ' YouTube:  Ready (Shared API)';
                youtubeStatus.style.color = '#10b981';
            } else {
                youtubeStatus.innerHTML = ' YouTube:  Not configured';
                youtubeStatus.style.color = '#ef4444';
            }
            
            if (spotifyClientId) {
                spotifyStatus.innerHTML = ' Spotify:  Ready (Shared API)';
                spotifyStatus.style.color = '#10b981';
            } else {
                spotifyStatus.innerHTML = ' Spotify:  Not configured';
                spotifyStatus.style.color = '#ef4444';
            }
        }

        // ============================================
        // YOUTUBE MUSIC FUNCTIONS
        // ============================================

        // Search YouTube
        async function searchYouTube() {
            const query = document.getElementById('youtubeSearchInput').value.trim();
            if (!query) {
                showNotification('Please enter a search term', 'warning');
                return;
            }

            const apiKey = localStorage.getItem('youtubeApiKey') || 'AIzaSyAtTsnqvnVajLBFyP69xqcD2EJC7h9nV1Q';
            const resultsDiv = document.getElementById('youtubeResults');
            
            resultsDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.7);"> Searching YouTube...</div>';

            try {
                const response = await fetch(
                    `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query + ' music')}&type=video&maxResults=12&key=${apiKey}`
                );

                if (!response.ok) {
                    throw new Error('YouTube API request failed');
                }

                const data = await response.json();
                
                if (!data.items || data.items.length === 0) {
                    resultsDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.7);">No results found</div>';
                    return;
                }

                displayYouTubeResults(data.items);
            } catch (error) {
                console.error('YouTube search error:', error);
                resultsDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;"> Search failed. Please check API key in Settings.</div>';
            }
        }

        // Display YouTube results
        function displayYouTubeResults(items) {
            const resultsDiv = document.getElementById('youtubeResults');
            
            resultsDiv.innerHTML = items.map(item => `
                <div class="music-card" onclick="playYouTubeVideo('${item.id.videoId}', '${escapeHtml(item.snippet.title)}')">
                    <img src="${item.snippet.thumbnails.medium.url}" alt="${escapeHtml(item.snippet.title)}" class="music-thumbnail">
                    <div class="music-title">${escapeHtml(item.snippet.title)}</div>
                    <div class="music-artist">${escapeHtml(item.snippet.channelTitle)}</div>
                    <div style="margin-top: 8px; color: rgba(255,255,255,0.5); font-size: 13px;"> Click to play</div>
                </div>
            `).join('');
        }

        // Play YouTube video
        function playYouTubeVideo(videoId, title) {
            const nowPlaying = document.getElementById('nowPlayingSection');
            const youtubeContainer = document.getElementById('youtubePlayerContainer');
            const spotifyContainer = document.getElementById('spotifyPlayerContainer');
            
            // Show YouTube player, hide Spotify
            nowPlaying.classList.add('active');
            youtubeContainer.style.display = 'block';
            spotifyContainer.style.display = 'none';
            
            // Don't scroll - let it play in background
            
            // Initialize or update player
            if (!youtubePlayerInstance) {
                // Wait for YouTube API to be ready
                if (window.YT && window.YT.Player) {
                    createYouTubePlayer(videoId);
                } else {
                    window.onYouTubeIframeAPIReady = function() {
                        createYouTubePlayer(videoId);
                    };
                }
            } else {
                youtubePlayerInstance.loadVideoById(videoId);
            }
            
            showNotification(` Now playing: ${title}`, 'success');
        }

        // Create YouTube player instance
        function createYouTubePlayer(videoId) {
            youtubePlayerInstance = new YT.Player('youtubePlayer', {
                height: '200',
                width: '100%',
                videoId: videoId,
                playerVars: {
                    'autoplay': 1,
                    'controls': 1,
                    'rel': 0,
                    'modestbranding': 1
                }
            });
        }

        // ============================================
        // SPOTIFY MUSIC FUNCTIONS
        // ============================================

        // Get Spotify access token
        async function getSpotifyToken() {
            if (spotifyAccessToken) {
                return spotifyAccessToken;
            }

            const clientId = localStorage.getItem('spotifyClientId') || '836517f7831341f3a342af90f5c1390e';
            const clientSecret = localStorage.getItem('spotifyClientSecret') || '07f314daeaad4525bbad0cbe3901487a';

            try {
                const response = await fetch('https://accounts.spotify.com/api/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Authorization': 'Basic ' + btoa(clientId + ':' + clientSecret)
                    },
                    body: 'grant_type=client_credentials'
                });

                if (!response.ok) {
                    throw new Error('Failed to get Spotify token');
                }

                const data = await response.json();
                spotifyAccessToken = data.access_token;
                
                // Token expires, so clear it after 55 minutes
                setTimeout(() => {
                    spotifyAccessToken = null;
                }, 55 * 60 * 1000);
                
                return spotifyAccessToken;
            } catch (error) {
                console.error('Spotify token error:', error);
                throw error;
            }
        }

        // Search Spotify
        async function searchSpotify() {
            const query = document.getElementById('spotifySearchInput').value.trim();
            if (!query) {
                showNotification('Please enter a search term', 'warning');
                return;
            }

            const resultsDiv = document.getElementById('spotifyResults');
            resultsDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.7);"> Searching Spotify...</div>';

            try {
                const token = await getSpotifyToken();
                
                const response = await fetch(
                    `https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=12`,
                    {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error('Spotify search failed');
                }

                const data = await response.json();
                
                if (!data.tracks || !data.tracks.items || data.tracks.items.length === 0) {
                    resultsDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.7);">No results found</div>';
                    return;
                }

                displaySpotifyResults(data.tracks.items);
            } catch (error) {
                console.error('Spotify search error:', error);
                resultsDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;"> Search failed. Please check API keys in Settings.</div>';
            }
        }

        // Display Spotify results
        function displaySpotifyResults(tracks) {
            const resultsDiv = document.getElementById('spotifyResults');
            
            resultsDiv.innerHTML = tracks.map(track => {
                const hasPreview = track.preview_url !== null;
                const albumImage = track.album.images[0]?.url || '';
                const artists = track.artists.map(a => a.name).join(', ');
                
                return `
                    <div class="music-card ${hasPreview ? '' : 'opacity-50'}" ${hasPreview ? `onclick="playSpotifyTrack('${track.preview_url}', '${escapeHtml(track.name)}', '${escapeHtml(artists)}')"` : ''}>
                        <img src="${albumImage}" alt="${escapeHtml(track.name)}" class="music-thumbnail">
                        <div class="music-title">${escapeHtml(track.name)}</div>
                        <div class="music-artist">${escapeHtml(artists)}</div>
                        <div style="margin-top: 8px; color: rgba(255,255,255,0.5); font-size: 13px;">
                            ${hasPreview ? ' 30s preview' : ' No preview available'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Play Spotify track preview
        function playSpotifyTrack(previewUrl, title, artist) {
            const nowPlaying = document.getElementById('nowPlayingSection');
            const youtubeContainer = document.getElementById('youtubePlayerContainer');
            const spotifyContainer = document.getElementById('spotifyPlayerContainer');
            const audioPlayer = document.getElementById('spotifyAudioPlayer');
            
            // Show Spotify player, hide YouTube
            nowPlaying.classList.add('active');
            youtubeContainer.style.display = 'none';
            spotifyContainer.style.display = 'block';
            
            // Stop YouTube if playing
            if (youtubePlayerInstance) {
                youtubePlayerInstance.stopVideo();
            }
            
            // Update track info
            document.getElementById('spotifyNowPlayingTitle').textContent = title;
            document.getElementById('spotifyNowPlayingArtist').textContent = artist;
            
            // Load and play preview
            audioPlayer.src = previewUrl;
            audioPlayer.play();
            
            // Don't scroll - let it play in background
            
            showNotification(` Playing: ${title}`, 'success');
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================
        // FIREBASE AUTHENTICATION FUNCTIONS
        // ============================================

        // Auth state observer
        auth.onAuthStateChanged(async (user) => {
            console.log('Auth state changed. User:', user ? user.email : 'null');
            
            if (user) {
                currentUser = user;
                
                try {
                    // Update UI
                    const loginBtn = document.getElementById('loginBtn');
                    const userBadge = document.getElementById('userBadge');
                    const userEmailBadge = document.getElementById('userEmailBadge');
                    
                    if (loginBtn) loginBtn.style.display = 'none';
                    if (userBadge) userBadge.style.display = 'flex';
                    if (userEmailBadge) userEmailBadge.textContent = user.email.split('@')[0];
                    
                    console.log('Loading user data from Firestore...');
                    
                    // Load user data from Firestore
                    await loadUserDataFromFirebase(user.uid);
                    
                    // Load challenges from Firestore
                    await loadChallengesFromFirebase();
                    
                    const displayName = user.displayName || user.email.split('@')[0];
                    console.log('User data loaded successfully for:', displayName);
                    
                    // Only show welcome notification on first load
                    if (!sessionStorage.getItem('welcomeShown')) {
                        showNotification(`Welcome back, ${displayName}! `, 'success');
                        sessionStorage.setItem('welcomeShown', 'true');
                    }
                    
                    // Initialize FriendsManager for real-time friend updates
                    if (typeof friendsManager !== 'undefined' && friendsManager.init) {
                        await friendsManager.init(user);
                        console.log(' FriendsManager initialized');
                    }
                    
                } catch (error) {
                    console.error('Error in auth state handler:', error);
                    showNotification('Error loading user data', 'warning');
                }
                
            } else {
                currentUser = null;
                console.log('No user logged in, using local storage');
                
                // Cleanup FriendsManager listeners
                if (typeof friendsManager !== 'undefined' && friendsManager.cleanup) {
                    friendsManager.cleanup();
                    console.log(' FriendsManager cleaned up');
                }
                
                const loginBtn = document.getElementById('loginBtn');
                const userBadge = document.getElementById('userBadge');
                
                if (loginBtn) loginBtn.style.display = 'flex';
                if (userBadge) userBadge.style.display = 'none';
                
                // Load local data if no user
                loadData();
                sessionStorage.removeItem('welcomeShown');
            }
        });

        // Open auth modal
        function openAuthModal() {
            document.getElementById('authModal').classList.add('active');
        }

        // Close auth modal
        function closeAuthModal() {
            document.getElementById('authModal').classList.remove('active');
        }

        // Switch between login and signup tabs
        function switchAuthTab(tab) {
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const tabs = document.querySelectorAll('.auth-tab');
            
            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            if (tab === 'login') {
                loginForm.classList.add('active');
                signupForm.classList.remove('active');
            } else {
                signupForm.classList.add('active');
                loginForm.classList.remove('active');
            }
        }

        // Sign in with Google
        async function signInWithGoogle() {
            try {
                showNotification('Opening Google Sign-In...', 'info');
                
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('profile');
                provider.addScope('email');
                
                // Try popup first, fallback to redirect
                try {
                    const result = await auth.signInWithPopup(provider);
                    console.log('Google sign-in successful:', result.user.email);
                    
                    // Create user profile in Firestore if new
                    await createOrUpdateUserProfile(result.user);
                    
                    closeAuthModal();
                    showNotification('Successfully signed in with Google! ', 'success');
                    
                } catch (popupError) {
                    // If popup is blocked, use redirect
                    if (popupError.code === 'auth/popup-blocked' || popupError.code === 'auth/cancelled-popup-request') {
                        console.log('Popup blocked, using redirect...');
                        await auth.signInWithRedirect(provider);
                    } else {
                        throw popupError;
                    }
                }
                
            } catch (error) {
                console.error('Google sign-in error:', error);
                let errorMessage = 'Failed to sign in with Google.';
                
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = 'Sign-in cancelled. Please try again.';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = 'Network error. Please check your connection.';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showNotification(errorMessage, 'warning');
            }
        }

        // Handle redirect result (for when popup is blocked)
        async function checkRedirectResult() {
            try {
                const result = await auth.getRedirectResult();
                if (result && result.user) {
                    console.log('Redirect sign-in successful:', result.user.email);
                    await createOrUpdateUserProfile(result.user);
                    showNotification('Successfully signed in with Google! ', 'success');
                }
            } catch (error) {
                console.error('Redirect error:', error);
                if (error.code !== 'auth/popup-closed-by-user') {
                    showNotification('Sign-in error: ' + error.message, 'warning');
                }
            }
        }
        
        // Check redirect result on page load
        checkRedirectResult();

        // Handle email/password login
        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                closeAuthModal();
                showNotification('Login successful! ', 'success');
            } catch (error) {
                console.error('Login error:', error);
                showNotification('Login failed: ' + error.message, 'warning');
            }
        }

        // Handle email/password signup
        async function handleSignup(event) {
            event.preventDefault();
            
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            
            try {
                const result = await auth.createUserWithEmailAndPassword(email, password);
                
                // Update profile with name
                await result.user.updateProfile({
                    displayName: name
                });
                
                // Create user profile in Firestore
                await createOrUpdateUserProfile(result.user, name);
                
                closeAuthModal();
                showNotification('Account created successfully! ', 'success');
            } catch (error) {
                console.error('Signup error:', error);
                showNotification('Signup failed: ' + error.message, 'warning');
            }
        }

        // Create or update user profile in Firestore
        async function createOrUpdateUserProfile(user, displayName = null) {
            try {
                console.log('Creating/updating profile for:', user.email);
                const userDocRef = db.collection('users').doc(user.uid);
                
                // Check if user profile exists
                const userDoc = await userDocRef.get();
                
                if (!userDoc.exists) {
                    // New user - create profile with friend code
                    const friendCode = 'FIT-' + Math.random().toString(36).substring(2, 8).toUpperCase();
                    
                    const newUserData = {
                        email: user.email,
                        displayName: displayName || user.displayName || user.email.split('@')[0],
                        username: '',
                        friendCode: friendCode,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                        level: 1,
                        xp: 0,
                        currentXP: 0,
                        maxXP: 100,
                        totalWorkouts: 0,
                        streak: 0,
                        currentWeight: null,
                        goalWeight: null,
                        startWeight: null,
                        achievements: [],
                        friends: [],
                        healthConditions: [],
                        healthNotes: '',
                        fitnessLevel: 'beginner'
                    };
                    
                    console.log('Creating new user profile with friend code:', friendCode);
                    await userDocRef.set(newUserData);
                    
                    // Also save to publicProfiles collection for friend code lookup
                    await db.collection('publicProfiles').doc(friendCode).set({
                        uid: user.uid,
                        displayName: displayName || user.displayName || user.email.split('@')[0],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    console.log('User profile created successfully with public profile');
                    
                } else {
                    // Existing user - update last active
                    console.log('Updating existing user profile');
                    await userDocRef.update({
                        lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                        displayName: displayName || user.displayName || userDoc.data().displayName
                    });
                    console.log('User profile updated');
                }
                
                return true;
                
            } catch (error) {
                console.error('Error creating/updating user profile:', error);
                showNotification('Error setting up profile. Please try again.', 'warning');
                return false;
            }
        }

        // Load user data from Firestore
        async function loadUserDataFromFirebase(uid) {
            try {
                const userDocRef = db.collection('users').doc(uid);
                const userDoc = await userDocRef.get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    
                    // Merge Firestore data with app state
                    appState.user = {
                        ...appState.user,
                        name: userData.displayName || userData.email?.split('@')[0] || appState.user.name,
                        username: userData.username || '',
                        email: userData.email,
                        displayName: userData.displayName,
                        friendCode: userData.friendCode,
                        level: userData.level || 1,
                        xp: userData.xp || 0,
                        currentXP: userData.currentXP || 0,
                        maxXP: userData.maxXP || 100,
                        totalWorkouts: userData.totalWorkouts || 0,
                        streak: userData.streak || 0,
                        currentWeight: userData.currentWeight,
                        goalWeight: userData.goalWeight,
                        startWeight: userData.startWeight,
                        achievements: userData.achievements || [],
                        lastWorkoutDate: userData.lastWorkoutDate,
                        healthConditions: userData.healthConditions || [],
                        healthNotes: userData.healthNotes || '',
                        fitnessLevel: userData.fitnessLevel || 'beginner'
                    };
                    
                    console.log(' Loaded user data. Friend Code:', appState.user.friendCode);
                    
                    // Load additional data
                    await loadProgressPhotosFromFirebase(uid);
                    await loadFriendsFromFirebase(uid);
                    await loadChallengesFromFirebase(uid);
                    
                    updateUI();
                    renderProgressTimeline();
                    renderLeaderboard();
                    renderChallenges();
                } else {
                    console.error('User document does not exist in Firestore');
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                // Fallback to local data
                loadData();
            }
        }

        // Save app state to Firestore
        async function saveDataToFirebase() {
            if (!currentUser) return;
            
            try {
                const userDocRef = db.collection('users').doc(currentUser.uid);
                
                // Ensure friend code exists before saving
                if (!appState.user.friendCode) {
                    console.warn(' No friend code in appState, fetching from Firestore...');
                    const userDoc = await userDocRef.get();
                    if (userDoc.exists && userDoc.data().friendCode) {
                        appState.user.friendCode = userDoc.data().friendCode;
                    }
                }
                
                console.log(' Saving user data to Firestore. Friend Code:', appState.user.friendCode);
                
                await userDocRef.update({
                    level: appState.user.level,
                    xp: appState.user.xp,
                    currentXP: appState.user.currentXP,
                    maxXP: appState.user.maxXP,
                    totalWorkouts: appState.user.totalWorkouts,
                    streak: appState.user.streak,
                    currentWeight: appState.user.currentWeight,
                    goalWeight: appState.user.goalWeight,
                    startWeight: appState.user.startWeight,
                    achievements: appState.achievements,
                    lastWorkoutDate: appState.user.lastWorkoutDate,
                    lastActive: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Save progress photos
                await saveProgressPhotosToFirebase(currentUser.uid);
                
                // Save challenges
                await saveChallengesToFirebase(currentUser.uid);
                
                console.log(' User data saved successfully');
                
            } catch (error) {
                console.error('Error saving to Firestore:', error);
            }
        }

        // Load progress photos from Firestore
        async function loadProgressPhotosFromFirebase(uid) {
            try {
                const photosCollection = db.collection('users').doc(uid).collection('progressPhotos');
                const photosSnapshot = await photosCollection.get();
                
                appState.progressPhotos = [];
                photosSnapshot.forEach((doc) => {
                    appState.progressPhotos.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by date
                appState.progressPhotos.sort((a, b) => {
                    const dateA = a.date?.toDate ? a.date.toDate() : new Date(a.date);
                    const dateB = b.date?.toDate ? b.date.toDate() : new Date(b.date);
                    return dateB - dateA;
                });
            } catch (error) {
                console.error('Error loading progress photos:', error);
            }
        }

        // Save progress photos to Firestore
        async function saveProgressPhotosToFirebase(uid) {
            try {
                const photosCollection = db.collection('users').doc(uid).collection('progressPhotos');
                
                // Save each photo as a document
                for (const photo of appState.progressPhotos) {
                    if (!photo.id) {
                        // New photo - create document
                        const photoId = 'photo_' + Date.now() + '_' + Math.random().toString(36).substring(7);
                        await photosCollection.doc(photoId).set({
                            ...photo,
                            id: photoId,
                            uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } else {
                        // Update existing photo
                        await photosCollection.doc(photo.id).set(photo, { merge: true });
                    }
                }
            } catch (error) {
                console.error('Error saving progress photos:', error);
            }
        }

        // Load friends from Firestore with real-time updates
        async function loadFriendsFromFirebase(uid) {
            try {
                const userDocRef = db.collection('users').doc(uid);
                const userDoc = await userDocRef.get();
                
                if (!userDoc.exists) return;
                
                const userData = userDoc.data();
                const friendIds = userData.friends || [];
                
                if (friendIds.length === 0) {
                    appState.friends = [];
                    renderFriendsList();
                    renderLeaderboard();
                    return;
                }
                
                // Load each friend's data with real-time listener
                appState.friends = [];
                
                for (const friendId of friendIds) {
                    const friendDocRef = db.collection('users').doc(friendId);
                    
                    // Set up real-time listener for each friend
                    friendDocRef.onSnapshot((friendDoc) => {
                        if (friendDoc.exists) {
                            const friendData = { uid: friendId, ...friendDoc.data() };
                            
                            // Update or add friend in the array
                            const existingIndex = appState.friends.findIndex(f => f.uid === friendId);
                            if (existingIndex >= 0) {
                                appState.friends[existingIndex] = friendData;
                            } else {
                                appState.friends.push(friendData);
                            }
                            
                            // Update UI
                            renderFriendsList();
                            renderLeaderboard();
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading friends:', error);
            }
        }

        // Add friend by username (fallback function)
        async function addFriendByCode() {
            const input = document.getElementById('addFriendInput') || document.getElementById('friendCodeInput');
            const username = input ? input.value.trim().toLowerCase() : '';
            
            if (!username) {
                showNotification('Please enter a username', 'warning');
                return;
            }

            if (!currentUser) {
                showNotification('Please login to add friends', 'warning');
                openAuthModal();
                return;
            }

            try {
                console.log(' Searching for username:', username);
                
                // Search for user with this username
                const snapshot = await db.collection('users').where('username', '==', username).get();
                
                console.log(' Search results:', snapshot.size, 'users found');
                
                if (snapshot.empty) {
                    // Try displayName as fallback
                    const displayNameSnapshot = await db.collection('users').where('displayName', '==', input.value.trim()).get();
                    
                    if (displayNameSnapshot.empty) {
                        showNotification(' User not found. Please check the username and try again.', 'warning');
                        console.error('No user found with username:', username);
                        return;
                    }
                    
                    // Use displayName result
                    displayNameSnapshot.forEach((doc) => {
                        friendData = doc.data();
                        friendUid = doc.id;
                    });
                } else {
                    snapshot.forEach((doc) => {
                        friendData = doc.data();
                        friendUid = doc.id;
                        console.log(' Found user:', friendData.displayName, 'Username:', friendData.username, 'UID:', friendUid);
                    });
                }
                
                let friendData = null;
                let friendUid = null;
                
                snapshot.forEach((doc) => {
                    friendData = doc.data();
                    friendUid = doc.id;
                    console.log(' Found user:', friendData.displayName, 'UID:', friendUid);
                });
                
                if (friendUid === currentUser.uid) {
                    showNotification('You cannot add yourself as a friend!', 'warning');
                    return;
                }
                
                // Check if already friends
                const myUserDocRef = db.collection('users').doc(currentUser.uid);
                const myUserDoc = await myUserDocRef.get();
                const myFriends = myUserDoc.data().friends || [];
                
                if (myFriends.includes(friendUid)) {
                    showNotification('You are already friends with this user!', 'warning');
                    return;
                }
                
                // Use friend request system instead of direct add
                if (typeof friendsManager !== 'undefined' && friendsManager.sendFriendRequest) {
                    await friendsManager.sendFriendRequest(username);
                } else {
                    // Fallback: direct add (both ways)
                    console.log(' Adding friend directly...');
                    
                    await myUserDocRef.update({
                        friends: firebase.firestore.FieldValue.arrayUnion(friendUid)
                    });
                    
                    await db.collection('users').doc(friendUid).update({
                        friends: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                    });
                    
                    appState.friends.push({ uid: friendUid, ...friendData });
                    console.log(' Friend added successfully!');
                    showNotification(`Added ${friendData.displayName} as a friend! `, 'success');
                }
                
                input.value = '';
                renderFriendsList();
                renderLeaderboard();
                
            } catch (error) {
                console.error(' Error adding friend:', error);
                showNotification('Failed to add friend: ' + error.message, 'warning');
            }
        }

        // Toggle user menu
        function toggleUserMenu() {
            if (confirm('Do you want to sign out?')) {
                auth.signOut().then(() => {
                    showNotification('Signed out successfully', 'info');
                    location.reload();
                }).catch((error) => {
                    console.error('Sign out error:', error);
                    showNotification('Error signing out', 'warning');
                });
            }
        }

        // ==========================================
        // CHALLENGES FIRESTORE FUNCTIONS
        // ==========================================
        
        // Load challenges from Firestore
        async function loadChallengesFromFirebase(uid) {
            try {
                // Load challenges where user is a participant
                const challengesSnapshot = await db.collection('challenges')
                    .where('participants', 'array-contains', uid || currentUser?.uid)
                    .get();
                
                appState.challenges = [];
                
                challengesSnapshot.forEach((doc) => {
                    appState.challenges.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by start date (newest first)
                appState.challenges.sort((a, b) => {
                    const dateA = a.startDate?.toDate ? a.startDate.toDate() : new Date(a.startDate);
                    const dateB = b.startDate?.toDate ? b.startDate.toDate() : new Date(b.startDate);
                    return dateB - dateA;
                });
                
                console.log('Loaded', appState.challenges.length, 'challenges from Firestore');
            } catch (error) {
                console.error('Error loading challenges:', error);
            }
        }
        
        // Save challenges to Firestore
        async function saveChallengesToFirebase(uid) {
            try {
                // Save each challenge
                for (const challenge of appState.challenges) {
                    if (!challenge.id) {
                        // New challenge - create document
                        const challengeId = 'challenge_' + Date.now() + '_' + Math.random().toString(36).substring(7);
                        
                        await db.collection('challenges').doc(challengeId).set({
                            ...challenge,
                            id: challengeId,
                            createdBy: uid,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        challenge.id = challengeId; // Update local challenge with ID
                    } else {
                        // Update existing challenge
                        await db.collection('challenges').doc(challenge.id).set({
                            ...challenge,
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });
                    }
                }
            } catch (error) {
                console.error('Error saving challenges:', error);
            }
        }
        
        // Join a challenge by invite code
        async function joinChallengeByCode(challengeCode) {
            if (!currentUser) {
                showNotification('Please login to join challenges', 'warning');
                openAuthModal();
                return false;
            }
            
            try {
                const snapshot = await db.collection('challenges').where('inviteCode', '==', challengeCode).get();
                
                if (snapshot.empty) {
                    showNotification('Challenge not found. Please check the code.', 'warning');
                    return false;
                }
                
                let challengeDoc = null;
                snapshot.forEach((doc) => {
                    challengeDoc = doc;
                });
                
                const challengeData = challengeDoc.data();
                const challengeId = challengeDoc.id;
                
                // Check if already a participant
                if (challengeData.participants.includes(currentUser.uid)) {
                    showNotification('You are already in this challenge!', 'warning');
                    return false;
                }
                
                // Add user to challenge
                await db.collection('challenges').doc(challengeId).update({
                    participants: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                });
                
                // Add challenge to local state
                appState.challenges.push({ id: challengeId, ...challengeData });
                renderChallenges();
                
                showNotification(`Joined "${challengeData.name}" challenge! `, 'success');
                return true;
                
            } catch (error) {
                console.error('Error joining challenge:', error);
                showNotification('Failed to join challenge. Please try again.', 'warning');
                return false;
            }
        }

        // ==========================================
        // FRIENDS MANAGER - Complete Friend System
        // Based on FriendsManager pattern
        // ==========================================

        // Friends Manager State
        const friendsManager = {
            friends: [],
            friendRequests: { incoming: [], outgoing: [] },
            unsubscribers: [],
            
            // Initialize the friends manager
            init: function(user) {
                this.cleanup();
                if (user) {
                    this.listenToFriendRequests();
                    this.listenToFriends();
                }
            },
            
            // Cleanup listeners
            cleanup: function() {
                this.unsubscribers.forEach(unsub => {
                    if (typeof unsub === 'function') unsub();
                });
                this.unsubscribers = [];
            },
            
            // Generate unique 6-character friend code
            generateFriendCode: function() {
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                let code = 'FIT-';
                for (let i = 0; i < 6; i++) {
                    code += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return code;
            },
            
            // Setup friend code for user
            setupFriendCode: async function(username, displayName) {
                if (!currentUser) throw new Error('No user logged in');
                
                // Check if user already has a code
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                let friendCode = userDoc.data()?.friendCode;
                
                if (!friendCode) {
                    // Generate unique code
                    let isUnique = false;
                    while (!isUnique) {
                        friendCode = this.generateFriendCode();
                        const codeDoc = await db.collection('publicProfiles').doc(friendCode).get();
                        if (!codeDoc.exists) {
                            isUnique = true;
                        }
                    }
                    
                    // Save to user document
                    await db.collection('users').doc(currentUser.uid).set({
                        friendCode,
                        username: username || '',
                        displayName: displayName || username || 'User',
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                }
                
                // Create/update public profile
                await db.collection('publicProfiles').doc(friendCode).set({
                    uid: currentUser.uid,
                    username: username || appState.user.username || '',
                    displayName: displayName || appState.user.name || 'User',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                appState.user.friendCode = friendCode;
                return friendCode;
            },
            
            // Get current user's friend code
            getMyFriendCode: async function() {
                if (!currentUser) return null;
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                return userDoc.data()?.friendCode || null;
            },
            
            // Find user by username (primary method)
            findUserByUsername: async function(usernameInput) {
                try {
                    const cleanUsername = usernameInput.trim().toLowerCase();
                    console.log(' Looking for username:', cleanUsername);
                    
                    // Search users collection by username field
                    const snapshot = await db.collection('users').where('username', '==', cleanUsername).get();
                    console.log(' Username search found:', snapshot.size, 'results');
                    
                    if (!snapshot.empty) {
                        let userData = null;
                        snapshot.forEach(doc => {
                            userData = { uid: doc.id, ...doc.data() };
                            console.log(' Found user:', userData.displayName, 'Username:', userData.username, 'UID:', doc.id);
                        });
                        return userData;
                    }
                    
                    // Also try displayName as fallback
                    console.log(' Username not found, trying displayName...');
                    const displayNameSnapshot = await db.collection('users').where('displayName', '==', usernameInput.trim()).get();
                    
                    if (!displayNameSnapshot.empty) {
                        let userData = null;
                        displayNameSnapshot.forEach(doc => {
                            userData = { uid: doc.id, ...doc.data() };
                            console.log(' Found user by displayName:', userData.displayName, 'UID:', doc.id);
                        });
                        return userData;
                    }
                    
                    console.log(' Username not found anywhere:', cleanUsername);
                    return null;
                } catch (error) {
                    console.error('Error finding user by username:', error);
                    return null;
                }
            },
            
            // Legacy: Find user by friend code (kept for backwards compatibility)
            findUserByCode: async function(friendCode) {
                try {
                    const cleanCode = friendCode.trim().toUpperCase();
                    const snapshot = await db.collection('users').where('friendCode', '==', cleanCode).get();
                    if (!snapshot.empty) {
                        let userData = null;
                        snapshot.forEach(doc => {
                            userData = { uid: doc.id, ...doc.data() };
                        });
                        return userData;
                    }
                    return null;
                } catch (error) {
                    console.error('Error finding user by code:', error);
                    return null;
                }
            },
            
            // Send friend request by username
            sendFriendRequest: async function(usernameInput) {
                if (!currentUser) throw new Error('No user logged in');
                
                const cleanInput = usernameInput.trim();
                
                // Find user by username
                const user = await this.findUserByUsername(cleanInput);
                if (!user) {
                    showNotification('User not found. Check the username and try again.', 'warning');
                    return false;
                }
                
                const toUid = user.uid;
                const toUsername = user.username || user.displayName || 'User';
                
                if (toUid === currentUser.uid) {
                    showNotification('Cannot send request to yourself', 'warning');
                    return false;
                }
                
                // Check if already friends
                const friendDoc = await db.collection('users').doc(currentUser.uid)
                    .collection('friends').doc(toUid).get();
                if (friendDoc.exists) {
                    showNotification('Already friends with this user', 'info');
                    return false;
                }
                
                // Check for existing pending request from me to them
                const existingOutgoing = await db.collection('friendRequests')
                    .where('fromUid', '==', currentUser.uid)
                    .where('toUid', '==', toUid)
                    .where('status', '==', 'pending')
                    .get();
                
                if (!existingOutgoing.empty) {
                    showNotification('Friend request already sent', 'info');
                    return false;
                }
                
                // Check if they already sent a request to me (mutual add)
                const existingIncoming = await db.collection('friendRequests')
                    .where('fromUid', '==', toUid)
                    .where('toUid', '==', currentUser.uid)
                    .where('status', '==', 'pending')
                    .get();
                
                if (!existingIncoming.empty) {
                    // Both users added each other - auto accept!
                    const requestId = existingIncoming.docs[0].id;
                    const requestData = existingIncoming.docs[0].data();
                    await this.acceptFriendRequest(requestId, requestData);
                    showNotification('Friend request auto-accepted! You\'re now friends! ', 'success');
                    return true;
                }
                
                // Create friend request
                await db.collection('friendRequests').add({
                    fromUid: currentUser.uid,
                    fromUsername: appState.user.username || 'User',
                    fromDisplayName: appState.user.name || currentUser.displayName || 'User',
                    toUid,
                    toUsername: toUsername,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showNotification('Friend request sent! ', 'success');
                return true;
            },
            
            // Accept friend request
            acceptFriendRequest: async function(requestId, request) {
                if (!currentUser) throw new Error('No user logged in');
                
                try {
                    console.log(' Accepting friend request:', requestId, request);
                    
                    // Get both users' data first
                    const myDoc = await db.collection('users').doc(currentUser.uid).get();
                    const theirDoc = await db.collection('users').doc(request.fromUid).get();
                    
                    const myData = myDoc.data() || {};
                    const theirData = theirDoc.data() || {};
                    
                    // Use a batch write for atomicity
                    const batch = db.batch();
                    
                    // Delete the friend request
                    batch.delete(db.collection('friendRequests').doc(requestId));
                    
                    // Add to MY friends subcollection (I can write to my own)
                    batch.set(
                        db.collection('users').doc(currentUser.uid).collection('friends').doc(request.fromUid),
                        {
                            friendUid: request.fromUid,
                            username: theirData.username || request.fromUsername || '',
                            displayName: theirData.displayName || request.fromDisplayName || 'User',
                            friendCode: theirData.friendCode || '',
                            addedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    );
                    
                    // Add to THEIR friends subcollection
                    // This requires permissive rules OR a Cloud Function
                    // For now, we'll try it and handle the error gracefully
                    batch.set(
                        db.collection('users').doc(request.fromUid).collection('friends').doc(currentUser.uid),
                        {
                            friendUid: currentUser.uid,
                            username: myData.username || appState.user.username || '',
                            displayName: myData.displayName || appState.user.name || 'User',
                            friendCode: myData.friendCode || '',
                            addedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    );
                    
                    // Commit the batch
                    await batch.commit();
                    console.log(' Batch write successful');
                    
                    showNotification('Friend request accepted! ', 'success');
                    await loadFriendsFromFirebase(currentUser.uid);
                    renderFriendsList();
                    
                    return true;
                } catch (error) {
                    console.error('Error accepting friend request:', error);
                    
                    // If batch failed, try just adding to our side
                    try {
                        console.log(' Trying fallback - adding friend to my list only');
                        
                        const theirDoc = await db.collection('users').doc(request.fromUid).get();
                        const theirData = theirDoc.data() || {};
                        
                        // Delete the request
                        await db.collection('friendRequests').doc(requestId).delete();
                        
                        // Add to my friends
                        await db.collection('users').doc(currentUser.uid).collection('friends').doc(request.fromUid).set({
                            friendUid: request.fromUid,
                            username: theirData.username || request.fromUsername || '',
                            displayName: theirData.displayName || request.fromDisplayName || 'User',
                            friendCode: theirData.friendCode || '',
                            addedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        showNotification('Friend added! ', 'success');
                        await loadFriendsFromFirebase(currentUser.uid);
                        renderFriendsList();
                        return true;
                    } catch (fallbackError) {
                        console.error('Fallback also failed:', fallbackError);
                        showNotification('Failed to accept: ' + fallbackError.message, 'warning');
                        return false;
                    }
                }
            },
            
            // Decline friend request
            declineFriendRequest: async function(requestId) {
                if (!currentUser) throw new Error('No user logged in');
                try {
                    await db.collection('friendRequests').doc(requestId).delete();
                    showNotification('Friend request declined', 'info');
                    return true;
                } catch (error) {
                    console.error('Error declining friend request:', error);
                    showNotification('Failed to decline request', 'warning');
                    return false;
                }
            },
            
            // Cancel sent friend request
            cancelFriendRequest: async function(requestId) {
                if (!currentUser) throw new Error('No user logged in');
                try {
                    await db.collection('friendRequests').doc(requestId).delete();
                    showNotification('Friend request cancelled', 'info');
                    return true;
                } catch (error) {
                    console.error('Error cancelling friend request:', error);
                    showNotification('Failed to cancel request', 'warning');
                    return false;
                }
            },
            
            // Remove friend
            removeFriend: async function(friendUid) {
                if (!currentUser) throw new Error('No user logged in');
                
                // Remove from both users' friend lists
                await db.collection('users').doc(currentUser.uid).collection('friends').doc(friendUid).delete();
                await db.collection('users').doc(friendUid).collection('friends').doc(currentUser.uid).delete();
                
                // Also remove from arrays
                await db.collection('users').doc(currentUser.uid).update({
                    friends: firebase.firestore.FieldValue.arrayRemove(friendUid)
                });
                await db.collection('users').doc(friendUid).update({
                    friends: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
                });
                
                showNotification('Friend removed', 'info');
                await loadFriendsFromFirebase(currentUser.uid);
                renderFriendsList();
                
                return true;
            },
            
            // Get all friends with stats
            getFriends: async function() {
                if (!currentUser) return [];
                
                const friendsSnapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('friends').get();
                
                const friends = [];
                for (const doc of friendsSnapshot.docs) {
                    const friendData = doc.data();
                    const progress = await this.getFriendProgress(friendData.friendUid);
                    friends.push({
                        uid: friendData.friendUid,
                        username: friendData.username,
                        displayName: friendData.displayName,
                        addedAt: friendData.addedAt,
                        ...progress
                    });
                }
                
                return friends;
            },
            
            // Get friend's progress/stats
            getFriendProgress: async function(friendUid) {
                try {
                    const userDoc = await db.collection('users').doc(friendUid).get();
                    if (!userDoc.exists) return {};
                    
                    const data = userDoc.data();
                    return {
                        totalWorkouts: data.totalWorkouts || 0,
                        level: data.level || 1,
                        xp: data.xp || 0,
                        streak: data.streak || 0,
                        lastActive: data.lastActive || null,
                        achievements: data.achievements || []
                    };
                } catch (error) {
                    console.error('Error fetching friend progress:', error);
                    return {};
                }
            },
            
            // Listen to friend requests (real-time)
            listenToFriendRequests: function(callback) {
                if (!currentUser) return;
                
                // Incoming requests
                const incomingUnsub = db.collection('friendRequests')
                    .where('toUid', '==', currentUser.uid)
                    .where('status', '==', 'pending')
                    .onSnapshot(snapshot => {
                        this.friendRequests.incoming = snapshot.docs.map(doc => ({
                            id: doc.id,
                            type: 'incoming',
                            ...doc.data()
                        }));
                        if (callback) callback(this.friendRequests);
                        this.renderFriendRequests();
                    });
                
                // Outgoing requests
                const outgoingUnsub = db.collection('friendRequests')
                    .where('fromUid', '==', currentUser.uid)
                    .where('status', '==', 'pending')
                    .onSnapshot(snapshot => {
                        this.friendRequests.outgoing = snapshot.docs.map(doc => ({
                            id: doc.id,
                            type: 'outgoing',
                            ...doc.data()
                        }));
                        if (callback) callback(this.friendRequests);
                        this.renderFriendRequests();
                    });
                
                this.unsubscribers.push(incomingUnsub, outgoingUnsub);
            },
            
            // Listen to friends list (real-time)
            listenToFriends: function(callback) {
                if (!currentUser) return;
                
                const unsub = db.collection('users').doc(currentUser.uid).collection('friends')
                    .onSnapshot(async snapshot => {
                        const friends = [];
                        for (const doc of snapshot.docs) {
                            const friendData = doc.data();
                            const progress = await this.getFriendProgress(friendData.friendUid);
                            friends.push({
                                uid: friendData.friendUid,
                                username: friendData.username,
                                displayName: friendData.displayName,
                                addedAt: friendData.addedAt,
                                ...progress
                            });
                        }
                        
                        this.friends = friends;
                        appState.friends = friends;
                        if (callback) callback(friends);
                        renderFriendsList();
                        renderLeaderboard();
                    });
                
                this.unsubscribers.push(unsub);
            },
            
            // Render friend requests UI
            renderFriendRequests: function() {
                const container = document.getElementById('friendRequestsContainer');
                const emptyState = document.getElementById('emptyPendingState');
                const badge = document.getElementById('pendingBadge');
                if (!container) return;
                
                const { incoming, outgoing } = this.friendRequests;
                const totalPending = incoming.length + outgoing.length;
                
                // Update badge count
                if (badge) {
                    if (totalPending > 0) {
                        badge.textContent = totalPending;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
                
                // Show/hide empty state
                if (totalPending === 0) {
                    container.innerHTML = '';
                    if (emptyState) emptyState.style.display = 'block';
                    return;
                }
                
                if (emptyState) emptyState.style.display = 'none';
                
                let html = '';
                
                if (incoming.length > 0) {
                    html += '<div style="margin-bottom: 20px;">';
                    html += '<div style="margin-bottom: 12px; color: var(--text-light); font-size: 12px; text-transform: uppercase; font-weight: 600;">Incoming  ' + incoming.length + '</div>';
                    incoming.forEach(req => {
                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--bg-light); border-radius: 10px; margin-bottom: 8px; border: 1px solid var(--border);">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 18px;">
                                        ${(req.fromDisplayName || req.fromUsername || 'U').charAt(0).toUpperCase()}
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; color: var(--text-dark);">${req.fromDisplayName || req.fromUsername || 'User'}</div>
                                        <div style="font-size: 12px; color: var(--text-light);">Incoming Friend Request</div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button onclick="friendsManager.acceptFriendRequest('${req.id}', ${JSON.stringify(req).replace(/"/g, '&quot;')})" style="width: 36px; height: 36px; background: #10b981; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 16px;" title="Accept"></button>
                                    <button onclick="friendsManager.declineFriendRequest('${req.id}')" style="width: 36px; height: 36px; background: #ef4444; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 16px;" title="Decline"></button>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
                
                if (outgoing.length > 0) {
                    html += '<div>';
                    html += '<div style="margin-bottom: 12px; color: var(--text-light); font-size: 12px; text-transform: uppercase; font-weight: 600;">Outgoing  ' + outgoing.length + '</div>';
                    outgoing.forEach(req => {
                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--bg-light); border-radius: 10px; margin-bottom: 8px; border: 1px solid var(--border);">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--text-light); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 18px;">
                                        ${(req.toUsername || 'U').charAt(0).toUpperCase()}
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; color: var(--text-dark);">${req.toUsername || 'User'}</div>
                                        <div style="font-size: 12px; color: var(--text-light);">Outgoing Friend Request</div>
                                    </div>
                                </div>
                                <button onclick="friendsManager.cancelFriendRequest('${req.id}')" style="padding: 8px 16px; background: transparent; color: var(--danger); border: 1px solid var(--danger); border-radius: 6px; cursor: pointer; font-weight: 600;">Cancel</button>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
                
                container.innerHTML = html;
            }
        };
        
        // Make friendsManager globally accessible
        window.friendsManager = friendsManager;

        // ==========================================
        // ENHANCED FIREBASE FUNCTIONS
        // Solo workouts, friend codes, friend requests,
        // group workouts, group challenges
        // ==========================================

        // Save/Update Friend Code in public profiles collection
        async function saveFriendCodeToPublicProfile(code) {
            if (!currentUser) throw new Error("Not logged in");
            
            const cleanCode = code.trim().toUpperCase();
            
            try {
                await db.collection('publicProfiles').doc(cleanCode).set({
                    uid: currentUser.uid,
                    displayName: appState.user.name || currentUser.displayName || 'User',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log(' Friend code saved to public profiles:', cleanCode);
                return true;
            } catch (error) {
                console.error(' Error saving friend code:', error);
                throw error;
            }
        }
        window.saveFriendCodeToPublicProfile = saveFriendCodeToPublicProfile;

        // Send friend request by code
        async function sendFriendRequest(code) {
            if (!currentUser) {
                showNotification('Please login first', 'warning');
                openAuthModal();
                return false;
            }
            
            const cleanCode = code.trim().toUpperCase();
            
            try {
                // Look up public profile by code
                const profileSnap = await db.collection('publicProfiles').doc(cleanCode).get();
                
                if (!profileSnap.exists()) {
                    // Fallback: search users collection
                    const userSnap = await db.collection('users').where('friendCode', '==', cleanCode).get();
                    
                    if (userSnap.empty) {
                        showNotification('Invalid friend code', 'warning');
                        return false;
                    }
                    
                    let toUid = null;
                    userSnap.forEach(doc => { toUid = doc.id; });
                    
                    if (toUid === currentUser.uid) {
                        showNotification('Cannot add yourself', 'warning');
                        return false;
                    }
                    
                    // Direct add (old method as fallback)
                    await addFriendByCode();
                    return true;
                }
                
                const { uid: toUid } = profileSnap.data();
                
                if (toUid === currentUser.uid) {
                    showNotification('Cannot add yourself', 'warning');
                    return false;
                }
                
                // Create friend request
                await db.collection('friendRequests').add({
                    fromUid: currentUser.uid,
                    fromName: appState.user.name || currentUser.displayName || 'User',
                    toUid: toUid,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showNotification('Friend request sent! ', 'success');
                return true;
                
            } catch (error) {
                console.error(' Error sending friend request:', error);
                showNotification('Failed to send request: ' + error.message, 'warning');
                return false;
            }
        }
        window.sendFriendRequest = sendFriendRequest;

        // Accept friend request
        async function acceptFriendRequest(requestId, otherUid) {
            if (!currentUser) return false;
            
            try {
                // Update request status
                await db.collection('friendRequests').doc(requestId).update({
                    status: 'accepted',
                    acceptedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Add to friends subcollection (both ways)
                await db.collection('users').doc(currentUser.uid).collection('friends').doc(otherUid).set({
                    friendUid: otherUid,
                    since: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                await db.collection('users').doc(otherUid).collection('friends').doc(currentUser.uid).set({
                    friendUid: currentUser.uid,
                    since: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Also update the friends array in main user doc
                await db.collection('users').doc(currentUser.uid).update({
                    friends: firebase.firestore.FieldValue.arrayUnion(otherUid)
                });
                
                await db.collection('users').doc(otherUid).update({
                    friends: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                });
                
                showNotification('Friend request accepted! ', 'success');
                await loadFriendsFromFirebase(currentUser.uid);
                renderFriendsList();
                
                return true;
            } catch (error) {
                console.error(' Error accepting friend request:', error);
                showNotification('Failed to accept request', 'warning');
                return false;
            }
        }
        window.acceptFriendRequest = acceptFriendRequest;

        // Decline friend request
        async function declineFriendRequest(requestId) {
            if (!currentUser) return false;
            
            try {
                await db.collection('friendRequests').doc(requestId).update({
                    status: 'declined',
                    declinedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showNotification('Friend request declined', 'info');
                return true;
            } catch (error) {
                console.error(' Error declining friend request:', error);
                return false;
            }
        }
        window.declineFriendRequest = declineFriendRequest;

        // Load pending friend requests
        async function loadFriendRequests() {
            if (!currentUser) return [];
            
            try {
                const snapshot = await db.collection('friendRequests')
                    .where('toUid', '==', currentUser.uid)
                    .where('status', '==', 'pending')
                    .get();
                
                const requests = [];
                snapshot.forEach(doc => {
                    requests.push({ id: doc.id, ...doc.data() });
                });
                
                console.log(' Loaded', requests.length, 'pending friend requests');
                return requests;
            } catch (error) {
                console.error(' Error loading friend requests:', error);
                return [];
            }
        }
        window.loadFriendRequests = loadFriendRequests;

        // Save solo workout entry
        async function saveSoloWorkout(workoutData) {
            if (!currentUser) {
                showNotification('Please login to save workouts', 'warning');
                return null;
            }
            
            try {
                const workoutId = 'workout_' + Date.now() + '_' + Math.random().toString(36).substring(7);
                
                await db.collection('users').doc(currentUser.uid).collection('workouts').doc(workoutId).set({
                    ...workoutData,
                    id: workoutId,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    completedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log(' Solo workout saved:', workoutId);
                showNotification('Workout saved! ', 'success');
                return workoutId;
            } catch (error) {
                console.error(' Error saving workout:', error);
                showNotification('Failed to save workout', 'warning');
                return null;
            }
        }
        window.saveSoloWorkout = saveSoloWorkout;

        // Save solo challenge entry
        async function saveSoloChallenge(challengeData) {
            if (!currentUser) {
                showNotification('Please login to save challenges', 'warning');
                return null;
            }
            
            try {
                const challengeId = 'solo_challenge_' + Date.now() + '_' + Math.random().toString(36).substring(7);
                
                await db.collection('users').doc(currentUser.uid).collection('challenges').doc(challengeId).set({
                    ...challengeData,
                    id: challengeId,
                    type: 'solo',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log(' Solo challenge saved:', challengeId);
                return challengeId;
            } catch (error) {
                console.error(' Error saving solo challenge:', error);
                return null;
            }
        }
        window.saveSoloChallenge = saveSoloChallenge;

        // Create group session (workout or challenge)
        async function createGroupSession(title, memberUids, type = 'workout') {
            if (!currentUser) {
                showNotification('Please login to create group sessions', 'warning');
                return null;
            }
            
            try {
                const sessionRef = await db.collection('sessions').add({
                    type: type, // 'workout' or 'challenge'
                    title: title,
                    createdBy: currentUser.uid,
                    createdByName: appState.user.name || currentUser.displayName || 'User',
                    members: [currentUser.uid, ...memberUids],
                    status: 'active',
                    inviteCode: 'GRP-' + Math.random().toString(36).substring(2, 8).toUpperCase(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log(' Group session created:', sessionRef.id);
                showNotification(`Group ${type} created! Share the invite code with friends.`, 'success');
                return sessionRef.id;
            } catch (error) {
                console.error(' Error creating group session:', error);
                showNotification('Failed to create group session', 'warning');
                return null;
            }
        }
        window.createGroupSession = createGroupSession;

        // Join group session by invite code
        async function joinGroupSession(inviteCode) {
            if (!currentUser) {
                showNotification('Please login to join sessions', 'warning');
                return false;
            }
            
            try {
                const snapshot = await db.collection('sessions')
                    .where('inviteCode', '==', inviteCode.trim().toUpperCase())
                    .get();
                
                if (snapshot.empty) {
                    showNotification('Session not found. Check the invite code.', 'warning');
                    return false;
                }
                
                let sessionDoc = null;
                snapshot.forEach(doc => { sessionDoc = doc; });
                
                const sessionId = sessionDoc.id;
                const sessionData = sessionDoc.data();
                
                if (sessionData.members.includes(currentUser.uid)) {
                    showNotification('You are already in this session!', 'info');
                    return false;
                }
                
                await db.collection('sessions').doc(sessionId).update({
                    members: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                });
                
                showNotification(`Joined "${sessionData.title}"! `, 'success');
                return true;
            } catch (error) {
                console.error(' Error joining session:', error);
                showNotification('Failed to join session', 'warning');
                return false;
            }
        }
        window.joinGroupSession = joinGroupSession;

        // Log entry to group session (progress update)
        async function logGroupEntry(sessionId, entryData) {
            if (!currentUser) return null;
            
            try {
                const entryRef = await db.collection('sessions').doc(sessionId).collection('entries').add({
                    uid: currentUser.uid,
                    userName: appState.user.name || currentUser.displayName || 'User',
                    ...entryData,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log(' Group entry logged:', entryRef.id);
                return entryRef.id;
            } catch (error) {
                console.error(' Error logging group entry:', error);
                return null;
            }
        }
        window.logGroupEntry = logGroupEntry;

        // Load group sessions for current user
        async function loadGroupSessions() {
            if (!currentUser) return [];
            
            try {
                const snapshot = await db.collection('sessions')
                    .where('members', 'array-contains', currentUser.uid)
                    .get();
                
                const sessions = [];
                snapshot.forEach(doc => {
                    sessions.push({ id: doc.id, ...doc.data() });
                });
                
                console.log(' Loaded', sessions.length, 'group sessions');
                return sessions;
            } catch (error) {
                console.error(' Error loading group sessions:', error);
                return [];
            }
        }
        window.loadGroupSessions = loadGroupSessions;

        // Load entries for a group session
        async function loadGroupEntries(sessionId) {
            try {
                const snapshot = await db.collection('sessions').doc(sessionId).collection('entries')
                    .orderBy('createdAt', 'desc')
                    .limit(50)
                    .get();
                
                const entries = [];
                snapshot.forEach(doc => {
                    entries.push({ id: doc.id, ...doc.data() });
                });
                
                return entries;
            } catch (error) {
                console.error(' Error loading group entries:', error);
                return [];
            }
        }
        window.loadGroupEntries = loadGroupEntries;

        // ==========================================
        // CHALLENGE PLANNER FUNCTIONS
        // ==========================================
        
        // Challenge Planner State
        let challengePlannerState = {
            challenges: [],
            activeChallengeId: null,
            currentView: 'month',
            currentDate: new Date(),
            dailyGrindTracking: {}, // Stores {challengeId: {lastCheckin: timestamp, streak: number}}
            templates: {
                '75hard': {
                    name: '75 Hard Challenge',
                    duration: 75,
                    tasks: [
                        { name: 'Workout #1 (45 min)', type: 'workout', required: true },
                        { name: 'Workout #2 (45 min)', type: 'workout', required: true },
                        { name: 'Drink 1 gallon water', type: 'hydration', required: true },
                        { name: 'Read 10 pages', type: 'reading', required: true },
                        { name: 'Follow diet', type: 'nutrition', required: true },
                        { name: 'Progress photo', type: 'photo', required: true }
                    ],
                    allowRestDays: false,
                    difficulty: 'extreme'
                },
                '30dayshred': {
                    name: '30 Day Shred',
                    duration: 30,
                    tasks: [
                        { name: '20-minute HIIT workout', type: 'workout', required: true },
                        { name: 'Log meals', type: 'nutrition', required: true }
                    ],
                    allowRestDays: true,
                    difficulty: 'hard'
                },
                'couch25k': {
                    name: 'Couch to 5K',
                    duration: 63,
                    tasks: [
                        { name: 'Running workout', type: 'workout', required: true, frequency: 3 }
                    ],
                    allowRestDays: true,
                    difficulty: 'beginner'
                },
                '21dayhabit': {
                    name: '21 Day Habit Builder',
                    duration: 21,
                    tasks: [
                        { name: 'Practice habit', type: 'custom', required: true }
                    ],
                    allowRestDays: false,
                    difficulty: 'medium'
                },
                'morningroutine': {
                    name: 'Morning Routine Challenge',
                    duration: 30,
                    tasks: [
                        { name: '10 min meditation', type: 'mindfulness', required: true },
                        { name: '20 min exercise', type: 'workout', required: true },
                        { name: 'Healthy breakfast', type: 'nutrition', required: true },
                        { name: '5 min journaling', type: 'journaling', required: true }
                    ],
                    allowRestDays: false,
                    difficulty: 'easy'
                },
                'hydration': {
                    name: 'Hydration Challenge',
                    duration: 14,
                    tasks: [
                        { name: 'Drink 8 glasses water', type: 'hydration', required: true }
                    ],
                    allowRestDays: false,
                    difficulty: 'easy'
                }
            }
        };

        // Show Challenge Tab
        function showChallengeTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.challenge-nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(tabName === 'my-challenges' ? 'myChallengesTab' :
                                   tabName === 'create' ? 'createTab' :
                                   tabName === 'templates' ? 'templatesTab' :
                                   tabName === 'calendar' ? 'calendarTab' : 'notificationsTab').classList.add('active');
            
            // Show/hide content
            document.querySelectorAll('.challenge-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(tabName + '-tab').style.display = 'block';
            
            // Load content if needed
            if (tabName === 'my-challenges') {
                renderMyChallenges();
            } else if (tabName === 'calendar') {
                renderCalendar();
            } else if (tabName === 'notifications') {
                renderNotifications();
            }
        }

        // Parse Challenge from Natural Language
        function parseChallenge() {
            const description = document.getElementById('challengeDescription').value.trim();
            if (!description) {
                showNotification('Please describe your challenge', 'warning');
                return;
            }

            // Simple NLP parsing
            const parsed = {
                name: '',
                duration: 30,
                tasks: [],
                startDate: new Date().toISOString().split('T')[0]
            };

            // Extract duration
            const durationMatch = description.match(/(\d+)\s*(day|week|month)/i);
            if (durationMatch) {
                const num = parseInt(durationMatch[1]);
                const unit = durationMatch[2].toLowerCase();
                parsed.duration = unit === 'week' ? num * 7 : unit === 'month' ? num * 30 : num;
            }

            // Extract challenge name from first sentence or key phrases
            const firstSentence = description.split(/[.!?]/)[0];
            parsed.name = firstSentence.length > 50 ? firstSentence.substring(0, 47) + '...' : firstSentence;

            // Extract tasks
            const taskKeywords = {
                'workout|exercise|train|gym': 'workout',
                'water|hydration|drink': 'hydration',
                'read|book|pages': 'reading',
                'meditate|meditation|mindfulness': 'mindfulness',
                'yoga': 'yoga',
                'run|running|jog': 'running',
                'diet|nutrition|eat|meal': 'nutrition',
                'photo|picture|progress pic': 'photo',
                'journal|write': 'journaling'
            };

            for (const [keywords, type] of Object.entries(taskKeywords)) {
                const regex = new RegExp(keywords, 'i');
                if (regex.test(description)) {
                    const match = description.match(new RegExp(`(${keywords})[^.!?]*`, 'i'));
                    if (match) {
                        parsed.tasks.push({
                            name: match[0].trim(),
                            type: type,
                            required: true
                        });
                    }
                }
            }

            if (parsed.tasks.length === 0) {
                parsed.tasks.push({ name: 'Daily task', type: 'custom', required: true });
            }

            // Display preview
            displayParsedChallenge(parsed);
        }

        // Display Parsed Challenge
        function displayParsedChallenge(parsed) {
            document.getElementById('challengeName').value = parsed.name;
            document.getElementById('challengeDuration').value = parsed.duration;
            document.getElementById('challengeStartDate').value = parsed.startDate;

            const tasksList = document.getElementById('challengeTasksList');
            tasksList.innerHTML = parsed.tasks.map((task, index) => `
                <div style="display: flex; gap: 10px; align-items: center; padding: 10px; background: #f9fafb; border-radius: 8px;">
                    <input type="text" value="${task.name}" class="form-input" style="flex: 1;" id="task-${index}">
                    <button class="btn" onclick="removeTask(${index})" style="background: #ef4444; color: white; padding: 8px 12px;"></button>
                </div>
            `).join('');

            document.getElementById('parsedChallengePreview').style.display = 'block';
            showNotification('Challenge parsed successfully! Review and edit below.', 'success');
        }

        // Add Challenge Task
        function addChallengeTask() {
            const tasksList = document.getElementById('challengeTasksList');
            const taskCount = tasksList.children.length;
            const newTask = document.createElement('div');
            newTask.style.cssText = 'display: flex; gap: 10px; align-items: center; padding: 10px; background: #f9fafb; border-radius: 8px;';
            newTask.innerHTML = `
                <input type="text" placeholder="New task" class="form-input" style="flex: 1;" id="task-${taskCount}">
                <button class="btn" onclick="this.parentElement.remove()" style="background: #ef4444; color: white; padding: 8px 12px;"></button>
            `;
            tasksList.appendChild(newTask);
        }

        // Voice Input for Challenge
        function startVoiceInput() {
            if (!('webkitSpeechRecognition' in window)) {
                showNotification('Voice input not supported in this browser', 'warning');
                return;
            }

            const recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;

            const btn = document.getElementById('voiceInputBtn');
            btn.textContent = ' Listening...';
            btn.disabled = true;

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('challengeDescription').value = transcript;
                parseChallenge();
            };

            recognition.onerror = () => {
                showNotification('Voice input failed. Please try again.', 'warning');
            };

            recognition.onend = () => {
                btn.textContent = ' Voice Input';
                btn.disabled = false;
            };

            recognition.start();
        }

        // Create Parsed Challenge
        async function createParsedChallenge() {
            const name = document.getElementById('challengeName').value.trim();
            const duration = parseInt(document.getElementById('challengeDuration').value);
            const startDate = document.getElementById('challengeStartDate').value;
            const allowRestDays = document.getElementById('allowRestDays').checked;
            const sendReminders = document.getElementById('sendReminders').checked;
            const trackProgress = document.getElementById('trackProgress').checked;

            if (!name || !duration || !startDate) {
                showNotification('Please fill in all required fields', 'warning');
                return;
            }

            // Collect tasks
            const tasks = [];
            document.querySelectorAll('#challengeTasksList input').forEach(input => {
                if (input.value.trim()) {
                    tasks.push({
                        name: input.value.trim(),
                        type: 'custom',
                        required: true
                    });
                }
            });

            if (tasks.length === 0) {
                showNotification('Please add at least one task', 'warning');
                return;
            }

            const challenge = {
                id: 'ch_' + Date.now(),
                name,
                duration,
                startDate,
                tasks,
                allowRestDays,
                sendReminders,
                trackProgress,
                createdAt: new Date().toISOString(),
                createdBy: currentUser?.uid || 'guest',
                participants: [currentUser?.uid || 'guest'],
                taskInstances: generateTaskInstances(tasks, duration, startDate),
                status: 'active',
                currentStreak: 0,
                longestStreak: 0
            };

            // Save to Firestore if user is logged in
            if (currentUser) {
                try {
                    await setDoc(doc(db, 'challenges', challenge.id), challenge);
                    console.log(' Challenge saved to Firestore:', challenge.id);
                } catch (error) {
                    console.error(' Error saving challenge:', error);
                }
            }

            // Add to local state
            challengePlannerState.challenges.push(challenge);
            challengePlannerState.activeChallengeId = challenge.id;
            
            // Save locally
            saveToLocalStorage('challengePlannerState', challengePlannerState);

            showNotification(`Challenge "${name}" created! `, 'success');
            showChallengeTab('my-challenges');
            
            // Clear form
            document.getElementById('challengeDescription').value = '';
            document.getElementById('parsedChallengePreview').style.display = 'none';
        }

        // Generate Task Instances for each day
        function generateTaskInstances(tasks, duration, startDate) {
            const instances = [];
            const start = new Date(startDate);

            for (let day = 0; day < duration; day++) {
                const date = new Date(start);
                date.setDate(date.getDate() + day);
                const dateStr = date.toISOString().split('T')[0];

                tasks.forEach((task, taskIndex) => {
                    instances.push({
                        id: `task_${day}_${taskIndex}`,
                        taskName: task.name,
                        taskType: task.type,
                        date: dateStr,
                        completed: false,
                        completedAt: null
                    });
                });
            }

            return instances;
        }

        // Load Template
        function loadTemplate(templateId) {
            const template = challengePlannerState.templates[templateId];
            if (!template) return;

            document.getElementById('challengeName').value = template.name;
            document.getElementById('challengeDuration').value = template.duration;
            document.getElementById('challengeStartDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('allowRestDays').checked = template.allowRestDays;

            const tasksList = document.getElementById('challengeTasksList');
            tasksList.innerHTML = template.tasks.map((task, index) => `
                <div style="display: flex; gap: 10px; align-items: center; padding: 10px; background: #f9fafb; border-radius: 8px;">
                    <input type="text" value="${task.name}" class="form-input" style="flex: 1;" id="task-${index}">
                    <button class="btn" onclick="this.parentElement.remove()" style="background: #ef4444; color: white; padding: 8px 12px;"></button>
                </div>
            `).join('');

            document.getElementById('parsedChallengePreview').style.display = 'block';
            showChallengeTab('create');
            showNotification(`Template "${template.name}" loaded!`, 'success');
        }

        // Render My Challenges
        function renderMyChallenges() {
            const activeGrid = document.getElementById('activeChallengesGrid');
            const completedGrid = document.getElementById('completedChallengesGrid');
            const emptyState = document.getElementById('emptyChallengesState');

            const activeChallenges = challengePlannerState.challenges.filter(c => c.status === 'active');
            const completedChallenges = challengePlannerState.challenges.filter(c => c.status === 'completed');

            if (activeChallenges.length === 0 && completedChallenges.length === 0) {
                emptyState.style.display = 'block';
                activeGrid.innerHTML = '';
                completedGrid.innerHTML = '';
                return;
            }

            emptyState.style.display = 'none';

            // Render active challenges
            activeGrid.innerHTML = activeChallenges.map(challenge => {
                const progress = calculateChallengeProgress(challenge);
                const needsGrindButton = challengeRequiresGrindButton(challenge);
                const grindButtonHtml = needsGrindButton ? renderGrindButton(challenge.id) : '';
                
                return `
                    <div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid var(--border);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <h4 style="margin: 0;">${challenge.name}</h4>
                            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                <span style="background: var(--primary); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                                    Day ${progress.currentDay}/${challenge.duration}
                                </span>
                                ${isGrindActiveForChallenge(challenge.id) ? '<span class="tracker-status-active"> Active</span>' : (needsGrindButton ? '<span class="tracker-status-waiting">Check In</span>' : '')}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px;">
                                <span>Progress</span>
                                <span>${progress.percentage}%</span>
                            </div>
                            <div style="background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="background: var(--success); height: 100%; width: ${progress.percentage}%; transition: width 0.3s;"></div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; margin-bottom: 15px; font-size: 14px;">
                            <span> ${challenge.currentStreak} day streak</span>
                            <span> ${progress.completedTasks}/${progress.totalTasks} tasks</span>
                        </div>

                        ${grindButtonHtml}

                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="btn btn-primary" onclick="viewChallengeDetails('${challenge.id}')" style="flex: 1; font-size: 14px;">
                                View Details
                            </button>
                            <button class="btn" onclick="shareChallengeInvite('${challenge.id}')" style="font-size: 14px;">
                                 Share
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            // Render completed challenges
            completedGrid.innerHTML = completedChallenges.map(challenge => {
                const progress = calculateChallengeProgress(challenge);
                return `
                    <div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid var(--success); opacity: 0.8;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <h4 style="margin: 0;">${challenge.name}</h4>
                            <span style="background: var(--success); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                                 Completed
                            </span>
                        </div>
                        <p style="font-size: 14px; color: var(--text-light);">
                            ${progress.percentage}% completion  ${challenge.longestStreak} day streak
                        </p>
                    </div>
                `;
            }).join('');
        }

        // Calculate Challenge Progress
        function calculateChallengeProgress(challenge) {
            const today = new Date().toISOString().split('T')[0];
            const startDate = new Date(challenge.startDate);
            const currentDate = new Date(today);
            const daysPassed = Math.floor((currentDate - startDate) / (1000 * 60 * 60 * 24));
            
            const completedTasks = challenge.taskInstances.filter(t => t.completed).length;
            const totalTasks = challenge.taskInstances.length;
            const percentage = Math.round((completedTasks / totalTasks) * 100);

            return {
                currentDay: Math.min(daysPassed + 1, challenge.duration),
                completedTasks,
                totalTasks,
                percentage
            };
        }

        // View Challenge Details
        function viewChallengeDetails(challengeId) {
            const challenge = challengePlannerState.challenges.find(c => c.id === challengeId);
            if (!challenge) return;

            const modal = document.getElementById('customModal');
            const content = document.getElementById('modalContent');
            const progress = calculateChallengeProgress(challenge);
            const needsGrindButton = challengeRequiresGrindButton(challenge);

            // Group tasks by date
            const tasksByDate = {};
            challenge.taskInstances.forEach(task => {
                if (!tasksByDate[task.date]) {
                    tasksByDate[task.date] = [];
                }
                tasksByDate[task.date].push(task);
            });

            content.innerHTML = `
                <h2>${challenge.name}</h2>
                <div style="margin: 20px 0;">
                    <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 80px; background: #f9fafb; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: var(--primary);">${progress.currentDay}/${challenge.duration}</div>
                            <div style="font-size: 14px; color: var(--text-light); margin-top: 5px;">Days</div>
                        </div>
                        <div style="flex: 1; min-width: 80px; background: #f9fafb; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: var(--success);">${progress.percentage}%</div>
                            <div style="font-size: 14px; color: var(--text-light); margin-top: 5px;">Complete</div>
                        </div>
                        <div style="flex: 1; min-width: 80px; background: #f9fafb; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: var(--warning);"> ${challenge.currentStreak}</div>
                            <div style="font-size: 14px; color: var(--text-light); margin-top: 5px;">Streak</div>
                        </div>
                    </div>

                    ${needsGrindButton ? `
                    <div class="daily-tracker-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0; color: white;"> Daily Check-In</h3>
                            ${isGrindActiveForChallenge(challengeId) ? '<span class="tracker-status-active"> Checked In</span>' : '<span class="tracker-status-waiting"> Waiting</span>'}
                        </div>
                        <p style="opacity: 0.9; font-size: 14px; margin-bottom: 15px;">
                            For non-physical tasks like hydration, reading, and nutrition - click below to confirm you're staying on track!
                        </p>
                        ${renderGrindButton(challengeId)}
                    </div>
                    ` : ''}

                    <h3 style="margin-top: 30px; margin-bottom: 15px;">Today's Tasks</h3>
                    <div id="todayTasksDetail">
                        ${renderTodayTasks(challenge)}
                    </div>
                </div>
            `;

            modal.style.display = 'flex';
        }

        // Render Today's Tasks
        function renderTodayTasks(challenge) {
            const today = new Date().toISOString().split('T')[0];
            const todayTasks = challenge.taskInstances.filter(t => t.date === today);

            if (todayTasks.length === 0) {
                return '<p style="color: var(--text-light); text-align: center; padding: 20px;">No tasks scheduled for today</p>';
            }

            return todayTasks.map(task => `
                <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: ${task.completed ? '#f0fdf4' : 'white'}; border: 2px solid ${task.completed ? 'var(--success)' : 'var(--border)'}; border-radius: 8px; margin-bottom: 10px;">
                    <input type="checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTaskCompletion('${challenge.id}', '${task.id}')" style="width: 20px; height: 20px; cursor: pointer;">
                    <span style="flex: 1; ${task.completed ? 'text-decoration: line-through; color: var(--text-light);' : ''}">${task.taskName}</span>
                    ${task.completed ? `<span style="color: var(--success); font-size: 12px;">${new Date(task.completedAt).toLocaleTimeString()}</span>` : ''}
                </div>
            `).join('');
        }

        // Toggle Task Completion
        async function toggleTaskCompletion(challengeId, taskId) {
            const challenge = challengePlannerState.challenges.find(c => c.id === challengeId);
            if (!challenge) return;

            const task = challenge.taskInstances.find(t => t.id === taskId);
            if (!task) return;

            task.completed = !task.completed;
            task.completedAt = task.completed ? new Date().toISOString() : null;

            // Update streak
            updateChallengeStreak(challenge);

            // Save to Firestore
            if (currentUser) {
                try {
                    await updateDoc(doc(db, 'challenges', challengeId), {
                        taskInstances: challenge.taskInstances,
                        currentStreak: challenge.currentStreak,
                        longestStreak: challenge.longestStreak
                    });
                } catch (error) {
                    console.error('Error updating challenge:', error);
                }
            }

            // Save locally
            saveToLocalStorage('challengePlannerState', challengePlannerState);

            // Refresh view
            viewChallengeDetails(challengeId);
            showNotification(task.completed ? 'Task completed! ' : 'Task unchecked', 'success');
        }

        // Update Challenge Streak
        function updateChallengeStreak(challenge) {
            const today = new Date().toISOString().split('T')[0];
            const todayTasks = challenge.taskInstances.filter(t => t.date === today);
            const allTodayComplete = todayTasks.length > 0 && todayTasks.every(t => t.completed);

            if (allTodayComplete) {
                challenge.currentStreak++;
                if (challenge.currentStreak > challenge.longestStreak) {
                    challenge.longestStreak = challenge.currentStreak;
                }
            }
        }

        // Physical task types (auto-tracked based on workout completion)
        const physicalTaskTypes = ['workout', 'exercise', 'cardio', 'strength', 'yoga', 'running', 'walking', 'stretching'];
        
        // Non-physical task types requiring manual "Stay on the Grind" check-in
        const manualCheckinTaskTypes = ['hydration', 'reading', 'nutrition', 'mindfulness', 'journaling', 'meditation', 'custom', 'diet', 'sleep', 'habit'];

        // Check if a challenge has any non-physical tasks requiring daily check-in
        function challengeRequiresGrindButton(challenge) {
            if (!challenge.taskInstances) return false;
            const taskTypes = [...new Set(challenge.taskInstances.map(t => t.taskType))];
            return taskTypes.some(type => manualCheckinTaskTypes.includes(type));
        }

        // Check if grind button was clicked within last 24 hours for a challenge
        function isGrindActiveForChallenge(challengeId) {
            const tracking = challengePlannerState.dailyGrindTracking[challengeId];
            if (!tracking || !tracking.lastCheckin) return false;
            
            const lastCheckin = new Date(tracking.lastCheckin);
            const now = new Date();
            const hoursSinceCheckin = (now - lastCheckin) / (1000 * 60 * 60);
            
            return hoursSinceCheckin < 24;
        }

        // Get remaining time until grind resets
        function getGrindTimeRemaining(challengeId) {
            const tracking = challengePlannerState.dailyGrindTracking[challengeId];
            if (!tracking || !tracking.lastCheckin) return null;
            
            const lastCheckin = new Date(tracking.lastCheckin);
            const resetTime = new Date(lastCheckin.getTime() + 24 * 60 * 60 * 1000);
            const now = new Date();
            
            if (now >= resetTime) return null;
            
            const remaining = resetTime - now;
            const hours = Math.floor(remaining / (1000 * 60 * 60));
            const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
            
            return { hours, minutes, resetTime };
        }

        // Handle "Stay on the Grind" button click
        async function stayOnTheGrind(challengeId) {
            const challenge = challengePlannerState.challenges.find(c => c.id === challengeId);
            if (!challenge) return;

            // Check if already active
            if (isGrindActiveForChallenge(challengeId)) {
                showNotification('Already checked in! Keep grinding! ', 'info');
                return;
            }

            // Initialize tracking if needed
            if (!challengePlannerState.dailyGrindTracking[challengeId]) {
                challengePlannerState.dailyGrindTracking[challengeId] = {
                    lastCheckin: null,
                    totalCheckins: 0,
                    currentStreak: 0,
                    longestStreak: 0
                };
            }

            const tracking = challengePlannerState.dailyGrindTracking[challengeId];
            const now = new Date();

            // Check if this continues a streak (within 48 hours of last checkin)
            if (tracking.lastCheckin) {
                const lastCheckin = new Date(tracking.lastCheckin);
                const hoursSinceLast = (now - lastCheckin) / (1000 * 60 * 60);
                if (hoursSinceLast <= 48) {
                    tracking.currentStreak++;
                } else {
                    tracking.currentStreak = 1; // Reset streak
                }
            } else {
                tracking.currentStreak = 1;
            }

            tracking.lastCheckin = now.toISOString();
            tracking.totalCheckins++;
            if (tracking.currentStreak > tracking.longestStreak) {
                tracking.longestStreak = tracking.currentStreak;
            }

            // Auto-complete non-physical tasks for today
            const today = now.toISOString().split('T')[0];
            let tasksCompleted = 0;
            challenge.taskInstances.forEach(task => {
                if (task.date === today && manualCheckinTaskTypes.includes(task.taskType) && !task.completed) {
                    task.completed = true;
                    task.completedAt = now.toISOString();
                    tasksCompleted++;
                }
            });

            // Save to Firestore
            if (currentUser) {
                try {
                    await updateDoc(doc(db, 'challenges', challengeId), {
                        taskInstances: challenge.taskInstances,
                        currentStreak: challenge.currentStreak,
                        longestStreak: challenge.longestStreak
                    });
                    
                    // Save tracking data
                    await setDoc(doc(db, 'users', currentUser.uid, 'grindTracking', challengeId), tracking);
                } catch (error) {
                    console.error('Error saving grind check-in:', error);
                }
            }

            // Save locally
            saveToLocalStorage('challengePlannerState', challengePlannerState);

            // Show celebration notification
            showNotification(` STAY ON THE GRIND! ${tasksCompleted} tasks auto-completed! Streak: ${tracking.currentStreak} days!`, 'success');

            // Refresh the view
            if (document.getElementById('customModal').style.display === 'flex') {
                viewChallengeDetails(challengeId);
            }
            renderMyChallenges();
        }

        // Render grind button for a challenge
        function renderGrindButton(challengeId) {
            const isActive = isGrindActiveForChallenge(challengeId);
            const timeRemaining = getGrindTimeRemaining(challengeId);
            const tracking = challengePlannerState.dailyGrindTracking[challengeId] || { currentStreak: 0 };

            if (isActive && timeRemaining) {
                return `
                    <div style="margin-top: 15px;">
                        <button class="grind-button" disabled>
                             GRINDING! Streak: ${tracking.currentStreak} days 
                        </button>
                        <div class="grind-timer">
                             Resets in ${timeRemaining.hours}h ${timeRemaining.minutes}m
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div style="margin-top: 15px;">
                        <button class="grind-button" onclick="stayOnTheGrind('${challengeId}')">
                             STAY ON THE GRIND 
                        </button>
                        <div class="grind-timer">
                            Click daily to track non-physical challenges (hydration, reading, etc.)
                        </div>
                    </div>
                `;
            }
        }

        // Share Challenge Invite
        function shareChallengeInvite(challengeId) {
            const challenge = challengePlannerState.challenges.find(c => c.id === challengeId);
            if (!challenge) return;

            const inviteCode = `FITQUEST-${challengeId.substring(3, 9).toUpperCase()}`;
            const inviteText = `Join my "${challenge.name}" challenge on FitQuest! Use invite code: ${inviteCode}`;

            // Copy to clipboard
            navigator.clipboard.writeText(inviteText).then(() => {
                showNotification('Invite code copied to clipboard! ', 'success');
            }).catch(() => {
                showNotification('Invite code: ' + inviteCode, 'info');
            });
        }

        // Calendar Navigation
        function changeCalendarView(view) {
            challengePlannerState.currentView = view;
            document.querySelectorAll('#monthViewBtn, #weekViewBtn, #dayViewBtn').forEach(btn => {
                btn.style.background = '';
                btn.style.color = '';
            });
            document.getElementById(view + 'ViewBtn').style.background = 'var(--primary)';
            document.getElementById(view + 'ViewBtn').style.color = 'white';
            renderCalendar();
        }

        function navigateCalendar(direction) {
            const current = challengePlannerState.currentDate;
            if (challengePlannerState.currentView === 'month') {
                current.setMonth(current.getMonth() + direction);
            } else if (challengePlannerState.currentView === 'week') {
                current.setDate(current.getDate() + (direction * 7));
            } else {
                current.setDate(current.getDate() + direction);
            }
            renderCalendar();
        }

        // Render Calendar
        function renderCalendar() {
            const title = document.getElementById('calendarTitle');
            const grid = document.getElementById('calendarGrid');
            const current = challengePlannerState.currentDate;

            if (challengePlannerState.currentView === 'month') {
                title.textContent = current.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                grid.innerHTML = renderMonthView(current);
            } else if (challengePlannerState.currentView === 'week') {
                const weekStart = new Date(current);
                weekStart.setDate(current.getDate() - current.getDay());
                title.textContent = `Week of ${weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
                grid.innerHTML = renderWeekView(weekStart);
            } else {
                title.textContent = current.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
                grid.innerHTML = renderDayView(current);
            }

            renderTodayTasksList();
        }

        function renderMonthView(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            let html = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px;">';
            
            // Day headers
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                html += `<div style="text-align: center; font-weight: bold; padding: 10px; background: #f9fafb;">${day}</div>`;
            });

            // Empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                html += '<div></div>';
            }

            // Day cells
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const tasks = getTasksForDate(dateStr);
                const completedCount = tasks.filter(t => t.completed).length;
                const isToday = dateStr === new Date().toISOString().split('T')[0];

                html += `
                    <div style="min-height: 80px; padding: 8px; border: 2px solid ${isToday ? 'var(--primary)' : 'var(--border)'}; border-radius: 8px; cursor: pointer; background: ${isToday ? '#f0f9ff' : 'white'};" onclick="selectDate('${dateStr}')">
                        <div style="font-weight: ${isToday ? 'bold' : 'normal'}; margin-bottom: 5px;">${day}</div>
                        ${tasks.length > 0 ? `<div style="font-size: 11px; color: ${completedCount === tasks.length ? 'var(--success)' : 'var(--text-light)'};">${completedCount}/${tasks.length} tasks</div>` : ''}
                    </div>
                `;
            }

            html += '</div>';
            return html;
        }

        function renderWeekView(startDate) {
            let html = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px;">';
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                const tasks = getTasksForDate(dateStr);
                const isToday = dateStr === new Date().toISOString().split('T')[0];

                html += `
                    <div style="padding: 15px; border: 2px solid ${isToday ? 'var(--primary)' : 'var(--border)'}; border-radius: 8px; background: ${isToday ? '#f0f9ff' : 'white'};">
                        <div style="font-weight: bold; margin-bottom: 10px;">${date.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric' })}</div>
                        ${tasks.map(t => `<div style="font-size: 12px; padding: 5px; margin: 3px 0; background: ${t.completed ? 'var(--success)' : '#f9fafb'}; color: ${t.completed ? 'white' : 'inherit'}; border-radius: 4px;">${t.taskName}</div>`).join('')}
                    </div>
                `;
            }

            html += '</div>';
            return html;
        }

        function renderDayView(date) {
            const dateStr = date.toISOString().split('T')[0];
            const tasks = getTasksForDate(dateStr);

            if (tasks.length === 0) {
                return '<p style="text-align: center; padding: 40px; color: var(--text-light);">No tasks scheduled for this day</p>';
            }

            return tasks.map(task => {
                const challenge = challengePlannerState.challenges.find(c => 
                    c.taskInstances.some(t => t.id === task.id)
                );
                return `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 15px; background: ${task.completed ? '#f0fdf4' : 'white'}; border: 2px solid ${task.completed ? 'var(--success)' : 'var(--border)'}; border-radius: 8px; margin-bottom: 10px;">
                        <input type="checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTaskCompletion('${challenge.id}', '${task.id}')" style="width: 20px; height: 20px;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; ${task.completed ? 'text-decoration: line-through;' : ''}">${task.taskName}</div>
                            <div style="font-size: 12px; color: var(--text-light); margin-top: 3px;">${challenge.name}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getTasksForDate(dateStr) {
            const allTasks = [];
            challengePlannerState.challenges.forEach(challenge => {
                const tasks = challenge.taskInstances.filter(t => t.date === dateStr);
                allTasks.push(...tasks);
            });
            return allTasks;
        }

        function selectDate(dateStr) {
            challengePlannerState.currentDate = new Date(dateStr);
            changeCalendarView('day');
        }

        function renderTodayTasksList() {
            const today = new Date().toISOString().split('T')[0];
            const container = document.getElementById('todayTasksList');
            const tasks = getTasksForDate(today);

            if (tasks.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--text-light);">No tasks scheduled for today</p>';
                return;
            }

            container.innerHTML = tasks.map(task => {
                const challenge = challengePlannerState.challenges.find(c => 
                    c.taskInstances.some(t => t.id === task.id)
                );
                return `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: ${task.completed ? '#f0fdf4' : 'white'}; border: 2px solid ${task.completed ? 'var(--success)' : 'var(--border)'}; border-radius: 8px; margin-bottom: 10px;">
                        <input type="checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTaskCompletion('${challenge.id}', '${task.id}')" style="width: 20px; height: 20px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; ${task.completed ? 'text-decoration: line-through;' : ''}">${task.taskName}</div>
                            <div style="font-size: 12px; color: var(--text-light); margin-top: 3px;">${challenge.name}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Notifications
        function toggleNotifications() {
            const enabled = document.getElementById('enableNotifications').checked;
            document.getElementById('notificationTimePicker').style.display = enabled ? 'block' : 'none';

            if (enabled && 'Notification' in window) {
                Notification.requestPermission();
            }
        }

        function saveNotificationSettings() {
            const time = document.getElementById('reminderTime').value;
            localStorage.setItem('challengeReminderTime', time);
            showNotification('Notification settings saved!', 'success');
        }

        function renderNotifications() {
            const container = document.getElementById('notificationsList');
            container.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--text-light);">No recent notifications</p>';
        }

        // Load challenges from Firestore
        async function loadChallengesFromFirebase() {
            if (!currentUser) return;

            try {
                const challengesQuery = query(
                    collection(db, 'challenges'),
                    where('participants', 'array-contains', currentUser.uid)
                );

                const snapshot = await getDocs(challengesQuery);
                const challenges = [];
                
                snapshot.forEach(doc => {
                    challenges.push({ ...doc.data(), id: doc.id });
                });

                challengePlannerState.challenges = challenges;
                saveToLocalStorage('challengePlannerState', challengePlannerState);
                
                console.log(' Loaded', challenges.length, 'challenges from Firestore');
            } catch (error) {
                console.error('Error loading challenges:', error);
            }
        }

        // Helper: Save to localStorage
        function saveToLocalStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error('LocalStorage save error:', e);
            }
        }

        // Helper: Load from localStorage
        function loadFromLocalStorage(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (e) {
                console.error('LocalStorage load error:', e);
                return null;
            }
        }

        // Initialize Challenge Planner on page load
        const savedChallengeState = loadFromLocalStorage('challengePlannerState');
        if (savedChallengeState) {
            challengePlannerState = { ...challengePlannerState, ...savedChallengeState };
        }

        // ==========================================
        // END CHALLENGE PLANNER FUNCTIONS
        // ==========================================

        // Override saveData to use Firebase when user is logged in
        const originalSaveData = saveData;
        saveData = function() {
            if (currentUser) {
                saveDataToFirebase();
            } else {
                originalSaveData();
            }
        };
        
        // ==========================================
        // EXPORT FUNCTIONS TO GLOBAL SCOPE FOR ONCLICK
        // ==========================================
        window.openAuthModal = openAuthModal;
        window.toggleUserMenu = toggleUserMenu;
        window.openMusicPlayer = openMusicPlayer;
        window.completeWorkout = completeWorkout;
        window.showChallengeTab = showChallengeTab;
        window.parseChallenge = parseChallenge;
        window.startVoiceInput = startVoiceInput;
        window.addChallengeTask = addChallengeTask;
        window.createParsedChallenge = createParsedChallenge;
        window.loadTemplate = loadTemplate;
        window.changeCalendarView = changeCalendarView;
        window.navigateCalendar = navigateCalendar;
        window.toggleNotifications = toggleNotifications;
        window.saveNotificationSettings = saveNotificationSettings;
        window.toggleTaskCompletion = toggleTaskCompletion;
        window.viewChallengeDetails = viewChallengeDetails;
        window.shareChallengeInvite = shareChallengeInvite;
        window.selectDate = selectDate;
        window.downloadQuickPhoto = downloadQuickPhoto;
        window.clearQuickPhoto = clearQuickPhoto;
        window.openProgressUpload = openProgressUpload;
        window.viewSlideshow = viewSlideshow;
        window.comparePhotos = comparePhotos;
        window.closeProgressUpload = closeProgressUpload;
        window.closeSlideshow = closeSlideshow;
        window.previousSlide = previousSlide;
        window.nextSlide = nextSlide;
        window.toggleAutoplay = toggleAutoplay;
        window.closeComparison = closeComparison;
        window.copyFriendCode = copyFriendCode;
        window.addFriend = addFriend;
        window.showLeaderboard = showLeaderboard;
        window.shareProgress = shareProgress;
        window.viewFriendProgress = viewFriendProgress;
        window.createChallenge = createChallenge;
        window.sendMessage = sendMessage;
        window.uploadImage = uploadImage;
        window.handleImageUpload = handleImageUpload;
        window.removeUploadedImage = removeUploadedImage;
        window.handleChatKeypress = handleChatKeypress;
        window.autoResize = autoResize;
        window.requestCameraPermission = requestCameraPermission;
        window.uploadBodyPhoto = uploadBodyPhoto;
        window.handleBodyPhotoUpload = handleBodyPhotoUpload;
        window.handleWebcamCapture = handleWebcamCapture;
        window.captureWebcamPhoto = captureWebcamPhoto;
        window.retakeWebcamPhoto = retakeWebcamPhoto;
        window.confirmWebcamPhoto = confirmWebcamPhoto;
        window.closeWebcamModal = closeWebcamModal;
        window.saveBodyAnalysis = saveBodyAnalysis;
        window.uploadProgressPhoto = uploadProgressPhoto;
        window.submitProgressPhoto = submitProgressPhoto;
        window.addExercise = addExercise;
        window.toggleExercise = toggleExercise;
        window.removeExercise = removeExercise;
        window.changeNutritionPlan = changeNutritionPlan;
        window.updateCalorieGoal = updateCalorieGoal;
        window.openCreatePlanModal = openCreatePlanModal;
        window.closeCreatePlanModal = closeCreatePlanModal;
        window.addPlanRequirement = addPlanRequirement;
        window.addPlanChecklist = addPlanChecklist;
        window.removeRequirement = removeRequirement;
        window.removeChecklistItem = removeChecklistItem;
        window.createWeeklyPlan = createWeeklyPlan;
        window.deletePlan = deletePlan;
        window.editPlan = editPlan;
        window.togglePlanRequirement = togglePlanRequirement;
        window.togglePlanChecklist = togglePlanChecklist;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.signOutUser = signOutUser;
        window.loadSettings = loadSettings;
        window.saveSettings = saveSettings;
        window.setWorkoutReminder = setWorkoutReminder;
        window.adjustBackgroundOpacity = adjustBackgroundOpacity;
        window.changeBackgroundImage = changeBackgroundImage;
        window.uploadCustomBackground = uploadCustomBackground;
        window.handleBackgroundUpload = handleBackgroundUpload;
        window.resetToDefault = resetToDefault;
        window.connectDevice = connectDevice;
        window.connectSpotify = connectSpotify;
        window.requestNotificationPermission = requestNotificationPermission;
        window.exportData = exportData;
        window.importData = importData;
        window.handleDataImport = handleDataImport;
        window.clearAllData = clearAllData;
        window.joinChallengeByCode = joinChallengeByCode;
    </script>
</body>
</html>
