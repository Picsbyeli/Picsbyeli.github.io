<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Burble - Brain Teasers & Riddles Platform</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <!-- Question pool manager and data -->
    <script src="scripts/question-utils.js"></script>
    <script src="scripts/questions-trivia.js"></script>
    <script src="scripts/questions-animals.js"></script>
    <script src="scripts/questions-riddles.js"></script>
    <script src="scripts/questions-emoji.js"></script>
    <script src="scripts/questions-valentine.js"></script>
    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <title>PicsByEli Games</title>
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>PicsByEli Games</title>
        <link rel="stylesheet" href="./style.css">
        <style>
            #debug-dump, pre#stateDump, pre#poolDump, pre.debug-dump, .debug-json, #pool-manager { display:none !important; }
            #topbar-player .tp-label { display:none !important; }
            .hidden { display:none !important; }
        </style>
    </head>
    <body>
        <nav>
            <button class="nav-btn" onclick="showPage(event,'trivia')">Trivia</button>
            <button class="nav-btn" onclick="showPage(event,'animal')">Animal Trivia</button>
            <button class="nav-btn" onclick="showPage(event,'riddles')">Riddles</button>
            <button class="nav-btn" onclick="showPage(event,'puzzles')">Puzzles</button>
            <button class="nav-btn" onclick="showPage(event,'leaderboard')">Leaderboard</button>
            <span id="navUser">Guest</span>
            <button id="btnAuth">Sign in</button>
            <button id="btnSignOut" style="display:none">Sign out</button>
        </nav>

        <div id="trivia" class="page hidden"><h2>Trivia</h2><pre id="trivia-run"></pre></div>
        <div id="animal" class="page hidden"><h2>Animal Trivia</h2><pre id="animal-run"></pre></div>
        <div id="riddles" class="page hidden"><h2>Riddles</h2><pre id="riddles-run"></pre></div>
        <div id="puzzles" class="page hidden"><h2>Puzzles</h2><pre id="puzzles-run"></pre></div>

        <div id="leaderboard" class="page hidden">
            <h2>üèÜ Leaderboard</h2>
            <label style="display:block;margin-bottom:4px">Game
                <select id="lbGame" aria-label="Choose game leaderboard" style="margin-left:4px">
                    <option value="trivia">Trivia</option>
                    <option value="animal">Animal Trivia</option>
                    <option value="riddles">Riddles</option>
                    <option value="puzzles">Puzzles</option>
                </select>
            </label>
            <button id="lbRefresh">Refresh</button>
            <pre id="lbRows" style="margin-top:12px"></pre>
        </div>

        <script src="./scripts/question-utils.js"></script>
        <script src="./scripts/questions-trivia.js"></script>
        <script src="./scripts/questions-animals.js"></script>
        <script src="./scripts/questions-riddles.js"></script>
        <script src="./scripts/questions-emoji.js"></script>
        <script src="./scripts/questions-valentine.js"></script>
        <script src="./scripts/questions-burble.js"></script>
        <script type="module" src="./scripts/auth.js"></script>
        <script type="module" src="./scripts/leaderboard.js"></script>
        <script type="module" src="./scripts/player-extend.js"></script>
        <script src="./scripts/app.js"></script>
        <script>
            function showPage(e,id){
                document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden'));
                const el=document.getElementById(id); if(el) el.classList.remove('hidden');
                document.querySelectorAll('nav .nav-btn').forEach(b=>b.classList.remove('active'));
                if(e && e.currentTarget) e.currentTarget.classList.add('active');
            }
            function startTriviaGame(){
                const src=(window.triviaQuestions && window.triviaQuestions.easy)||[];
                const run=window.getUniqueRun(src,'trivia_easy',10);
                document.getElementById('trivia-run').textContent=run.map(q=>q.question).join('\n');
            }
            function startAnimalTriviaGame(){
                const cat=(window.animalTriviaQuestions && window.animalTriviaQuestions.medium)||[];
                const run=window.getUniqueRun(cat,'animal_medium',10);
                document.getElementById('animal-run').textContent=run.map(q=>q.question).join('\n');
            }
            function startRiddlesGame(){
                const list=(window.riddlesData && window.riddlesData.logic && window.riddlesData.logic.medium)||[];
                const run=window.getUniqueRun(list,'riddles_logic_medium',10);
                document.getElementById('riddles-run').textContent=run.map(r=>r.riddle).join('\n');
            }
            function startPuzzlesGame(){
                const all=Object.values(window.emojiPuzzles||{}).flat();
                const run=window.getUniqueRun(all,'puzzles_all',10);
                document.getElementById('puzzles-run').textContent=run.map(p=>p.emoji+': '+p.answer).join('\n');
            }
            window.addEventListener('DOMContentLoaded',()=>{ showPage(null,'trivia'); startTriviaGame(); });
        </script>
    </body>
    </html>
                </div>
                <div class="info-card">
                    <div class="info-label">Difficulty</div>
                    <div class="info-value" id="riddles-difficulty">Medium</div>
                </div>
            </div>

            <div id="riddles-question-container">
                <div class="game-display" id="riddles-question">Click "New Riddle" to start solving brain teasers!</div>
            </div>

            <div class="input-section">
                <input type="text" class="game-input" id="riddles-input" placeholder="Type your answer..." disabled>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" id="riddles-submit" disabled>Submit Answer</button>
                <button class="btn btn-secondary" id="riddles-hint" disabled>Get Hint (-10 points)</button>
                <button class="btn btn-secondary" id="riddles-next">New Riddle</button>
            </div>

            <div id="riddles-feedback"></div>
            <div id="riddles-game-over"></div>
        </div>

        <!-- Burble Word Game -->
        <div id="burble-page" class="game-container hidden">
            <div class="game-header">
                <h1 class="game-title-main">üß© Burble Word Game</h1>
                
                <div class="difficulty-selector">
                    <span class="selector-label">Difficulty</span>
                    <div class="selector-buttons">
                        <button class="selector-btn" data-difficulty="easy">Easy (15 attempts)</button>
                        <button class="selector-btn active" data-difficulty="medium">Medium (10 attempts)</button>
                        <button class="selector-btn" data-difficulty="hard">Hard (5 attempts)</button>
                    </div>
                </div>

                <div class="category-selector">
                    <span class="selector-label">Category</span>
                    <div class="selector-buttons">
                        <button class="selector-btn active" data-category="Food">Food</button>
                        <button class="selector-btn" data-category="Animals">Animals</button>
                        <button class="selector-btn" data-category="Colors">Colors</button>
                        <button class="selector-btn" data-category="Cities">Cities</button>
                        <button class="selector-btn" data-category="Items">Items</button>
                        <button class="selector-btn" data-category="Sports">Sports</button>
                    </div>
                </div>
            </div>

            <div class="game-info">
                <div class="info-card">
                    <div class="info-label">Attempts</div>
                    <div class="info-value" id="burble-attempts">0/10</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Category</div>
                    <div class="info-value" id="burble-category">Food</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Time</div>
                    <div class="info-value timer" id="burble-timer">00:00</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Score</div>
                    <div class="info-value" id="burble-score">0</div>
                </div>
            </div>

            <div class="game-display" id="burble-display">Click "New Game" to start!</div>

            <div class="input-section">
                <input type="text" class="game-input" id="burble-input" placeholder="Enter your guess..." maxlength="20" disabled>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" id="burble-submit" disabled>Submit Guess</button>
                <button class="btn btn-secondary" id="burble-hint" disabled>Get Hint</button>
                <button class="btn btn-secondary" id="burble-new-game">New Game</button>
            </div>

            <div id="burble-feedback"></div>
            <div id="burble-game-over"></div>
        </div>

        <!-- Emoji Guess Game -->
        <div id="emoji-page" class="game-container hidden">
            <div class="game-header">
                <h1 class="game-title-main">üß© Emoji Guess</h1>
                
                <div class="difficulty-selector">
                    <span class="selector-label">Difficulty</span>
                    <div class="selector-buttons">
                        <button class="selector-btn" data-difficulty="easy">Easy</button>
                        <button class="selector-btn active" data-difficulty="medium">Medium</button>
                        <button class="selector-btn" data-difficulty="hard">Hard</button>
                    </div>
                </div>

                <div class="category-selector">
                    <span class="selector-label">Category</span>
                    <div class="selector-buttons">
                        <button class="selector-btn active" data-category="all">All</button>
                        <button class="selector-btn" data-category="movies">Movies</button>
                        <button class="selector-btn" data-category="foods">Foods</button>
                        <button class="selector-btn" data-category="animals">Animals</button>
                        <button class="selector-btn" data-category="items">Items</button>
                    </div>
                </div>
            </div>

            <div class="game-info">
                <div class="info-card">
                    <div class="info-label">Score</div>
                    <div class="info-value" id="emoji-score">0</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Hints Used</div>
                    <div class="info-value" id="emoji-hints">0</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Category</div>
                    <div class="info-value" id="emoji-category">All</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Difficulty</div>
                    <div class="info-value" id="emoji-difficulty">Medium</div>
                </div>
            </div>

            <div class="game-display emoji-display" id="emoji-display">Click "New Puzzle" to start!</div>

            <div class="input-section">
                <input type="text" class="game-input" id="emoji-input" placeholder="What does this emoji combination represent?" disabled>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" id="emoji-submit" disabled>Submit Answer</button>
                <button class="btn btn-secondary" id="emoji-hint" disabled>Get Hint (-5 points)</button>
                <button class="btn btn-secondary" id="emoji-new-puzzle">New Puzzle</button>
            </div>

            <div id="emoji-feedback"></div>
            <div id="emoji-game-over"></div>
        </div>

        <!-- Twenty Questions Game -->
        <div id="valentine-page" class="game-container hidden">
            <div class="game-header">
                <h1 class="game-title-main">üéØ Twenty Questions</h1>
                
                <div class="difficulty-selector">
                    <span class="selector-label">Difficulty</span>
                    <div class="selector-buttons">
                        <button class="selector-btn" data-difficulty="easy">Easy (8 questions)</button>
                        <button class="selector-btn active" data-difficulty="medium">Medium (6 questions)</button>
                        <button class="selector-btn" data-difficulty="hard">Hard (4 questions)</button>
                    </div>
                </div>

                <div class="category-selector">
                    <span class="selector-label">Category</span>
                    <div class="selector-buttons">
                        <button class="selector-btn active" data-category="movies">Movies</button>
                        <button class="selector-btn" data-category="animals">Animals</button>
                        <button class="selector-btn" data-category="places">Places</button>
                        <button class="selector-btn" data-category="objects">Objects</button>
                    </div>
                </div>
            </div>

            <div class="game-info">
                <div class="info-card">
                    <div class="info-label">Questions Left</div>
                    <div class="info-value" id="valentine-questions">6</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Guesses Left</div>
                    <div class="info-value" id="valentine-guesses">3</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Category</div>
                    <div class="info-value" id="valentine-category">Movies</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Score</div>
                    <div class="info-value" id="valentine-score">0</div>
                </div>
            </div>

            <div class="question-history" id="valentine-history">
                <p class="muted-center-small">Ask yes/no questions to figure out what I'm thinking of!</p>
            </div>

            <div class="input-section">
                <input type="text" class="game-input" id="valentine-question" placeholder="Ask a yes/no question..." disabled>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" id="valentine-ask" disabled>Ask Question</button>
                <button class="btn btn-secondary" id="valentine-guess" disabled>Make Guess</button>
                <button class="btn btn-secondary" id="valentine-new-game">New Game</button>
            </div>

            <div id="valentine-feedback"></div>
            <div id="valentine-game-over"></div>
        </div>

        <!-- General Trivia Game -->
        <div id="trivia-page" class="game-container hidden">
            <div class="game-header">
                <h1 class="game-title-main">üß† General Trivia</h1>
                
                <div class="difficulty-selector">
                    <span class="selector-label">Difficulty</span>
                    <div class="selector-buttons">
                        <button class="selector-btn" data-difficulty="easy">Easy</button>
                        <button class="selector-btn active" data-difficulty="medium">Medium</button>
                        <button class="selector-btn" data-difficulty="hard">Hard</button>
                    </div>
                </div>
            </div>

            <div class="game-info">
                <div class="info-card">
                    <div class="info-label">Question</div>
                    <div class="info-value" id="trivia-question-num">0/15</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Correct</div>
                    <div class="info-value" id="trivia-correct">0</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Score</div>
                    <div class="info-value" id="trivia-score">0</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Time</div>
                    <div class="info-value timer" id="trivia-timer">00:00</div>
                </div>
            </div>

            <div class="trivia-question" id="trivia-question-text">Click "Start Quiz" to begin!</div>

            <div class="trivia-options" id="trivia-options"></div>

            <div class="action-buttons">
                <button class="btn btn-primary" id="trivia-submit" disabled>Submit Answer</button>
                <button class="btn btn-secondary" id="trivia-next" disabled>Next Question</button>
                <button class="btn btn-secondary" id="trivia-start">Start Quiz</button>
            </div>

            <div id="trivia-feedback"></div>
            <div id="trivia-game-over"></div>
        </div>

        <!-- Animal Trivia Game -->
        <div id="animal-trivia-page" class="game-container hidden">
            <div class="game-header">
                <h1 class="game-title-main">ü¶Å Animal Trivia</h1>
                
                <div class="difficulty-selector">
                    <span class="selector-label">Difficulty</span>
                    <div class="selector-buttons">
                        <button class="selector-btn" data-difficulty="easy">Easy</button>
                        <button class="selector-btn active" data-difficulty="medium">Medium</button>
                        <button class="selector-btn" data-difficulty="hard">Hard</button>
                    </div>
                </div>
            </div>

            <div class="game-info">
                <div class="info-card">
                    <div class="info-label">Question</div>
                    <div class="info-value" id="animal-question-num">0/15</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Correct</div>
                    <div class="info-value" id="animal-correct">0</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Score</div>
                    <div class="info-value" id="animal-score">0</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Time</div>
                    <div class="info-value timer" id="animal-timer">00:00</div>
                </div>
            </div>

            <div class="trivia-question" id="animal-question-text">Click "Start Quiz" to begin!</div>

            <div class="trivia-options" id="animal-options"></div>

            <div class="action-buttons">
                <button class="btn btn-primary" id="animal-submit" disabled>Submit Answer</button>
                <button class="btn btn-secondary" id="animal-next" disabled>Next Question</button>
                <button class="btn btn-secondary" id="animal-start">Start Quiz</button>
            </div>

            <div id="animal-feedback"></div>
            <div id="animal-game-over"></div>
        </div>
        
        <!-- School Trivia Game -->
        <div id="school-trivia-page" class="game-container hidden">
            <div class="game-header">
                <h1 class="game-title-main">üè´ School Trivia</h1>
                <div class="selectors">
                    <label>Subject
                        <select id="school-subject">
                            <option>Math</option>
                            <option>Science</option>
                            <option>History</option>
                            <option>English</option>
                        </select>
                    </label>
                    <label>Difficulty
                        <select id="school-difficulty">
                            <option>Easy</option>
                            <option selected>Medium</option>
                            <option>Hard</option>
                            <option>Expert</option>
                        </select>
                    </label>
                </div>
            </div>

            <div class="game-info">
                <div class="info-card"><div class="info-label">Question</div><div class="info-value" id="school-q-count">0</div></div>
                <div class="info-card"><div class="info-label">Score</div><div class="info-value" id="school-score">0</div></div>
            </div>

            <div id="school-question" class="trivia-question">Press "New Question" to start.</div>
            <div class="action-buttons">
                <button class="btn btn-primary" id="school-new">New Question</button>
                <button class="btn btn-secondary" id="school-show-answer" disabled>Show Answer</button>
            </div>
            <div id="school-answer" class="muted-center"></div>
        </div>
    </div>

    <!-- App bootstrap, player styles, and shared game state -->
    <!-- TOP BAR MUSIC PLAYER STYLE -->
<style>
    /* --- Top Bar Player (tuned for purple header) --- */
    #topbar-player { margin-left: auto; display: flex; align-items: center; gap: .4rem; flex-wrap: wrap; }
    #topbar-player .tp-label { display: none !important; }
    #topbar-player select { max-width: 180px; }
    /* keep existing controls tidy */
    #topbar-player input[type="range"]#tp-seek { width: 160px; height: 6px; border-radius: 6px; }
    #topbar-player input[type="range"]#tp-vol { width: 80px; height: 6px; border-radius: 6px; }
    #topbar-player .tp-inline { display:flex; align-items:center; gap:4px; font-size: 12px; opacity: .9; }
    @media (max-width: 820px) { #topbar-player select { max-width: 160px; } #topbar-player input[type="range"]#tp-seek { width: 120px; } }
</style>

<script>
document.addEventListener('DOMContentLoaded', function(){
    <!-- Player extension: drag & drop uploads -->
    <script type="module" src="./scripts/player-extend.js"></script>

    const TP_TRACKS = [
        { title: "Marvel Opening Theme", url: "assets/audio/Marvel Opening Theme.mp3" },
        { title: "Pok√©mon Theme Song",    url: "assets/audio/Pok√©mon Theme Song.mp3" },
        { title: "Star Wars Main Theme",  url: "assets/audio/Star Wars Main Theme (Full).mp3" }
    ];

    const $ = (id) => document.getElementById(id);
    const audio = $('tp-audio');
    const songSel = $('tp-song');
    const btnPrev = $('tp-prev');
    const btnPlay = $('tp-play');
    const btnNext = $('tp-next');
    const btnBack = $('tp-back10');
    const btnFwd  = $('tp-fwd10');
    const seek    = $('tp-seek');
    const vol     = $('tp-vol');
    const loopOne = $('tp-loop-one');
    const btnAdd  = $('tp-add');
    const fileInp = $('tp-file');

    const LS_KEY = 'topbarPlayer.v1';
    let state = { i: 0, t: 0, v: 0.8, loop1: false, tracks: TP_TRACKS.slice() };
    try { const saved = JSON.parse(localStorage.getItem(LS_KEY) || '{}'); state = { ...state, ...saved, tracks: (saved.tracks?.length ? saved.tracks : state.tracks) }; } catch {}
    const save = () => localStorage.setItem(LS_KEY, JSON.stringify(state));

    function buildSongList(){ songSel.innerHTML=''; state.tracks.forEach((t, idx)=>{ const opt=document.createElement('option'); opt.value=idx; opt.textContent=t.title; songSel.appendChild(opt); }); songSel.value=String(state.i); }
    function load(idx, resumeTime=false){ if(idx<0) idx=state.tracks.length-1; if(idx>=state.tracks.length) idx=0; state.i=idx; audio.src = state.tracks[state.i].url; audio.load(); if(resumeTime) audio.currentTime=Number(state.t)||0; else state.t=0; buildSongList(); save(); }
    function play(){ audio.play().then(()=>{ state.playing = true; btnPlay.textContent='‚è∏'; save(); }).catch(()=>{ btnPlay.textContent='‚ñ∂Ô∏è'; }); }
    function pause(){ audio.pause(); state.playing=false; btnPlay.textContent='‚ñ∂Ô∏è'; save(); }
    function next(){ load(state.i+1,false); play(); }
    function prev(){ load(state.i-1,false); play(); }

    btnPlay?.addEventListener('click', ()=> audio.paused ? play() : pause());
    btnNext?.addEventListener('click', next);
    btnPrev?.addEventListener('click', prev);
    btnBack?.addEventListener('click', ()=>{ audio.currentTime = Math.max(0, audio.currentTime - 10); });
    btnFwd?.addEventListener('click', ()=>{ audio.currentTime = Math.min(audio.duration||0, audio.currentTime + 10); });
    songSel?.addEventListener('change', ()=>{ load(Number(songSel.value), false); play(); });
    vol?.addEventListener('input', e=>{ audio.volume = Number(e.target.value); state.v = audio.volume; save(); });
    seek?.addEventListener('input', e=>{ const pct = Number(e.target.value)/100; audio.currentTime = pct * (audio.duration||0); });
    loopOne?.addEventListener('change', ()=>{ state.loop1 = loopOne.checked; save(); });
    btnAdd?.addEventListener('click', ()=> fileInp.click());
    fileInp?.addEventListener('change', (e)=>{ Array.from(e.target.files||[]).forEach(f=>{ const url = URL.createObjectURL(f); state.tracks.push({ title: f.name.replace(/\.(mp3|mpeg)$/i,''), url }); }); buildSongList(); save(); });
    audio?.addEventListener('timeupdate', ()=>{ if(!audio.duration) return; seek.value = String((audio.currentTime / audio.duration) * 100); state.t = audio.currentTime; save(); });
    audio?.addEventListener('ended', ()=>{ state.loop1 ? (audio.currentTime=0, play()) : next(); });
    audio?.addEventListener('play', ()=>{ btnPlay.textContent='‚è∏'; state.playing=true; save(); });
    audio?.addEventListener('pause', ()=>{ btnPlay.textContent='‚ñ∂Ô∏è'; state.playing=false; save(); });

    // Public API for extensions (drag/drop, cloud uploads, etc)
    window.playerApi = {
        addTracks(tracks){
            if(!Array.isArray(tracks) || !tracks.length) return;
            tracks.forEach(t => { if(t && t.url && t.title){ state.tracks.push({ title: String(t.title), url: String(t.url) }); }});
            buildSongList();
            save();
        },
        getState(){ return { ...state }; },
        playIndex(i){ load(Number(i)||0,false); play(); },
        next, prev,
        play(){ if(audio.paused) play(); },
        pause(){ if(!audio.paused) pause(); }
    };

        (function init(){
            if (!audio) return; // guard if DOM ids not present
            audio.volume = Number(state.v) || 0.8;
            if (vol) vol.value = String(audio.volume);
            if (loopOne) loopOne.checked = !!state.loop1;
            buildSongList(); load(Number(state.i) || 0, true); if(state.playing) play(); const kick = ()=>{ if(audio.paused) play(); window.removeEventListener('click', kick, true); }; window.addEventListener('click', kick, true);
        })();
    });
    </script>

    <!-- Load Question Engine -->
    <!-- (removed duplicate question-engine.js include; kept single include near end) -->
        <!-- Emergency: hide accidental debug dumps and overlays until code cleanup -->
        <style>
            /* Emergency hide for stray debug / state dumps injected as <pre> */
            #debug-dump, pre#stateDump, pre#poolDump, pre.debug-dump, .debug-json {
                display: none !important;
                visibility: hidden !important;
                pointer-events: none !important;
                max-height: 0 !important;
                overflow: hidden !important;
            }
            /* Hide common overlays that can block gestures */
            #overlay, #loading, .scrim, .modal-backdrop { display: none !important; }
            /* Hide legacy audio controls to keep a single compact player */
            #audio-controls, #audio-queue { display: none !important; }
        </style>
        <script>
            // Debug and safety helpers (disabled by default)
            (function(){
                const DEBUG = false;
                function debugDump(obj){
                    if (!DEBUG) return;
                    let pre = document.getElementById('debug-dump');
                    if (!pre) {
                        pre = document.createElement('pre');
                        pre.id = 'debug-dump';
                        pre.className = 'debug-json';
                        pre.style.whiteSpace = 'pre-wrap';
                        pre.style.fontSize = '12px';
                        pre.style.maxHeight = '40vh';
                        pre.style.overflow = 'auto';
                        document.body.appendChild(pre);
                    }
                    try { pre.textContent = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2); } catch(e) { pre.textContent = String(obj); }
                }

                let _audioUnlocked = false;
                function ensureAudioUnlocked(){
                    if (_audioUnlocked) return;
                    const tryUnlock = async ()=>{
                        try{
                            const Ctx = window.AudioContext || window.webkitAudioContext;
                            if (Ctx) {
                                window._ac = window._ac || new Ctx();
                                if (window._ac.state === 'suspended') await window._ac.resume();
                            }
                            // play a very quiet short sound if available to satisfy browsers
                            try{ const a = new Audio('assets/audio/30 Second Timer With Jeopardy Thinking Music.mp3'); a.volume = 0.01; await a.play().catch(()=>{}); } catch(e) {}
                            _audioUnlocked = true;
                        } finally {
                            window.removeEventListener('pointerdown', tryUnlock);
                            window.removeEventListener('keydown', tryUnlock);
                        }
                    };
                    window.addEventListener('pointerdown', tryUnlock, { once: true });
                    window.addEventListener('keydown', tryUnlock, { once: true });
                }

                // Expose helpers globally for other scripts/tests
                window.debugDump = debugDump;
                window.ensureAudioUnlocked = ensureAudioUnlocked;
                if (!window.__burbleBooted) window.__burbleBooted = false;
            })();
        </script>
        <script>
        // Global game state used by all games
        const gameState = {
            userStats: {
                totalScore: 0,
                gamesPlayed: 0,
                gamesWon: 0
            },
            burble: {
                difficulty: 'medium',
                category: 'Food',
                currentWord: '',
                attempts: 0,
                maxAttempts: 10,
                score: 0,
                gameActive: false,
                startTime: null,
                timerInterval: null,
                hintsUsed: 0
            },
            emoji: {
                difficulty: 'medium',
                category: 'all',
                currentPuzzle: null,
                score: 0,
                hintsUsed: 0,
                gameActive: false
            },
            valentine: {
                difficulty: 'medium',
                category: 'movies',
                currentAnswer: '',
                questionsLeft: 6,
                guessesLeft: 3,
                score: 0,
                gameActive: false,
                questions: [],
                answers: []
            },
            trivia: {
                difficulty: 'medium',
                currentQuestion: 0,
                totalQuestions: 15,
                correctAnswers: 0,
                score: 0,
                gameActive: false,
                startTime: null,
                timerInterval: null,
                selectedAnswer: null
            },
            animalTrivia: {
                difficulty: 'medium',
                currentQuestion: 0,
                totalQuestions: 15,
                correctAnswers: 0,
                score: 0,
                gameActive: false,
                startTime: null,
                timerInterval: null,
                selectedAnswer: null
            },
            riddles: {
                difficulty: 'medium',
                category: 'all',
                currentRiddle: null,
                currentHintLevel: 0,
                score: 0,
                solved: 0,
                hintsUsed: 0,
                gameActive: false,
                attemptCount: 0,
                maxAttempts: 3
            }
        };

        // Word categories now loaded from external file

        // Riddles database now loaded from external file

        // Function to get all riddles for a category/difficulty combination
        function getRiddlesByFilter(category, difficulty) {
            if (category === 'all') {
                const allRiddles = [];
                Object.keys(riddlesData).forEach(cat => {
                    if (riddlesData[cat][difficulty]) {
                        allRiddles.push(...riddlesData[cat][difficulty]);
                    }
                });
                return allRiddles;
            } else {
                return riddlesData[category] && riddlesData[category][difficulty] ? riddlesData[category][difficulty] : [];
            }
        }

        // Function to check if answer is correct (fuzzy matching)
        function checkRiddleAnswer(userAnswer, correctAnswers) {
            const normalized = userAnswer.toLowerCase().trim();
            return correctAnswers.some(answer => {
                const normalizedAnswer = answer.toLowerCase().trim();
                return normalized === normalizedAnswer || 
                       normalized.includes(normalizedAnswer) || 
                       normalizedAnswer.includes(normalized) ||
                       levenshteinDistance(normalized, normalizedAnswer) <= Math.max(1, Math.floor(normalizedAnswer.length * 0.2));
            });
        }

        // Simple edit distance calculation for fuzzy matching
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            return matrix[str2.length][str1.length];
        }

        // Emoji puzzles now loaded from external file

        // Twenty Questions answers now loaded from external file

        // Trivia questions now loaded from external files

        // Navigation functions
        function showPage(evt, pageName) {
            // Hide all pages
            document.querySelectorAll('.game-container').forEach(page => {
                page.classList.add('hidden');
            });

            // Show selected page

            // Show selected page
            document.getElementById(pageName + '-page').classList.remove('hidden');

            // Update navigation: remove active from all and add to the clicked button (if available)
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            try {
                // evt may be undefined if showPage is called programmatically; try to set active from the event first
                if (evt && evt.currentTarget) {
                    evt.currentTarget.classList.add('active');
                } else if (evt && evt.target && evt.target.closest && evt.target.closest('.nav-buttons')) {
                    // If the event target is a child element, find the closest button
                    const btn = evt.target.closest('.nav-btn');
                    if (btn) btn.classList.add('active');
                } else {
                    // Fallback: try to find nav button by matching pageName text (best-effort)
                    const fallback = Array.from(document.querySelectorAll('.nav-btn')).find(b => b.textContent.trim().toLowerCase().includes(pageName.replace('-', ' ')) );
                    if (fallback) fallback.classList.add('active');
                }
            } catch (e) {
                // Ignore and continue
            }

            gameState.currentPage = pageName;

            // Update stats if returning to home
            if (pageName === 'home') {
                updateUserStats();
            }
        }

        // User stats functions
        function updateUserStats() {
            document.getElementById('total-score').textContent = gameState.userStats.totalScore;
            document.getElementById('games-played').textContent = gameState.userStats.gamesPlayed;
            document.getElementById('games-won').textContent = gameState.userStats.gamesWon;
            
            const winRate = gameState.userStats.gamesPlayed > 0 
                ? Math.round((gameState.userStats.gamesWon / gameState.userStats.gamesPlayed) * 100)
                : 0;
            document.getElementById('win-rate').textContent = winRate + '%';
        }

        function addGameResult(won, score = 0) {
            gameState.userStats.gamesPlayed++;
            if (won) gameState.userStats.gamesWon++;
            gameState.userStats.totalScore += score;
            
            // Save to localStorage
            localStorage.setItem('burbleGameStats', JSON.stringify(gameState.userStats));
        }

        // Load stats from localStorage
        function loadUserStats() {
            const saved = localStorage.getItem('burbleGameStats');
            if (saved) {
                gameState.userStats = JSON.parse(saved);
                updateUserStats();
            }
        }

        // Utility functions
        // Fisher-Yates shuffle
        function shuffleArray(arr) {
            const a = arr.slice();
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        // Build a run of `count` items from a pool; repeats the shuffled pool if needed
        function buildRunRepeatable(all, count) {
            const out = [];
            if (!Array.isArray(all) || all.length === 0) return out;
            while (out.length < count) {
                const take = Math.min(count - out.length, all.length);
                const chunk = shuffleArray(all).slice(0, take);
                out.push(...chunk);
            }
            return out.slice(0, count);
        }

        // Riddles: maintain per-filter shuffled pools to avoid repeats until exhausted
        function getRiddleFromPool(category, difficulty) {
            const key = `${category}|${difficulty}`;
            if (!gameState.riddles.pools) gameState.riddles.pools = {};
            if (!gameState.riddles.pools[key] || gameState.riddles.pools[key].length === 0) {
                const pool = getRiddlesByFilter(category, difficulty);
                gameState.riddles.pools[key] = shuffleArray(pool);
            }
            return gameState.riddles.pools[key].shift();
        }
        function showFeedback(gameType, message, type) {
            const feedback = document.getElementById(gameType + '-feedback');
            feedback.innerHTML = `<div class="feedback ${type}">${message}</div>`;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function startTimer(gameType) {
            const game = gameState[gameType];
            game.startTime = Date.now();
            game.timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - game.startTime) / 1000);
                document.getElementById(gameType + '-timer').textContent = formatTime(elapsed);
            }, 1000);
        }

        function stopTimer(gameType) {
            const game = gameState[gameType];
            if (game.timerInterval) {
                clearInterval(game.timerInterval);
                game.timerInterval = null;
            }
        }

        // RIDDLES GAME
        function initRiddlesGame() {
            // Difficulty selectors
            document.querySelectorAll('#riddles-page .selector-btn[data-difficulty]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#riddles-page .selector-btn[data-difficulty]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    gameState.riddles.difficulty = btn.dataset.difficulty;
                    updateRiddlesDisplay();
                });
            });

            // Category selectors
            document.querySelectorAll('#riddles-page .selector-btn[data-category]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#riddles-page .selector-btn[data-category]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    gameState.riddles.category = btn.dataset.category;
                    updateRiddlesDisplay();
                });
            });

            // Game buttons
            document.getElementById('riddles-next').addEventListener('click', nextRiddle);
            document.getElementById('riddles-submit').addEventListener('click', submitRiddleAnswer);
            document.getElementById('riddles-hint').addEventListener('click', getRiddleHint);

            // Input handling
            document.getElementById('riddles-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && gameState.riddles.gameActive) {
                    submitRiddleAnswer();
                }
            });

            updateRiddlesDisplay();
        }

        function nextRiddle() {
            const riddles = gameState.riddles;
            
            // Get riddles for current filter
            const availableRiddles = getRiddlesByFilter(riddles.category, riddles.difficulty);
            if (availableRiddles.length === 0) {
                showFeedback('riddles', 'No riddles available for this category/difficulty combination.', 'error');
                return;
            }
            // Select riddle using pool manager to avoid repeats
            let newRiddle;
            if (window.questionUtils) {
                const poolKey = `riddles_${riddles.category}_${riddles.difficulty}`;
                const riddleRun = window.questionUtils.getUniqueRun(availableRiddles, poolKey, 1);
                newRiddle = riddleRun.length > 0 ? riddleRun[0] : null;
            } else {
                newRiddle = getRiddleFromPool(riddles.category, riddles.difficulty);
            }
            if (!newRiddle) {
                // Fallback to random selection
                newRiddle = availableRiddles[Math.floor(Math.random() * availableRiddles.length)];
            }
            riddles.currentRiddle = newRiddle;
            riddles.currentHintLevel = 0;
            riddles.attemptCount = 0;
            riddles.gameActive = true;

            // Display riddle
            document.getElementById('riddles-question').textContent = riddles.currentRiddle.riddle;
            
            // Enable inputs
            document.getElementById('riddles-input').disabled = false;
            document.getElementById('riddles-submit').disabled = false;
            document.getElementById('riddles-hint').disabled = false;
            document.getElementById('riddles-input').focus();
            
            // Clear previous feedback
            document.getElementById('riddles-feedback').innerHTML = '';
            
            updateRiddlesDisplay();
            showFeedback('riddles', 'New riddle loaded! Think carefully about your answer.', 'info');
        }

        function submitRiddleAnswer() {
            if (!gameState.riddles.gameActive || !gameState.riddles.currentRiddle) return;
            
            const answer = document.getElementById('riddles-input').value.trim();
            if (!answer) return;

            const riddles = gameState.riddles;
            riddles.attemptCount++;

            if (checkRiddleAnswer(answer, riddles.currentRiddle.acceptedAnswers)) {
                handleRiddleCorrect();
            } else {
                handleRiddleIncorrect();
            }

            document.getElementById('riddles-input').value = '';
        }

        function handleRiddleCorrect() {
            const riddles = gameState.riddles;
            riddles.gameActive = false;
            riddles.solved++;

            // Calculate score based on difficulty, attempts, and hints used
            let basePoints = 0;
            switch (riddles.difficulty) {
                case 'easy': basePoints = 10; break;
                case 'medium': basePoints = 25; break;
                case 'hard': basePoints = 50; break;
            }

            // Bonus for fewer attempts
            const attemptBonus = Math.max(0, (riddles.maxAttempts - riddles.attemptCount + 1) * 5);
            
            // Penalty for hints (already calculated when hint is used)
            const totalScore = basePoints + attemptBonus;
            riddles.score += totalScore;

            // Disable inputs
            document.getElementById('riddles-input').disabled = true;
            document.getElementById('riddles-submit').disabled = true;
            document.getElementById('riddles-hint').disabled = true;

            addGameResult(true, totalScore);
            updateRiddlesDisplay();
            
            showFeedback('riddles', 
                `üéâ Correct! The answer was "${riddles.currentRiddle.answer}". You earned ${totalScore} points! Click "New Riddle" to continue.`, 
                'success'
            );
        }

        function handleRiddleIncorrect() {
            const riddles = gameState.riddles;
            
            if (riddles.attemptCount >= riddles.maxAttempts) {
                // Game over - show correct answer
                riddles.gameActive = false;
                
                document.getElementById('riddles-input').disabled = true;
                document.getElementById('riddles-submit').disabled = true;
                document.getElementById('riddles-hint').disabled = true;

                addGameResult(false, 0);
                
                showFeedback('riddles', 
                    `‚ùå Incorrect! The answer was "${riddles.currentRiddle.answer}". Click "New Riddle" to try another!`, 
                    'error'
                );
            } else {
                const attemptsLeft = riddles.maxAttempts - riddles.attemptCount;
                showFeedback('riddles', 
                    `‚ùå Incorrect! You have ${attemptsLeft} attempt${attemptsLeft !== 1 ? 's' : ''} left. Try again!`, 
                    'warning'
                );
            }
            
            updateRiddlesDisplay();
        }

        function getRiddleHint() {
            const riddles = gameState.riddles;
            if (!riddles.currentRiddle || !riddles.gameActive) return;

            // Check if hints are available
            const hints = riddles.currentRiddle.hints || [];
            if (riddles.currentHintLevel >= hints.length) {
                showFeedback('riddles', 'üí° No more hints available for this riddle.', 'warning');
                return;
            }

            const currentHint = hints[riddles.currentHintLevel];
            const hintNumber = riddles.currentHintLevel + 1;
            const pointPenalty = (hintNumber * 5) + 5; // Progressive penalty: 10, 15, 20 points

            riddles.hintsUsed++;
            riddles.currentHintLevel++;
            riddles.score = Math.max(0, riddles.score - pointPenalty);

            showFeedback('riddles', `üí° Hint ${hintNumber}: ${currentHint} (-${pointPenalty} points)`, 'info');
            
            updateRiddlesDisplay();
            updateHintButton();
        }

        function updateRiddlesDisplay() {
            const riddles = gameState.riddles;
            
            // Update stats
            document.getElementById('riddles-score').textContent = riddles.score;
            document.getElementById('riddles-solved').textContent = riddles.solved;
            document.getElementById('riddles-difficulty').textContent = 
                riddles.difficulty.charAt(0).toUpperCase() + riddles.difficulty.slice(1);
            
            // Update category display
            const categoryDisplay = {
                'all': 'All Types',
                'logic': 'Logic',
                'word': 'Word',
                'math': 'Math', 
                'lateral': 'Lateral Thinking'
            };
            document.getElementById('riddles-category').textContent = categoryDisplay[riddles.category] || riddles.category;
        }

        // BURBLE WORD GAME
        function initBurbleGame() {
            // Difficulty selectors
            document.querySelectorAll('#burble-page .selector-btn[data-difficulty]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#burble-page .selector-btn[data-difficulty]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    gameState.burble.difficulty = btn.dataset.difficulty;
                    setBurbleMaxAttempts();
                    updateBurbleDisplay();
                });
            });

            // Category selectors
            document.querySelectorAll('#burble-page .selector-btn[data-category]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#burble-page .selector-btn[data-category]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    gameState.burble.category = btn.dataset.category;
                    updateBurbleDisplay();
                });
            });

            // Game buttons
            document.getElementById('burble-new-game').addEventListener('click', startBurbleGame);
            document.getElementById('burble-submit').addEventListener('click', submitBurbleGuess);
            document.getElementById('burble-hint').addEventListener('click', getBurbleHint);

            // Input handling
            document.getElementById('burble-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && gameState.burble.gameActive) {
                    submitBurbleGuess();
                }
            });

            setBurbleMaxAttempts();
        }

        function setBurbleMaxAttempts() {
            switch (gameState.burble.difficulty) {
                case 'easy':
                    gameState.burble.maxAttempts = 15;
                    break;
                case 'medium':
                    gameState.burble.maxAttempts = 10;
                    break;
                case 'hard':
                    gameState.burble.maxAttempts = 5;
                    break;
            }
        }

        function startBurbleGame() {
            const burble = gameState.burble;
            
            // Reset game state
            burble.attempts = 0;
            burble.score = 0;
            burble.hintsUsed = 0;
            burble.gameActive = true;
            
            // Select word using pool manager to avoid repeats
            const category = wordCategories[burble.category];
            const lengths = Object.keys(category);
            if (window.questionUtils) {
                // Get all words from all lengths for this category
                const allWords = [];
                lengths.forEach(len => allWords.push(...category[len]));
                const poolKey = `burble_${burble.category}`;
                const wordRun = window.questionUtils.getUniqueRun(allWords, poolKey, 1);
                burble.currentWord = wordRun.length > 0 ? wordRun[0] : allWords[0];
            } else {
                // Fallback to random selection
                const randomLength = lengths[Math.floor(Math.random() * lengths.length)];
                const words = category[randomLength];
                burble.currentWord = words[Math.floor(Math.random() * words.length)];
            }
            
            // Start timer
            startTimer('burble');
            
            // Enable inputs
            document.getElementById('burble-input').disabled = false;
            document.getElementById('burble-submit').disabled = false;
            document.getElementById('burble-hint').disabled = false;
            document.getElementById('burble-input').focus();
            
            updateBurbleDisplay();
            showFeedback('burble', 'Game started! Guess the word.', 'info');
        }

        function submitBurbleGuess() {
            if (!gameState.burble.gameActive) return;
            
            const guess = document.getElementById('burble-input').value.trim().toLowerCase();
            if (!guess) return;
            
            const burble = gameState.burble;
            burble.attempts++;
            
            if (guess === burble.currentWord) {
                handleBurbleWin();
            } else {
                handleBurbleIncorrect(guess);
            }
            
            document.getElementById('burble-input').value = '';
            updateBurbleDisplay();
        }

        function handleBurbleWin() {
            const burble = gameState.burble;
            burble.gameActive = false;
            stopTimer('burble');
            
            const elapsedTime = Math.floor((Date.now() - burble.startTime) / 1000);
            const timeBonus = Math.max(0, 300 - elapsedTime);
            const attemptBonus = Math.max(0, (burble.maxAttempts - burble.attempts) * 10);
            const hintPenalty = burble.hintsUsed * 25;
            burble.score = Math.max(0, 100 + timeBonus + attemptBonus - hintPenalty);
            
            addGameResult(true, burble.score);
            
            showFeedback('burble', `üéâ Correct! The word was "${burble.currentWord}"`, 'correct');
            
            document.getElementById('burble-game-over').innerHTML = `
                <div class="game-over win">
                    <h3>üéâ Congratulations!</h3>
                    <p>You guessed "${burble.currentWord}" correctly!</p>
                    <p><strong>Score:</strong> ${burble.score} points</p>
                    <p><strong>Time:</strong> ${formatTime(Math.floor((Date.now() - burble.startTime) / 1000))}</p>
                    <p><strong>Attempts:</strong> ${burble.attempts}/${burble.maxAttempts}</p>
                </div>
            `;
            
            disableBurbleInputs();
        }

        function handleBurbleIncorrect(guess) {
            const burble = gameState.burble;
            const feedback = generateBurbleFeedback(guess, burble.currentWord);
            
            showFeedback('burble', `‚ùå "${guess}" is incorrect. ${feedback}`, 'incorrect');
            
            if (burble.attempts >= burble.maxAttempts) {
                burble.gameActive = false;
                stopTimer('burble');
                addGameResult(false, 0);
                
                document.getElementById('burble-game-over').innerHTML = `
                    <div class="game-over lose">
                        <h3>üòî Game Over</h3>
                        <p>The word was: <strong>"${burble.currentWord}"</strong></p>
                        <p>Category: ${burble.category}</p>
                        <p>Better luck next time!</p>
                    </div>
                `;
                
                disableBurbleInputs();
            }
        }

        function generateBurbleFeedback(guess, targetWord) {
            if (guess.length !== targetWord.length) {
                return `Try a ${targetWord.length}-letter word.`;
            }
            
            let commonLetters = 0;
            for (let i = 0; i < Math.min(guess.length, targetWord.length); i++) {
                if (targetWord.includes(guess[i])) {
                    commonLetters++;
                }
            }
            
            if (commonLetters === 0) {
                return "No matching letters.";
            } else if (commonLetters === 1) {
                return "1 letter is in the word.";
            } else {
                return `${commonLetters} letters are in the word.`;
            }
        }

        function getBurbleHint() {
            if (!gameState.burble.gameActive) return;
            
            const burble = gameState.burble;
            burble.hintsUsed++;
            
            const hints = [
                `The word is ${burble.currentWord.length} letters long.`,
                `The word is in the ${burble.category} category.`,
                `The word starts with "${burble.currentWord[0]}".`,
                `The word ends with "${burble.currentWord[burble.currentWord.length - 1]}".`,
                `The second letter is "${burble.currentWord[1]}".`
            ];
            
            const hintIndex = Math.min(burble.hintsUsed - 1, hints.length - 1);
            showFeedback('burble', `üí° Hint ${burble.hintsUsed}: ${hints[hintIndex]} (-25 points)`, 'hint');
            
            updateBurbleDisplay();
        }

        function updateBurbleDisplay() {
            const burble = gameState.burble;
            
            document.getElementById('burble-attempts').textContent = `${burble.attempts}/${burble.maxAttempts}`;
            document.getElementById('burble-category').textContent = burble.category;
            document.getElementById('burble-score').textContent = burble.score;
            
            if (burble.currentWord && burble.gameActive) {
                document.getElementById('burble-display').textContent = '_ '.repeat(burble.currentWord.length).trim();
            } else if (burble.currentWord && !burble.gameActive) {
                document.getElementById('burble-display').textContent = burble.currentWord.toUpperCase();
            } else {
                document.getElementById('burble-display').textContent = 'Click "New Game" to start!';
            }
        }

        function disableBurbleInputs() {
            document.getElementById('burble-input').disabled = true;
            document.getElementById('burble-submit').disabled = true;
            document.getElementById('burble-hint').disabled = true;
        }

        // EMOJI GUESS GAME
        function initEmojiGame() {
            // Difficulty selectors
            document.querySelectorAll('#emoji-page .selector-btn[data-difficulty]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#emoji-page .selector-btn[data-difficulty]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    gameState.emoji.difficulty = btn.dataset.difficulty;
                    updateEmojiDisplay();
                });
            });

            // Category selectors
            document.querySelectorAll('#emoji-page .selector-btn[data-category]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#emoji-page .selector-btn[data-category]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    gameState.emoji.category = btn.dataset.category;
                    updateEmojiDisplay();
                });
            });

            // Game buttons
            document.getElementById('emoji-new-puzzle').addEventListener('click', startEmojiGame);
            document.getElementById('emoji-submit').addEventListener('click', submitEmojiAnswer);
            document.getElementById('emoji-hint').addEventListener('click', getEmojiHint);

            // Input handling
            document.getElementById('emoji-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && gameState.emoji.gameActive) {
                    submitEmojiAnswer();
                }
            });
        }

        function startEmojiGame() {
            const emoji = gameState.emoji;
            
            // Get available puzzles
            let availablePuzzles = [];
            if (emoji.category === 'all') {
                Object.values(emojiPuzzles).forEach(puzzles => {
                    availablePuzzles.push(...puzzles);
                });
            } else {
                availablePuzzles = emojiPuzzles[emoji.category] || [];
            }
            
            if (availablePuzzles.length === 0) {
                showFeedback('emoji', 'No puzzles available for this category!', 'incorrect');
                return;
            }
            
            // Select puzzle using pool manager to avoid repeats
            if (window.questionUtils) {
                const poolKey = `emoji_${emoji.category}`;
                const puzzleRun = window.questionUtils.getUniqueRun(availablePuzzles, poolKey, 1);
                emoji.currentPuzzle = puzzleRun.length > 0 ? puzzleRun[0] : availablePuzzles[0];
            } else {
                // Fallback to random selection
                emoji.currentPuzzle = availablePuzzles[Math.floor(Math.random() * availablePuzzles.length)];
            }
            emoji.gameActive = true;
            emoji.hintsUsed = 0;
            
            // Enable inputs
            document.getElementById('emoji-input').disabled = false;
            document.getElementById('emoji-submit').disabled = false;
            document.getElementById('emoji-hint').disabled = false;
            document.getElementById('emoji-input').focus();
            
            updateEmojiDisplay();
            showFeedback('emoji', 'New puzzle! What does this emoji combination represent?', 'info');
        }

        function submitEmojiAnswer() {
            if (!gameState.emoji.gameActive) return;
            
            const answer = document.getElementById('emoji-input').value.trim();
            if (!answer) return;
            
            const emoji = gameState.emoji;
            const correctAnswer = emoji.currentPuzzle.answer.toLowerCase();
            const userAnswer = answer.toLowerCase();
            
            if (userAnswer === correctAnswer || correctAnswer.includes(userAnswer) || userAnswer.includes(correctAnswer)) {
                handleEmojiWin();
            } else {
                handleEmojiIncorrect();
            }
            
            document.getElementById('emoji-input').value = '';
        }

        function handleEmojiWin() {
            const emoji = gameState.emoji;
            emoji.gameActive = false;
            
            const baseScore = 100;
            const hintPenalty = emoji.hintsUsed * 5;
            const difficultyBonus = emoji.difficulty === 'hard' ? 50 : emoji.difficulty === 'medium' ? 25 : 0;
            emoji.score += Math.max(10, baseScore - hintPenalty + difficultyBonus);
            
            addGameResult(true, baseScore - hintPenalty + difficultyBonus);
            
            showFeedback('emoji', `üéâ Correct! The answer was "${emoji.currentPuzzle.answer}"`, 'correct');
            
            document.getElementById('emoji-game-over').innerHTML = `
                <div class="game-over win">
                    <h3>üéâ Excellent!</h3>
                    <p>You solved: ${emoji.currentPuzzle.emoji}</p>
                    <p><strong>Answer:</strong> ${emoji.currentPuzzle.answer}</p>
                    <p><strong>Score:</strong> ${baseScore - (emoji.hintsUsed * 5) + difficultyBonus} points</p>
                    <p><strong>Hints used:</strong> ${emoji.hintsUsed}</p>
                </div>
            `;
            
            disableEmojiInputs();
            updateEmojiDisplay();
        }

        function handleEmojiIncorrect() {
            showFeedback('emoji', '‚ùå Incorrect! Try again or get a hint.', 'incorrect');
        }

        function getEmojiHint() {
            if (!gameState.emoji.gameActive) return;
            
            const emoji = gameState.emoji;
            emoji.hintsUsed++;
            
            showFeedback('emoji', `üí° Hint: ${emoji.currentPuzzle.hint} (-5 points)`, 'hint');
            updateEmojiDisplay();
        }

        function updateEmojiDisplay() {
            const emoji = gameState.emoji;
            
            document.getElementById('emoji-score').textContent = emoji.score;
            document.getElementById('emoji-hints').textContent = emoji.hintsUsed;
            document.getElementById('emoji-category').textContent = emoji.category.charAt(0).toUpperCase() + emoji.category.slice(1);
            document.getElementById('emoji-difficulty').textContent = emoji.difficulty.charAt(0).toUpperCase() + emoji.difficulty.slice(1);
            
            if (emoji.currentPuzzle && emoji.gameActive) {
                document.getElementById('emoji-display').textContent = emoji.currentPuzzle.emoji;
            } else if (emoji.currentPuzzle && !emoji.gameActive) {
                document.getElementById('emoji-display').textContent = emoji.currentPuzzle.emoji;
            } else {
                document.getElementById('emoji-display').textContent = 'Click "New Puzzle" to start!';
            }
        }

        function disableEmojiInputs() {
            document.getElementById('emoji-input').disabled = true;
            document.getElementById('emoji-submit').disabled = true;
            document.getElementById('emoji-hint').disabled = true;
        }

        // TWENTY QUESTIONS GAME
        function initValentineGame() {
            // Difficulty selectors
            document.querySelectorAll('#valentine-page .selector-btn[data-difficulty]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#valentine-page .selector-btn[data-difficulty]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    gameState.valentine.difficulty = btn.dataset.difficulty;
                    setValentineQuestions();
                    updateValentineDisplay();
                });
            });

            // Category selectors
            document.querySelectorAll('#valentine-page .selector-btn[data-category]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#valentine-page .selector-btn[data-category]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    gameState.valentine.category = btn.dataset.category;
                    updateValentineDisplay();
                });
            });

            // Game buttons
            document.getElementById('valentine-new-game').addEventListener('click', startValentineGame);
            document.getElementById('valentine-ask').addEventListener('click', askValentineQuestion);
            document.getElementById('valentine-guess').addEventListener('click', makeValentineGuess);

            // Input handling
            document.getElementById('valentine-question').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && gameState.valentine.gameActive) {
                    askValentineQuestion();
                }
            });

            setValentineQuestions();
        }

        function setValentineQuestions() {
            switch (gameState.valentine.difficulty) {
                case 'easy':
                    gameState.valentine.questionsLeft = 8;
                    break;
                case 'medium':
                    gameState.valentine.questionsLeft = 6;
                    break;
                case 'hard':
                    gameState.valentine.questionsLeft = 4;
                    break;
            }
        }

        function startValentineGame() {
            const valentine = gameState.valentine;
            
            // Reset game state
            valentine.questions = [];
            valentine.answers = [];
            valentine.guessesLeft = 3;
            valentine.gameActive = true;
            valentine.score = 0;
            setValentineQuestions();
            
            // Select answer using pool manager to avoid repeats
            const categoryAnswers = valentineAnswers[valentine.category];
            if (window.questionUtils) {
                const poolKey = `valentine_${valentine.category}`;
                const answerRun = window.questionUtils.getUniqueRun(categoryAnswers, poolKey, 1);
                valentine.currentAnswer = answerRun.length > 0 ? answerRun[0].answer : categoryAnswers[0].answer;
            } else {
                // Fallback to random selection
                valentine.currentAnswer = categoryAnswers[Math.floor(Math.random() * categoryAnswers.length)].answer;
            }
            
            // Enable inputs
            document.getElementById('valentine-question').disabled = false;
            document.getElementById('valentine-ask').disabled = false;
            document.getElementById('valentine-guess').disabled = false;
            document.getElementById('valentine-question').focus();
            
            // Clear history
            document.getElementById('valentine-history').innerHTML = '<p class="muted-center-small">Ask yes/no questions to figure out what I\'m thinking of!</p>';
            
            updateValentineDisplay();
            showFeedback('valentine', `I'm thinking of something in the ${valentine.category} category. Ask yes/no questions!`, 'info');
        }

        function askValentineQuestion() {
            if (!gameState.valentine.gameActive) return;
            
            const question = document.getElementById('valentine-question').value.trim();
            if (!question) return;
            
            const valentine = gameState.valentine;
            valentine.questionsLeft--;
            valentine.questions.push(question);
            
            // Generate AI-like response
            const answer = generateValentineAnswer(question, valentine.currentAnswer);
            valentine.answers.push(answer);
            
            // Update history
            updateValentineHistory();
            
            document.getElementById('valentine-question').value = '';
            updateValentineDisplay();
            
            if (valentine.questionsLeft === 0) {
                showFeedback('valentine', 'No more questions! You must make a guess now.', 'hint');
                document.getElementById('valentine-ask').disabled = true;
                document.getElementById('valentine-question').disabled = true;
            }
        }

        function generateValentineAnswer(question, answer) {
            const q = question.toLowerCase();
            const a = answer.toLowerCase();
            
            // Simple keyword matching for basic responses
            if (q.includes('alive') || q.includes('living')) {
                return gameState.valentine.category === 'animals' ? 'Yes' : 'No';
            }
            if (q.includes('animal')) {
                return gameState.valentine.category === 'animals' ? 'Yes' : 'No';
            }
            if (q.includes('place') || q.includes('location')) {
                return gameState.valentine.category === 'places' ? 'Yes' : 'No';
            }
            if (q.includes('movie') || q.includes('film')) {
                return gameState.valentine.category === 'movies' ? 'Yes' : 'No';
            }
            if (q.includes('object') || q.includes('thing')) {
                return gameState.valentine.category === 'objects' ? 'Yes' : 'No';
            }
            if (q.includes('big') || q.includes('large')) {
                return ['elephant', 'giraffe', 'whale', 'titanic', 'avatar'].some(word => a.includes(word)) ? 'Yes' : 'No';
            }
            if (q.includes('small')) {
                return ['phone', 'key', 'watch'].some(word => a.includes(word)) ? 'Yes' : 'No';
            }
            if (q.includes('water')) {
                return ['dolphin', 'titanic', 'sydney', 'paris'].some(word => a.includes(word)) ? 'Yes' : 'No';
            }
            if (q.includes('fly') || q.includes('flight')) {
                return ['penguin', 'avatar'].some(word => a.includes(word)) ? 'Yes' : 'No';
            }
            
            // Random yes/no for other questions
            return Math.random() > 0.5 ? 'Yes' : 'No';
        }

        function makeValentineGuess() {
            if (!gameState.valentine.gameActive) return;
            
            const guess = prompt('What do you think I\'m thinking of?');
            if (!guess) return;
            
            const valentine = gameState.valentine;
            valentine.guessesLeft--;
            
            if (guess.toLowerCase() === valentine.currentAnswer.toLowerCase()) {
                handleValentineWin();
            } else {
                if (valentine.guessesLeft === 0) {
                    handleValentineLose();
                } else {
                    showFeedback('valentine', `‚ùå Not quite! You have ${valentine.guessesLeft} guess(es) left.`, 'incorrect');
                    updateValentineDisplay();
                }
            }
        }

        function handleValentineWin() {
            const valentine = gameState.valentine;
            valentine.gameActive = false;
            
            const baseScore = 100;
            const questionBonus = valentine.questionsLeft * 10;
            const guessBonus = valentine.guessesLeft * 20;
            valentine.score = baseScore + questionBonus + guessBonus;
            
            addGameResult(true, valentine.score);
            
            showFeedback('valentine', `üéâ Correct! I was thinking of "${valentine.currentAnswer}"`, 'correct');
            
            document.getElementById('valentine-game-over').innerHTML = `
                <div class="game-over win">
                    <h3>üéâ Amazing!</h3>
                    <p>You guessed "${valentine.currentAnswer}" correctly!</p>
                    <p><strong>Score:</strong> ${valentine.score} points</p>
                    <p><strong>Questions used:</strong> ${valentine.questions.length}</p>
                    <p><strong>Guesses remaining:</strong> ${valentine.guessesLeft}</p>
                </div>
            `;
            
            disableValentineInputs();
        }

        function handleValentineLose() {
            const valentine = gameState.valentine;
            valentine.gameActive = false;
            
            addGameResult(false, 0);
            
            showFeedback('valentine', `üòî The answer was "${valentine.currentAnswer}". Better luck next time!`, 'incorrect');
            
            document.getElementById('valentine-game-over').innerHTML = `
                <div class="game-over lose">
                    <h3>üòî Game Over</h3>
                    <p>I was thinking of: <strong>"${valentine.currentAnswer}"</strong></p>
                    <p>Category: ${valentine.category}</p>
                    <p>You asked ${valentine.questions.length} questions</p>
                </div>
            `;
            
            disableValentineInputs();
        }

        function updateValentineHistory() {
            const valentine = gameState.valentine;
            const history = document.getElementById('valentine-history');
            
            let historyHTML = '';
            for (let i = 0; i < valentine.questions.length; i++) {
                historyHTML += `
                    <div class="question-item">
                        <div class="question-text">Q: ${valentine.questions[i]}</div>
                        <div class="answer-text">A: ${valentine.answers[i]}</div>
                    </div>
                `;
            }
            
            history.innerHTML = historyHTML || '<p class="muted-center-small">Ask yes/no questions to figure out what I\'m thinking of!</p>';
        }

        function updateValentineDisplay() {
            const valentine = gameState.valentine;
            
            document.getElementById('valentine-questions').textContent = valentine.questionsLeft;
            document.getElementById('valentine-guesses').textContent = valentine.guessesLeft;
            document.getElementById('valentine-category').textContent = valentine.category.charAt(0).toUpperCase() + valentine.category.slice(1);
            document.getElementById('valentine-score').textContent = valentine.score;
        }

        function disableValentineInputs() {
            document.getElementById('valentine-question').disabled = true;
            document.getElementById('valentine-ask').disabled = true;
            document.getElementById('valentine-guess').disabled = true;
        }

        // TRIVIA GAME
        function initTriviaGame() {
            // Difficulty selectors
            document.querySelectorAll('#trivia-page .selector-btn[data-difficulty]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#trivia-page .selector-btn[data-difficulty]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    gameState.trivia.difficulty = btn.dataset.difficulty;
                });
            });

            // Game buttons
            document.getElementById('trivia-start').addEventListener('click', startTriviaGame);
            document.getElementById('trivia-submit').addEventListener('click', submitTriviaAnswer);
            document.getElementById('trivia-next').addEventListener('click', nextTriviaQuestion);
        }

        function startTriviaGame() {
            const trivia = gameState.trivia;
            
            // Reset game state
            trivia.currentQuestion = 0;
            trivia.correctAnswers = 0;
            trivia.score = 0;
            trivia.gameActive = true;
            trivia.selectedAnswer = null;
            
            // Start timer
            startTimer('trivia');
            // Prepare a fixed-length run of 15 questions for this difficulty using pool manager
            const allQuestions = triviaQuestions[trivia.difficulty] || [];
            trivia.run = window.questionUtils 
                ? window.questionUtils.getUniqueRun(allQuestions, `trivia_${trivia.difficulty}`, trivia.totalQuestions)
                : buildRunRepeatable(allQuestions, trivia.totalQuestions);

            // Show first question
            showTriviaQuestion();
            
            // Update buttons
            document.getElementById('trivia-start').disabled = true;
            document.getElementById('trivia-submit').disabled = false;
            
            updateTriviaDisplay();
        }

        function showTriviaQuestion() {
            const trivia = gameState.trivia;
            const questions = trivia.run || [];

            if (trivia.currentQuestion >= trivia.totalQuestions) {
                endTriviaGame();
                return;
            }

            const question = questions[trivia.currentQuestion];
            
            document.getElementById('trivia-question-text').textContent = question.question;
            
            const optionsContainer = document.getElementById('trivia-options');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'trivia-option';
                optionDiv.textContent = option;
                optionDiv.onclick = () => selectTriviaOption(index, optionDiv);
                optionsContainer.appendChild(optionDiv);
            });
            
            trivia.selectedAnswer = null;
            document.getElementById('trivia-submit').disabled = false;
            document.getElementById('trivia-next').disabled = true;
        }

        function selectTriviaOption(index, element) {
            // Remove previous selection
            document.querySelectorAll('#trivia-options .trivia-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Select new option
            element.classList.add('selected');
            gameState.trivia.selectedAnswer = index;
        }

        function submitTriviaAnswer() {
            if (gameState.trivia.selectedAnswer === null) return;
            
            const trivia = gameState.trivia;
            const questions = trivia.run || [];
            const question = questions[trivia.currentQuestion];
            const isCorrect = trivia.selectedAnswer === question.correct;
            
            // Show correct/incorrect styling
            const options = document.querySelectorAll('#trivia-options .trivia-option');
            options.forEach((opt, index) => {
                if (index === question.correct) {
                    opt.classList.add('correct');
                } else if (index === trivia.selectedAnswer && !isCorrect) {
                    opt.classList.add('incorrect');
                }
                opt.onclick = null; // Disable clicking
            });
            
            if (isCorrect) {
                trivia.correctAnswers++;
                trivia.score += trivia.difficulty === 'hard' ? 15 : trivia.difficulty === 'medium' ? 10 : 5;
                showFeedback('trivia', '‚úÖ Correct!', 'correct');
            } else {
                showFeedback('trivia', `‚ùå Incorrect. The correct answer was: ${question.options[question.correct]}`, 'incorrect');
            }
            
            trivia.currentQuestion++;
            
            document.getElementById('trivia-submit').disabled = true;
            document.getElementById('trivia-next').disabled = false;
            
            updateTriviaDisplay();
        }

        function nextTriviaQuestion() {
            if (gameState.trivia.currentQuestion >= gameState.trivia.totalQuestions) {
                endTriviaGame();
            } else {
                showTriviaQuestion();
                document.getElementById('trivia-feedback').innerHTML = '';
            }
        }

        function endTriviaGame() {
            const trivia = gameState.trivia;
            trivia.gameActive = false;
            stopTimer('trivia');
            
            const percentage = Math.round((trivia.correctAnswers / trivia.totalQuestions) * 100);
            const won = percentage >= 70;
            
            addGameResult(won, trivia.score);
            
            document.getElementById('trivia-question-text').textContent = 'Quiz Complete!';
            document.getElementById('trivia-options').innerHTML = '';
            
            document.getElementById('trivia-game-over').innerHTML = `
                <div class="game-over ${won ? 'win' : 'lose'}">
                    <h3>${won ? 'üéâ Great Job!' : 'üìö Keep Studying!'}</h3>
                    <p><strong>Score:</strong> ${trivia.score} points</p>
                    <p><strong>Correct:</strong> ${trivia.correctAnswers}/${trivia.totalQuestions} (${percentage}%)</p>
                    <p><strong>Time:</strong> ${document.getElementById('trivia-timer').textContent}</p>
                    ${won ? '<p>Excellent knowledge!</p>' : '<p>Try again to improve your score!</p>'}
                </div>
            `;
            
            document.getElementById('trivia-start').disabled = false;
            document.getElementById('trivia-submit').disabled = true;
            document.getElementById('trivia-next').disabled = true;
        }

        function updateTriviaDisplay() {
            const trivia = gameState.trivia;
            
            document.getElementById('trivia-question-num').textContent = `${trivia.currentQuestion}/${trivia.totalQuestions}`;
            document.getElementById('trivia-correct').textContent = trivia.correctAnswers;
            document.getElementById('trivia-score').textContent = trivia.score;
        }

        // ANIMAL TRIVIA GAME
        function initAnimalTriviaGame() {
            // Difficulty selectors
            document.querySelectorAll('#animal-trivia-page .selector-btn[data-difficulty]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#animal-trivia-page .selector-btn[data-difficulty]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    gameState.animalTrivia.difficulty = btn.dataset.difficulty;
                });
            });

            // Game buttons
            document.getElementById('animal-start').addEventListener('click', startAnimalTriviaGame);
            document.getElementById('animal-submit').addEventListener('click', submitAnimalTriviaAnswer);
            document.getElementById('animal-next').addEventListener('click', nextAnimalTriviaQuestion);
        }

        function startAnimalTriviaGame() {
            const animalTrivia = gameState.animalTrivia;
            
            // Reset game state
            animalTrivia.currentQuestion = 0;
            animalTrivia.correctAnswers = 0;
            animalTrivia.score = 0;
            animalTrivia.gameActive = true;
            animalTrivia.selectedAnswer = null;
            
            // Start timer
            startTimer('animalTrivia');
            // Prepare a fixed-length run of 15 questions for this difficulty using pool manager
            const allQuestions = animalTriviaQuestions[animalTrivia.difficulty] || [];
            animalTrivia.run = window.questionUtils 
                ? window.questionUtils.getUniqueRun(allQuestions, `animal_trivia_${animalTrivia.difficulty}`, animalTrivia.totalQuestions)
                : buildRunRepeatable(allQuestions, animalTrivia.totalQuestions);

            // Show first question
            showAnimalTriviaQuestion();
            
            // Update buttons
            document.getElementById('animal-start').disabled = true;
            document.getElementById('animal-submit').disabled = false;
            
            updateAnimalTriviaDisplay();
        }

        function showAnimalTriviaQuestion() {
            const animalTrivia = gameState.animalTrivia;
            const questions = animalTrivia.run || [];
            
            if (animalTrivia.currentQuestion >= animalTrivia.totalQuestions) {
                endAnimalTriviaGame();
                return;
            }
            
            const question = questions[animalTrivia.currentQuestion];
            
            document.getElementById('animal-question-text').textContent = question.question;
            
            const optionsContainer = document.getElementById('animal-options');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'trivia-option';
                optionDiv.textContent = option;
                optionDiv.onclick = () => selectAnimalTriviaOption(index, optionDiv);
                optionsContainer.appendChild(optionDiv);
            });
            
            animalTrivia.selectedAnswer = null;
            document.getElementById('animal-submit').disabled = false;
            document.getElementById('animal-next').disabled = true;
        }

        function selectAnimalTriviaOption(index, element) {
            // Remove previous selection
            document.querySelectorAll('#animal-options .trivia-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Select new option
            element.classList.add('selected');
            gameState.animalTrivia.selectedAnswer = index;
        }

        function submitAnimalTriviaAnswer() {
            if (gameState.animalTrivia.selectedAnswer === null) return;
            
            const animalTrivia = gameState.animalTrivia;
            const questions = animalTrivia.run || [];
            const question = questions[animalTrivia.currentQuestion];
            const isCorrect = animalTrivia.selectedAnswer === question.correct;
            
            // Show correct/incorrect styling
            const options = document.querySelectorAll('#animal-options .trivia-option');
            options.forEach((opt, index) => {
                if (index === question.correct) {
                    opt.classList.add('correct');
                } else if (index === animalTrivia.selectedAnswer && !isCorrect) {
                    opt.classList.add('incorrect');
                }
                opt.onclick = null; // Disable clicking
            });
            
            if (isCorrect) {
                animalTrivia.correctAnswers++;
                animalTrivia.score += animalTrivia.difficulty === 'hard' ? 15 : animalTrivia.difficulty === 'medium' ? 10 : 5;
                showFeedback('animal', '‚úÖ Correct!', 'correct');
            } else {
                showFeedback('animal', `‚ùå Incorrect. The correct answer was: ${question.options[question.correct]}`, 'incorrect');
            }
            
            animalTrivia.currentQuestion++;
            
            document.getElementById('animal-submit').disabled = true;
            document.getElementById('animal-next').disabled = false;
            
            updateAnimalTriviaDisplay();
        }

        function nextAnimalTriviaQuestion() {
            if (gameState.animalTrivia.currentQuestion >= gameState.animalTrivia.totalQuestions) {
                endAnimalTriviaGame();
            } else {
                showAnimalTriviaQuestion();
                document.getElementById('animal-feedback').innerHTML = '';
            }
        }

        function endAnimalTriviaGame() {
            const animalTrivia = gameState.animalTrivia;
            animalTrivia.gameActive = false;
            stopTimer('animalTrivia');
            
            const percentage = Math.round((animalTrivia.correctAnswers / animalTrivia.totalQuestions) * 100);
            const won = percentage >= 70;
            
            addGameResult(won, animalTrivia.score);
            
            document.getElementById('animal-question-text').textContent = 'Quiz Complete!';
            document.getElementById('animal-options').innerHTML = '';
            
            document.getElementById('animal-game-over').innerHTML = `
                <div class="game-over ${won ? 'win' : 'lose'}">
                    <h3>${won ? 'ü¶Å Animal Expert!' : 'üêæ Keep Learning!'}</h3>
                    <p><strong>Score:</strong> ${animalTrivia.score} points</p>
                    <p><strong>Correct:</strong> ${animalTrivia.correctAnswers}/${animalTrivia.totalQuestions} (${percentage}%)</p>
                    <p><strong>Time:</strong> ${document.getElementById('animal-timer').textContent}</p>
                    ${won ? '<p>You know your animals!</p>' : '<p>Study more about animals and try again!</p>'}
                </div>
            `;
            
            document.getElementById('animal-start').disabled = false;
            document.getElementById('animal-submit').disabled = true;
            document.getElementById('animal-next').disabled = true;
        }

        function updateAnimalTriviaDisplay() {
            const animalTrivia = gameState.animalTrivia;
            
            document.getElementById('animal-question-num').textContent = `${animalTrivia.currentQuestion}/${animalTrivia.totalQuestions}`;
            document.getElementById('animal-correct').textContent = animalTrivia.correctAnswers;
            document.getElementById('animal-score').textContent = animalTrivia.score;
        }

    // Initialize all games when page loads
    window.addEventListener('DOMContentLoaded', () => {
            if (window.__burbleBooted) { console.warn('Burble already booted, skipping duplicate init.'); return; }
            window.__burbleBooted = true;
            try { if (window.ensureAudioUnlocked) window.ensureAudioUnlocked(); } catch(e) {}
            loadUserStats();
            initRiddlesGame();
            initBurbleGame();
            initEmojiGame();
            initValentineGame();
            initTriviaGame();
            initAnimalTriviaGame();
            updateUserStats();

            // Initialize pool manager UI. Only admins should see the Pool Manager.
            // If the full `initPoolManager` from the standalone build is present,
            // call it (but only for admins). Otherwise provide a lightweight
            // fallback so admins on `index.html` can still reset/rotate pools.
            try {
                // small isAdmin helper for the simplified index build
                function isAdmin() {
                    try {
                        const u = JSON.parse(localStorage.getItem('burbleUser') || 'null');
                        if (!u) return false;
                        if (u.isAdmin) return true;
                        const ADMIN_USERS = ['eli','elival','admin@example.com'];
                        if (u.username && ADMIN_USERS.includes(u.username)) return true;
                        if (u.email && ADMIN_USERS.includes(u.email)) return true;
                    } catch (e) {}
                    return false;
                }
                // If not admin, hide the pool manager section and skip initialization
                try { if (!isAdmin()) { const pm = document.getElementById('pool-manager'); if (pm) pm.style.display = 'none'; return; } } catch (e) {}
                if (typeof initPoolManager === 'function') {
                    try { initPoolManager(); } catch (e) { /* ignore */ }
                } else {
                    // Fallback: compute and render simple pool counts and wire reset
                    function computePoolCountsFallback() {
                        const counts = { animal: {}, trivia: {}, riddles: {} };
                        try {
                            const raw = localStorage.getItem('burblePools');
                            if (!raw) return counts;
                            const p = JSON.parse(raw) || {};
                            ['animal','trivia','riddles'].forEach(name => {
                                const pools = p[name] || {};
                                Object.keys(pools).forEach(k => {
                                    counts[name][k] = Array.isArray(pools[k]) ? pools[k].length : 0;
                                });
                            });
                        } catch (e) { /* ignore */ }
                        return counts;
                    }

                    function renderPoolCountsFallback() {
                        try {
                            const container = document.getElementById('pool-counts');
                            if (!container) return;
                            const counts = computePoolCountsFallback();
                            const parts = [];
                            Object.keys(counts).forEach(name => {
                                const inner = counts[name];
                                const sub = Object.keys(inner).map(k => `${k}: ${inner[k]}`).join(', ') || 'none';
                                parts.push(`<strong>${name}</strong>: ${sub}`);
                            });
                            const last = localStorage.getItem('burbleLastRotation');
                            if (last) {
                                let rel = last;
                                try {
                                    const t = new Date(last).getTime();
                                    if (isFinite(t)) {
                                        const diff = Date.now() - t;
                                        const sec = Math.floor(diff/1000);
                                        if (sec < 60) rel = `${sec}s ago`;
                                        else if (sec < 3600) rel = `${Math.floor(sec/60)}m ago`;
                                        else if (sec < 86400) rel = `${Math.floor(sec/3600)}h ago`;
                                        else rel = `${Math.floor(sec/86400)}d ago`;
                                    }
                                } catch (e) {}
                                parts.push(`<em>Last rotation:</em> ${String(rel)}`);
                            }
                            container.innerHTML = parts.join('<br>');
                        } catch (e) { /* ignore */ }
                    }

                    // Wire reset and rotate UI
                    try {
                        const btn = document.getElementById('reset-all-pools');
                        if (btn && !document.getElementById('rotate-now-pools')) {
                            // create wrapper with override checkbox, rotate button and status
                            const wrapper = document.createElement('div');
                            wrapper.style.marginTop = '8px';
                            wrapper.style.display = 'flex';
                            wrapper.style.alignItems = 'center';
                            wrapper.style.gap = '8px';

                            const overrideLabel = document.createElement('label');
                            overrideLabel.style.display = 'inline-flex';
                            overrideLabel.style.alignItems = 'center';
                            overrideLabel.style.gap = '6px';
                            const overrideCb = document.createElement('input');
                            overrideCb.type = 'checkbox';
                            overrideCb.id = 'rotate-force-override';
                            overrideCb.title = 'Force rotate even if games are active (admin override)';
                            const overrideText = document.createElement('span');
                            overrideText.textContent = 'Force rotate';
                            overrideText.style.fontSize = '0.9em';
                            overrideLabel.appendChild(overrideCb);
                            overrideLabel.appendChild(overrideText);

                            const rotateBtn = document.createElement('button');
                            rotateBtn.id = 'rotate-now-pools';
                            rotateBtn.className = 'nav-btn';
                            rotateBtn.textContent = 'Rotate now';
                            rotateBtn.title = 'Immediately rotate persistent pools (will skip pools for active games)';

                            const status = document.createElement('div');
                            status.id = 'rotate-status';
                            status.setAttribute('aria-live','polite');
                            status.style.fontSize = '0.95em';
                            status.style.color = '#333';
                            status.textContent = '';

                            wrapper.appendChild(overrideLabel);
                            wrapper.appendChild(rotateBtn);
                            wrapper.appendChild(status);
                            if (btn && btn.parentNode) btn.parentNode.insertBefore(wrapper, btn.nextSibling);

                            // Reset button wiring
                            btn.addEventListener('click', () => {
                                if (!confirm('Reset all persistent pools? This cannot be undone.')) return;
                                try {
                                    localStorage.removeItem('burblePools');
                                    const toRemove = [];
                                    for (let i = 0; i < localStorage.length; i++) {
                                        const key = localStorage.key(i);
                                        if (!key) continue;
                                        if (key.startsWith('pool::') || key.startsWith('burblePool::') || key.startsWith('pool:')) toRemove.push(key);
                                    }
                                    toRemove.forEach(k => localStorage.removeItem(k));
                                    try { if (gameState && gameState.animalTrivia && gameState.animalTrivia.pools) gameState.animalTrivia.pools = {}; } catch (e) {}
                                    try { if (gameState && gameState.trivia && gameState.trivia.pools) gameState.trivia.pools = {}; } catch (e) {}
                                    try { if (gameState && gameState.riddles && gameState.riddles.pools) gameState.riddles.pools = {}; } catch (e) {}
                                    renderPoolCountsFallback();
                                    alert('All pools reset.');
                                } catch (e) { console.error('resetAllPools fallback', e); }
                            });

                            // Rotate handler: try to delegate to rotatePersistentPools if available,
                            // otherwise perform a local reshuffle of stored pool arrays and update timestamp.
                            rotateBtn.addEventListener('click', () => {
                                const force = !!(document.getElementById('rotate-force-override') && document.getElementById('rotate-force-override').checked);
                                const warn = force ? 'Force-rotate pools now? This will override active games and may disturb players.' : 'Rotate all persistent pools now? Pools for any active games will be skipped.';
                                if (!confirm(warn)) return;
                                try {
                                    // Prefer the full function when present
                                    if (typeof rotatePersistentPools === 'function') {
                                        const res = rotatePersistentPools({ force });
                                        if (res && res.then) {
                                            res.then(() => { alert('Rotation complete.'); try { renderPoolCountsFallback(); } catch (e) {} }).catch(e => alert('Rotation failed: ' + (e && e.message ? e.message : String(e))));
                                        } else {
                                            alert('Rotation complete.');
                                            try { renderPoolCountsFallback(); } catch (e) {}
                                        }
                                        // update status
                                        try { localStorage.setItem('burbleLastRotation', new Date().toISOString()); } catch (e) {}
                                        try { status.textContent = `Rotated ${(() => { const l = localStorage.getItem('burbleLastRotation'); return l ? (function(){const t=new Date(l).getTime(); const diff=Date.now()-t; const sec=Math.floor(diff/1000); if(sec<60) return `${sec}s ago`; if(sec<3600) return `${Math.floor(sec/60)}m ago`; if(sec<86400) return `${Math.floor(sec/3600)}h ago`; return `${Math.floor(sec/86400)}d ago`; })() : 'now'; })()}`; } catch (e) {}
                                    } else {
                                        // local fallback: reshuffle stored pool arrays
                                        for (let i = 0; i < localStorage.length; i++) {
                                            const key = localStorage.key(i);
                                            if (!key) continue;
                                            if (!key.startsWith('pool::')) continue;
                                            try {
                                                const raw = localStorage.getItem(key);
                                                if (!raw) continue;
                                                const arr = JSON.parse(raw);
                                                if (!Array.isArray(arr) || arr.length === 0) continue;
                                                // simple shuffle
                                                for (let a = arr.length - 1; a > 0; a--) {
                                                    const b = Math.floor(Math.random() * (a + 1));
                                                    [arr[a], arr[b]] = [arr[b], arr[a]];
                                                }
                                                localStorage.setItem(key, JSON.stringify(arr));
                                            } catch (e) { /* ignore per-key errors */ }
                                        }
                                        try { localStorage.setItem('burbleLastRotation', new Date().toISOString()); } catch (e) {}
                                        try { renderPoolCountsFallback(); } catch (e) {}
                                        alert('Rotation complete (fallback).');
                                        try { const l = localStorage.getItem('burbleLastRotation'); if (l) { const t=new Date(l).getTime(); const diff=Date.now()-t; const sec=Math.floor(diff/1000); let rel='now'; if(sec<60) rel=`${sec}s ago`; else if(sec<3600) rel=`${Math.floor(sec/60)}m ago`; else if(sec<86400) rel=`${Math.floor(sec/3600)}h ago`; else rel=`${Math.floor(sec/86400)}d ago`; status.textContent = `Rotated ${rel}`; } } catch (e) {}
                                    }
                                } catch (e) { alert('Rotation failed: ' + (e && e.message ? e.message : String(e))); }
                            });
                        }
                    } catch (e) {}

                    // initial render
                    try { renderPoolCountsFallback(); } catch (e) {}
                }
            } catch (e) { /* ignore */ }
        });
    </script>

    <!-- Firebase + shared logic -->
    <script type="module" src="/js/app.js"></script>

    <!-- Load Question Engine -->
    <script src="scripts/question-engine.js"></script>
    <script>
    // School Trivia wiring
    document.addEventListener('DOMContentLoaded', () => {
        const newBtn = document.getElementById('school-new');
        const showBtn = document.getElementById('school-show-answer');
        const qEl = document.getElementById('school-question');
        const aEl = document.getElementById('school-answer');
        const subj = document.getElementById('school-subject');
        const diff = document.getElementById('school-difficulty');
        const qCount = document.getElementById('school-q-count');

        let lastQA = null;
        let counter = 0;

        function updateCount() { qCount.textContent = String(counter); }

        newBtn.addEventListener('click', () => {
            const s = subj.value;
            const d = diff.value;
            const res = (window.QuestionEngine && window.QuestionEngine.getQuestion)
                ? window.QuestionEngine.getQuestion('School Trivia', s, d)
                : { q: 'Question engine not loaded', a: null };
            lastQA = res;
            qEl.textContent = res.q || 'No question';
            aEl.textContent = '';
            showBtn.disabled = !res.a;
            counter++;
            updateCount();
        });

        showBtn.addEventListener('click', () => {
            if (!lastQA) return;
            aEl.textContent = lastQA.a || 'No answer available';
        });
    });
    </script>
